(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";exports.formatUserID=formatUserID;exports.create=create;exports.style_link_hover=exports.style_link=void 0;var assert=require("assert");var local_storage=require("./glov/local_storage.js");var glov_font=require("./glov/font.js");var _require=require("./glov/input.js"),KEYS=_require.KEYS,keyDownEdge=_require.keyDownEdge;var _require2=require("./glov/link.js"),linkText=_require2.linkText;var net=require("./glov/net.js");var ui=require("./glov/ui.js");var _require3=require("./glov/vmath.js"),vec4=_require3.vec4;var style_link=glov_font.style(null,{color:1346437119,outline_width:1,outline_color:32});exports.style_link=style_link;var style_link_hover=glov_font.style(null,{color:65535,outline_width:1,outline_color:32});exports.style_link_hover=style_link_hover;function formatUserID(user_id,display_name){var name=display_name||user_id;if(user_id.toLowerCase()!==name.toLowerCase()){name=display_name+" ("+user_id+")"}return name}function AccountUI(){this.edit_box_name=ui.createEditBox({placeholder:"Username",initial_focus:true,text:local_storage.get("name")||""});this.edit_box_password=ui.createEditBox({placeholder:"Password",type:"password",text:local_storage.get("name")&&local_storage.get("password")||""});this.edit_box_password_confirm=ui.createEditBox({initial_focus:true,placeholder:"Confirm",type:"password",text:""});this.edit_box_email=ui.createEditBox({placeholder:"Email",text:""});this.edit_box_display_name=ui.createEditBox({placeholder:"Display",text:""});this.creation_mode=false}AccountUI.prototype.showLogin=function(param){var _this=this;var x=param.x,y=param.y,style=param.style,button_height=param.button_height,button_width=param.button_width,prelogout=param.prelogout,center=param.center,url_tos=param.url_tos,url_priv=param.url_priv,text_w=param.text_w,font_height=param.font_height;font_height=font_height||ui.font_height;button_height=button_height||ui.button_height;button_width=button_width||240;text_w=text_w||400;var edit_box_name=this.edit_box_name,edit_box_password=this.edit_box_password,edit_box_password_confirm=this.edit_box_password_confirm,edit_box_email=this.edit_box_email,edit_box_display_name=this.edit_box_display_name;var login_message;var BOX_H=font_height;var pad=10;var min_h=BOX_H*2+pad*3+button_height;var calign=center?glov_font.ALIGN.HRIGHT:glov_font.ALIGN.HLEFT|glov_font.ALIGN.HFIT;function showTOS(is_create){if(url_tos){assert(url_priv);var terms_height=font_height*.75;ui.font.drawSizedAligned(style,x,y,Z.UI,terms_height,glov_font.ALIGN.HCENTER,0,0,"By "+(is_create?"creating an account":"logging in")+" you agree to our");y+=terms_height;var and_w=ui.font.getStringWidth(style,terms_height," and ");ui.font.drawSizedAligned(style,x,y,Z.UI,terms_height,glov_font.ALIGN.HCENTER,0,0,"and");linkText({style_link:style_link,style_link_hover:style_link_hover,x:x-and_w/2-ui.font.getStringWidth(style_link,terms_height,"Terms of Service"),y:y,z:Z.UI,font_size:terms_height,url:url_tos,text:"Terms of Service"});linkText({style_link:style_link,style_link_hover:style_link_hover,x:x+and_w/2,y:y,z:Z.UI,font_size:terms_height,url:url_priv,text:"Privacy Policy"})}y+=BOX_H+pad}if(!net.client.connected){login_message="Establishing connection..."}else if(net.subs.logging_in){login_message="Logging in..."}else if(net.subs.logging_out){login_message="Logging out..."}else if(!net.subs.loggedIn()&&window.FBInstant){net.subs.loginFacebook(function(err){if(err){ui.modalDialog({title:"Facebook login Failed",text:err,buttons:{Cancel:null}})}})}else if(!net.subs.loggedIn()&&net.subs.auto_create_user&&!local_storage.get("did_auto_anon")&&!local_storage.get("name")){login_message="Auto logging in...";local_storage.set("did_auto_anon","yes");var name="anon"+String(Math.random()).slice(2,8);var pass="test";local_storage.set("name",name);net.subs.login(name,pass,function(err){if(err){ui.modalDialog({title:"Auto-login Failed",text:err,buttons:{Retry:function Retry(){local_storage.set("did_auto_anon",undefined);local_storage.set("name",undefined)},Cancel:null}})}else{net.subs.sendCmdParse("rename_random",function(err){if(err){console.log(err)}})}})}else if(!net.subs.loggedIn()){var submit=false;var w=text_w/2;var indent=center?0:140;var text_x=center?x-8:x;ui.font.drawSizedAligned(style,text_x,y,Z.UI,font_height,calign,indent-pad,0,"Username:");submit=edit_box_name.run({x:x+indent,y:y,w:w,font_height:font_height})===edit_box_name.SUBMIT||submit;y+=BOX_H+pad;ui.font.drawSizedAligned(style,text_x,y,Z.UI,font_height,calign,indent-pad,0,"Password:");submit=edit_box_password.run({x:x+indent,y:y,w:w,font_height:font_height})===edit_box_password.SUBMIT||submit;y+=BOX_H+pad;if(this.creation_mode){ui.font.drawSizedAligned(style,text_x,y,Z.UI,font_height,calign,indent-pad,0,"Confirm Password:");submit=edit_box_password_confirm.run({x:x+indent,y:y,w:w,font_height:font_height})===edit_box_password.SUBMIT||submit;y+=BOX_H+pad;ui.font.drawSizedAligned(style,text_x,y,Z.UI,font_height,calign,indent-pad,0,"Email Address:");submit=edit_box_email.run({x:x+indent,y:y,w:w,font_height:font_height})===edit_box_password.SUBMIT||submit;y+=BOX_H+pad;ui.font.drawSizedAligned(style,text_x,y,Z.UI,font_height,calign,indent-pad,0,"Display Name:");submit=edit_box_display_name.run({x:x+indent,y:y,w:w,font_height:font_height})===edit_box_password.SUBMIT||submit;if(ui.buttonText({x:x+w+(center?0:140)+pad,y:y,w:button_width*.5,h:BOX_H+pad-4,font_height:font_height*.75,text:"Random"})){net.client.send("random_name",null,function(ignored,data){if(data){edit_box_display_name.setText(data)}})}y+=BOX_H+pad;showTOS(true);submit=ui.buttonText({x:x,y:y,w:button_width,h:button_height,font_height:font_height,text:"Create User"})||submit;if(ui.buttonText({x:x+button_width+pad,y:y,w:button_width,h:button_height,font_height:font_height,text:"Cancel"})||keyDownEdge(KEYS.ESC)){this.creation_mode=false}y+=button_height+pad;if(submit){local_storage.set("name",edit_box_name.text);net.subs.userCreate({user_id:edit_box_name.text,email:edit_box_email.text,password:edit_box_password.text,password_confirm:edit_box_password_confirm.text,display_name:edit_box_display_name.text},function(err){if(err){ui.modalDialog({title:"Login Error",text:err,buttons:{OK:null}})}else{_this.creation_mode=false;edit_box_password_confirm.setText("");edit_box_email.setText("");edit_box_display_name.setText("")}})}}else{showTOS(false);submit=ui.buttonText({x:x,y:y,w:button_width,h:button_height,font_height:font_height,text:"Log in"})||submit;if(center){y+=button_height+pad}if(ui.buttonText({x:center?x:x+button_width+pad,y:y,w:button_width,h:button_height,font_height:font_height,text:"New User"})){this.creation_mode=true;edit_box_display_name.setText(edit_box_name.text);if(edit_box_name.text&&edit_box_password.text){edit_box_password_confirm.initial_focus=true}else{edit_box_password_confirm.initial_focus=false;edit_box_name.focus()}}y+=button_height+pad;if(submit){local_storage.set("name",edit_box_name.text);net.subs.login(edit_box_name.text,edit_box_password.text,function(err){if(err){ui.modalDialog({title:"Login Error",text:err,buttons:{OK:null}})}})}}}else{var show_logout=!window.FBInstant;var user_id=net.subs.loggedIn();var user_channel=net.subs.getChannel("user."+user_id);var display_name=user_channel.getChannelData("public.display_name")||user_id;var _name=formatUserID(user_id,display_name);if(show_logout){var logged_in_font_height=font_height*.75;if(center){ui.font.drawSizedAligned(style,center?x-text_w/2:x+button_width+8,y,Z.UI,logged_in_font_height,(center?glov_font.ALIGN.HCENTER:calign)|glov_font.ALIGN.HFIT,text_w,button_height,"Logged in as: "+_name);y+=logged_in_font_height+8}else{ui.font.drawSizedAligned(style,x+button_width+8,y+logged_in_font_height*-.25,Z.UI,logged_in_font_height,calign|glov_font.ALIGN.VCENTER|glov_font.ALIGN.HFIT,text_w,button_height,"Logged in as:");ui.font.drawSizedAligned(style,x+button_width+8,y+logged_in_font_height*.75,Z.UI,logged_in_font_height,calign|glov_font.ALIGN.VCENTER|glov_font.ALIGN.HFIT,text_w,button_height,_name)}if(ui.buttonText({x:center?x-button_width/2:x,y:y,w:button_width,h:button_height,font_height:font_height,text:"Log out"})){edit_box_password.setText("");if(prelogout){prelogout()}net.subs.logout()}y+=button_height+8}else{ui.font.drawSizedAligned(style,center?x-text_w/2:x+button_width+8,y,Z.UI,font_height,(center?glov_font.ALIGN.HCENTER:calign)|glov_font.ALIGN.VCENTER|glov_font.ALIGN.HFIT,text_w,button_height,"Logged in as: "+_name)}}if(login_message){var _w=ui.font.drawSizedAligned(style,center?x-400:x,y,Z.UI,font_height*1.5,glov_font.ALIGN.HVCENTERFIT,center?800:400,min_h,login_message);_w+=100;ui.drawRect(x-(center?_w/2:50),y,x+(center?_w/2:_w-50),y+min_h,Z.UI-.5,vec4(0,0,0,.25));y+=min_h}return y};function create(){return new AccountUI}


},{"./glov/font.js":15,"./glov/input.js":25,"./glov/link.js":26,"./glov/local_storage.js":27,"./glov/net.js":30,"./glov/ui.js":47,"./glov/vmath.js":49,"assert":undefined}],2:[function(require,module,exports){
"use strict";var called_once=false;window.onload=function(){if(called_once){return}called_once=true;require("./glov/bootstrap.js");if(window.glov_env==="multiplayer"){require("./multiplayer.js").main()}else{require("./main.js").main()}};


},{"./glov/bootstrap.js":4,"./main.js":57,"./multiplayer.js":58}],3:[function(require,module,exports){
"use strict";exports.distSq=distSq;exports.createGalaxy=createGalaxy;exports.MAX_LAYER=exports.STAR_LAYER=exports.LAYER_STEP=void 0;var LAYER_STEP=4;exports.LAYER_STEP=LAYER_STEP;var STAR_LAYER=6;exports.STAR_LAYER=STAR_LAYER;var MAX_LAYER=8;exports.MAX_LAYER=MAX_LAYER;var assert=require("assert");var engine=require("./glov/engine.js");var abs=Math.abs,atan2=Math.atan2,ceil=Math.ceil,floor=Math.floor,max=Math.max,min=Math.min,sqrt=Math.sqrt,pow=Math.pow,PI=Math.PI,round=Math.round;var _require=require("./glov/rand_alea.js"),randCreate=_require.randCreate,mashString=_require.mashString;var SimplexNoise=require("simplex-noise");var _require2=require("./star_types.js"),hueFromID=_require2.hueFromID;var _require3=require("./solar_system.js"),solarSystemCreate=_require3.solarSystemCreate;var textures=require("./glov/textures.js");var _require4=require("../common/util.js"),clamp=_require4.clamp,lerp=_require4.lerp,easeOut=_require4.easeOut,easeInOut=_require4.easeInOut;var SUMSQ=.75;var POI_TYPE_OFFS=[[1,0,0,.5,0,-1,.5,-1,0,.5,0,1,.5,1,0],[1,0,0,.5,0,-1,.5,0,-2,.5,-1,0,.5,-2,0,.5,1,0,.5,2,0,.5,0,1,.5,0,2,.2,-1,-1,.2,1,-1,.2,-1,1,.2,1,1],[1,0,0,.2,0,-1,.2,0,-2,.2,-1,0,.2,-2,0,.2,1,0,.2,2,0,.2,0,1,.2,0,2,.2,-1,-1,.2,1,-1,.2,-1,1,.2,1,1]];var counts={bicubic:0,getSampleBuf:0,realizeStars:0,realizeStarsFinish:0,perturb:0,assignChildStars:0,data:0,star_buf:0,hue_buf:0,getCellTextured:0,tex:0,cell:0,star:0,renderStars:0};var star_buf_pool=[];var hue_buf_pool=[];var noise=new Array(2);var rand=randCreate(0);function genGalaxy(params){var seed=params.seed,arms=params.arms,buf_dim=params.buf_dim,twirl=params.twirl,center=params.center,poi_count=params.poi_count,len_mods=params.len_mods,noise_freq=params.noise_freq,noise_weight=params.noise_weight,star_count=params.star_count,max_zoom=params.max_zoom;for(var ii=0;ii<noise.length;++ii){noise[ii]=new SimplexNoise(seed+"n"+ii)}rand.reseed(seed);var arm_len=new Array(len_mods);for(var _ii=0;_ii<arm_len.length;++_ii){arm_len[_ii]=rand.random()}var data=new Float32Array(buf_dim*buf_dim);for(var idx=0,yy=0;yy<buf_dim;++yy){var y=yy/buf_dim*2-1;for(var xx=0;xx<buf_dim;++xx,++idx){var x=xx/buf_dim*2-1;var d=sqrt(x*x+y*y);var rawd=d;var theta=atan2(x,y);var rawtheta=theta;theta+=d*twirl;var dense=theta/(2*PI);while(dense<0){dense+=1}var armidx=dense*2%1*arm_len.length;var armi=floor(armidx);var armf=armidx-armi;var interp_arm_len=lerp(easeInOut(armf,2),arm_len[armi],arm_len[(armi+1)%arm_len.length]);d*=1+interp_arm_len;dense*=arms;dense%=1;dense=abs(dense*2-1);dense*=dense;var invd=max(0,1-d);var id2=max(0,min(1,invd*2));if(id2===0){dense=0}else{dense=max(0,min(1,dense/id2-(1/id2-1)))}dense=easeOut(dense,2);var v=void 0;dense=lerp(min(d,1),invd,dense);v=dense;var cv=clamp((center-rawd)*20,0,1);v+=easeInOut(cv,2);var noise_v1=noise[0].noise2D(rawd*noise_freq,theta*d)*.5+.5;var theta_rot=(rawtheta+PI*2)%(PI*2)+d*twirl;var noise_v2=noise[0].noise2D(rawd*noise_freq,theta_rot*d)*.5+.5;var theta01=(rawtheta/(PI*2)+1)%1;var noise_v=lerp(abs(theta01*2-1),noise_v2,noise_v1);noise_v=noise_v*2-1;noise_v*=lerp(clamp(v*10,0,1),.05,1);noise_v*=lerp(clamp((v-.7)/.1,0,1),1,0);noise_v*=lerp(clamp((rawd-.7)/.3,0,1),1,0);v+=noise_v*noise_weight;data[idx]=max(v,0)}}var POI_BORDER=5;var pois=[];var poi_offs=.5/pow(2,max_zoom);for(var _ii2=0;_ii2<poi_count;++_ii2){var _x=POI_BORDER+rand.range(buf_dim-POI_BORDER*2);var _y=POI_BORDER+rand.range(buf_dim-POI_BORDER*2);var _v=rand.floatBetween(.2,1);var _idx=_x+_y*buf_dim;data[_idx]=max(data[_idx],_v*.5);_x=_x/buf_dim+poi_offs;_y=_y/buf_dim+poi_offs;var type=rand.range(POI_TYPE_OFFS.length);pois.push({x:_x,y:_y,type:type,v:_v})}var sum=0;var sumsq=0;for(var _ii3=0;_ii3<data.length;++_ii3){var _v2=data[_ii3];sum+=_v2;sumsq+=_v2*_v2}return{data:data,sum:sum,sumsq:sumsq,star_count:star_count,pois:pois}}var tex_pool=[];var tex_id_idx=0;function Galaxy(params){this.params=params;var buf_dim=this.buf_dim=params.buf_dim;var tex_total_size=this.tex_total_size=buf_dim*buf_dim;this.tex_data=new Uint8Array(tex_total_size*4);this.layers=[];this.work_frame=0;this.loading=false}var SAMPLE_PAD=4;var cubic_weights=function(){function cub(v){return v*v*v}function p(v){return max(0,v)}function r(x){var v=1/6*(cub(p(x+2))-4*cub(p(x+1))+6*cub(p(x))-4*cub(p(x-1)));return v}function weight(ii,jj,dx,dy){return r(ii-dx/4)*r(jj-dy/4)}var ret=[];for(var dy=0;dy<4;++dy){var row=[];ret.push(row);for(var dx=0;dx<4;++dx){var w=[];for(var ii=-1;ii<=2;++ii){for(var jj=-1;jj<=2;++jj){w.push(weight(ii,jj,dx,dy))}}row.push(w)}}return ret}();function expandBicubic16X(data,buf_dim,xq,yq){++counts.bicubic;var sample_dim=buf_dim+SAMPLE_PAD*2;var ret=new Float32Array(buf_dim*buf_dim);++counts.data;var qs=buf_dim/4;var idx_add=(yq*qs+SAMPLE_PAD)*sample_dim+xq*qs+SAMPLE_PAD;for(var yy=0;yy<buf_dim;++yy){var y_in=floor(yy/4);var dy=yy-y_in*4;var in_idx_y=y_in*sample_dim+idx_add;var w_row=cubic_weights[dy];for(var xx=0;xx<buf_dim;++xx){var x_in=floor(xx/4);var dx=xx-x_in*4;var in_idx=in_idx_y+x_in;var sum=0;var weights=w_row[dx];for(var ii=-1,widx=0;ii<=2;++ii){for(var jj=-1;jj<=2;++jj,++widx){sum+=data[in_idx+ii+jj*sample_dim]*weights[widx]}}ret[xx+yy*buf_dim]=sum}}return ret}Galaxy.prototype.getSampleBuf=function(layer_idx,cx,cy){var sample_buf=this.sample_buf,buf_dim=this.buf_dim;var key=[layer_idx,cx,cy].join();if(this.last_sample_buf===key){return sample_buf}var layer_res=pow(LAYER_STEP,layer_idx);var sample_dim=buf_dim+SAMPLE_PAD*2;if(!sample_buf){sample_buf=this.sample_buf=new Float32Array(sample_dim*sample_dim)}var bufs=[];for(var dy=-1;dy<=1;++dy){var py=cy+dy;bufs[dy]=[];for(var dx=-1;dx<=1;++dx){var px=cx+dx;var buf=void 0;if(px<0||px>=layer_res||py<0||py>=layer_res){buf=null}else{var cell=this.getCell(layer_idx,px+py*layer_res);if(!cell.ready){return null}buf=cell.data}bufs[dy][dx]=buf}}if(engine.frame_index===this.work_frame&&!this.loading){return null}++counts.getSampleBuf;for(var _dy=-1;_dy<=1;++_dy){for(var _dx=-1;_dx<=1;++_dx){var _buf=bufs[_dy][_dx];var ox=SAMPLE_PAD+_dx*buf_dim;var oy=SAMPLE_PAD+_dy*buf_dim;var x0=max(0,-ox);var y0=max(0,-oy);var x1=min(buf_dim,sample_dim-ox);var y1=min(buf_dim,sample_dim-oy);for(var xx=x0;xx<x1;++xx){for(var yy=y0;yy<y1;++yy){sample_buf[ox+xx+(oy+yy)*sample_dim]=_buf?_buf[xx+yy*buf_dim]:0}}}}this.last_sample_buf=key;return sample_buf};var STAR_QUOTA=14;var realize_scratch_buf;var realize_scratch_buf_size=0;Galaxy.prototype.realizeStars=function(cell){var start=Date.now();var layer_idx=cell.layer_idx,cell_idx=cell.cell_idx,star_count=cell.star_count,data=cell.data,sum=cell.sum,sumsq=cell.sumsq,x0=cell.x0,y0=cell.y0,w=cell.w,pois=cell.pois,star_progress=cell.star_progress,star_storage=cell.star_storage;var scale=star_count/lerp(SUMSQ,sum,sumsq)*1.03;assert.equal(layer_idx,STAR_LAYER);var buf_dim=this.buf_dim,params=this.params;var seed=params.seed;var yy0;var out_idx;++counts.realizeStars;if(!star_progress){assert(star_count>=pois.length);rand.reseed(mashString(seed+"_"+layer_idx+"_"+cell_idx));star_storage=cell.star_storage=new Float64Array(star_count*2);cell.star_storage_start=0;yy0=0;out_idx=0}else{if(star_progress.state){rand.importState(star_progress.state)}yy0=star_progress.y;out_idx=star_progress.out}function addStarSub(x,y){++counts.star;var idx;if(out_idx===star_count){idx=rand.range(star_count-pois.length)+pois.length}else{idx=out_idx++}star_storage[idx*2]=x;star_storage[idx*2+1]=y;var xfloat=star_storage[idx*2];var yfloat=star_storage[idx*2+1];assert(xfloat>=cell.x0);assert(xfloat<cell.x0+w);assert(yfloat>=cell.y0);assert(yfloat<cell.y0+w)}function addStar(xx,yy){var x=x0+xx/buf_dim*w;var y=y0+yy/buf_dim*w;addStarSub(x,y)}if(star_count){var expire=start+STAR_QUOTA;if(out_idx===0){for(var ii=0;ii<pois.length;++ii){var poi=pois[ii];addStarSub(poi.x,poi.y)}}for(var idx=yy0*buf_dim,yy=yy0;yy<buf_dim;++yy){for(var xx=0;xx<buf_dim;++xx,++idx){var v=data[idx];v*=1+SUMSQ*(v-1);var expected_stars=v*scale;var actual_stars=floor(rand.random()*(expected_stars+1)+expected_stars*.5);for(var _ii4=0;_ii4<actual_stars;++_ii4){addStar(xx+rand.random(),yy+rand.random())}}if(Date.now()>expire&&yy!==buf_dim-1&&!this.loading){cell.star_progress={y:yy+1,state:rand.exportState(),out:out_idx};return false}}while(out_idx<star_count){addStar(rand.floatBetween(0,buf_dim),rand.floatBetween(0,buf_dim))}assert.equal(out_idx,star_count);var temp=new Array(star_count);for(var _ii5=0;_ii5<star_count;++_ii5){temp[_ii5]=_ii5*2}var mod0=w/LAYER_STEP;temp.sort(function(ai,bi){var ax=star_storage[ai];var ay=star_storage[ai+1];var bx=star_storage[bi];var by=star_storage[bi+1];var mod=mod0;var layer=layer_idx;while(true){if(layer===MAX_LAYER+1){return 0}var ayi=floor(ay/mod);var byi=floor(by/mod);if(ayi!==byi){return ayi-byi}var axi=floor(ax/mod);var bxi=floor(bx/mod);if(axi!==bxi){return axi-bxi}mod/=LAYER_STEP;++layer}});if(star_count>realize_scratch_buf_size){realize_scratch_buf_size=ceil(1.25*star_count);realize_scratch_buf=new Float64Array(realize_scratch_buf_size*2)}for(var _ii6=0;_ii6<star_count;++_ii6){var _idx2=temp[_ii6];realize_scratch_buf[_ii6*2]=star_storage[_idx2];realize_scratch_buf[_ii6*2+1]=star_storage[_idx2+1];var x=realize_scratch_buf[_ii6*2];var y=realize_scratch_buf[_ii6*2+1];assert(x>=cell.x0);assert(x<cell.x0+w);assert(y>=cell.y0);assert(y<cell.y0+w)}for(var _ii7=0;_ii7<star_count*2;++_ii7){star_storage[_ii7]=realize_scratch_buf[_ii7]}}delete cell.star_progress;++counts.realizeStarsFinish;return true};function hash(x){x=(x>>>16^x)*73244475>>>0;x=(x>>>16^x)*73244475>>>0;x=(x>>>16^x)>>>0;return x}function starValueFromID(id){return(.5+hash(id)/4294967295)*.75}function starVisTypeFromID(id){return(hash(id)&32767)/32768*POI_TYPE_OFFS.length|0}{var blur_weights=[1/16,1/8,1/16,1/8,1/4,1/8,1/16,1/8,1/16];Galaxy.prototype.renderStars=function(cell){var layer_idx=cell.layer_idx,x0=cell.x0,y0=cell.y0,w=cell.w,cx=cell.cx,cy=cell.cy;var buf_dim=this.buf_dim;var scale=buf_dim/w;var layer_res=pow(LAYER_STEP,layer_idx);var ndata=[];var nhue=[];for(var yy=-1;yy<=1;++yy){var ncy=cy+yy;for(var xx=-1;xx<=1;++xx){var ncx=cx+xx;var n=void 0;if(ncy<0||ncy>=layer_res||ncx<0||ncx>=layer_res){n=cell}else{n=this.getCell(layer_idx,ncx+ncy*layer_res,true)}assert(!n.tex);if(!n.star_buf){if(star_buf_pool.length){n.star_buf=star_buf_pool.pop();n.star_buf.fill(0)}else{n.star_buf=new Float32Array(buf_dim*buf_dim);++counts.star_buf}}ndata.push(n.star_buf);if(!n.hue_buf){if(hue_buf_pool.length){n.hue_buf=hue_buf_pool.pop();n.hue_buf.fill(0)}else{n.hue_buf=new Uint8Array(buf_dim*buf_dim);++counts.hue_buf}}nhue.push(n.hue_buf)}}assert(ndata[4]===cell.star_buf);++counts.renderStars;var weights=[];var xpos=[];var ypos=[];var star_count=cell.star_count,star_storage=cell.star_storage,star_storage_start=cell.star_storage_start,star_idx=cell.star_idx;var store_idx=star_storage_start*2;for(var ii=0;ii<star_count;++ii){var x=star_storage[store_idx++];var y=star_storage[store_idx++];var id=star_idx+ii;var v=starValueFromID(id);x=(x-x0)*scale;y=(y-y0)*scale;if(layer_idx===7||layer_idx===6){var hue=hueFromID(id);var r=layer_idx===7?2:1.5;var vscale=layer_idx===7?4:2;var rsq=r*r;var wtot=0;var widx=0;var ix=floor(x);var iy=floor(y);if(layer_idx===7){for(var _yy=floor(-r);_yy<=ceil(r);++_yy){var dy=iy+_yy-y+.5;if(abs(dy)>=r){continue}for(var _xx=floor(-r);_xx<=ceil(r);++_xx){var dx=ix+_xx-x+.5;var dsq=dx*dx+dy*dy;if(dsq>=rsq){continue}var d=sqrt(dsq);var wt=(1-d/r)*(1-d/r);wtot+=wt;weights[widx]=wt;xpos[widx]=ix+_xx;ypos[widx++]=iy+_yy}}}else if(layer_idx===6){weights=blur_weights;wtot=1;for(var _yy2=-1;_yy2<=1;++_yy2){for(var _xx2=-1;_xx2<=1;++_xx2){xpos[widx]=ix+_xx2;ypos[widx++]=iy+_yy2}}}for(var jj=0;jj<widx;++jj){var _wt=weights[jj];var _xx3=xpos[jj];var _yy3=ypos[jj];var nid=4;if(_xx3<0){nid--;_xx3+=buf_dim}else if(_xx3>=buf_dim){nid++;_xx3-=buf_dim}if(_yy3<0){nid-=3;_yy3+=buf_dim}else if(_yy3>=buf_dim){nid+=3;_yy3-=buf_dim}var data=ndata[nid];var hue_buf=nhue[nid];var idx=_xx3+_yy3*buf_dim;var old_w=data[idx];var new_w=_wt/wtot;data[idx]+=v*vscale*new_w;hue_buf[idx]=round((old_w*hue_buf[idx]+hue*new_w)/(new_w+old_w))}}else{}}return true}}Galaxy.prototype.assignChildStars=function(cell){var buf_dim=this.buf_dim;var pois=cell.pois,star_count=cell.star_count,sum=cell.sum,sumsq=cell.sumsq,data=cell.data,star_idx=cell.star_idx,star_storage=cell.star_storage,star_storage_start=cell.star_storage_start;var child_data=[];for(var ii=0;ii<LAYER_STEP*LAYER_STEP;++ii){child_data.push({pois:[]})}if(!star_storage){var qs=buf_dim/LAYER_STEP;var running_sum=0;var running_sumsq=0;var last_star_count=0;for(var idx=0,yy=0;yy<LAYER_STEP;++yy){for(var xx=0;xx<LAYER_STEP;++xx,++idx){if(sum){var idxbase=xx*qs+yy*qs*buf_dim;for(var jj=0;jj<qs;++jj){var idx_in=idxbase+jj*buf_dim;for(var _ii8=0;_ii8<qs;++_ii8,++idx_in){var v=data[idx_in];running_sum+=v;running_sumsq+=v*v}}}var sc=sum?round(lerp(SUMSQ,running_sum/sum,running_sumsq/sumsq)*star_count):0;child_data[idx].star_count=sc-last_star_count;child_data[idx].star_idx=star_idx+last_star_count;last_star_count=sc}}assert.equal(last_star_count,star_count)}var mul=LAYER_STEP/cell.w;for(var _ii9=0;_ii9<pois.length;++_ii9){var poi=pois[_ii9];var qx=floor((poi.x-cell.x0)*mul);var qy=floor((poi.y-cell.y0)*mul);assert(qx>=0&&qx<LAYER_STEP);assert(qy>=0&&qy<LAYER_STEP);var _idx3=qy*LAYER_STEP+qx;child_data[_idx3].pois.push(poi)}if(star_storage){var child_idx=0;var last_start=star_storage_start;var end=star_storage_start+star_count;for(var _ii10=star_storage_start;_ii10<end;++_ii10){var x=star_storage[_ii10*2];var y=star_storage[_ii10*2+1];var _qx=floor((x-cell.x0)*mul);var _qy=floor((y-cell.y0)*mul);assert(_qx>=0&&_qx<LAYER_STEP);assert(_qy>=0&&_qy<LAYER_STEP);var _idx4=_qy*LAYER_STEP+_qx;assert(_idx4>=child_idx);while(child_idx<_idx4){child_data[child_idx].store_start=last_start;child_data[child_idx++].store_count=_ii10-last_start;last_start=_ii10}}while(child_idx<LAYER_STEP*LAYER_STEP){child_data[child_idx].store_start=last_start;child_data[child_idx++].store_count=end-last_start;last_start=end}}cell.child_data=child_data;++counts.assignChildStars};Galaxy.prototype.perturb=function(cell,params){var buf_dim=this.buf_dim;var noise_freq=params.noise_freq,noise_weight=params.noise_weight;var data=cell.data,x0=cell.x0,y0=cell.y0,w=cell.w;var mul=w/buf_dim;for(var idx=0,yy=0;yy<buf_dim;++yy){var world_y=y0+yy*mul;for(var xx=0;xx<buf_dim;++xx,++idx){var world_x=x0+xx*mul;var noisev=noise[1].noise2D(world_x*noise_freq,world_y*noise_freq);var v=data[idx]*(1+noise_weight*(noisev*.5-.5));v=max(0,v);data[idx]=v}}++counts.perturb};Galaxy.prototype.getCell=function(layer_idx,cell_idx,just_alloc){if(layer_idx>MAX_LAYER){return{}}var layers=this.layers,buf_dim=this.buf_dim,params=this.params;var layer=layers[layer_idx];if(!layer){layer=layers[layer_idx]=[]}var cell=layer[cell_idx];if(cell&&cell.ready){return cell}var layer_res=pow(LAYER_STEP,layer_idx);var cx=cell_idx%layer_res;var cy=floor(cell_idx/layer_res);var x0=cx/layer_res;var y0=cy/layer_res;var w=1/layer_res;if(!cell){++counts.cell;cell={x0:x0,y0:y0,w:w,h:w,layer_idx:layer_idx,cell_idx:cell_idx,cx:cx,cy:cy,ready:false};layer[cell_idx]=cell}if(just_alloc){return cell}if(layer_idx===0){assert(cell_idx===0);var ret=genGalaxy(params);cell.sum=ret.sum;cell.sumsq=ret.sumsq;cell.data=ret.data;cell.star_count=ret.star_count;cell.star_idx=0;cell.stars_ready=true;cell.pois=ret.pois}else{var px=floor(cx/LAYER_STEP);var py=floor(cy/LAYER_STEP);var pres=pow(LAYER_STEP,layer_idx-1);var parent=this.getCell(layer_idx-1,py*pres+px);if(!parent.ready){return cell}if(engine.frame_index===this.work_frame&&!this.loading){return cell}var qx=cx-px*LAYER_STEP;var qy=cy-py*LAYER_STEP;var qidx=qx+qy*LAYER_STEP;if(!cell.pois){cell.pois=parent.child_data[qidx].pois}if(!cell.data){if(layer_idx>STAR_LAYER){cell.data=null}else{var sample_buf=this.getSampleBuf(layer_idx-1,px,py);if(!sample_buf){return cell}this.work_frame=engine.frame_index;var data=cell.data=expandBicubic16X(sample_buf,buf_dim,qx,qy);var key="layer"+layer_idx;if(params[key]){this.perturb(cell,params[key])}var sum=0;var sumsq=0;for(var ii=0;ii<data.length;++ii){var v=data[ii];sum+=v;sumsq+=v*v}cell.sum=sum;cell.sumsq=sumsq}}if(!cell.stars_ready){if(parent.star_storage){cell.star_storage=parent.star_storage;cell.star_storage_start=parent.child_data[qidx].store_start;cell.star_count=parent.child_data[qidx].store_count;cell.star_idx=parent.star_idx+(cell.star_storage_start-parent.star_storage_start)}else{cell.star_count=parent.child_data[qidx].star_count;cell.star_idx=parent.child_data[qidx].star_idx;this.work_frame=engine.frame_index;if(layer_idx===STAR_LAYER){if(!this.realizeStars(cell)){return cell}}}cell.stars_ready=true}if(layer_idx>=STAR_LAYER){if(!this.renderStars(cell)){return cell}}}this.assignChildStars(cell);cell.ready=true;return cell};{var debug_pix=[[0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,0,1,0,1,0,0,1,0,1,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0,1,1,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,1,0,0,0,0,1,1,1,0,0,1,0,1,0,0,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,0,1,0,0,1,1,1,0,0,1,0,1,0,0,1,1,1,0,0,0,0,0,0]];Galaxy.prototype.getCellTextured=function(layer_idx,cell_idx){var buf_dim=this.buf_dim,tex_data=this.tex_data,tex_total_size=this.tex_total_size;var cell=this.getCell(layer_idx,cell_idx);if(cell.tex){return cell}var data=cell.data,pois=cell.pois,x0=cell.x0,y0=cell.y0,w=cell.w,ready=cell.ready,cx=cell.cx,cy=cell.cy;if(!ready){return cell}var layer_res=pow(LAYER_STEP,layer_idx);if(layer_idx>=STAR_LAYER){data=cell.star_buf;for(var yy=-1;yy<=1;++yy){var ny=cy+yy;if(ny<0||ny>=layer_res){continue}for(var xx=-1;xx<=1;++xx){var nx=cx+xx;if(!nx&&!ny||nx<0||nx>=layer_res){continue}var n=this.getCell(layer_idx,nx+ny*layer_res);if(!n.ready){return cell}}}}++counts.getCellTextured;var max_res=pow(2,this.params.max_zoom);if(layer_res===max_res){for(var ii=0;ii<tex_total_size;++ii){tex_data[ii*4+0]=0;tex_data[ii*4+1]=0;tex_data[ii*4+2]=0;tex_data[ii*4+3]=255}var star_storage=cell.star_storage,star_count=cell.star_count,star_storage_start=cell.star_storage_start,star_idx=cell.star_idx;var store_idx=star_storage_start*2;for(var _ii11=0;_ii11<star_count;++_ii11){var x=star_storage[store_idx++];var y=star_storage[store_idx++];var id=star_idx+_ii11;var type=starVisTypeFromID(id);var v=starValueFromID(id);var hue=hueFromID(id);x=floor((x-x0)/w*buf_dim);y=floor((y-y0)/w*buf_dim);x=max(2,min(buf_dim-2-1,x));y=max(2,min(buf_dim-2-1,y));var idx=(x+y*buf_dim)*4;var offs=POI_TYPE_OFFS[type];for(var jj=0;jj<offs.length;jj+=3){var v2=clamp(floor(v*offs[jj]*255),0,255);var dx=offs[jj+1];var dy=offs[jj+2];var _xx4=x+dx;var _yy4=y+dy;if(_xx4<0||_xx4>=buf_dim||_yy4<0||_yy4>=buf_dim){continue}var d=(dx+dy*buf_dim)*4;tex_data[idx+d]=max(tex_data[idx+d],v2);tex_data[idx+d+1]=max(tex_data[idx+d+1],hue)}}}else{var hue_buf=cell.hue_buf;for(var _ii12=0;_ii12<tex_total_size;++_ii12){var _d=data[_ii12];tex_data[_ii12*4+0]=clamp(floor(_d*255),0,255);tex_data[_ii12*4+1]=hue_buf?hue_buf[_ii12]:0;tex_data[_ii12*4+3]=255}for(var _ii13=0;_ii13<pois.length;++_ii13){var poi=pois[_ii13];var _x2=poi.x,_y2=poi.y,_type=poi.type,_v3=poi.v;_x2=floor((_x2-x0)/w*buf_dim);_y2=floor((_y2-y0)/w*buf_dim);var _idx5=(_x2+_y2*buf_dim)*4;var _offs=POI_TYPE_OFFS[_type];for(var _jj=0;_jj<_offs.length;_jj+=3){var _v4=clamp(floor(_v3*_offs[_jj]*255),0,255);var _dx2=_offs[_jj+1];var _dy2=_offs[_jj+2];var _xx5=_x2+_dx2;var _yy5=_y2+_dy2;if(_xx5<0||_xx5>=buf_dim||_yy5<0||_yy5>=buf_dim){continue}var _d2=(_dx2+_dy2*buf_dim)*4;tex_data[_idx5+_d2+0]=max(tex_data[_idx5+_d2+0],_v4);tex_data[_idx5+_d2+1]=max(tex_data[_idx5+_d2+1],0)}}}if(engine.DEBUG&&false){var dbg=debug_pix[layer_idx];if(dbg){for(var _idx6=0,_yy6=0;_yy6<7;++_yy6){for(var _xx6=0;_xx6<5;++_xx6,++_idx6){var idx2=(_yy6*buf_dim+_xx6)*4;for(var _ii14=0;_ii14<3;++_ii14){tex_data[idx2+_ii14]=dbg[_idx6]?255:0}}}}}if(tex_pool.length){cell.tex=tex_pool.pop();cell.tex.updateData(buf_dim,buf_dim,tex_data)}else{++counts.tex;cell.tex=textures.load({name:"galaxy_"+ ++tex_id_idx,format:textures.format.RGBA8,width:buf_dim,height:buf_dim,data:tex_data,filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE})}if(cell.star_buf){star_buf_pool.push(cell.star_buf);cell.star_buf=null}if(cell.hue_buf){hue_buf_pool.push(cell.hue_buf);cell.hue_buf=null}return cell}}function distSq(x1,y1,x2,y2){var dx=x2-x1;var dy=y2-y1;return dx*dx+dy*dy}{var dy=[0,1,-1];var dx=[0,1,-1];Galaxy.prototype.starsNear=function(x,y,num){var layers=this.layers;var layer_idx=MAX_LAYER-1;var layer=layers[layer_idx];if(!layer){return[]}var layer_res=pow(LAYER_STEP,layer_idx);var cx=floor(x*layer_res);var cy=floor(y*layer_res);var closest=new Array(num*2);for(var ddy=0;ddy<=3;++ddy){var yy=cy+dy[ddy];if(yy<0||yy>=layer_res){continue}for(var ddx=0;ddx<=3;++ddx){var xx=cx+dx[ddx];if(xx<0||xx>=layer_res){continue}var cell_idx=yy*layer_res+xx;var cell=layer[cell_idx];if(!cell||!cell.star_storage){continue}var star_storage=cell.star_storage,star_storage_start=cell.star_storage_start,star_count=cell.star_count,star_idx=cell.star_idx;var store_idx=star_storage_start*2;for(var ii=0;ii<star_count;++ii){var star_x=star_storage[store_idx++];var star_y=star_storage[store_idx++];var star_id=star_idx+ii;var star_dist=distSq(x,y,star_x,star_y);for(var jj=0;jj<closest.length;jj+=2){var other_id=closest[jj+1];if(other_id===undefined){closest[jj]=star_dist;closest[jj+1]=star_id;break}var other_dist=closest[jj];if(star_dist<other_dist){closest[jj]=star_dist;closest[jj+1]=star_id;star_dist=other_dist;star_id=other_id}}}}}var ret=[];for(var _ii15=1;_ii15<closest.length;_ii15+=2){var id=closest[_ii15];if(id!==undefined){ret.push(id)}}return ret}}Galaxy.prototype.getStar=function(star_id){var layers=this.layers,stars=this.stars;if(!stars){this.stars=stars={}}if(stars[star_id]){return stars[star_id]}function search(layer_idx,cx,cy){var layer=layers[layer_idx];var layer_res=pow(LAYER_STEP,layer_idx);var cell_idx=cx+cy*layer_res;var cell=layer[cell_idx];if(!cell||!cell.stars_ready){return null}assert(star_id>=cell.star_idx);if(layer_idx===STAR_LAYER){var star_storage=cell.star_storage,star_storage_start=cell.star_storage_start;if(!star_storage){return null}var idx=star_id-cell.star_idx;assert(idx<cell.star_count);var store_idx=(star_storage_start+idx)*2;var x=star_storage[store_idx++];var y=star_storage[store_idx++];var star={x:x,y:y,id:star_id};stars[star_id]=star;return star}if(!cell.child_data){return null}for(var qidx=0;qidx<cell.child_data.length;++qidx){var cd=cell.child_data[qidx];if(star_id<cd.star_idx+cd.star_count){var qx=qidx%LAYER_STEP;var qy=(qidx-qx)/LAYER_STEP;return search(layer_idx+1,cx*LAYER_STEP+qx,cy*LAYER_STEP+qy)}}assert(false);return null}return search(0,0,0)};Galaxy.prototype.getStarData=function(star){if(!star.solar_system){star.solar_system=solarSystemCreate(this.params.seed,star)}return star};Galaxy.prototype.dispose=function(){var layers=this.layers;for(var ii=0;ii<layers.length;++ii){var layer=layers[ii];for(var key in layer){var cell=layer[key];if(cell.tex){tex_pool.push(cell.tex);cell.tex=null}}}};var debug_buf=JSON.stringify(counts,undefined,2);setInterval(function(){var buf=JSON.stringify(counts,undefined,2);if(debug_buf!==buf){debug_buf=buf;console.log(buf)}},5e3);function createGalaxy(params){return new Galaxy(params)}


},{"../common/util.js":70,"./glov/engine.js":11,"./glov/rand_alea.js":36,"./glov/textures.js":45,"./solar_system.js":60,"./star_types.js":61,"assert":undefined,"simplex-noise":undefined}],4:[function(require,module,exports){
"use strict";require("./polyfill.js");var debug=document.getElementById("debug");window.onerror=function(e,file,line,col,errorobj){var msg=e+"\n  at "+file+"("+line+":"+col+")";if(errorobj&&errorobj.stack){msg=""+errorobj.stack;if(errorobj.message){if(msg.indexOf(errorobj.message)===-1){msg=errorobj.message+"\n"+msg}}var origin=document.location.origin||"";if(origin){if(origin.slice(-1)!=="/"){origin+="/"}msg=msg.split(origin).join("")}msg=msg.replace(/\[\d+\]</g,"").replace(/<?\/<?/g,"/").replace(/\n([^ ])/g,"\n  $1")}var show=true;if(window.glov_error_report){show=window.glov_error_report(msg,file,line,col)}if(show){debug.innerText=msg+"\n\nPlease report this error to the developer, and then reload this page."}};window.debugmsg=function(msg,clear){if(clear){debug.innerText=msg}else{debug.innerText+=msg+"\n"}};


},{"./polyfill.js":35}],5:[function(require,module,exports){
"use strict";exports.is_discrete_gpu=exports.is_ios_safari=exports.is_webkit=exports.is_android=exports.is_windows_phone=exports.is_ios=void 0;var ua=window.navigator.userAgent;var is_ios=!window.MSStream&&ua.match(/iPad|iPhone|iPod/);exports.is_ios=is_ios;var is_windows_phone=ua.match(/windows phone/i);exports.is_windows_phone=is_windows_phone;var is_android=!is_windows_phone&&ua.match(/android/i);exports.is_android=is_android;var is_webkit=ua.match(/WebKit/i);exports.is_webkit=is_webkit;var is_ios_safari=is_ios&&is_webkit&&!ua.match(/CriOS/i);exports.is_ios_safari=is_ios_safari;var is_discrete_gpu=false;exports.is_discrete_gpu=is_discrete_gpu;function init(){var canvas=document.createElement("canvas");canvas.width=4;canvas.height=4;var gltest=canvas.getContext("webgl");var debug_info=gltest.getExtension("WEBGL_debug_renderer_info");if(debug_info){var renderer_unmasked=gltest.getParameter(debug_info.UNMASKED_RENDERER_WEBGL);exports.is_discrete_gpu=is_discrete_gpu=Boolean(renderer_unmasked&&renderer_unmasked.match(/nvidia|radeon/i))}}init();


},{}],6:[function(require,module,exports){
"use strict";exports.virtualToCanvas=virtualToCanvas;exports.canvasToVirtual=canvasToVirtual;exports.set=set;exports.setSafeAreaPadding=setSafeAreaPadding;exports.safeAreaPadding=safeAreaPadding;exports.push=push;exports.pop=pop;exports.domToCanvasRatio=domToCanvasRatio;exports.screenAspect=screenAspect;exports.setAspectFixed=setAspectFixed;exports.setAspectFixed2=setAspectFixed2;exports.zoom=zoom;exports.calcMap=calcMap;exports.setNormalized=setNormalized;exports.x0Real=x0Real;exports.y0Real=y0Real;exports.x1Real=x1Real;exports.y1Real=y1Real;exports.wReal=wReal;exports.hReal=hReal;exports.x0=x0;exports.y0=y0;exports.x1=x1;exports.y1=y1;exports.w=w;exports.h=h;exports.xScale=xScale;exports.yScale=yScale;exports.htmlPos=htmlPos;exports.htmlSize=htmlSize;exports.setInputClipping=setInputClipping;exports.domToVirtual=domToVirtual;exports.domDeltaToVirtual=domDeltaToVirtual;exports.virtualToDom=virtualToDom;exports.virtualToFontSize=virtualToFontSize;exports.virtualToDomPosParam=virtualToDomPosParam;exports.clipTestRect=clipTestRect;exports.tickCamera2D=tickCamera2D;exports.startup=startup;exports.render_offset_y_bottom=exports.render_offset_x=exports.render_viewport_h=exports.render_viewport_w=exports.data=void 0;var engine=require("./engine.js");var max=Math.max,round=Math.round;var safearea_pad=new Float32Array(4);var data=new Float32Array(13);exports.data=data;var screen_width;var screen_height;var render_width;var render_height;var render_viewport_w;exports.render_viewport_w=render_viewport_w;var render_viewport_h;exports.render_viewport_h=render_viewport_h;var render_offset_x;exports.render_offset_x=render_offset_x;var render_offset_y_top;var render_offset_y_bottom;exports.render_offset_y_bottom=render_offset_y_bottom;function reapply(){if(render_width){data[4]=render_width/(data[2]-data[0]);data[5]=render_height/(data[3]-data[1]);data[7]=(data[2]-data[0])/render_viewport_w;data[8]=(data[3]-data[1])/render_viewport_h}else{data[4]=screen_width/(data[2]-data[0]);data[5]=screen_height/(data[3]-data[1])}}function virtualToCanvas(dst,src){dst[0]=(src[0]-data[0])*data[4];dst[1]=(src[1]-data[1])*data[5]}function canvasToVirtual(dst,src){dst[0]=src[0]/data[4]+data[0];dst[1]=src[1]/data[5]+data[1]}function safeScreenWidth(){return max(1,screen_width-safearea_pad[0]-safearea_pad[1])}function safeScreenHeight(){return max(1,screen_height-safearea_pad[2]-safearea_pad[3])}function set(x0,y0,x1,y1,ignore_safe_area){if(ignore_safe_area||render_width){data[9]=data[0]=x0;data[10]=data[1]=y0;data[11]=data[2]=x1;data[12]=data[3]=y1}else{data[9]=x0;data[10]=y0;data[11]=x1;data[12]=y1;var wscale=(x1-x0)/safeScreenWidth();var hscale=(y1-y0)/safeScreenHeight();data[0]=x0-safearea_pad[0]*wscale;data[1]=y0-safearea_pad[2]*hscale;data[2]=x1+safearea_pad[1]*wscale;data[3]=y1+safearea_pad[3]*hscale}reapply()}function setSafeAreaPadding(left,right,top,bottom){safearea_pad[0]=round(left);safearea_pad[1]=round(right);safearea_pad[2]=round(top);safearea_pad[3]=round(bottom)}function safeAreaPadding(){return safearea_pad}var stack=[];function push(){stack.push(data.slice(0))}function pop(){var old=stack.pop();for(var ii=0;ii<old.length;++ii){data[ii]=old[ii]}reapply()}function domToCanvasRatio(){return data[6]}function screenAspect(){return safeScreenWidth()/safeScreenHeight()}function setAspectFixed(w,h){var pa=render_width?1:engine.pixel_aspect;var inv_aspect=h/pa/w;var inv_desired_aspect;if(render_width){inv_desired_aspect=render_height/render_width}else{inv_desired_aspect=1/screenAspect()}if(inv_aspect>inv_desired_aspect){var margin=(h/pa/inv_desired_aspect-w)/2;set(-margin,0,w+margin,h,false)}else{var _margin=(w*pa*inv_desired_aspect-h)/2;set(0,-_margin,w,h+_margin,false)}}function setAspectFixed2(w,h){var pa=render_width?1:engine.pixel_aspect;var inv_aspect=h/pa/w;var inv_desired_aspect;if(render_width){inv_desired_aspect=render_height/render_width}else{inv_desired_aspect=1/screenAspect()}if(inv_aspect>inv_desired_aspect){var margin=h/pa/inv_desired_aspect-w;set(0,0,w+margin,h,false)}else{var _margin2=w*pa*inv_desired_aspect-h;set(0,0,w,h+_margin2,false)}}function zoom(x,y,factor){var inv_factor=1/factor;set(x-(x-data[0])*inv_factor,y-(y-data[1])*inv_factor,x+(data[2]-x)*inv_factor,y+(data[3]-y)*inv_factor,true)}function calcMap(out,src_rect,dest_rect){var cur_w=data[11]-data[9];var cur_h=data[12]-data[10];var vx0=src_rect[0]/cur_w;var vy0=src_rect[1]/cur_h;var vx1=src_rect[2]/cur_w;var vy1=src_rect[3]/cur_h;var vw=vx1-vx0;var vh=vy1-vy0;var dest_vw=dest_rect[2]-dest_rect[0];var dest_vh=dest_rect[3]-dest_rect[1];out[0]=dest_rect[0]-dest_vw/vw*vx0;out[1]=dest_rect[1]-dest_vh/vh*vy0;out[2]=dest_rect[2]+dest_vw/vw*(1-vx1);out[3]=dest_rect[3]+dest_vh/vh*(1-vy1)}function setNormalized(){set(0,0,1,1,true)}function x0Real(){return data[0]}function y0Real(){return data[1]}function x1Real(){return data[2]}function y1Real(){return data[3]}function wReal(){return data[2]-data[0]}function hReal(){return data[3]-data[1]}function x0(){return data[9]}function y0(){return data[10]}function x1(){return data[11]}function y1(){return data[12]}function w(){return data[11]-data[9]}function h(){return data[12]-data[10]}function xScale(){return data[4]}function yScale(){return data[5]}function htmlPos(x,y){if(render_width){return[100*(((x-data[0])/data[7]+render_offset_x)/screen_width),100*(((y-data[1])/data[8]+render_offset_y_top)/screen_height)]}else{return[100*(x-data[0])/(data[2]-data[0]),100*(y-data[1])/(data[3]-data[1])]}}function htmlSize(w,h){if(render_width){return[100*w/data[7]/screen_width,100*h/data[8]/screen_height]}else{return[100*w/(data[2]-data[0]),100*h/(data[3]-data[1])]}}var input_clipping;function setInputClipping(xywh){input_clipping=xywh}function domToVirtual(dst,src){var ret=true;if(input_clipping){if(src[0]<input_clipping[0]||src[0]>input_clipping[0]+input_clipping[2]||src[1]<input_clipping[1]||src[1]>input_clipping[1]+input_clipping[3]){ret=false}}if(render_width){dst[0]=(src[0]*data[6]-render_offset_x)*data[7]+data[0];dst[1]=(src[1]*data[6]-render_offset_y_top)*data[8]+data[1]}else{dst[0]=src[0]*data[6]/data[4]+data[0];dst[1]=src[1]*data[6]/data[5]+data[1]}return ret}function domDeltaToVirtual(dst,src){if(render_width){dst[0]=src[0]*data[6]*data[7];dst[1]=src[1]*data[6]*data[8]}else{dst[0]=src[0]*data[6]/data[4];dst[1]=src[1]*data[6]/data[5]}}var input_clipping_virtual=new Float32Array(4);function updateVirtualInputClipping(){domToVirtual(input_clipping_virtual,input_clipping);if(render_width){input_clipping_virtual[2]=input_clipping[2]*data[6]*data[7];input_clipping_virtual[3]=input_clipping[3]*data[6]*data[8]}else{input_clipping_virtual[2]=input_clipping[2]*data[6]/data[4];input_clipping_virtual[3]=input_clipping[3]*data[6]/data[5]}}function virtualToDom(dst,src){if(render_width){dst[0]=(render_offset_x+(src[0]-data[0])/data[7])/data[6];dst[1]=(render_offset_y_top+(src[1]-data[1])/data[8])/data[6]}else{dst[0]=(src[0]-data[0])*data[4]/data[6];dst[1]=(src[1]-data[1])*data[5]/data[6]}}function virtualToFontSize(height){if(render_width){return height/(data[6]*data[8])*.84}else{return height*data[5]/data[6]*.84}}function virtualToDomPosParam(dst,src){if(render_width){dst.x=(render_offset_x+(src.x-data[0])/data[7])/data[6];dst.w=src.w/data[7]/data[6];dst.y=(render_offset_y_top+(src.y-data[1])/data[8])/data[6];dst.h=src.h/data[8]/data[6]}else{dst.x=(src.x-data[0])*data[4]/data[6];dst.w=src.w*data[4]/data[6];dst.y=(src.y-data[1])*data[5]/data[6];dst.h=src.h*data[5]/data[6]}}function clipTestRect(rect){if(!input_clipping){return true}updateVirtualInputClipping();var icv=input_clipping_virtual;if(rect.x>icv[0]+icv[2]||rect.x+rect.w<icv[0]||rect.y>icv[1]+icv[3]||rect.y+rect.h<icv[1]){return false}if(rect.x<icv[0]){rect.w-=icv[0]-rect.x;rect.x=icv[0]}if(rect.y<icv[1]){rect.h-=icv[1]-rect.y;rect.y=icv[1]}if(rect.x+rect.w>icv[0]+icv[2]){rect.w=icv[0]+icv[2]-rect.x}if(rect.y+rect.h>icv[1]+icv[3]){rect.h=icv[1]+icv[3]-rect.y}return true}function tickCamera2D(){data[6]=engine.dom_to_canvas_ratio;screen_width=engine.width;screen_height=engine.height;var viewport=[0,0,screen_width,screen_height];if(engine.render_width){render_width=engine.render_width;render_height=engine.render_height;var pa=engine.pixel_aspect;var inv_aspect=render_height/pa/render_width;var eff_screen_width=safeScreenWidth();var eff_screen_height=safeScreenHeight();var inv_desired_aspect=eff_screen_height/eff_screen_width;if(inv_aspect>inv_desired_aspect){var margin=(render_height/inv_desired_aspect-render_width*pa)/2*eff_screen_height/render_height;exports.render_offset_x=render_offset_x=safearea_pad[0]+round(margin);render_offset_y_top=safearea_pad[2];exports.render_offset_y_bottom=render_offset_y_bottom=safearea_pad[3];exports.render_viewport_w=render_viewport_w=round(eff_screen_width-margin*2);exports.render_viewport_h=render_viewport_h=eff_screen_height}else{var _margin3=(render_width*inv_desired_aspect-render_height/pa)/2*eff_screen_width/render_width;exports.render_offset_x=render_offset_x=safearea_pad[0];render_offset_y_top=safearea_pad[2]+round(_margin3);exports.render_offset_y_bottom=render_offset_y_bottom=safearea_pad[3]+round(_margin3);exports.render_viewport_w=render_viewport_w=eff_screen_width;exports.render_viewport_h=render_viewport_h=round(eff_screen_height-_margin3*2)}viewport[2]=render_width;viewport[3]=render_height}else{render_width=render_height=0;exports.render_offset_x=render_offset_x=0;render_offset_y_top=0;exports.render_offset_y_bottom=render_offset_y_bottom=0}reapply();engine.setViewport(viewport)}function startup(){set(0,0,engine.width,engine.height);tickCamera2D()}


},{"./engine.js":11}],7:[function(require,module,exports){
"use strict";exports.create=create;var assert=require("assert");var _require=require("../../common/async.js"),asyncParallel=_require.asyncParallel;var camera2d=require("./camera2d.js");var _require2=require("./cmds.js"),cmd_parse=_require2.cmd_parse;var engine=require("./engine.js");var glov_font=require("./font.js");var _require3=require("./friends.js"),isFriend=_require3.isFriend;var input=require("./input.js");var _require4=require("./link.js"),link=_require4.link;var local_storage=require("./local_storage.js");var ceil=Math.ceil,floor=Math.floor,max=Math.max,min=Math.min;var net=require("./net.js");var _require5=require("./words/profanity.js"),profanityFilter=_require5.profanityFilter,profanityStartup=_require5.profanityStartup;var _require6=require("./scroll_area.js"),scrollAreaCreate=_require6.scrollAreaCreate;var settings=require("./settings.js");var ui=require("./ui.js");var _require7=require("../../common/util.js"),clamp=_require7.clamp,matchAll=_require7.matchAll;var _require8=require("./vmath.js"),vec4=_require8.vec4,v3copy=_require8.v3copy;var FADE_START_TIME=[1e4,1e3];var FADE_TIME=[1e3,500];var INDENT=40;var FLAG_EMOTE=1;var FLAG_USERCHAT=2;Z.CHAT=Z.CHAT||500;Z.CHAT_FOCUSED=Z.CHAT_FOCUSED||Z.CHAT;var color_user_rollover=vec4(1,1,1,.5);var MAX_PER_STYLE={join_leave:3};settings.register({chat_auto_unfocus:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],help:"Automatically unfocus chat after sending a message"}});settings.register({profanity_filter:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1],help:"Filter profanity in chat"}});function CmdHistory(){assert(local_storage.storage_prefix!=="demo");this.entries=new Array(50);this.idx=local_storage.getJSON("console_idx");if(typeof this.idx!=="number"||this.idx<0||this.idx>=this.entries.length){this.idx=0}else{for(var ii=0;ii<this.entries.length;++ii){this.entries[ii]=local_storage.getJSON("console_e"+ii)}}this.resetPos()}CmdHistory.prototype.setHist=function(idx,text){this.entries[idx]=text;local_storage.setJSON("console_e"+idx,text)};CmdHistory.prototype.add=function(text){if(!text){return}var idx=this.entries.indexOf(text);if(idx!==-1){var target=(this.idx-1+this.entries.length)%this.entries.length;while(idx!==target){var next=(idx+1)%this.entries.length;this.setHist(idx,this.entries[next]);idx=next}this.setHist(target,text);return}this.setHist(this.idx,text);this.idx=(this.idx+1)%this.entries.length;local_storage.setJSON("console_idx",this.idx);this.resetPos()};CmdHistory.prototype.unadd=function(text){var idx=(this.idx-1+this.entries.length)%this.entries.length;if(this.entries[idx]!==text){return}this.idx=idx;local_storage.setJSON("console_idx",this.idx);this.resetPos()};CmdHistory.prototype.resetPos=function(){this.hist_idx=this.idx;this.edit_line=""};CmdHistory.prototype.prev=function(cur_text){if(this.hist_idx===this.idx){this.edit_line=cur_text}var idx=(this.hist_idx-1+this.entries.length)%this.entries.length;var text=this.entries[idx];if(idx===this.idx||!text){return this.entries[this.hist_idx]||""}this.hist_idx=idx;return text||""};CmdHistory.prototype.next=function(cur_text){if(this.hist_idx===this.idx){return cur_text||""}var idx=(this.hist_idx+1)%this.entries.length;this.hist_idx=idx;if(this.hist_idx===this.idx){var ret=this.edit_line;this.edit_line="";return ret||""}return this.entries[idx]||""};function ChatUI(params){assert.equal(typeof params,"object");assert.equal(typeof params.max_len,"number");this.edit_text_entry=ui.createEditBox({placeholder:"Chat",initial_focus:false,auto_unfocus:true,max_len:params.max_len,text:""});this.channel=null;this.on_join=this.onMsgJoin.bind(this);this.on_leave=this.onMsgLeave.bind(this);this.on_chat=this.onMsgChat.bind(this);this.handle_cmd_parse=this.handleCmdParse.bind(this);this.handle_cmd_parse_error=this.handleCmdParseError.bind(this);cmd_parse.setDefaultHandler(this.handle_cmd_parse_error);this.clearChat();this.max_lines=params.max_lines||8;this.max_messages=params.max_messages||1e3;this.max_len=params.max_len;this.font_height=params.font_height||ui.font_height;this.hide_disconnected_message=params.hide_disconnected_message||false;this.scroll_area=scrollAreaCreate({background_color:null,auto_scroll:true});this.w=params.w||engine.game_width/2;this.h=params.h||engine.game_height/2;this.volume_join_leave=params.volume_join_leave||1;this.volume_in=params.volume_in||1;this.volume_out=params.volume_out||1;this.history=new CmdHistory;this.get_roles=null;this.url_match=params.url_match;this.url_info=params.url_info;this.user_context_cb=params.user_context_cb;this.setActiveSize(this.font_height,this.w);this.styles={def:glov_font.style(null,{color:4008636159,outline_width:1,outline_color:255}),system:glov_font.style(null,{color:2863311615,outline_width:1,outline_color:255}),error:glov_font.style(null,{color:3707764991,outline_width:1,outline_color:255}),link:glov_font.style(null,{color:1346437119,outline_width:1,outline_color:255}),link_hover:glov_font.style(null,{color:65535,outline_width:1,outline_color:255})};this.styles.join_leave=this.styles.system;net.subs.on("chat_broadcast",this.onChatBroadcast.bind(this))}ChatUI.prototype.setActiveSize=function(font_height,w){var wrap_w=w-this.scroll_area.barWidth();if(this.active_font_height!==font_height||this.wrap_w!==wrap_w){this.active_font_height=font_height;this.wrap_w=wrap_w;this.total_lines=0;for(var ii=0;ii<this.msgs.length;++ii){var elem=this.msgs[ii];elem.numlines=ui.font.numLines(this.styles[elem.style]||this.styles.def,this.wrap_w,INDENT,this.active_font_height,elem.msg_text);this.total_lines+=elem.numlines}}};ChatUI.prototype.clearChat=function(){this.msgs=[];this.total_lines=0};function notHidden(msg){return!msg.hidden}ChatUI.prototype.addMsgInternal=function(elem){elem.timestamp=elem.timestamp||Date.now();if(elem.flags&FLAG_USERCHAT){if(elem.flags&FLAG_EMOTE){elem.msg_text=elem.display_name+" "+elem.msg}else{elem.msg_text="["+elem.display_name+"] "+elem.msg}}else{elem.msg_text=elem.msg}elem.numlines=ui.font.numLines(this.styles[elem.style]||this.styles.def,this.wrap_w,INDENT,this.active_font_height,elem.msg_text);this.total_lines+=elem.numlines;this.msgs.push(elem);var max_msgs=MAX_PER_STYLE[elem.style];if(max_msgs){for(var ii=this.msgs.length-2;ii>=0;--ii){var elem2=this.msgs[ii];if(elem2.style===elem.style&&!elem2.hidden){if(elem.id&&elem2.id===elem.id){elem2.hidden=true;this.total_lines-=elem2.numlines;elem2.numlines=0}else{--max_msgs;if(max_msgs<=0){elem2.hidden=true;this.total_lines-=elem2.numlines;elem2.numlines=0;break}}}}}if(this.msgs.length>this.max_messages*1.25){this.msgs=this.msgs.filter(notHidden);if(this.msgs.length>this.max_messages*1.25){this.msgs.splice(0,this.msgs.length-this.max_messages);this.total_lines=0;for(var _ii=0;_ii<this.msgs.length;++_ii){this.total_lines+=this.msgs[_ii].numlines}}}};ChatUI.prototype.addChat=function(msg,style){console.log(msg);this.addMsgInternal({msg:msg,style:style})};ChatUI.prototype.addChatFiltered=function(data){console.log("Chat from "+data.id+": "+data.msg);if(settings.profanity_filter){data.msg=profanityFilter(data.msg)}this.addMsgInternal(data)};ChatUI.prototype.onMsgJoin=function(data){if(data.client_id!==net.client.id){if(this.volume_join_leave){ui.playUISound("user_join",this.volume_join_leave)}this.addChatFiltered({id:data.user_id||data.client_id,display_name:data.display_name||data.client_id,flags:FLAG_EMOTE|FLAG_USERCHAT,msg:"joined the channel",style:"join_leave"})}};ChatUI.prototype.onMsgLeave=function(data){if(this.volume_join_leave){ui.playUISound("user_leave",this.volume_join_leave)}this.addChatFiltered({id:data.user_id||data.client_id,display_name:data.display_name||data.client_id,flags:FLAG_EMOTE|FLAG_USERCHAT,msg:"left the channel",style:"join_leave"})};ChatUI.prototype.onMsgChat=function(data){var msg=data.msg,id=data.id,client_id=data.client_id,display_name=data.display_name,flags=data.flags,ts=data.ts,quiet=data.quiet;if(!quiet&&client_id!==net.client.id){if(this.volume_in){ui.playUISound("msg_in",this.volume_in)}}display_name=display_name||id;flags=(flags||0)|FLAG_USERCHAT;this.addChatFiltered({id:id,display_name:display_name,msg:msg,flags:flags,timestamp:ts,quiet:quiet})};ChatUI.prototype.onChatBroadcast=function(data){var msg=data.msg,src=data.src;ui.playUISound("msg_err");this.addChatFiltered({msg:"["+src+"] "+msg,style:"error"})};ChatUI.prototype.runLate=function(){this.did_run_late=true;if(input.keyDownEdge(input.KEYS.RETURN)){this.edit_text_entry.focus()}if(input.keyDownEdge(input.KEYS.SLASH)||input.keyDownEdge(input.KEYS.NUMPAD_DIVIDE)){this.edit_text_entry.focus();this.edit_text_entry.setText("/")}};function errStr(err){if(typeof err==="object"){return JSON.stringify(err)}return err}ChatUI.prototype.handleCmdParseError=function(err,resp){if(err){this.addChat("[error] "+errStr(err),"error")}};ChatUI.prototype.handleCmdParse=function(err,resp){if(err){this.addChat("[error] "+errStr(err),"error")}else if(resp){this.addChat("[system] "+(typeof resp==="string"?resp:JSON.stringify(resp)),"system")}};ChatUI.prototype.setGetRoles=function(fn){this.get_roles=fn};var access_dummy={access:null};ChatUI.prototype.getAccessObj=function(){if(!this.get_roles){return{}}access_dummy.access=this.get_roles();return access_dummy};ChatUI.prototype.cmdParse=function(str,on_error){var _this=this;var handleResult=on_error?function(err,resp){_this.handle_cmd_parse(err,resp);if(on_error&&err){on_error(err)}}:this.handle_cmd_parse;cmd_parse.handle(this.getAccessObj(),str,function(err,resp){if(err&&cmd_parse.was_not_found){net.subs.sendCmdParse(str,handleResult)}else{handleResult(err,resp)}})};ChatUI.prototype.cmdParseInternal=function(str){cmd_parse.handle(this.getAccessObj(),str,this.handle_cmd_parse_error)};function pad2(str){return("0"+str).slice(-2)}function conciseDate(dt){return pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate())+" "+pad2(dt.getHours())+":"+pad2(dt.getMinutes())+":"+pad2(dt.getSeconds())}var help_font_style=glov_font.styleColored(null,255);var help_font_style_cmd=glov_font.style(help_font_style,{outline_width:.5,outline_color:255});var help_rollover_color=vec4(0,0,0,.25);var help_rollover_color2=vec4(0,0,0,.125);var TOOLTIP_MIN_PAGE_SIZE=20;var tooltip_page=0;var tooltip_last="";var tooltip_panel_color=vec4();function drawHelpTooltip(param){assert(Array.isArray(param.tooltip));var tooltip=param.tooltip;var num_pages=1;var h=param.font_height;var eff_tooltip_pad=ui.tooltip_pad*.5;var num_per_page=min(TOOLTIP_MIN_PAGE_SIZE,max(1,floor((param.y-camera2d.y0()-eff_tooltip_pad)/h)-1));if(tooltip.length>20){var text=tooltip.join("\n");if(text!==tooltip_last){tooltip_page=0;tooltip_last=text}num_pages=ceil(tooltip.length/num_per_page);tooltip=tooltip.slice(tooltip_page*num_per_page,(tooltip_page+1)*num_per_page)}else{tooltip_page=0;tooltip_last=""}var w=param.tooltip_width;var x=param.x;var z=param.z||Z.TOOLTIP+5;var text_x=x+eff_tooltip_pad;var text_w=w-eff_tooltip_pad*2;var tooltip_y1=param.y;var alpha=1;var vis_h=eff_tooltip_pad*2+h*tooltip.length;if(!param.do_selection&&num_pages===1&&input.mouseOver({x:x,y:tooltip_y1-vis_h,w:w,h:vis_h})){alpha=.15}var style=help_font_style;if(alpha!==1){style=glov_font.styleAlpha(style,alpha)}var y=tooltip_y1-eff_tooltip_pad;var ret=null;if(num_pages>1){y-=h;ui.font.drawSizedAligned(help_font_style,text_x,y,z+1,h,glov_font.ALIGN.HCENTER,text_w,0,"Page "+(tooltip_page+1)+" / "+num_pages);var pos={x:x,y:y,w:w,h:h};if(input.mouseUpEdge(pos)){tooltip_page=(tooltip_page+1)%num_pages}else if(input.mouseOver(pos)){ui.drawRect(x,y,x+w,y+h,z+.5,help_rollover_color)}}for(var ii=tooltip.length-1;ii>=0;--ii){var line=tooltip[ii];y-=h;var idx=line.indexOf(" ");if(line[0]==="/"&&idx!==-1&&param.do_selection){var cmd=line.slice(0,idx);var help=line.slice(idx);var cmd_w=ui.font.drawSized(help_font_style_cmd,text_x,y,z+1,h,cmd);ui.font.drawSizedAligned(help_font_style,text_x+cmd_w,y,z+1,h,glov_font.ALIGN.HFIT,text_w-cmd_w,0,help);var _pos={x:x,y:y,w:w,h:h};if(input.mouseUpEdge(_pos)){ret=cmd.slice(1)}else if(input.mouseOver(_pos)){ui.drawRect(x,y,text_x+cmd_w+4,y+h,z+.5,help_rollover_color);ui.drawRect(text_x+cmd_w+4,y,x+w,y+h,z+.5,help_rollover_color2)}}else{ui.font.drawSizedAligned(style,text_x,y,z+1,h,glov_font.ALIGN.HFIT,text_w,0,line)}}y-=eff_tooltip_pad;var pixel_scale=ui.tooltip_panel_pixel_scale*.5;v3copy(tooltip_panel_color,ui.color_panel);tooltip_panel_color[3]=alpha;ui.panel({x:x,y:y,z:z,w:w,h:tooltip_y1-y,pixel_scale:pixel_scale,color:tooltip_panel_color});return ret}ChatUI.prototype.isFocused=function(){return this.edit_text_entry&&this.edit_text_entry.isFocused()||this.scroll_area&&this.scroll_area.isFocused()};ChatUI.prototype.sendChat=function(flags,text){var _this2=this;if(!net.client.connected){this.addChat("[error] Cannot chat: Disconnected","error")}else if(!this.channel||!net.subs.loggedIn()){this.addChat("[error] Cannot chat: Must be logged in","error")}else if(text.length>this.max_len){this.addChat("[error] Chat message too long","error")}else{var pak=this.channel.pak("chat");pak.writeInt(flags);pak.writeString(text);pak.send(function(err){if(err){_this2.addChat("[error] "+errStr(err),"error")}})}};var SPACE_ABOVE_ENTRY=8;ChatUI.prototype.run=function(opts){var _this3=this;opts=opts||{};if(net.client.disconnected&&!this.hide_disconnected_message){ui.font.drawSizedAligned(glov_font.style(null,{outline_width:2,outline_color:255,color:3709870335}),camera2d.x0(),camera2d.y0(),Z.DEBUG,ui.font_height,glov_font.ALIGN.HVCENTER,camera2d.w(),camera2d.h()*.2,"Connection lost, attempting to reconnect ("+(net.client.timeSinceDisconnect()/1e3).toFixed(0)+")...")}if(!this.did_run_late){this.runLate()}this.did_run_late=false;var x=camera2d.x0()+10;var y0=camera2d.y1();var y=y0;var w=this.w;var was_focused=this.isFocused();var z=was_focused?Z.CHAT_FOCUSED:Z.CHAT;var is_focused=false;var font_height=this.font_height;var anything_visible=false;var hide_light=(opts.hide||engine.defines.NOUI||!net.subs.loggedIn())&&!was_focused?1:0;var hide_text_input=ui.modal_dialog||ui.menu_up||hide_light;if(!hide_text_input&&was_focused&&input.touch_mode){w=camera2d.x1()-x-24;var font_scale=4;var aspect=camera2d.screenAspect();if(aspect>2){font_scale=4+4*min((aspect-2)/8,1)}font_height*=font_scale}this.setActiveSize(font_height,w);if(!hide_text_input){anything_visible=true;y-=16+font_height;if(!was_focused&&opts.pointerlock&&input.pointerLocked()){ui.font.drawSizedAligned(this.styles.def,x,y,z+1,font_height,glov_font.ALIGN.HFIT,w,0,"<Press Enter to chat>")}else{if(was_focused){var pressed_tab=input.keyDownEdge(input.KEYS.TAB);if(pressed_tab){this.edit_text_entry.focus()}var cur_text=this.edit_text_entry.getText();if(cur_text){if(cur_text[0]==="/"){var autocomplete=cmd_parse.autoComplete(cur_text.slice(1),this.getAccessObj().access);if(autocomplete&&autocomplete.length){var first=autocomplete[0];var auto_text=[];for(var ii=0;ii<autocomplete.length;++ii){var elem=autocomplete[ii];auto_text.push("/"+elem.cmd+" - "+elem.help)}var do_selection=false;if(autocomplete.length===1&&first.cname&&cmd_parse.canonical(cur_text.slice(1)).slice(0,first.cname.length)===first.cname){if(first.usage){auto_text=first.usage.split("\n")}else{auto_text=[first.help]}}else{do_selection=true}var tooltip_y=y;var last_msg=this.msgs[this.msgs.length-1];if(last_msg){var msg=last_msg.msg;if(msg&&!(msg.flags&FLAG_USERCHAT)&&msg.slice(0,7)==="[error]"){var numlines=last_msg.numlines;tooltip_y-=font_height*numlines+SPACE_ABOVE_ENTRY}}var selected=drawHelpTooltip({x:x,y:tooltip_y,tooltip_width:max(w,engine.game_width*.8),tooltip:auto_text,do_selection:do_selection,font_height:min(font_height,camera2d.w()/30)});if(do_selection){if(pressed_tab||selected){this.edit_text_entry.setText("/"+(selected||first.cmd)+" ")}}}}}else{this.history.resetPos()}if(input.keyDownEdge(input.KEYS.UP)){this.edit_text_entry.setText(this.history.prev(cur_text))}if(input.keyDownEdge(input.KEYS.DOWN)){this.edit_text_entry.setText(this.history.next(cur_text))}this.scroll_area.keyboardScroll()}var input_height=font_height;var input_width=w;if(input.touch_mode&&!was_focused){y-=font_height*2;input_height=font_height*3;input_width=font_height*6}var res=this.edit_text_entry.run({x:x,y:y,w:input_width,font_height:input_height,pointer_lock:opts.pointerlock});is_focused=this.isFocused();if(res===this.edit_text_entry.SUBMIT){var text=this.edit_text_entry.getText().trim();if(text){this.edit_text_entry.setText("");if(text[0]==="/"){if(text[1]==="/"){text=text.slice(1)}this.history.add(text);this.cmdParse(text.slice(1),function(){if(_this3.volume_out){ui.playUISound("msg_out_err",_this3.volume_out)}if(!_this3.edit_text_entry.getText()){_this3.history.unadd(text);_this3.edit_text_entry.setText(text)}if(!is_focused){_this3.edit_text_entry.focus()}})}else{this.sendChat(0,text)}if(this.volume_out){ui.playUISound("msg_out",this.volume_out)}if(settings.chat_auto_unfocus){is_focused=false;ui.focusCanvas()}}else{is_focused=false;ui.focusCanvas()}}}}y-=SPACE_ABOVE_ENTRY;var url_match=this.url_match,url_info=this.url_info,styles=this.styles,wrap_w=this.wrap_w,user_context_cb=this.user_context_cb;var self=this;var do_scroll_area=is_focused;var bracket_width=0;var name_width={};function drawChatLine(msg,alpha){if(msg.hidden){return}var line=msg.msg_text;var numlines=msg.numlines;var is_url=do_scroll_area&&url_match&&matchAll(line,url_match);is_url=is_url&&is_url.length===1&&is_url[0];var url_label=is_url;if(is_url&&url_info){var m=is_url.match(url_info);if(m){url_label=m[1]}}var h=font_height*numlines;var do_mouseover=do_scroll_area&&!input.mousePosIsTouch()&&(!msg.style||msg.style==="def"||is_url);var text_w;var mouseover=false;if(do_mouseover){text_w=ui.font.getStringWidth(styles.def,font_height,line);mouseover=input.mouseOver({x:x,y:y,w:min(text_w,wrap_w),h:h,peek:true})}var user_mouseover=false;var user_indent=0;var did_user_context=false;if(msg.flags&FLAG_USERCHAT&&user_context_cb&&msg.id&&do_scroll_area){var nw=name_width[msg.display_name];if(!nw){nw=name_width[msg.display_name]=ui.font.getStringWidth(styles.def,font_height,msg.display_name)}if(!(msg.flags&FLAG_EMOTE)){if(!bracket_width){bracket_width=ui.font.getStringWidth(styles.def,font_height,"[]")}nw+=bracket_width}user_indent=nw;var pos_param={x:x,y:y,w:min(nw,wrap_w),h:font_height,button:0,peek:true,z:z+.5,color:color_user_rollover};if(input.click(pos_param)){did_user_context=true;user_context_cb({user_id:msg.id})}else{user_mouseover=input.mouseOver(pos_param);if(user_mouseover){ui.drawRect2(pos_param)}}}var click;if(is_url){click=link({x:x+user_indent,y:y,w:wrap_w-user_indent,h:h,url:is_url,internal:true})}var style=styles[msg.style||(is_url?mouseover&&!user_mouseover?"link_hover":"link":"def")];ui.font.drawSizedWrapped(glov_font.styleAlpha(style,alpha),x,y,z+1,wrap_w,INDENT,font_height,line);if(mouseover&&(!do_scroll_area||y>self.scroll_area.scroll_pos-font_height)&&(!msg.style||msg.style==="def"||is_url)){ui.drawTooltip({x:x,y:y,z:Z.TOOLTIP,tooltip_above:true,tooltip_width:450,tooltip_pad:ui.tooltip_pad*.5,tooltip:is_url&&!user_mouseover?"Click to open "+url_label:"Received"+(msg.id?' from "'+msg.id+'"':"")+" at "+conciseDate(new Date(msg.timestamp))+"\n"+"Right-click to copy message"+(""+(user_mouseover?"\nClick to view user info":"")),pixel_scale:ui.tooltip_panel_pixel_scale*.5})}click=click||input.click({x:x,y:y,w:wrap_w,h:h});if(did_user_context){click=null}if(click){if(click.button===2){ui.provideUserString("Chat Text",is_url?"URL":"Text",is_url||line)}else if(is_url){self.cmdParseInternal("url "+url_label)}}anything_visible=true}var border=8;var now=Date.now();if(do_scroll_area){var scroll_internal_h=this.total_lines*font_height;var scroll_external_h=min(this.h,scroll_internal_h);this.scroll_area.begin({x:x,y:y-scroll_external_h,z:z,w:w+8,h:scroll_external_h,focusable_elem:this.edit_text_entry,auto_hide:this.total_lines<=2});var x_save=x;var y_save=y;x=0;y=0;var y_min=this.scroll_area.scroll_pos;var y_max=y_min+scroll_external_h;for(var _ii2=0;_ii2<this.msgs.length;++_ii2){var _msg=this.msgs[_ii2];var h=font_height*_msg.numlines;if(y<=y_max&&y+h>=y_min){drawChatLine(_msg,1)}y+=h}this.scroll_area.end(scroll_internal_h);x=x_save;y=y_save-scroll_external_h;input.mouseDownEdge({x:camera2d.x0(),y:y-border,w:w+border+8,h:y0-y+border});if(input.mouseUpEdge({x:camera2d.x0(),y:y-border,w:w+border+8,h:y0-y+border,in_event_cb:opts.pointerlock?input.pointerLockEnter:null})){ui.focusCanvas();is_focused=false}input.mouseOver({x:camera2d.x0(),y:y-border,w:w+border+8,h:y0-y+border});if(input.mouseDownEdge({peek:true})){ui.focusCanvas();is_focused=false}}else{var max_lines=this.max_lines;for(var _ii3=0;_ii3<this.msgs.length;++_ii3){var _msg2=this.msgs[this.msgs.length-_ii3-1];var age=now-_msg2.timestamp;var alpha=1-clamp((age-FADE_START_TIME[hide_light])/FADE_TIME[hide_light],0,1);if(!alpha||_msg2.quiet){break}var _numlines=_msg2.numlines;if(_numlines>max_lines&&_ii3){break}max_lines-=_numlines;var _h=font_height*_numlines;y-=_h;drawChatLine(_msg2,alpha)}}if(opts.pointerlock&&is_focused&&input.pointerLocked()){input.pointerLockExit()}if(!anything_visible&&(ui.modal_dialog||ui.menu_up||hide_light)){return}ui.drawRect(camera2d.x0(),y-border,x+w+border+8,y0,z,[.3,.3,.3,.75])};ChatUI.prototype.setChannel=function(channel){var _this4=this;if(channel===this.channel){return}if(this.channel){if(!channel){this.addChat("Left channel "+this.channel.channel_id)}this.channel.removeMsgHandler("chat",this.on_chat);this.channel.removeMsgHandler("join",this.on_join);this.channel.removeMsgHandler("leave",this.on_leave)}this.channel=channel;if(!this.channel){return}this.clearChat();channel.onMsg("chat",this.on_chat);channel.onMsg("join",this.on_join);channel.onMsg("leave",this.on_leave);var chat_history;var here;var here_map={};var friends;asyncParallel([function(next){channel.send("chat_get",null,function(err,data){if(!err&&data&&data.msgs&&data.msgs.length){chat_history=data}next()})},function(next){channel.onceSubscribe(function(data){var clients=data&&data.public&&data.public.clients;if(clients){here=[];friends=[];for(var client_id in clients){var client=clients[client_id];var user_id=client.ids&&client.ids.user_id;var already_in_list=false;if(user_id&&client.ids.display_name){if(here_map[user_id]){already_in_list=true}else{here_map[user_id]=client.ids.display_name}}if(client_id===net.client.id||already_in_list){continue}if(client.ids){if(user_id&&isFriend(user_id)){friends.push(client.ids.display_name||user_id||client_id)}else{here.push(client.ids.display_name||user_id||client_id)}}}}next()})}],function(){if(!_this4.channel){return}if(chat_history){var messages_pre=_this4.msgs.slice(0);if(messages_pre.length){_this4.msgs=[]}for(var ii=0;ii<chat_history.msgs.length;++ii){var idx=(chat_history.idx+ii)%chat_history.msgs.length;var elem=chat_history.msgs[idx];if(elem&&elem.msg){elem.quiet=true;if(here_map[elem.id]){elem.display_name=here_map[elem.id]}_this4.onMsgChat(elem)}}if(messages_pre.length){_this4.msgs=_this4.msgs.concat(messages_pre)}}_this4.addChat("Joined channel "+_this4.channel.channel_id,"join_leave");if(here&&here.length||friends&&friends.length){var msg=[];if(here.length){msg.push("Other users already here: "+here.join(", "))}if(friends.length){msg.push("Friends already here: "+friends.join(", "))}_this4.addChatFiltered({msg:msg.join("\n"),style:"join_leave"})}})};function create(params){profanityStartup();var chat_ui=new ChatUI(params);function emote(str,resp_func){if(!str){return void resp_func(null,"Usage: /me does something.")}if(params.emote_cb){params.emote_cb(str)}chat_ui.sendChat(FLAG_EMOTE,str)}cmd_parse.registerValue("volume_chat_joinleave",{type:cmd_parse.TYPE_FLOAT,label:"Join/Leave chat message volume",range:[0,1],get:function get(){return chat_ui.volume_join_leave},set:function set(v){return chat_ui.volume_join_leave=v},store:true});cmd_parse.registerValue("volume_chat_in",{type:cmd_parse.TYPE_FLOAT,label:"Incoming chat message volume",range:[0,1],get:function get(){return chat_ui.volume_in},set:function set(v){return chat_ui.volume_in=v},store:true});cmd_parse.registerValue("volume_chat_out",{type:cmd_parse.TYPE_FLOAT,label:"Outgoing chat message volume",range:[0,1],get:function get(){return chat_ui.volume_out},set:function set(v){return chat_ui.volume_out=v},store:true});cmd_parse.register({cmd:"me",help:"Emote",usage:"Emote\n  Example: /me jumps up and down!",func:emote});cmd_parse.register({access_show:["hidden"],cmd:"em",func:emote});cmd_parse.register({cmd:"echo",help:"Echo text locally",func:function func(str,resp_func){chat_ui.addChatFiltered({msg:str});resp_func()}});return chat_ui}


},{"../../common/async.js":63,"../../common/util.js":70,"./camera2d.js":6,"./cmds.js":8,"./engine.js":11,"./font.js":15,"./friends.js":17,"./input.js":25,"./link.js":26,"./local_storage.js":27,"./net.js":30,"./scroll_area.js":38,"./settings.js":39,"./ui.js":47,"./vmath.js":49,"./words/profanity.js":52,"assert":undefined}],8:[function(require,module,exports){
"use strict";exports.safearea=exports.cmd_parse=void 0;var cmd_parse_mod=require("../../common/cmd_parse.js");var local_storage=require("./local_storage.js");var cmd_parse=cmd_parse_mod.create({storage:local_storage});exports.cmd_parse=cmd_parse;var engine=require("./engine.js");var net=require("./net.js");var textures=require("./textures.js");window.cmd=function(str){cmd_parse.handle(null,str,cmd_parse_mod.defaultHandler)};function byteFormat(bytes){if(bytes>85e4){return(bytes/(1024*1024)).toFixed(2)+"MB"}if(bytes>850){return(bytes/1024).toFixed(2)+"KB"}return bytes+"B"}cmd_parse.register({cmd:"texmem",help:"Displays texture memory usage",func:function func(str,resp_func){var keys=Object.keys(textures.textures);keys=keys.filter(function(a){return textures.textures[a].gpu_mem>1024});keys.sort(function(a,b){return textures.textures[a].gpu_mem-textures.textures[b].gpu_mem});resp_func(null,keys.map(function(a){return byteFormat(textures.textures[a].gpu_mem)+" "+a}).join("\n"))}});cmd_parse.register({cmd:"gpumem",help:"Displays GPU memory usage summary",func:function func(str,resp_func){var gpu_mem=engine.perf_state.gpu_mem;resp_func(null,byteFormat(gpu_mem.geom)+" Geo\n"+byteFormat(gpu_mem.tex)+" Tex\n"+byteFormat(gpu_mem.geom+gpu_mem.tex)+" Total")}});cmd_parse.register({cmd:"d",help:"Toggles a debug define",func:function func(str,resp_func){str=str.toUpperCase();engine.defines[str]=!engine.defines[str];resp_func(null,"D="+str+" now "+(engine.defines[str]?"SET":"unset"));engine.definesChanged()}});cmd_parse.register({cmd:"renderer",help:"Displays current renderer",func:function func(str,resp_func){resp_func(null,"Renderer=WebGL"+(engine.webgl2?2:1))}});cmd_parse.register({cmd:"csr",access_run:["sysadmin"],help:"(Admin) Run a command as another user",usage:"/csr UserID command\n"+"Example: /csr jimbly gems -100",func:function func(str,resp_func){var idx=str.indexOf(" ");if(idx===-1){return void resp_func("Invalid number of arguments")}var user_id=str.slice(0,idx);var cmd=str.slice(idx+1);var pak=net.subs.getChannelImmediate("user."+user_id).pak("csr_admin_to_user");pak.writeString(cmd);pak.send(resp_func)}});function cmdDesc(cmd_data){return"/"+cmd_data.cmd+" - "+cmd_data.help}cmd_parse.register({cmd:"help",help:"Searches commands",func:function func(str,resp_func){var list=cmd_parse.autoComplete("",this&&this.access);if(str){var str_cname=cmd_parse.canonical(str);var str_lc=str.toLowerCase();list=list.filter(function(cmd_data){return cmd_data.cname.indexOf(str_cname)!==-1||cmd_data.help.toLowerCase().indexOf(str_lc)!==-1})}if(!list.length){return void resp_func(null,'No commands found matching "'+str+'"')}resp_func(null,list.map(cmdDesc).join("\n"))}});var safearea=[-1,-1,-1,-1];exports.safearea=safearea;cmd_parse.registerValue("safe_area",{label:"Safe Area",type:cmd_parse.TYPE_STRING,usage:"Safe Area value: Use -1 for auto based on browser environment,\n"+"or 0-25 for percentage of screen size\n"+"  Usage: /safe_area [value]\n"+"  Usage: /safe_area horizontal,vertical\n"+"  Usage: /safe_area left,right,top,bottom",default_value:"-1",get:function get(){return safearea[0]===-1?"-1 (auto)":safearea.join(",")},set:function set(v){v=String(v);var keys=v.split(",");if(v&&keys.length===1){safearea[0]=safearea[1]=safearea[2]=safearea[3]=Number(v)}else if(keys.length===2){safearea[0]=safearea[1]=Number(keys[0]);safearea[2]=safearea[3]=Number(keys[1])}else if(keys.length===4){for(var ii=0;ii<4;++ii){safearea[ii]=Number(keys[ii])}}else{}},store:true});cmd_parse.register({cmd:"webgl2_auto",help:"Resets WebGL2 auto-detection",func:function func(str,resp_func){var disable_data=local_storage.getJSON("webgl2_disable");if(!disable_data){return resp_func(null,"WebGL2 is already being auto-detected")}local_storage.setJSON("webgl2_disable",undefined);return resp_func(null,"WebGL2 was disabled, will attempt to use it again on the next load")}});cmd_parse.registerValue("postprocessing",{label:"Postprocessing",type:cmd_parse.TYPE_INT,help:"Enables/disables postprocessing",get:function get(){return engine.postprocessing?1:0},set:function set(v){return engine.postprocessingAllow(v)}});


},{"../../common/cmd_parse.js":65,"./engine.js":11,"./local_storage.js":27,"./net.js":30,"./textures.js":45}],9:[function(require,module,exports){
"use strict";exports.create=create;var camera2d=require("./camera2d.js");var engine=require("./engine.js");var glov_input=require("./input.js");var glov_ui=require("./ui.js");var focuslog=glov_ui.focuslog;var GlovUIEditBox=function(){function GlovUIEditBox(params){this.x=0;this.y=0;this.z=Z.UI;this.w=glov_ui.button_width;this.type="text";this.allow_modal=false;this.font_height=glov_ui.font_height;this.text="";this.placeholder="";this.max_len=0;this.zindex=null;this.initial_focus=false;this.onetime_focus=false;this.auto_unfocus=false;this.initial_select=false;this.spellcheck=true;this.esc_clears=true;this.multiline=0;this.applyParams(params);this.is_focused=false;this.elem=null;this.input=null;this.submitted=false;this.pointer_lock=false;this.last_frame=0}var _proto=GlovUIEditBox.prototype;_proto.applyParams=function applyParams(params){if(!params){return}for(var f in params){this[f]=params[f]}};_proto.getText=function getText(){return this.text};_proto.setText=function setText(new_text){if(this.input){this.input.value=new_text}this.text=new_text};_proto.focus=function focus(){if(this.input){this.input.focus()}else{this.onetime_focus=true}glov_ui.focusSteal(this);this.is_focused=true;if(this.pointer_lock&&glov_input.pointerLocked()){glov_input.pointerLockExit()}};_proto.unfocus=function unfocus(){glov_ui.focusNext(this)};_proto.isFocused=function isFocused(){return this.is_focused};_proto.updateFocus=function updateFocus(){var was_glov_focused=this.is_focused;var glov_focused=glov_ui.focusCheck(this);var dom_focused=this.input&&document.activeElement===this.input;if(was_glov_focused!==glov_focused){if(glov_focused&&!dom_focused&&this.input){focuslog("GLOV focused, DOM not, focusing",this);this.input.focus()}if(!glov_focused&&dom_focused){focuslog("DOM focused, GLOV not, and changed, blurring",this);this.input.blur()}}else if(dom_focused&&!glov_focused){focuslog("DOM focused, GLOV not, stealing",this);glov_ui.focusSteal(this);glov_focused=true}else if(!dom_focused&&glov_focused){}var focused=glov_focused;if(focused){var key_opt=this.pointer_lock&&!this.text?{in_event_cb:glov_input.pointerLockEnter}:null;if(glov_input.keyUpEdge(glov_input.KEYS.ESC,key_opt)){if(this.text&&this.esc_clears){this.setText("")}else{glov_ui.focusCanvas();if(this.input){this.input.blur()}focused=false;this.canceled=true}}}this.is_focused=focused;return focused};_proto.run=function run(params){var _this=this;this.applyParams(params);if(this.last_frame!==engine.frame_index-1){this.submitted=false}this.last_frame=engine.frame_index;this.canceled=false;var focused=this.updateFocus();glov_ui.this_frame_edit_boxes.push(this);var elem=glov_ui.getElem(this.allow_modal,this.elem);if(elem!==this.elem){if(elem){elem.textContent="";var form=document.createElement("form");form.setAttribute("autocomplete","off");var input=document.createElement(this.multiline?"textarea":"input");input.setAttribute("autocomplete","auto_off_"+Math.random());input.setAttribute("type",this.type);input.setAttribute("placeholder",this.placeholder);if(this.max_len){input.setAttribute("maxLength",this.max_len)}if(this.multiline){input.setAttribute("rows",this.multiline)}input.setAttribute("tabindex",2);form.addEventListener("submit",function(ev){ev.preventDefault();_this.submitted=true;_this.text=_this.input.value;if(_this.pointer_lock&&!_this.text){glov_input.pointerLockEnter("edit_box_submit")}},true);form.appendChild(input);var span=document.createElement("span");span.setAttribute("tabindex",3);form.appendChild(span);elem.appendChild(form);input.value=this.text;this.input=input;if(this.initial_focus||this.onetime_focus){input.focus();this.onetime_focus=false}if(this.initial_select){input.select()}}else{this.input=null}this.submitted=false;this.elem=elem}else{if(this.input){this.text=this.input.value}}if(elem){var pos=camera2d.htmlPos(this.x,this.y);if(!this.spellcheck){elem.spellcheck=false}elem.style.left=pos[0]+"%";elem.style.top=pos[1]+"%";var size=camera2d.htmlSize(this.w,0);elem.style.width=size[0]+"%";var old_fontsize=elem.style.fontSize||"?px";var new_fontsize=camera2d.virtualToFontSize(this.font_height).toFixed(0)+"px";if(new_fontsize!==old_fontsize){elem.style.fontSize=new_fontsize}if(this.zindex){elem.style["z-index"]=this.zindex}}if(focused){if(this.auto_unfocus){if(glov_input.click({peek:true})){glov_ui.focusSteal("canvas")}}glov_input.eatAllKeyboardInput()}glov_input.mouseConsumeClicks({x:this.x,y:this.y,w:this.w,h:this.font_height});if(this.submitted){this.submitted=false;return this.SUBMIT}if(this.canceled){this.canceled=false;return this.CANCEL}return null};_proto.unrun=function unrun(){this.elem=null;this.input=null};return GlovUIEditBox}();GlovUIEditBox.prototype.SUBMIT="submit";GlovUIEditBox.prototype.CANCEL="cancel";function create(params){return new GlovUIEditBox(params)}


},{"./camera2d.js":6,"./engine.js":11,"./input.js":25,"./ui.js":47}],10:[function(require,module,exports){
"use strict";exports.registerShader=registerShader;exports.effectsPassAdd=effectsPassAdd;exports.effectsPassConsume=effectsPassConsume;exports.effectsQueue=effectsQueue;exports.effectsTopOfFrame=effectsTopOfFrame;exports.effectsReset=effectsReset;exports.effectsIsFinal=effectsIsFinal;exports.grayScaleMatrix=grayScaleMatrix;exports.sepiaMatrix=sepiaMatrix;exports.negativeMatrix=negativeMatrix;exports.saturationMatrix=saturationMatrix;exports.hueMatrix=hueMatrix;exports.brightnessAddMatrix=brightnessAddMatrix;exports.brightnessScaleMatrix=brightnessScaleMatrix;exports.additiveMatrix=additiveMatrix;exports.contrastMatrix=contrastMatrix;exports.applyCopy=applyCopy;exports.applyPixelyExpand=applyPixelyExpand;exports.applyGaussianBlur=applyGaussianBlur;exports.applyColorMatrix=applyColorMatrix;exports.clearAlpha=clearAlpha;var assert=require("assert");var engine=require("./engine.js");var renderWidth=engine.renderWidth,renderHeight=engine.renderHeight;var _require=require("./framebuffer.js"),framebufferEnd=_require.framebufferEnd,framebufferStart=_require.framebufferStart,framebufferTopOfFrame=_require.framebufferTopOfFrame;var geom=require("./geom.js");var shaders=require("./shaders.js");var sprites=require("./sprites.js");var textures=require("./textures.js");var _require2=require("./vmath.js"),vec2=_require2.vec2,vec3=_require2.vec3,vec4=_require2.vec4,v4set=_require2.v4set;var shader_data={vp_copy:{vp:"glov/shaders/effects_copy.vp"},copy:{fp:"glov/shaders/effects_copy.fp"},pixely_expand:{fp:"glov/shaders/pixely_expand.fp"},gaussian_blur:{fp:"glov/shaders/effects_gaussian_blur.fp"},color_matrix:{fp:"glov/shaders/effects_color_matrix.fp"}};function registerShader(key,obj){shader_data[key]=obj}function getShader(key){var elem=shader_data[key];if(!elem.shader){if(elem.fp){elem.shader=shaders.create(elem.fp)}else{elem.shader=shaders.create(elem.vp)}}return elem.shader}var inited=false;var clip_space=vec4(2,2,-1,-1);var copy_uv_scale=vec2(1,1);var shader_params_default={clip_space:clip_space,copy_uv_scale:copy_uv_scale};var shader_params_color_matrix;var shader_params_gaussian_blur;var shader_params_pixely_expand;var quad_geom;function startup(){inited=true;quad_geom=geom.create([[shaders.semantic.POSITION,gl.FLOAT,2,false]],new Float32Array([0,0,1,0,1,1,0,1]),null,geom.QUADS);shader_params_color_matrix={clip_space:clip_space,copy_uv_scale:copy_uv_scale,colorMatrix:new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0])};shader_params_gaussian_blur={clip_space:clip_space,copy_uv_scale:copy_uv_scale,sampleRadius:vec3(1,1,1),Gauss:new Float32Array([.93,.8,.7,.6,.5,.4,.3,.2,.1])};shader_params_pixely_expand={clip_space:clip_space,copy_uv_scale:copy_uv_scale,orig_pixel_size:vec4()}}var num_passes=0;function effectsPassAdd(){++num_passes}function effectsPassConsume(){--num_passes}function doEffect(fn){effectsPassConsume();fn()}function effectsQueue(z,fn){effectsPassAdd();sprites.queuefn(z,doEffect.bind(null,fn))}function effectsTopOfFrame(){num_passes=0;framebufferTopOfFrame()}function effectsReset(){assert.equal(num_passes,0)}function effectsIsFinal(){return!num_passes}function grayScaleMatrix(dst){dst[0]=.2126;dst[1]=.2126;dst[2]=.2126;dst[3]=.7152;dst[4]=.7152;dst[5]=.7152;dst[6]=.0722;dst[7]=.0722;dst[8]=.0722;dst[9]=dst[10]=dst[11]=0}function sepiaMatrix(dst){dst[0]=.393;dst[1]=.349;dst[2]=.272;dst[3]=.769;dst[4]=.686;dst[5]=.534;dst[6]=.189;dst[7]=.168;dst[8]=.131;dst[9]=dst[10]=dst[11]=0}function negativeMatrix(dst){dst[0]=dst[4]=dst[8]=-1;dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0;dst[9]=dst[10]=dst[11]=1}function saturationMatrix(dst,saturationScale){var is=1-saturationScale;dst[0]=is*.2126+saturationScale;dst[1]=is*.2126;dst[2]=is*.2126;dst[3]=is*.7152;dst[4]=is*.7152+saturationScale;dst[5]=is*.7152;dst[6]=is*.0722;dst[7]=is*.0722;dst[8]=is*.0722+saturationScale;dst[9]=dst[10]=dst[11]=0}function hueMatrix(dst,angle){var c=Math.cos(angle);var s=Math.sin(angle);dst[0]=.7874*c+-.3712362230889293*s+.2126;dst[1]=-.2126*c+.20611404610069642*s+.2126;dst[2]=-.2126*c+-.9485864922785551*s+.2126;dst[3]=-.7152*c+-.4962902913954023*s+.7152;dst[4]=.2848*c+.08105997779422341*s+.7152;dst[5]=-.7152*c+.6584102469838492*s+.7152;dst[6]=-.0722*c+.8675265144843316*s+.0722;dst[7]=-.0722*c+-.28717402389491986*s+.0722;dst[8]=.9278*c+.290176245294706*s+.0722;dst[9]=dst[10]=dst[11]=0}function brightnessAddMatrix(dst,brightnessOffset){dst[0]=dst[4]=dst[8]=1;dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0;dst[9]=dst[10]=dst[11]=brightnessOffset}function brightnessScaleMatrix(dst,scale){dst[0]=dst[4]=dst[8]=scale;dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0;dst[9]=dst[10]=dst[11]=0}function additiveMatrix(dst,additiveRGB){dst[0]=dst[4]=dst[8]=1;dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0;dst[9]=additiveRGB[0];dst[10]=additiveRGB[1];dst[11]=additiveRGB[2]}function contrastMatrix(dst,contrastScale){dst[0]=dst[4]=dst[8]=contrastScale;dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0;dst[9]=dst[10]=dst[11]=.5*(1-contrastScale)}function applyEffect(effect,view_w,view_h){var final=effect.final!==false&&effectsIsFinal()||effect.final;if(effect.no_framebuffer){var viewport=engine.viewport;var target_w=viewport[2];var target_h=viewport[3];view_w=view_w||target_w;view_h=view_h||target_h;clip_space[0]=2*view_w/target_w;clip_space[1]=2*view_h/target_h}else if(effect.viewport){assert(final);var _viewport=effect.viewport;var _target_w=_viewport[2];var _target_h=_viewport[3];view_w=view_w||_target_w;view_h=view_h||_target_h;clip_space[0]=2*view_w/_target_w;clip_space[1]=2*view_h/_target_h;framebufferStart({clear:effect.clear,clear_all:effect.clear_all,clear_color:effect.clear_color,viewport:_viewport,final:final})}else{clip_space[0]=2;clip_space[1]=2;view_w=view_w||renderWidth();view_h=view_h||renderHeight();framebufferStart({width:view_w,height:view_h,final:final})}shaders.bind(getShader("vp_copy"),getShader(effect.shader),effect.params);textures.bindArray(effect.texs);quad_geom.draw()}function applyCopy(params){if(!inited){startup()}var source=params.source;if(!source){source=framebufferEnd({filter_linear:params.filter_linear})}params.shader=params.shader||"copy";params.params=shader_params_default;params.texs=[source];applyEffect(params)}function applyPixelyExpand(params){if(!inited){startup()}var source=params.source;assert(!source);if(!source){source=framebufferEnd({filter_linear:true})}var resx=source.width;var resy=source.height;var sampleRadius=(params.hblur||.25)/resx;shader_params_gaussian_blur.sampleRadius[0]=sampleRadius;shader_params_gaussian_blur.sampleRadius[1]=0;shader_params_gaussian_blur.sampleRadius[2]=1;applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[source],final:false},resx,resy);var hblur=framebufferEnd({filter_linear:true});sampleRadius=(params.vblur||.75)/resy;shader_params_gaussian_blur.sampleRadius[0]=0;shader_params_gaussian_blur.sampleRadius[1]=sampleRadius;shader_params_gaussian_blur.sampleRadius[2]=1;applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[hblur],final:false},resx,resy);var vblur=framebufferEnd({filter_linear:true});v4set(shader_params_pixely_expand.orig_pixel_size,source.width,source.height,1/source.width,1/source.height);applyEffect({shader:"pixely_expand",params:shader_params_pixely_expand,texs:[source,hblur,vblur],clear:params.clear,clear_all:params.clear_all,clear_color:params.clear_color,viewport:params.viewport})}function applyGaussianBlur(params){if(!inited){startup()}var source=framebufferEnd({filter_linear:true});var max_size=params.max_size||512;var min_size=params.min_size||128;var inputTexture0=source;var viewport=engine.viewport;var res=max_size;while(res>viewport[2]||res>viewport[3]){res/=2}while(res>min_size){applyEffect({shader:params.shader_copy||"copy",params:shader_params_default,texs:[inputTexture0],final:false},res,res);inputTexture0=framebufferEnd({filter_linear:true});res/=2}var sampleRadius=(params.blur||1)/res;shader_params_gaussian_blur.sampleRadius[0]=sampleRadius;shader_params_gaussian_blur.sampleRadius[1]=0;shader_params_gaussian_blur.sampleRadius[2]=params.glow||1;applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[inputTexture0],final:false},res,res);var blur=framebufferEnd({filter_linear:true});shader_params_gaussian_blur.sampleRadius[0]=0;shader_params_gaussian_blur.sampleRadius[1]=sampleRadius;shader_params_gaussian_blur.sampleRadius[2]=params.glow||1;applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[blur]});return true}function applyColorMatrix(params){if(!inited){startup()}var source=framebufferEnd({filter_linear:true});var matrix=params.colorMatrix;var mout=shader_params_color_matrix.colorMatrix;mout[0]=matrix[0];mout[1]=matrix[3];mout[2]=matrix[6];mout[3]=matrix[9];mout[4]=matrix[1];mout[5]=matrix[4];mout[6]=matrix[7];mout[7]=matrix[10];mout[8]=matrix[2];mout[9]=matrix[5];mout[10]=matrix[8];mout[11]=matrix[11];applyEffect({shader:"color_matrix",params:shader_params_color_matrix,texs:[source]});return true}function clearAlpha(){var old_dt=gl.getParameter(gl.DEPTH_TEST);if(old_dt){gl.disable(gl.DEPTH_TEST)}gl.colorMask(false,false,false,true);applyCopy({source:textures.textures.white,no_framebuffer:true});gl.colorMask(true,true,true,true);if(old_dt){gl.enable(gl.DEPTH_TEST)}}


},{"./engine.js":11,"./framebuffer.js":16,"./geom.js":18,"./shaders.js":40,"./sprites.js":43,"./textures.js":45,"./vmath.js":49,"assert":undefined}],11:[function(require,module,exports){
"use strict";exports.disableRender=disableRender;exports.setGlobalMatrices=setGlobalMatrices;exports.setMatVP=setMatVP;exports.setFOV=setFOV;exports.setGameDims=setGameDims;exports.postprocessingAllow=postprocessingAllow;exports.glCheckError=glCheckError;exports.releaseCanvas=releaseCanvas;exports.reloadSafe=reloadSafe;exports.defineCausesReload=defineCausesReload;exports.definesChanged=definesChanged;exports.updateMatrices=updateMatrices;exports.getFrameTimestamp=getFrameTimestamp;exports.getFrameIndex=getFrameIndex;exports.getFrameDt=getFrameDt;exports.getFrameDtActual=getFrameDtActual;exports.setState=setState;exports.stateActive=stateActive;exports.resizing=resizing;exports.addTickFunc=addTickFunc;exports.postTick=postTick;exports.postRender=postRender;exports.renderWidth=renderWidth;exports.renderHeight=renderHeight;exports.setViewport=setViewport;exports.setupProjection=setupProjection;exports.setZRange=setZRange;exports.start3DRendering=start3DRendering;exports.startSpriteRendering=startSpriteRendering;exports.projectionZBias=projectionZBias;exports.setPixelyStrict=setPixelyStrict;exports.startup=startup;exports.loadsPending=loadsPending;exports.hrnow=exports.had_3d_this_frame=exports.viewport=exports.perf_state=exports.PERF_HISTORY_SIZE=exports.is_loading=exports.hrtime=exports.frame_dt=exports.frame_index=exports.frame_timestamp=exports.postprocessing=exports.border_color=exports.app_state=exports.font=exports.light_dir_ws=exports.light_ambient=exports.light_diffuse=exports.mat_vp=exports.mat_view=exports.mat_projection=exports.fov_x=exports.fov_y=exports.ZNEAR=exports.ZFAR=exports.defines=exports.render_height=exports.render_width=exports.game_height=exports.game_width=exports.antialias_unavailable=exports.antialias=exports.dom_to_canvas_ratio=exports.pixel_aspect=exports.height=exports.width=exports.glov_particles=exports.webgl2=exports.canvas=exports.DEBUG=void 0;require("./bootstrap.js");var DEBUG=String(document.location).match(/^https?:\/\/localhost/);exports.DEBUG=DEBUG;require("not_worker");var assert=require("assert");var _require=require("./browser.js"),is_ios_safari=_require.is_ios_safari;var camera2d=require("./camera2d.js");var cmds=require("./cmds.js");var effects=require("./effects.js");var effectsReset=effects.effectsReset,effectsTopOfFrame=effects.effectsTopOfFrame,effectsIsFinal=effects.effectsIsFinal,effectsPassAdd=effects.effectsPassAdd,effectsPassConsume=effects.effectsPassConsume;var _require2=require("./error_report.js"),errorReportDisable=_require2.errorReportDisable,errorReportSetPath=_require2.errorReportSetPath,glovErrorReport=_require2.glovErrorReport;var glov_font=require("./font.js");var _require3=require("./framebuffer.js"),framebufferStart=_require3.framebufferStart,framebufferEndOfFrame=_require3.framebufferEndOfFrame;var geom=require("./geom.js");var input=require("./input.js");var local_storage=require("./local_storage.js");var mat3FromMat4=require("gl-mat3/fromMat4");var mat4Copy=require("gl-mat4/copy");var mat4Invert=require("gl-mat4/invert");var mat4Mul=require("gl-mat4/multiply");var mat4Transpose=require("gl-mat4/transpose");var mat4Perspective=require("gl-mat4/perspective");var asin=Math.asin,cos=Math.cos,floor=Math.floor,min=Math.min,max=Math.max,PI=Math.PI,round=Math.round,sin=Math.sin,sqrt=Math.sqrt;var models=require("./models.js");var perf=require("./perf.js");var settings=require("./settings.js");var shaders=require("./shaders.js");var _require4=require("./sound.js"),soundLoading=_require4.soundLoading,soundStartup=_require4.soundStartup,soundTick=_require4.soundTick;var sprites=require("./sprites.js");var textures=require("./textures.js");var texturesTick=textures.texturesTick;var glov_transition=require("./transition.js");var glov_ui=require("./ui.js");var urlhash=require("./urlhash.js");var _require5=require("../../common/util.js"),callEach=_require5.callEach,clamp=_require5.clamp,defaults=_require5.defaults,nearSame=_require5.nearSame,ridx=_require5.ridx;var _require6=require("./vmath.js"),mat3=_require6.mat3,mat4=_require6.mat4,vec3=_require6.vec3,vec4=_require6.vec4,v3mulMat4=_require6.v3mulMat4,v3iNormalize=_require6.v3iNormalize,v4copy=_require6.v4copy,v4same=_require6.v4same,v4set=_require6.v4set;var canvas;exports.canvas=canvas;var webgl2;exports.webgl2=webgl2;var glov_particles;exports.glov_particles=glov_particles;var width;exports.width=width;var height;exports.height=height;var width_3d;var height_3d;var pixel_aspect=1;exports.pixel_aspect=pixel_aspect;var dom_to_canvas_ratio=window.devicePixelRatio||1;exports.dom_to_canvas_ratio=dom_to_canvas_ratio;var antialias;exports.antialias=antialias;var antialias_unavailable;exports.antialias_unavailable=antialias_unavailable;var game_width;exports.game_width=game_width;var game_height;exports.game_height=game_height;var game_aspect;var render_width;exports.render_width=render_width;var render_height;exports.render_height=render_height;var defines=urlhash.register({key:"D",type:urlhash.TYPE_SET,change:definesChanged});exports.defines=defines;var ZFAR;exports.ZFAR=ZFAR;var ZNEAR;exports.ZNEAR=ZNEAR;var fov_y=1;exports.fov_y=fov_y;var fov_x=1;exports.fov_x=fov_x;var mat_projection=mat4();exports.mat_projection=mat_projection;var mat_view=mat4();exports.mat_view=mat_view;var mat_m=mat4();var mat_vp=mat4();exports.mat_vp=mat_vp;var mat_mv=mat4();var mat_mv_no_skew=mat4();var mat_mvp=mat4();var mat_mv_inv_transform=mat3();var mat_inv_view=mat3();var projection_inverse=vec4();var light_diffuse=vec3(.75,.75,.75);exports.light_diffuse=light_diffuse;var light_dir_vs=vec3(0,0,0);var light_ambient=vec3(.25,.25,.25);exports.light_ambient=light_ambient;var light_dir_ws=vec3(-1,-2,-3);exports.light_dir_ws=light_dir_ws;var font;exports.font=font;var app_state=null;exports.app_state=app_state;var border_color=vec4(0,0,0,1);exports.border_color=border_color;var no_render=false;function disableRender(new_value){no_render=new_value;if(no_render){glov_ui.cleanupDOMElems()}}var mat_temp=mat4();function setGlobalMatrices(_mat_view){mat4Copy(mat_view,_mat_view);mat4Mul(mat_vp,mat_projection,mat_view);v3iNormalize(light_dir_ws);v3mulMat4(light_dir_vs,light_dir_ws,mat_view);mat4Invert(mat_temp,mat_view);mat3FromMat4(mat_inv_view,mat_temp)}function setMatVP(_mat_view){setupProjection(fov_y,width,height,ZNEAR,ZFAR);mat4Copy(mat_view,_mat_view);mat4Mul(mat_vp,mat_projection,mat_view)}function setFOV(fov_min){var w=render_width||width;var h=render_height||height;var aspect=w/h;if(aspect>game_aspect){exports.fov_y=fov_y=fov_min;var rise=sin(fov_y/2)/cos(fov_y/2)*aspect;exports.fov_x=fov_x=2*asin(rise/sqrt(rise*rise+1))}else{var _rise=sin(fov_min/2)/cos(fov_min/2)*game_aspect;exports.fov_x=fov_x=2*asin(_rise/sqrt(_rise*_rise+1));var rise2=sin(fov_x/2)/cos(fov_x/2)/aspect;exports.fov_y=fov_y=2*asin(rise2/sqrt(rise2*rise2+1))}}function setGameDims(w,h){exports.game_width=game_width=w;exports.game_height=game_height=h;game_aspect=game_width/game_height}var postprocessing_reset_version="5";var postprocessing=local_storage.get("glov_no_postprocessing")!==postprocessing_reset_version;exports.postprocessing=postprocessing;function postprocessingAllow(allow){local_storage.set("glov_no_postprocessing",allow?undefined:postprocessing_reset_version);exports.postprocessing=postprocessing=allow}function glCheckError(){var gl_err=gl.getError();if(gl_err){console.error(gl_err);throw new Error(gl_err)}}function releaseCanvas(){try{if(gl){var ext=gl.getExtension("WEBGL_lose_context");if(ext){ext.loseContext()}}}catch(ignored){}}function reloadSafe(){errorReportDisable();releaseCanvas();if(window.FBInstant){try{window.top.location.reload()}catch(e){window.FBInstant.quit()}}else{document.location.reload()}}window.reloadSafe=reloadSafe;var reloading_defines={};function defineCausesReload(define){reloading_defines[define]=defines[define]}defineCausesReload("FORCEWEBGL2");defineCausesReload("NOWEBGL2");function definesChanged(){for(var key in reloading_defines){if(defines[key]!==reloading_defines[key]){urlhash.onURLChange(reloadSafe);break}}shaders.handleDefinesChanged()}function normalizeRow(m,idx){var len=m[idx]*m[idx]+m[idx+1]*m[idx+1]+m[idx+2]*m[idx+2];if(len>0){len=1/sqrt(len);m[idx]*=len;m[idx+1]*=len;m[idx+2]*=len}}function updateMatrices(mat_model){mat4Copy(mat_m,mat_model);mat4Mul(mat_mv,mat_view,mat_model);mat4Mul(mat_mvp,mat_projection,mat_mv);mat4Copy(mat_temp,mat_model);normalizeRow(mat_temp,0);normalizeRow(mat_temp,4);normalizeRow(mat_temp,8);mat4Mul(mat_mv_no_skew,mat_view,mat_temp);mat4Invert(mat_temp,mat_mv_no_skew);mat4Transpose(mat_temp,mat_temp);mat3FromMat4(mat_mv_inv_transform,mat_temp)}var frame_timestamp=0;exports.frame_timestamp=frame_timestamp;function getFrameTimestamp(){return frame_timestamp}var frame_index=0;exports.frame_index=frame_index;function getFrameIndex(){return frame_index}var frame_dt=0;exports.frame_dt=frame_dt;function getFrameDt(){return frame_dt}var hrtime=0;exports.hrtime=hrtime;var this_frame_time_actual=0;function getFrameDtActual(){return this_frame_time_actual}var after_loading_state=null;var is_loading=true;exports.is_loading=is_loading;function setState(new_state){if(is_loading){after_loading_state=new_state}else{exports.app_state=app_state=new_state}}function stateActive(test_state){if(is_loading){return after_loading_state===test_state}else{return app_state===test_state}}var mspf=1e3;var mspf_update_time=0;var mspf_frame_count=0;var last_tick_cpu=0;var mspf_tick=1e3;var mspf_tick_accum=0;var PERF_HISTORY_SIZE=128;exports.PERF_HISTORY_SIZE=PERF_HISTORY_SIZE;var perf_state=window.glov_perf_state={fpsgraph:{index:0,history:new Float32Array(PERF_HISTORY_SIZE*2)},gpu_mem:{tex:0,geom:0}};exports.perf_state=perf_state;var fpsgraph=perf_state.fpsgraph;perf.addMetric({name:"fps",show_stat:"show_fps",show_graph:"fps_graph",labels:{"fps: ":function fps(){return(1e3/mspf).toFixed(1)},"ms/f: ":function msF(){return mspf.toFixed(0)},"cpu: ":function cpu(){return mspf_tick.toFixed(0)}},data:fpsgraph,line_scale_top:50,colors:[vec4(1,.925,.153,1),vec4(0,.894,.212,1)]});var do_borders=true;var do_viewport_postprocess=false;var need_repos=0;function resizing(){return need_repos}var app_tick_functions=[];function addTickFunc(cb){app_tick_functions.push(cb)}var post_tick=[];function postTick(opts){opts.ticks=opts.ticks||1;opts.inactive=opts.inactive||false;assert.equal(typeof opts.fn,"function");post_tick.push(opts)}var post_render=null;function postRender(fn){if(!post_render){post_render=[]}post_render.push(fn)}function resetEffects(){effectsReset();framebufferEndOfFrame()}function renderWidth(){return render_width||width}function renderHeight(){return render_height||height}var SAFARI_FULLSCREEN_ASPECT=function(){var screen=window.screen;if(!is_ios_safari||!screen){return 0}var SAFARI_DIMS={"896,414":896/414,"812,375":812/375,"736,414":736/414,"716,414":736/414,"667,375":667/375,"647,375":667/375,"548,320":568/320};var key=max(screen.availWidth,screen.availHeight)+","+min(screen.availWidth,screen.availHeight);return SAFARI_DIMS[key]||0}();function safariTopSafeArea(view_w,view_h){if(SAFARI_FULLSCREEN_ASPECT&&nearSame(view_w/view_h,SAFARI_FULLSCREEN_ASPECT,.001)){return 50*(window.devicePixelRatio||1)}return 0}var last_canvas_width;var last_canvas_height;var last_body_height;var safearea_elem;var safearea_ignore_bottom=false;var safearea_values=[0,0,0,0];var last_safearea_values=[0,0,0,0];function checkResize(){var vv=window.visualViewport||{};exports.dom_to_canvas_ratio=dom_to_canvas_ratio=window.devicePixelRatio||1;exports.dom_to_canvas_ratio=dom_to_canvas_ratio=dom_to_canvas_ratio*settings.render_scale_all;var view_w=vv.width||window.innerWidth;var view_h=vv.height||window.innerHeight;if(view_h!==last_body_height){last_body_height=view_h;document.body.style.height=view_h+"px"}var rect=canvas.getBoundingClientRect();var new_width=round(rect.width*dom_to_canvas_ratio)||1;var new_height=round(rect.height*dom_to_canvas_ratio)||1;if(cmds.safearea[0]===-1){if(safearea_elem){var sa_width=safearea_elem.offsetWidth;var sa_height=safearea_elem.offsetHeight;if(sa_width&&sa_height){v4set(safearea_values,safearea_elem.offsetLeft*dom_to_canvas_ratio,new_width-(sa_width+safearea_elem.offsetLeft)*dom_to_canvas_ratio,max(safearea_elem.offsetTop*dom_to_canvas_ratio,safariTopSafeArea(view_w,view_h)*settings.render_scale_all),safearea_ignore_bottom?0:new_height-(sa_height+safearea_elem.offsetTop)*dom_to_canvas_ratio)}}}else{v4set(safearea_values,new_width*clamp(cmds.safearea[0],0,25)/100,new_width*clamp(cmds.safearea[1],0,25)/100,new_height*clamp(cmds.safearea[2],0,25)/100,new_height*clamp(cmds.safearea[3],0,25)/100)}if(!v4same(safearea_values,last_safearea_values)){v4copy(last_safearea_values,safearea_values);camera2d.setSafeAreaPadding(safearea_values[0],safearea_values[1],safearea_values[2],safearea_values[3]);need_repos=max(need_repos,1)}if(new_width!==last_canvas_width||new_height!==last_canvas_height){window.pixel_scale=dom_to_canvas_ratio;last_canvas_width=canvas.width=new_width||1;last_canvas_height=canvas.height=new_height||1;exports.width=width=canvas.width;exports.height=height=canvas.height;setFOV(settings.fov*PI/180);need_repos=10}if(is_ios_safari&&(window.visualViewport||need_repos)){window.scroll(0,0)}}var viewport=vec4(0,0,1,1);exports.viewport=viewport;function setViewport(xywh){v4copy(viewport,xywh);gl.viewport(xywh[0],xywh[1],xywh[2],xywh[3])}var frame_requested=false;function requestFrame(){if(frame_requested){return}frame_requested=true;var max_fps=settings.max_fps;if(defines.SLOWLOAD&&is_loading){max_fps=2}if(max_fps){setTimeout(tick,round(1e3/max_fps))}else{requestAnimationFrame(tick)}}var mat_projection_10;var had_3d_this_frame;exports.had_3d_this_frame=had_3d_this_frame;function setupProjection(use_fov_y,use_width,use_height,znear,zfar){mat4Perspective(mat_projection,use_fov_y,use_width/use_height,znear,zfar);mat_projection_10=mat_projection[10];v4set(projection_inverse,2/(use_width*mat_projection[0]),2/(use_height*mat_projection[5]),-(1+mat_projection[8])/mat_projection[0],-(1+mat_projection[9])/mat_projection[5])}function setZRange(znear,zfar){exports.ZNEAR=ZNEAR=znear;exports.ZFAR=ZFAR=zfar;if(had_3d_this_frame){setupProjection(fov_y,width,height,ZNEAR,ZFAR)}}var render_scale_3d_this_frame;function start3DRendering(){exports.had_3d_this_frame=had_3d_this_frame=true;if(render_scale_3d_this_frame&&!defines.NOCOPY){effectsPassAdd()}gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);framebufferStart({width:width_3d,height:height_3d,final:effectsIsFinal(),need_depth:true,clear:true,clear_all:settings.render_scale_clear});if(render_width){setupProjection(fov_y,render_width,render_height,ZNEAR,ZFAR)}else{setupProjection(fov_y,width,height,ZNEAR,ZFAR)}gl.enable(gl.CULL_FACE)}function renderScaleFinish(){if(defines.NOCOPY){gl.disable(gl.SCISSOR_TEST);v4set(viewport,0,0,width,height);gl.viewport(viewport[0],viewport[1],viewport[2],viewport[3])}else{effectsPassConsume();if(settings.render_scale_mode===2){effects.applyPixelyExpand({final:effectsIsFinal(),clear:false})}else{effects.applyCopy({filter_linear:settings.render_scale_mode===0})}}}function startSpriteRendering(){gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.depthMask(false)}function projectionZBias(dist,at_z){if(!dist){mat_projection[10]=mat_projection_10;return}var e=.2*(dist/(at_z*(at_z+dist)));e=max(e,2e-7);mat_projection[10]=mat_projection_10+e}function fixNatives(is_startup){var b=[];for(var a in b){console[is_startup?"log":"error"]('Found invasive enumerable property "'+a+'" on Array.prototype, removing...');var old_val=b[a];delete Array.prototype[a];Object.defineProperty(Array.prototype,a,{value:old_val,enumerable:false})}for(var _a in b){assert(false,"Array.prototype has unremovable member "+_a)}}function resetState(){textures.texturesResetState();shaders.shadersResetState();geom.geomResetState();gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);gl.enable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);gl.disable(gl.SCISSOR_TEST);gl.cullFace(gl.BACK);gl.viewport(0,0,width,height)}var hrnow=window.performance?window.performance.now.bind(window.performance):Date.now.bind(Date);exports.hrnow=hrnow;var last_tick=0;function tick(timestamp){frame_requested=false;exports.hrtime=hrtime=hrnow();var now=round(hrtime);if(!last_tick){last_tick=now}this_frame_time_actual=now-last_tick;var dt=min(max(this_frame_time_actual,1),250);if(defines.ATTRACT){dt=16}exports.frame_dt=frame_dt=dt;last_tick=now;exports.frame_timestamp=frame_timestamp=frame_timestamp+dt;exports.frame_index=frame_index=frame_index+1;fixNatives(false);fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+1]=this_frame_time_actual;fpsgraph.index++;fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+0]=0;++mspf_frame_count;mspf_tick_accum+=last_tick_cpu;if(now-mspf_update_time>settings.fps_window*1e3){if(!mspf_update_time){mspf_update_time=now}else{mspf=(now-mspf_update_time)/mspf_frame_count;mspf_tick=mspf_tick_accum/mspf_frame_count;mspf_tick_accum=0;mspf_frame_count=0;mspf_update_time=now}}effectsTopOfFrame();if(document.hidden||document.webkitHidden||no_render){resetEffects();input.tickInputInactive();last_tick_cpu=0;for(var ii=post_tick.length-1;ii>=0;--ii){if(post_tick[ii].inactive&&!--post_tick[ii].ticks){post_tick[ii].fn();ridx(post_tick,ii)}}requestFrame();return}checkResize();exports.had_3d_this_frame=had_3d_this_frame=false;render_scale_3d_this_frame=false;if(render_width){width_3d=render_width;height_3d=render_height;effectsPassAdd()}else{width_3d=round(width*settings.render_scale);height_3d=round(height*settings.render_scale);if(width_3d!==width){render_scale_3d_this_frame=true}}resetState();textures.bind(0,textures.textures.error);camera2d.tickCamera2D();glov_transition.render(dt);camera2d.setAspectFixed(game_width,game_height);soundTick(dt);input.tickInput();glov_ui.tickUI(dt);if(need_repos){--need_repos;var ul=[];camera2d.virtualToDom(ul,[0,0]);var lr=[];camera2d.virtualToDom(lr,[game_width-1,game_height-1]);var viewport2=[ul[0],ul[1],lr[0],lr[1]];var view_height=viewport2[3]-viewport2[1];var font_size=min(256,max(2,floor(view_height/800*16)));var elem_fullscreen=document.getElementById("fullscreen");if(elem_fullscreen){elem_fullscreen.style["font-size"]=font_size+"px"}}if(do_borders){glov_ui.drawRect(camera2d.x0Real(),camera2d.y0Real(),camera2d.x1Real(),0,Z.BORDERS,border_color);glov_ui.drawRect(camera2d.x0Real(),game_height,camera2d.x1Real(),camera2d.y1Real(),Z.BORDERS,border_color);glov_ui.drawRect(camera2d.x0Real(),0,0,game_height,Z.BORDERS,border_color);glov_ui.drawRect(game_width,0,camera2d.x1Real(),game_height,Z.BORDERS,border_color)}if(settings.show_metrics){perf.draw()}for(var _ii=0;_ii<app_tick_functions.length;++_ii){app_tick_functions[_ii](dt)}if(app_state){app_state(dt)}glov_particles.tick(dt);if(had_3d_this_frame){if(render_scale_3d_this_frame){renderScaleFinish()}}else{if(render_width){framebufferStart({width:render_width,height:render_height,clear:true,clear_all:settings.render_scale_clear,final:effectsIsFinal(),need_depth:false})}else{framebufferStart({width:width,height:height,clear:true,final:effectsIsFinal(),need_depth:false})}}startSpriteRendering();sprites.draw();glov_ui.endFrame();if(post_render){callEach(post_render,post_render=null)}if(render_width){effectsPassConsume();var clear_color=[0,0,0,1];var final_viewport=[camera2d.render_offset_x,camera2d.render_offset_y_bottom,camera2d.render_viewport_w,camera2d.render_viewport_h];var params={clear:true,clear_all:true,clear_color:clear_color,viewport:final_viewport};if(do_viewport_postprocess){effects.applyPixelyExpand(params)}else{effects.applyCopy(params)}}input.endFrame();resetEffects();texturesTick();for(var _ii2=post_tick.length-1;_ii2>=0;--_ii2){if(!--post_tick[_ii2].ticks){post_tick[_ii2].fn();ridx(post_tick,_ii2)}}last_tick_cpu=hrnow()-now;fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+0]=last_tick_cpu;requestFrame()}function periodiclyRequestFrame(){requestFrame();setTimeout(periodiclyRequestFrame,5e3)}function setPixelyStrict(on){if(on){exports.render_width=render_width=game_width;exports.render_height=render_height=game_height}else{exports.render_width=render_width=undefined;exports.render_height=render_height=undefined}}function startup(params){fixNatives(true);exports.canvas=canvas=document.getElementById("canvas");safearea_elem=document.getElementById("safearea");if(params.error_report!==false){errorReportSetPath(urlhash.getAPIPath());window.glov_error_report=function(msg,file,line,col){setTimeout(requestFrame,1);return glovErrorReport(true,msg,file,line,col)}}safearea_ignore_bottom=params.safearea_ignore_bottom||false;window.addEventListener("resize",checkResize,false);checkResize();var is_pixely=params.pixely&&params.pixely!=="off";exports.antialias=antialias=params.antialias||!is_pixely&&params.antialias!==false;var powerPreference=params.high?"high-performance":"default";var context_names=["webgl2","webgl","experimental-webgl"];var force_webgl1=defines.NOWEBGL2;var disable_data=local_storage.getJSON("webgl2_disable");if(disable_data&&disable_data.ua===navigator.userAgent&&disable_data.ts>Date.now()-7*24*60*60*1e3){console.log("Disabling WebGL2 because a previous run encountered a related error");force_webgl1=true}if(DEBUG&&!defines.FORCEWEBGL2){var rc=local_storage.getJSON("run_count",0)+1;local_storage.setJSON("run_count",rc);if(rc%2){force_webgl1=true}}if(force_webgl1){context_names.splice(0,1)}var context_opts=[{antialias:antialias,powerPreference:powerPreference,alpha:false},{powerPreference:powerPreference,alpha:false},{antialias:antialias,alpha:false},{alpha:false},{}];var good=false;exports.webgl2=webgl2=false;for(var i=0;!good&&i<context_names.length;i+=1){for(var jj=0;!good&&jj<context_opts.length;++jj){try{window.gl=canvas.getContext(context_names[i],context_opts[jj]);if(window.gl){if(context_names[i]==="webgl2"){exports.webgl2=webgl2=true}if(antialias&&!context_opts[jj].antialias){exports.antialias_unavailable=antialias_unavailable=true;exports.antialias=antialias=false}good=true;break}}catch(e){}}}if(!good){window.alert("Sorry, but your browser does not support WebGL or does not have it enabled.");document.getElementById("loading").style.visibility="hidden";document.getElementById("nowebgl").style.visibility="visible";return false}console.log("Using WebGL"+(webgl2?2:1));assert(gl);canvas.focus();setGameDims(params.game_width||1280,params.game_height||960);exports.ZNEAR=ZNEAR=params.znear||.7;exports.ZFAR=ZFAR=params.zfar||1e4;setPixelyStrict(params.pixely==="strict");if(params.viewport_postprocess&&params.pixely==="strict"){do_viewport_postprocess=true}exports.pixel_aspect=pixel_aspect=params.pixel_aspect||1;setFOV(settings.fov*PI/180);gl.depthFunc(gl.LEQUAL);gl.cullFace(gl.BACK);gl.clearColor(0,.1,.2,1);gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);textures.startup();geom.startup();shaders.startup({light_diffuse:light_diffuse,light_dir_vs:light_dir_vs,ambient:light_ambient,mat_m:mat_m,mat_mv:mat_mv,mat_vp:mat_vp,mvp:mat_mvp,mv_inv_trans:mat_mv_inv_transform,mat_inv_view:mat_inv_view,view:mat_view,projection:mat_projection,projection_inverse:projection_inverse});camera2d.startup();sprites.startup();input.startup(canvas,params);models.startup();exports.glov_particles=glov_particles=require("./particles.js").create();if(is_pixely){textures.defaultFilters(gl.NEAREST,gl.NEAREST);settings.runTimeDefault("render_scale_mode",1)}else{textures.defaultFilters(gl.LINEAR_MIPMAP_LINEAR,gl.LINEAR)}assert(params.font);params.font=exports.font=font=glov_font.create(params.font.info,params.font.texture);if(params.title_font){params.title_font=glov_font.create(params.title_font.info,params.title_font.texture)}glov_ui.startup(params);soundStartup(params.sound);glov_ui.bindSounds(defaults(params.ui_sounds||{},{button_click:"button_click",rollover:"rollover"}));camera2d.setAspectFixed(game_width,game_height);if(params.state){setState(params.state)}if(params.do_borders!==undefined){do_borders=params.do_borders}if(params.show_fps!==undefined){settings.show_fps=params.show_fps}periodiclyRequestFrame();return true}function loadsPending(){return textures.load_count+soundLoading()+models.load_count}function loading(){var load_count=loadsPending();var elem_loading_text=document.getElementById("loading_text");if(elem_loading_text){elem_loading_text.innerText="Loading ("+load_count+")..."}if(!load_count){exports.is_loading=is_loading=false;exports.app_state=app_state=after_loading_state;postTick({ticks:2,fn:function fn(){var loading_elem=document.getElementById("loading");if(loading_elem){loading_elem.style.visibility="hidden"}}})}}exports.app_state=app_state=loading;window.glov_engine=exports;


},{"../../common/util.js":70,"./bootstrap.js":4,"./browser.js":5,"./camera2d.js":6,"./cmds.js":8,"./effects.js":10,"./error_report.js":12,"./font.js":15,"./framebuffer.js":16,"./geom.js":18,"./input.js":25,"./local_storage.js":27,"./models.js":29,"./particles.js":32,"./perf.js":33,"./settings.js":39,"./shaders.js":40,"./sound.js":41,"./sprites.js":43,"./textures.js":45,"./transition.js":46,"./ui.js":47,"./urlhash.js":48,"./vmath.js":49,"assert":undefined,"gl-mat3/fromMat4":undefined,"gl-mat4/copy":undefined,"gl-mat4/invert":undefined,"gl-mat4/multiply":undefined,"gl-mat4/perspective":undefined,"gl-mat4/transpose":undefined,"not_worker":undefined}],12:[function(require,module,exports){
"use strict";exports.errorReportDisable=errorReportDisable;exports.errorReportSetPath=errorReportSetPath;exports.errorReportSetDetails=errorReportSetDetails;exports.errorReportGetDetails=errorReportGetDetails;exports.glovErrorReport=glovErrorReport;var error_report_disabled=false;function errorReportDisable(){error_report_disabled=true}var api_path="/";function errorReportSetPath(path){api_path=path}var error_report_details={};var error_report_details_str="";function errorReportSetDetails(key,value){if(value){error_report_details[key]=escape(String(value))}else{delete error_report_details[key]}error_report_details_str="&"+Object.keys(error_report_details).map(function(k){return k+"="+error_report_details[k]}).join("&")}errorReportSetDetails("ver",'1609697707517');function errorReportGetDetails(){return error_report_details}var last_error_time=0;var crash_idx=0;var filtered_errors=/avast_submit|vc_request_action|^Script error\.\n  at \(0:0\)$|^null\n  at null(null:null)$/;function glovErrorReport(is_fatal,msg,file,line,col){console.error(msg);if(is_fatal){++crash_idx;var now=Date.now();var dt=now-last_error_time;last_error_time=now;if(error_report_disabled){return false}if(dt<30*1e3){return false}if(msg.match(filtered_errors)){return false}}var url=api_path;url+=(is_fatal?"errorReport":"errorLog")+"?cidx="+crash_idx+"&file="+escape(file)+("&line="+(line||0)+"&col="+(col||0)+"&url="+escape(location.href))+("&msg="+escape(msg)+error_report_details_str);var xhr=new XMLHttpRequest;xhr.open("POST",url,true);xhr.send(null);return true}


},{}],13:[function(require,module,exports){
"use strict";exports.onready=onready;exports.init=init;exports.fbGetLoginInfo=fbGetLoginInfo;exports.fbFriendName=fbFriendName;exports.fbGetFriends=fbGetFriends;exports.ready=void 0;var urlhash=require("./urlhash.js");var local_storage=require("./local_storage.js");var _require=require("./sound.js"),soundPause=_require.soundPause;var ready=false;exports.ready=ready;var onreadycallbacks=[];function onready(callback){if(ready){return void callback()}onreadycallbacks.push(callback)}var hasSubscribedAlready=false;function initSubscribe(callback,skipShortcut){skipShortcut=skipShortcut||false;function handleSubscribeToBotComplete(){if(callback){setTimeout(callback,1)}}function handleSubscribeToBotFailure(e){if(e&&e.code!=="USER_INPUT"){console.error("handleSubscribeToBotFailure",e)}FBInstant.logEvent("bot_subscribe_failure");handleSubscribeToBotComplete()}function subscribeToBot(){console.warn("Window social trying to bot subscribe");if(FBInstant.getSupportedAPIs().indexOf("player.canSubscribeBotAsync")!==-1){FBInstant.player.canSubscribeBotAsync().then(function(canSubscribe){if(canSubscribe){FBInstant.logEvent("bot_subscribe_show");FBInstant.player.subscribeBotAsync().then(function(){FBInstant.logEvent("bot_subscribe_success");handleSubscribeToBotComplete()},handleSubscribeToBotFailure).catch(handleSubscribeToBotFailure)}else{handleSubscribeToBotComplete()}}).catch(handleSubscribeToBotFailure)}else{handleSubscribeToBotComplete()}}function handleHomescreenComplete(){subscribeToBot()}function handleCreateShortcutFailure(e){console.error("handleCreateShortcutFailure",e);FBInstant.logEvent("homescreen_install_failure");handleHomescreenComplete()}var hasAddedToHomescreen=local_storage.get("instant.hasInstalledShortcut.v2");function createShortcut(){console.warn("Window social trying to create shortcut");if(FBInstant.getSupportedAPIs().indexOf("canCreateShortcutAsync")!==-1&&!hasAddedToHomescreen&&!hasSubscribedAlready){hasSubscribedAlready=true;FBInstant.canCreateShortcutAsync().then(function(canCreateShortcut){if(canCreateShortcut){FBInstant.logEvent("homescreen_install_show");FBInstant.createShortcutAsync().then(function(){local_storage.set("instant.hasInstalledShortcut.v2",true);FBInstant.logEvent("homescreen_install_success");handleHomescreenComplete()},function(){FBInstant.logEvent("homescreen_install_useraborted");handleHomescreenComplete()}).catch(handleCreateShortcutFailure)}else{handleHomescreenComplete()}}).catch(handleCreateShortcutFailure)}else{handleHomescreenComplete()}}if(skipShortcut){subscribeToBot()}else{createShortcut()}}function init(){if(!window.FBInstant){return}var left=1;var fake_load_interval=setInterval(function(){left*=.9;FBInstant.setLoadingProgress(100-left*100>>0)},100);FBInstant.initializeAsync().then(function(){var entryPointData=FBInstant.getEntryPointData()||{};var querystring=entryPointData.querystring||{};for(var x in querystring){urlhash.set(x,querystring[x])}clearInterval(fake_load_interval);exports.ready=ready=true;FBInstant.startGameAsync().then(function(){onreadycallbacks.forEach(function(e){return e()});onreadycallbacks=[];console.warn("outside init fb");initSubscribe(function(){console.warn("All done initing FB")})})}).catch(function(e){console.warn("initializeAsync failed",e)});FBInstant.onPause(function(){soundPause()})}function fbGetLoginInfo(cb){onready(function(){window.FBInstant.player.getSignedPlayerInfoAsync().then(function(result){if(cb){cb(null,{signature:result.getSignature(),display_name:window.FBInstant.player.getName()});cb=null}}).catch(function(err){if(cb){cb(err);cb=null}})})}var fb_friends={};function fbFriendName(user_id){return fb_friends[user_id]}function fbGetFriends(cb){onready(function(){window.FBInstant.player.getConnectedPlayersAsync().then(function(players){var list=players.map(function(player){var user_id="fb$"+player.getID();fb_friends[user_id]=player.getName();return user_id});if(cb){cb(null,list);cb=null}}).catch(function(err){if(cb){cb(err);cb=null}})})}


},{"./local_storage.js":27,"./sound.js":41,"./urlhash.js":48}],14:[function(require,module,exports){
"use strict";exports.filewatchOn=filewatchOn;exports.filewatchMessageHandler=filewatchMessageHandler;exports.filewatchTriggerChange=filewatchTriggerChange;exports.filewatchStartup=filewatchStartup;var assert=require("assert");var by_ext={};var by_match=[];function filewatchOn(ext_or_search,cb){if(ext_or_search[0]==="."){assert(!by_ext[ext_or_search]);by_ext[ext_or_search]=cb}else{by_match.push([ext_or_search,cb])}}var message_cb;function filewatchMessageHandler(cb){message_cb=cb}function onFileChange(filename){console.log("FileWatch change: "+filename);var ext_idx=filename.lastIndexOf(".");var did_reload=false;if(ext_idx!==-1){var ext=filename.slice(ext_idx);if(by_ext[ext]){if(by_ext[ext](filename)!==false){did_reload=true}}}for(var ii=0;ii<by_match.length;++ii){if(filename.match(by_match[ii][0])){if(by_match[ii][1](filename)!==false){did_reload=true}}}if(message_cb&&did_reload){message_cb("Reloading: "+filename)}}function filewatchTriggerChange(filename){onFileChange(filename)}function filewatchStartup(client){client.onMsg("filewatch",onFileChange)}


},{"assert":undefined}],15:[function(require,module,exports){
"use strict";exports.intColorFromVec4Color=intColorFromVec4Color;exports.vec4ColorFromIntColor=vec4ColorFromIntColor;exports.style=style;exports.styleColored=styleColored;exports.styleAlpha=styleAlpha;exports.create=create;exports.glov_font_default_style=exports.font_shaders=exports.ALIGN=exports.COLOR_MODE=void 0;var assert=require("assert");var camera2d=require("./camera2d.js");var floor=Math.floor,max=Math.max,round=Math.round;var shaders=require("./shaders.js");var sprites=require("./sprites.js");var textures=require("./textures.js");var _require=require("../../common/util.js"),clamp=_require.clamp;var _require2=require("./vmath.js"),vec4=_require2.vec4,v4clone=_require2.v4clone,v4scale=_require2.v4scale;var COLOR_MODE={SINGLE:0,GRADIENT:1};exports.COLOR_MODE=COLOR_MODE;var ALIGN={HLEFT:0,HCENTER:1,HRIGHT:2,HMASK:3,VTOP:0<<2,VCENTER:1<<2,VBOTTOM:2<<2,VMASK:3<<2,HFIT:1<<4,HWRAP:1<<5,HCENTERFIT:1|1<<4,HVCENTER:1|1<<2,HVCENTERFIT:1|1<<2|1<<4};exports.ALIGN=ALIGN;function GlovFontStyle(){this.color_vec4=vec4(1,1,1,1)}GlovFontStyle.prototype.outline_width=0;GlovFontStyle.prototype.outline_color=0;GlovFontStyle.prototype.glow_xoffs=0;GlovFontStyle.prototype.glow_yoffs=0;GlovFontStyle.prototype.glow_inner=0;GlovFontStyle.prototype.glow_outer=0;GlovFontStyle.prototype.glow_color=0;GlovFontStyle.prototype.color=4294967295;GlovFontStyle.prototype.colorUR=0;GlovFontStyle.prototype.colorLR=0;GlovFontStyle.prototype.colorLL=0;GlovFontStyle.prototype.color_mode=COLOR_MODE.SINGLE;var font_shaders={};exports.font_shaders=font_shaders;function intColorFromVec4Color(v){return(v[0]*255|0)<<24|(v[1]*255|0)<<16|(v[2]*255|0)<<8|(v[3]*255|0)}function vec4ColorFromIntColor(v,c){v[0]=(c>>24&255)/255;v[1]=(c>>16&255)/255;v[2]=(c>>8&255)/255;v[3]=(c&255)/255}var glov_font_default_style=new GlovFontStyle;exports.glov_font_default_style=glov_font_default_style;function style(font_style,fields){var ret=new GlovFontStyle;var color_vec4=ret.color_vec4;if(font_style){for(var f in font_style){ret[f]=font_style[f]}}for(var _f in fields){ret[_f]=fields[_f]}ret.color_vec4=color_vec4;vec4ColorFromIntColor(ret.color_vec4,ret.color);return ret}function styleColored(font_style,color){return style(font_style,{color:color})}function colorAlpha(color,alpha){alpha=clamp(round((color&255)*alpha),0,255);return color&4294967040|alpha}function styleAlpha(font_style,alpha){return style(font_style,{color:colorAlpha((font_style||glov_font_default_style).color,alpha),outline_color:colorAlpha((font_style||glov_font_default_style).outline_color,alpha),glow_color:colorAlpha((font_style||glov_font_default_style).glow_color,alpha)})}var tech_params=null;var tech_params_dirty=false;var temp_color=null;function createTechniqueParameters(){if(tech_params){return}tech_params={param0:vec4(),outlineColor:vec4(),glowColor:vec4(),glowParams:vec4(),tex0:null};if(!temp_color){temp_color=vec4()}}function techParamsSet(param,value){var tpv=tech_params[param];if(!tech_params_dirty){if(tpv[0]!==value[0]||tpv[1]!==value[1]||tpv[2]!==value[2]||tpv[3]!==value[3]){tech_params={param0:v4clone(tech_params.param0),outlineColor:v4clone(tech_params.outlineColor),glowColor:v4clone(tech_params.glowColor),glowParams:v4clone(tech_params.glowParams)};tech_params_dirty=true;tpv=tech_params[param]}else{return}}if(tech_params_dirty){tpv[0]=value[0];tpv[1]=value[1];tpv[2]=value[2];tpv[3]=value[3]}}function techParamsGet(){tech_params_dirty=false;return tech_params}function GlovFont(font_info,texture_name){assert(font_info.font_size!==0);this.texture=textures.load({url:"img/"+texture_name+".png",filter_min:font_info.noFilter?gl.NEAREST:gl.LINEAR,filter_mag:font_info.noFilter?gl.NEAREST:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE});this.textures=[this.texture];this.font_info=font_info;this.shader=font_shaders.font_aa;this.tex_w=font_info.imageW;this.tex_h=font_info.imageH;for(var ii=0;ii<font_info.char_infos.length;++ii){var char_info=font_info.char_infos[ii];char_info.scale=1/(char_info.sc||1);char_info.w=char_info.w||0}this.char_infos=[];for(var _ii=0;_ii<font_info.char_infos.length;++_ii){var _char_info=font_info.char_infos[_ii];this.char_infos[font_info.char_infos[_ii].c]=_char_info;_char_info.xpad=_char_info.xpad||0;_char_info.yoffs=_char_info.yoffs||0}this.replacement_character=this.infoFromChar(65533);if(!this.replacement_character){this.replacement_character=this.infoFromChar(63)}this.default_style=new GlovFontStyle;this.applied_style=new GlovFontStyle;createTechniqueParameters()}GlovFont.prototype.drawSizedColor=function(style,x,y,z,size,color,text){return this.drawSized(styleColored(style,color),x,y,z,size,text)};GlovFont.prototype.drawSized=function(style,x,y,z,size,text){return this.drawScaled(style,x,y,z,size/this.font_info.font_size,size/this.font_info.font_size,text)};GlovFont.prototype.drawSizedAligned=function(style,_x,_y,z,size,align,w,h,text){var x_size=size;var y_size=size;var width=this.getStringWidth(style,x_size,text);if(align&ALIGN.HFIT&&width>w){var scale=w/width;x_size*=scale;width=w;if(scale<.5){if((align&ALIGN.VMASK)!==ALIGN.VCENTER&&(align&ALIGN.VMASK)!==ALIGN.VBOTTOM){_y+=(y_size-y_size*scale*2)/2}y_size*=scale*2}}var height=y_size;var x;var y;switch(align&ALIGN.HMASK){case ALIGN.HCENTER:x=_x+(w-width)/2;if(this.font_info.noFilter){x|=0}break;case ALIGN.HRIGHT:x=_x+w-width;break;case ALIGN.HLEFT:x=_x;break;default:x=_x}switch(align&ALIGN.VMASK){case ALIGN.VCENTER:y=_y+(h-height)/2;if(this.font_info.noFilter){y|=0}break;case ALIGN.VBOTTOM:y=_y+h-height;break;case ALIGN.VTOP:y=_y;break;default:y=_y}return this.drawScaled(style,x,y,z,x_size/this.font_info.font_size,y_size/this.font_info.font_size,text)};GlovFont.prototype.drawSizedColorWrapped=function(style,x,y,z,w,indent,size,color,text){return this.drawScaledWrapped(styleColored(style,color),x,y,z,w,indent,size/this.font_info.font_size,size/this.font_info.font_size,text)};GlovFont.prototype.drawSizedWrapped=function(style,x,y,z,w,indent,size,text){return this.drawScaledWrapped(style,x,y,z,w,indent,size/this.font_info.font_size,size/this.font_info.font_size,text)};GlovFont.prototype.wrapLines=function(w,indent,size,text,word_cb){return this.wrapLinesScaled(w,indent,size/this.font_info.font_size,text,word_cb)};GlovFont.prototype.numLines=function(style,w,indent,size,text){this.applyStyle(style);var numlines=0;function wordCallback(ignored,linenum,word){numlines=max(numlines,linenum)}this.wrapLines(w,indent,size,text,wordCallback);return numlines+1};GlovFont.prototype.infoFromChar=function(c){var ret=this.char_infos[c];if(ret){return ret}if(c>127){return this.replacement_character}return null};GlovFont.prototype.getCharacterWidth=function(style,x_size,c){assert.equal(typeof c,"number");this.applyStyle(style);var char_info=this.infoFromChar(c);var xsc=x_size/this.font_info.font_size;var x_advance=this.calcXAdvance(xsc);if(char_info){return(char_info.w+char_info.xpad)*xsc*char_info.scale+x_advance}return 0};GlovFont.prototype.getStringWidth=function(style,x_size,text){this.applyStyle(style);var ret=0;var xsc=x_size/this.font_info.font_size;var x_advance=this.calcXAdvance(xsc);for(var ii=0;ii<text.length;++ii){var c=text.charCodeAt(ii);var char_info=this.infoFromChar(c);if(!char_info){char_info=this.infoFromChar(13)}if(char_info){ret+=(char_info.w+char_info.xpad)*xsc*char_info.scale+x_advance}}return ret};GlovFont.prototype.wrapLinesScaled=function(w,indent,xsc,text,word_cb){var len=text.length;var s=0;var word_start=0;var word_x0=0;var x=word_x0;var linenum=0;var space_info=this.infoFromChar(32);var space_size=(space_info?space_info.w+space_info.xpad:this.font_info.font_size)*xsc;var hard_wrap=false;var x_advance=this.calcXAdvance(xsc);do{var c=s<len?text.charCodeAt(s)||65533:0;var newx=x;var char_w=void 0;var char_info=this.infoFromChar(c);if(!char_info){char_info=this.infoFromChar(10)}if(char_info){char_w=(char_info.w+char_info.xpad)*xsc*char_info.scale+x_advance;newx=x+char_w}if(newx>=w&&hard_wrap){if(word_cb){word_cb(word_x0,linenum,text.slice(word_start,s))}word_start=s;word_x0=indent;x=word_x0+char_w;linenum++}else{x=newx}if(!(c===32||c===0||c===10||c===9)){s++;c=s<len?text.charCodeAt(s)||65533:0}if(c===32||c===0||c===10||c===9){hard_wrap=false;if(x>w){var word_width=x-word_x0;if(word_width>w-indent){hard_wrap=true;s=word_start;x=word_x0;continue}else{word_x0=indent;x=word_x0+word_width;linenum++}}if(word_cb){word_cb(word_x0,linenum,text.slice(word_start,s))}word_start=s+1;if(c===10){x=indent;linenum++}else if(c===9){var tabsize=xsc*this.font_info.font_size*2;x=(floor(x/tabsize)+1)*tabsize}else{x+=space_size}word_x0=x;if(c===32||c===10||c===9){s++}}}while(s<len);++linenum;return linenum};GlovFont.prototype.drawScaledWrapped=function(style,x,y,z,w,indent,xsc,ysc,text){var _this=this;if(text===null||text===undefined){text="(null)"}this.applyStyle(style);this.last_width=0;var num_lines=this.wrapLinesScaled(w,indent,xsc,text,function(xoffs,linenum,word){var y2=y+_this.font_info.font_size*ysc*linenum;var x2=x+xoffs;var word_w=_this.drawScaled(style,x2,y2,z,xsc,ysc,word);_this.last_width=max(_this.last_width,xoffs+word_w)});return num_lines*this.font_info.font_size*ysc};GlovFont.prototype.calcXAdvance=function(xsc){var font_texel_scale=this.font_info.font_size/32;var x_advance=xsc*font_texel_scale*max(this.applied_style.outline_width-2,0);x_advance=max(x_advance,xsc*font_texel_scale*max(this.applied_style.glow_outer-this.applied_style.glow_xoffs-3,0));return x_advance};GlovFont.prototype.drawScaled=function(style,_x,y,z,xsc,ysc,text){var x=_x;assert(isFinite(x));assert(isFinite(y));assert(isFinite(z));var font_info=this.font_info;y+=(font_info.y_offset||0)*ysc;var texs=this.textures;if(text===null||text===undefined){text="(null)"}var len=text.length;if(xsc===0||ysc===0){return 0}this.applyStyle(style);var avg_scale_font=(xsc+ysc)*.5;var camera_xscale=camera2d.data[4];var camera_yscale=camera2d.data[5];var avg_scale_combined=(xsc*camera_xscale+ysc*camera_yscale)*.5;var x_advance=this.calcXAdvance(xsc);var font_texel_scale=font_info.font_size/32;var tile_state=0;var applied_style=this.applied_style;var delta_per_source_pixel=.5/font_info.spread;var delta_per_dest_pixel=delta_per_source_pixel/avg_scale_combined;var value=vec4(1/delta_per_dest_pixel,-.5/delta_per_dest_pixel+.5,-.5/delta_per_dest_pixel+.5+applied_style.outline_width*font_texel_scale*avg_scale_combined,0);if(value[2]>0){value[2]=0}var padding1=max(0,applied_style.outline_width*font_texel_scale*avg_scale_font);var padding4=vec4();var outer_scaled=applied_style.glow_outer*font_texel_scale;padding4[0]=max(outer_scaled*xsc-applied_style.glow_xoffs*font_texel_scale*xsc,padding1);padding4[2]=max(outer_scaled*xsc+applied_style.glow_xoffs*font_texel_scale*xsc,padding1);padding4[1]=max(outer_scaled*ysc-applied_style.glow_yoffs*font_texel_scale*ysc,padding1);padding4[3]=max(outer_scaled*ysc+applied_style.glow_yoffs*font_texel_scale*ysc,padding1);techParamsSet("param0",value);var value2=vec4(0,0,1/((applied_style.glow_outer-applied_style.glow_inner)*delta_per_source_pixel*font_texel_scale),-(.5-applied_style.glow_outer*delta_per_source_pixel*font_texel_scale)/((applied_style.glow_outer-applied_style.glow_inner)*delta_per_source_pixel*font_texel_scale));if(value2[3]>0){value2[3]=0}var padding_in_font_space=vec4();v4scale(padding_in_font_space,padding4,1/avg_scale_font);for(var ii=0;ii<4;++ii){if(padding_in_font_space[ii]>font_info.spread){var sc=font_info.spread/padding_in_font_space[ii];padding4[ii]*=sc;padding_in_font_space[ii]*=sc}}var z_advance=applied_style.glow_xoffs<0?-1e-4:1e-4;var rel_x_scale=xsc/avg_scale_font;var rel_y_scale=ysc/avg_scale_font;for(var i=0;i<len;i++){var c=text.charCodeAt(i);if(c===9){var tabsize=xsc*font_info.font_size*4;x=(((x-_x)/tabsize|0)+1)*tabsize+_x}else{var char_info=this.infoFromChar(c);if(!char_info){char_info=this.infoFromChar(13)}if(char_info){var char_scale=char_info.scale;var xsc2=xsc*char_scale;if(char_info.w){var ysc2=ysc*char_scale;var pad_scale=1/char_scale;var tile_width=this.tex_w;var tile_height=this.tex_h;if(char_scale!==tile_state){value2[0]=-applied_style.glow_xoffs*font_texel_scale*pad_scale/tile_width;value2[1]=-applied_style.glow_yoffs*font_texel_scale*pad_scale/tile_height;techParamsSet("glowParams",value2)}var u0=(char_info.x0-padding_in_font_space[0]*pad_scale)/tile_width;var u1=(char_info.x0+char_info.w+padding_in_font_space[2]*pad_scale)/tile_width;var v0=(char_info.y0-padding_in_font_space[1]*pad_scale)/tile_height;var v1=(char_info.y0+char_info.h+padding_in_font_space[3]*pad_scale)/tile_height;var w=char_info.w*xsc2+(padding4[0]+padding4[2])*rel_x_scale;var h=char_info.h*ysc2+(padding4[1]+padding4[3])*rel_y_scale;sprites.queueraw(texs,x-rel_x_scale*padding4[0],y-rel_y_scale*padding4[2]+char_info.yoffs*ysc2,z+z_advance*i,w,h,u0,v0,u1,v1,applied_style.color_vec4,this.shader,techParamsGet())}x+=(char_info.w+char_info.xpad)*xsc2+x_advance}}}return x-_x};GlovFont.prototype.determineShader=function(){var outline=this.applied_style.outline_width&&this.applied_style.outline_color&255;var glow=this.applied_style.glow_outer>0&&this.applied_style.glow_color&255;if(outline){if(glow){this.shader=font_shaders.font_aa_outline_glow}else{this.shader=font_shaders.font_aa_outline}}else if(glow){this.shader=font_shaders.font_aa_glow}else{this.shader=font_shaders.font_aa}};GlovFont.prototype.applyStyle=function(style){if(!style){style=this.default_style}vec4ColorFromIntColor(temp_color,style.outline_color);techParamsSet("outlineColor",temp_color);vec4ColorFromIntColor(temp_color,style.glow_color);techParamsSet("glowColor",temp_color);this.applied_style.outline_width=style.outline_width;this.applied_style.outline_color=style.outline_color;this.applied_style.glow_xoffs=style.glow_xoffs;this.applied_style.glow_yoffs=style.glow_yoffs;this.applied_style.glow_inner=style.glow_inner;this.applied_style.glow_outer=style.glow_outer;this.applied_style.glow_color=style.glow_color;this.applied_style.color=style.color;this.applied_style.color_vec4=style.color_vec4;this.applied_style.colorUR=style.colorUR;this.applied_style.colorLR=style.colorLR;this.applied_style.colorLL=style.colorLL;this.applied_style.color_mode=style.color_mode;if(this.applied_style.color_mode===COLOR_MODE.SINGLE){this.applied_style.colorUR=this.applied_style.colorLL=this.applied_style.colorLR=this.applied_style.color}this.determineShader()};GlovFont.prototype.COLOR_MODE=COLOR_MODE;GlovFont.prototype.ALIGN=ALIGN;GlovFont.prototype.style=style;GlovFont.prototype.styleAlpha=styleAlpha;GlovFont.prototype.styleColored=styleColored;function fontShadersInit(){if(font_shaders.font_aa){return}font_shaders.font_aa=shaders.create("glov/shaders/font_aa.fp");font_shaders.font_aa_glow=shaders.create("glov/shaders/font_aa_glow.fp");font_shaders.font_aa_outline=shaders.create("glov/shaders/font_aa_outline.fp");font_shaders.font_aa_outline_glow=shaders.create("glov/shaders/font_aa_outline_glow.fp")}function create(font_info,texture_name){fontShadersInit();return new GlovFont(font_info,texture_name)}


},{"../../common/util.js":70,"./camera2d.js":6,"./shaders.js":40,"./sprites.js":43,"./textures.js":45,"./vmath.js":49,"assert":undefined}],16:[function(require,module,exports){
"use strict";exports.temporaryTextureClaim=temporaryTextureClaim;exports.framebufferCapture=framebufferCapture;exports.framebufferStart=framebufferStart;exports.framebufferEnd=framebufferEnd;exports.framebufferTopOfFrame=framebufferTopOfFrame;exports.framebufferEndOfFrame=framebufferEndOfFrame;exports.framebufferUpdateCanvasForCapture=framebufferUpdateCanvasForCapture;exports.copyCanvasToClipboard=copyCanvasToClipboard;var assert=require("assert");var _require=require("./browser.js"),is_ios=_require.is_ios;var _require2=require("./cmds.js"),cmd_parse=_require2.cmd_parse;var _require3=require("./effects.js"),applyCopy=_require3.applyCopy;var engine=require("./engine.js");var renderWidth=engine.renderWidth,renderHeight=engine.renderHeight;var perf=require("./perf.js");var settings=require("./settings.js");var textures=require("./textures.js");var last_num_passes=0;var num_passes=0;var temporary_textures={};var temporary_depthbuffers={};var reset_fbos=false;function resetFBOs(){reset_fbos=true}var last_temp_idx=0;function getTemporaryTexture(w,h,possibly_fbo){var key=w+"_"+h;var is_fbo=possibly_fbo&&settings.use_fbos;if(is_fbo){key+="_fbo"}var temp=temporary_textures[key];if(!temp){temp=temporary_textures[key]={list:[],idx:0}}if(temp.idx>=temp.list.length){var _tex=textures.createForCapture("temp_"+key+"_"+ ++last_temp_idx);if(is_fbo){_tex.allocFBO(w,h)}temp.list.push(_tex)}var tex=temp.list[temp.idx++];return tex}function bindTemporaryDepthbuffer(w,h){var key=w+"_"+h;var temp=temporary_depthbuffers[key];if(!temp){temp=temporary_depthbuffers[key]={list:[],idx:0}}if(temp.idx>=temp.list.length){var _depth_buffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,_depth_buffer);var _attachment;if(settings.fbo_depth16){gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,w,h);_attachment=gl.DEPTH_ATTACHMENT}else{gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,w,h);_attachment=gl.DEPTH_STENCIL_ATTACHMENT}gl.bindRenderbuffer(gl.RENDERBUFFER,null);temp.list.push({depth_buffer:_depth_buffer,attachment:_attachment})}var _temp$list$temp$idx=temp.list[temp.idx++],depth_buffer=_temp$list$temp$idx.depth_buffer,attachment=_temp$list$temp$idx.attachment;gl.framebufferRenderbuffer(gl.FRAMEBUFFER,attachment,gl.RENDERBUFFER,depth_buffer)}function temporaryTextureClaim(tex){for(var key in temporary_textures){var temp=temporary_textures[key];var idx=temp.list.indexOf(tex);if(idx!==-1){temp.list.splice(idx,1);if(temp.idx>idx){--temp.idx}return}}assert(false)}function framebufferCaptureStart(tex,w,h,possibly_fbo){assert.equal(engine.viewport[0],0);assert.equal(engine.viewport[1],0);if(!w){w=renderWidth();h=renderHeight()}if(!tex){tex=getTemporaryTexture(w,h,possibly_fbo)}tex.captureStart(w,h);return tex}function framebufferCapture(tex,w,h,filter_linear,wrap){tex=framebufferCaptureStart(tex,w,h,false);tex.captureEnd(filter_linear,wrap);return tex}var cur_tex;function framebufferStart(opts){assert(!cur_tex);var width=opts.width,height=opts.height,viewport=opts.viewport,final=opts.final,clear=opts.clear,need_depth=opts.need_depth,clear_all=opts.clear_all,clear_color=opts.clear_color,force_tex=opts.force_tex;++num_passes;if(force_tex){assert(viewport);cur_tex=force_tex;cur_tex.captureStart()}else if(!final){cur_tex=framebufferCaptureStart(null,width,height,true);if(settings.use_fbos){if(need_depth){bindTemporaryDepthbuffer(width,height)}else{}}}if(clear_color){gl.clearColor(clear_color[0],clear_color[1],clear_color[2],clear_color[3])}if(clear&&clear_all){gl.disable(gl.SCISSOR_TEST);gl.clear(gl.COLOR_BUFFER_BIT|(need_depth?gl.DEPTH_BUFFER_BIT:0))}var need_scissor;if(viewport){engine.setViewport(viewport);need_scissor=viewport[0]||viewport[1]||viewport[2]!==engine.width||viewport[3]!==engine.height;if(clear_all){need_scissor=false}}else{engine.setViewport([0,0,width,height]);need_scissor=width!==engine.width}if(need_scissor&&!settings.use_fbos){gl.enable(gl.SCISSOR_TEST);if(viewport){gl.scissor(viewport[0],viewport[1],viewport[2],viewport[3])}else{gl.scissor(0,0,width,height)}}else{gl.disable(gl.SCISSOR_TEST)}if(clear&&!clear_all){gl.clear(gl.COLOR_BUFFER_BIT|(need_depth?gl.DEPTH_BUFFER_BIT:0))}}function framebufferEnd(opts){assert(cur_tex);opts=opts||{};var _opts=opts,filter_linear=_opts.filter_linear,wrap=_opts.wrap;cur_tex.captureEnd(filter_linear,wrap);var ret=cur_tex;cur_tex=null;return ret}function framebufferTopOfFrame(){cur_tex=null}function framebufferEndOfFrame(){assert(!cur_tex);last_num_passes=num_passes;num_passes=0;for(var key in temporary_textures){var temp=temporary_textures[key];if(reset_fbos){temp.idx=0}while(temp.list.length>temp.idx){temp.list.pop().destroy()}if(!temp.idx){delete temporary_textures[key]}else{temp.idx=0}}for(var _key in temporary_depthbuffers){var _temp=temporary_depthbuffers[_key];if(reset_fbos){_temp.idx=0}while(_temp.list.length>_temp.idx){var _temp$list$pop=_temp.list.pop(),depth_buffer=_temp$list$pop.depth_buffer;gl.deleteRenderbuffer(depth_buffer)}if(!_temp.idx){delete temporary_depthbuffers[_key]}else{_temp.idx=0}}reset_fbos=false}function framebufferUpdateCanvasForCapture(){if(cur_tex&&settings.use_fbos){var saved_tex=cur_tex;var saved_viewport=engine.viewport.slice(0);framebufferEnd();applyCopy({source:saved_tex,final:true,viewport:saved_viewport});framebufferStart({force_tex:saved_tex,viewport:saved_viewport});return saved_tex}else{return{width:engine.viewport[2],height:engine.viewport[3]}}}var clipboard_copy_supported;function copyCanvasToClipboard(){if(clipboard_copy_supported===false){return}engine.postRender(function(){var dims=framebufferUpdateCanvasForCapture();var canvas=engine.canvas;if(dims.width!==canvas.width){canvas=document.createElement("canvas");canvas.width=dims.width;canvas.height=dims.height;var ctx=canvas.getContext("2d");ctx.drawImage(engine.canvas,0,engine.canvas.height-dims.height,dims.width,dims.height,0,0,dims.width,dims.height)}canvas.toBlob(function(blob){try{navigator.clipboard.write([new ClipboardItem({"image/png":blob})]);clipboard_copy_supported=true}catch(err){if(clipboard_copy_supported===undefined){clipboard_copy_supported=false}console.error("Error copying to clipboard:",err)}},"image/png")})}settings.register({show_passes:{label:"Show Postprocessing Passes",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},use_fbos:{label:"Use Framebuffer Objects for postprocessing",default_value:is_ios?1:0,type:cmd_parse.TYPE_INT,range:[0,1],ver:1},fbo_depth16:{label:"Use 16-bit depth buffers for offscreen rendering",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],on_change:resetFBOs},fbo_rgba:{label:"Use RGBA color buffers for offscreen rendering",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],on_change:resetFBOs}});perf.addMetric({name:"passes",show_stat:"show_passes",labels:{"passes: ":function passes(){return last_num_passes.toString()}}});


},{"./browser.js":5,"./cmds.js":8,"./effects.js":10,"./engine.js":11,"./perf.js":33,"./settings.js":39,"./textures.js":45,"assert":undefined}],17:[function(require,module,exports){
"use strict";exports.friendsGet=friendsGet;exports.isFriend=isFriend;exports.friendAdd=friendAdd;exports.friendRemove=friendRemove;exports.richPresenceSet=richPresenceSet;exports.friendsInit=friendsInit;var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse;var _require2=require("../../common/enums.js"),FRIEND_ADDED=_require2.FRIEND_ADDED,FRIEND_ADDED_AUTO=_require2.FRIEND_ADDED_AUTO,FRIEND_REMOVED=_require2.FRIEND_REMOVED,PRESENCE_ACTIVE=_require2.PRESENCE_ACTIVE,PRESENCE_INACTIVE=_require2.PRESENCE_INACTIVE,PRESENCE_OFFLINE=_require2.PRESENCE_OFFLINE;var _require3=require("./fbinstant.js"),fbGetFriends=_require3.fbGetFriends;var input=require("./input.js");var net=require("./net.js");var _require4=require("../../common/util.js"),deepEqual=_require4.deepEqual;var IDLE_TIME=6e4;var subs;var friend_list=null;function friendsGet(){return friend_list}function isFriend(user_id){return friend_list&&friend_list[user_id]&&friend_list[user_id]!==FRIEND_REMOVED}function friendAdd(user_id,cb){net.subs.getMyUserChannel().cmdParse("friend_add "+user_id,function(err,resp){if(!err){friend_list[user_id]=FRIEND_ADDED}cb(err,resp)})}function friendRemove(user_id,cb){net.subs.getMyUserChannel().cmdParse("friend_remove "+user_id,function(err,resp){if(!err){friend_list[user_id]=FRIEND_REMOVED}cb(err,resp)})}cmd_parse.register({cmd:"friend_add",help:"Add a friend",func:friendAdd});cmd_parse.register({cmd:"friend_remove",help:"Remove a friend",func:friendRemove});cmd_parse.register({cmd:"friend_list",help:"List all friends",func:function func(str,resp_func){if(!friend_list){return void resp_func("Friend list not loaded")}resp_func(null,Object.keys(friend_list).filter(function(a){return friend_list[a]!==FRIEND_REMOVED}).join(",")||"You have no friends")}});var invisible=0;cmd_parse.registerValue("invisible",{type:cmd_parse.TYPE_INT,help:"Hide rich presence information from other users",label:"Invisible",range:[0,1],get:function get(){return invisible},set:function set(v){return invisible=v}});var afk=0;cmd_parse.registerValue("afk",{type:cmd_parse.TYPE_INT,help:"Appear as idle to other users",label:"AFK",range:[0,1],get:function get(){return afk},set:function set(v){return afk=v}});function onPresence(data){var user_channel=this;user_channel.presence_data=data}var last_presence=null;var send_queued;function richPresenceSend(){if(!net.subs.loggedIn()||!last_presence||send_queued){return}send_queued=true;subs.onceConnected(function(){send_queued=false;if(!net.subs.loggedIn()||!last_presence){return}var pak=net.subs.getMyUserChannel().pak("presence_set");pak.writeInt(last_presence.active);pak.writeAnsiString(last_presence.state);pak.writeJSON(last_presence.payload);pak.send()})}function richPresenceSet(active,state,payload){active=!active||afk||Date.now()-input.inputLastTime()>IDLE_TIME?PRESENCE_INACTIVE:PRESENCE_ACTIVE;if(invisible){active=PRESENCE_OFFLINE}payload=payload||null;if(!last_presence||active!==last_presence.active||state!==last_presence.state||!deepEqual(last_presence.payload,payload)){last_presence={active:active,state:state,payload:payload};richPresenceSend()}}function friendsInit(){subs=net.subs;subs.on("login",function(){var user_channel=subs.getMyUserChannel();var user_id=subs.logged_in_username;richPresenceSend();friend_list=null;user_channel.pak("friend_list").send(function(err,pak){if(err||user_id!==subs.logged_in_username){if(pak){pak.pool()}return}friend_list={};var friend_id;while(friend_id=pak.readAnsiString()){friend_list[friend_id]=pak.readInt()}if(subs.login_credentials&&subs.login_credentials.fb){fbGetFriends(function(err,fb_friends){if(err||!fb_friends||user_id!==subs.logged_in_username){return}var to_add=[];var to_remove=[];var found={};for(var ii=0;ii<fb_friends.length;++ii){var id=fb_friends[ii];found[id]=true;if(!friend_list[id]){friend_list[id]=FRIEND_ADDED_AUTO;to_add.push(id)}}for(var _id in friend_list){if(!found[_id]&&friend_list[_id]===FRIEND_ADDED_AUTO){friend_list[_id]=FRIEND_REMOVED;to_remove.push(_id)}}if(!to_add.length&&!to_remove.length){return}var pak=user_channel.pak("friend_auto_update");for(var _ii=0;_ii<to_add.length;++_ii){pak.writeAnsiString(to_add[_ii])}pak.writeAnsiString("");for(var _ii2=0;_ii2<to_remove.length;++_ii2){pak.writeAnsiString(to_remove[_ii2])}pak.writeAnsiString("");pak.send()})}})});subs.on("logout",function(){friend_list=null});subs.onChannelMsg("user","presence",onPresence)}


},{"../../common/enums.js":66,"../../common/util.js":70,"./cmds.js":8,"./fbinstant.js":13,"./input.js":25,"./net.js":30}],18:[function(require,module,exports){
"use strict";exports.createIndices=createIndices;exports.geomResetState=geomResetState;exports.create=create;exports.createQuads=createQuads;exports.startup=startup;exports.QUADS=exports.TRIANGLE_FAN=exports.TRIANGLES=void 0;var assert=require("assert");var engine=require("./engine.js");var _require=require("./shaders.js"),MAX_SEMANTIC=_require.MAX_SEMANTIC;var ceil=Math.ceil,max=Math.max,min=Math.min;var TRIANGLES=4;exports.TRIANGLES=TRIANGLES;var TRIANGLE_FAN=6;exports.TRIANGLE_FAN=TRIANGLE_FAN;var QUADS=7;exports.QUADS=QUADS;var gl_byte_size={5120:1,5121:1,5122:2,5123:2,5126:4};var bound_geom;var bound_array_buf=null;var bound_index_buf=null;var quad_index_buf;var quad_index_buf_len=0;function deleteBuffer(handle){if(!handle){return}if(bound_array_buf===handle){gl.bindBuffer(gl.ARRAY_BUFFER,null);bound_array_buf=null}if(bound_index_buf===handle){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);bound_index_buf=null}gl.deleteBuffer(handle)}var attrib_enabled=0;function enableVertexAttribArray(bits){if(bits===attrib_enabled){return}var disable_mask=attrib_enabled&~bits;var enable_mask=~attrib_enabled&bits;attrib_enabled=bits;if(disable_mask){var n=0;do{if(disable_mask&1){gl.disableVertexAttribArray(n)}n++;disable_mask>>=1}while(disable_mask)}if(enable_mask){var _n=0;do{if(enable_mask&1){gl.enableVertexAttribArray(_n)}_n++;enable_mask>>=1}while(enable_mask)}}function getQuadIndexBuf(quad_count){assert(quad_count<=16384);if(quad_count*6>quad_index_buf_len){if(!quad_index_buf){quad_index_buf=gl.createBuffer()}else{engine.perf_state.gpu_mem.geom-=quad_index_buf_len*2}quad_index_buf_len=max(ceil(quad_index_buf_len*1.5),quad_count*6);if(bound_index_buf!==quad_index_buf){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,quad_index_buf);bound_index_buf=quad_index_buf}var arr=new Uint16Array(quad_index_buf_len);var vidx=0;for(var ii=0;ii<quad_index_buf_len;){arr[ii++]=vidx+1;arr[ii++]=vidx+3;arr[ii++]=vidx++;arr[ii++]=vidx++;arr[ii++]=vidx++;arr[ii++]=vidx++}gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,arr,gl.STATIC_DRAW);engine.perf_state.gpu_mem.geom+=quad_index_buf_len*2}return quad_index_buf}function createIndices(idxs){var ret={ibo:gl.createBuffer(),ibo_size:idxs.length};gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ret.ibo);bound_index_buf=ret.ibo;gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idxs,gl.STATIC_DRAW);engine.perf_state.gpu_mem.geom+=idxs.length*2;return ret}function formatInfo(format){if(!format.info){var stride=0;var elem_count=0;var used_attribs=0;var common_byte_size=0;for(var ii=0;ii<format.length;++ii){var fmt=format[ii];var sem=fmt[0];var gltype=fmt[1];var count=fmt[2];used_attribs|=1<<sem;var byte_size=gl_byte_size[gltype];assert(byte_size);assert(!common_byte_size||byte_size===common_byte_size);common_byte_size=byte_size;fmt[3]=fmt[3]||false;fmt[4]=byte_size;stride+=count*byte_size;elem_count+=count}format.info={stride:stride,elem_count:elem_count,used_attribs:used_attribs,common_byte_size:common_byte_size}}return format.info}function Geom(format,verts,idxs,mode){this.mode=mode||TRIANGLES;this.format=format;var info=this.format_info=formatInfo(format);this.stride=info.stride;this.used_attribs=info.used_attribs;this.vert_count=verts.length/this.format_info.elem_count;this.vert_gpu_mem=verts.length*this.format_info.common_byte_size;if(verts.length){this.vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);bound_array_buf=this.vbo;gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW);engine.perf_state.gpu_mem.geom+=this.vert_gpu_mem}this.orig_mode=mode;if(idxs){if(idxs.ibo){this.ibo=idxs.ibo;this.ibo_owned=false;this.ibo_size=idxs.ibo_size}else{this.ibo=gl.createBuffer();this.ibo_owned=true;this.ibo_size=idxs.length;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo);bound_index_buf=this.ibo;gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idxs,gl.STATIC_DRAW);engine.perf_state.gpu_mem.geom+=idxs.length*2}}else if(mode===QUADS){assert.equal(this.vert_count%4,0);var quad_count=this.vert_count/4;this.ibo=getQuadIndexBuf(quad_count);this.ibo_owned=false;this.ibo_size=quad_count*6;this.mode=TRIANGLES}else if(mode===TRIANGLE_FAN){this.mode=TRIANGLE_FAN}else{this.ibo=null;this.ibo_owned=false}}Geom.prototype.updateSub=function(offset,verts){if(bound_array_buf!==this.vbo){gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);bound_array_buf=this.vbo}gl.bufferSubData(gl.ARRAY_BUFFER,offset,verts)};Geom.prototype.update=function(verts,num_verts){assert.equal(this.ibo_owned,false);if(num_verts>this.vert_count){if(bound_geom===this){bound_geom=null}engine.perf_state.gpu_mem.geom-=this.vert_gpu_mem;deleteBuffer(this.vbo);this.vert_count=verts.length/this.format_info.elem_count;this.vert_gpu_mem=verts.length*this.format_info.common_byte_size;this.vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);bound_array_buf=this.vbo;gl.bufferData(gl.ARRAY_BUFFER,verts,gl.DYNAMIC_DRAW);engine.perf_state.gpu_mem.geom+=this.vert_gpu_mem}else{if(bound_array_buf!==this.vbo){gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo);bound_array_buf=this.vbo}gl.bufferSubData(gl.ARRAY_BUFFER,0,verts.subarray(0,num_verts*this.format_info.elem_count))}if(this.orig_mode===QUADS){var quad_count=num_verts/4;this.ibo=getQuadIndexBuf(quad_count);this.ibo_size=quad_count*6}};Geom.prototype.dispose=function(){if(this.ibo_owned){deleteBuffer(this.ibo)}this.ibo=null;deleteBuffer(this.vbo);this.vbo=null;engine.perf_state.gpu_mem.geom-=this.vert_gpu_mem;this.vert_gpu_mem=0};var bound_attribs=function(){var r=[];for(var ii=0;ii<16;++ii){r.push({vbo:null,offset:0})}return r}();function geomResetState(){bound_geom=null;bound_index_buf=null;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);bound_array_buf=null;gl.bindBuffer(gl.ARRAY_BUFFER,null);for(var ii=0;ii<MAX_SEMANTIC;++ii){gl.disableVertexAttribArray(ii)}attrib_enabled=0;for(var _ii=0;_ii<bound_attribs.length;++_ii){bound_attribs[_ii].vbo=null}}Geom.prototype.bind=function(){if(bound_geom!==this){bound_geom=this;var vbo=this.vbo;var offset=0;for(var ii=0;ii<this.format.length;++ii){var fmt=this.format[ii];var count=fmt[2];var byte_size=fmt[4];var sem=fmt[0];if(bound_attribs[sem].vbo===vbo){}else{if(bound_array_buf!==vbo){gl.bindBuffer(gl.ARRAY_BUFFER,vbo);bound_array_buf=vbo}var gltype=fmt[1];var normalized=fmt[3];gl.vertexAttribPointer(sem,count,gltype,normalized,this.stride,offset);bound_attribs[sem].vbo=bound_array_buf}offset+=count*byte_size}enableVertexAttribArray(this.used_attribs)}if(this.ibo&&bound_index_buf!==this.ibo){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo);bound_index_buf=this.ibo}};Geom.prototype.draw=function(){this.bind();if(this.ibo){gl.drawElements(this.mode,this.ibo_size,gl.UNSIGNED_SHORT,0)}else{gl.drawArrays(this.mode,0,this.vert_count)}};function GeomMultiQuads(format,verts){var format_info=formatInfo(format);var ec=format_info.elem_count;var vert_count=verts.length/ec;this.geoms=[];for(var idx=0;idx<vert_count;idx+=65536){var num_sub_verts=min(vert_count-idx,65536);var sub_data=new Uint8Array(verts.buffer,idx*ec,num_sub_verts*ec);this.geoms.push(new Geom(format,sub_data,null,QUADS))}}GeomMultiQuads.prototype.draw=function(){for(var ii=0;ii<this.geoms.length;++ii){this.geoms[ii].draw()}};GeomMultiQuads.prototype.dispose=function(){for(var ii=0;ii<this.geoms.length;++ii){this.geoms[ii].dispose()}this.geoms=null};function create(format,verts,idxs,mode){return new Geom(format,verts,idxs,mode)}function createQuads(format,verts){var format_info=formatInfo(format);assert(verts instanceof Uint8Array);var vert_count=verts.length/format_info.elem_count;if(vert_count>65536){return new GeomMultiQuads(format,verts)}return new Geom(format,verts,null,QUADS)}function startup(){}


},{"./engine.js":11,"./shaders.js":40,"assert":undefined}],19:[function(require,module,exports){
"use strict";exports.decode=decode;var charCache=new Array(128);var charFromCodePt=String.fromCodePoint||String.fromCharCode;var result=[];function decode(array){var codePt;var byte1;var buffLen=array.length;result.length=0;for(var i=0;i<buffLen;){byte1=array[i++];if(byte1<=127){codePt=byte1}else if(byte1<=223){codePt=(byte1&31)<<6|array[i++]&63}else if(byte1<=239){codePt=(byte1&15)<<12|(array[i++]&63)<<6|array[i++]&63}else if(String.fromCodePoint){codePt=(byte1&7)<<18|(array[i++]&63)<<12|(array[i++]&63)<<6|array[i++]&63}else{codePt=63;i+=3}result.push(charCache[codePt]||(charCache[codePt]=charFromCodePt(codePt)))}return result.join("")}


},{}],20:[function(require,module,exports){
"use strict";exports.getAccessorTypeFromSize=getAccessorTypeFromSize;exports.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=exports.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=exports.ATTRIBUTE_TYPE_TO_COMPONENTS=void 0;var TYPES=["SCALAR","VEC2","VEC3","VEC4"];function getAccessorTypeFromSize(size){var type=TYPES[size-1];return type||TYPES[0]}var ATTRIBUTE_TYPE_TO_COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};exports.ATTRIBUTE_TYPE_TO_COMPONENTS=ATTRIBUTE_TYPE_TO_COMPONENTS;var ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4};exports.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE;var ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};exports.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY;


},{}],21:[function(require,module,exports){
"use strict";var assert=require("assert");var _require=require("./unpack-glb-buffers.js"),unpackGLBBuffers=_require.unpackGLBBuffers;var _require2=require("./unpack-binary-json.js"),unpackBinaryJson=_require2.unpackBinaryJson;function padTo4Bytes(byteLength){return byteLength+3&~3}var decode_utf8=require("./decode-utf8.js");var _require3=require("./gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require3.ATTRIBUTE_TYPE_TO_COMPONENTS,ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=_require3.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE,ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=_require3.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY;var MAGIC_glTF=1735152710;var GLB_FILE_HEADER_SIZE=12;var GLB_CHUNK_HEADER_SIZE=8;var GLB_CHUNK_TYPE_JSON=1313821514;var GLB_CHUNK_TYPE_BIN=5130562;var LE=true;var BE=false;function GLBParser(){this.binaryByteOffset=null;this.packedJson=null;this.json=null}function parseBinary(self){var dataView=new DataView(self.glbArrayBuffer);var magic1=dataView.getUint32(0,BE);var version=dataView.getUint32(4,LE);var fileLength=dataView.getUint32(8,LE);var valid=magic1===MAGIC_glTF;if(!valid){console.warn("Invalid GLB magic string")}assert(version===2,"Invalid GLB version "+version+". Only .glb v2 supported");assert(fileLength>20);var jsonChunkLength=dataView.getUint32(12,LE);var jsonChunkFormat=dataView.getUint32(16,LE);valid=jsonChunkFormat===GLB_CHUNK_TYPE_JSON||jsonChunkFormat===0;assert(valid,"JSON chunk format "+jsonChunkFormat);var jsonChunkOffset=GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE;var jsonChunk=new Uint8Array(self.glbArrayBuffer,jsonChunkOffset,jsonChunkLength);var jsonText=decode_utf8.decode(jsonChunk);self.json=JSON.parse(jsonText);var binaryChunkStart=jsonChunkOffset+padTo4Bytes(jsonChunkLength);self.binaryByteOffset=binaryChunkStart+GLB_CHUNK_HEADER_SIZE;var binChunkFormat=dataView.getUint32(binaryChunkStart+4,LE);valid=binChunkFormat===GLB_CHUNK_TYPE_BIN||binChunkFormat===1;assert(valid,"BIN chunk format "+binChunkFormat);return{arrayBuffer:self.glbArrayBuffer,binaryByteOffset:self.binaryByteOffset,json:self.json}}function parseInternal(self){var result=parseBinary(self);self.packedJson=result.json;self.unpackedBuffers=unpackGLBBuffers(self.glbArrayBuffer,self.json,self.binaryByteOffset);self.json=unpackBinaryJson(self.json,self.unpackedBuffers)}GLBParser.prototype.parseSync=function(arrayBuffer){this.glbArrayBuffer=arrayBuffer;if(this.json===null&&this.binaryByteOffset===null){parseInternal(this)}return this};GLBParser.prototype.parse=function(arrayBuffer){return this.parseSync(arrayBuffer)};GLBParser.prototype.getApplicationData=function(key){return this.json[key]};GLBParser.prototype.getJSON=function(){return this.json};GLBParser.prototype.getArrayBuffer=function(){return this.glbArrayBuffer};GLBParser.prototype.getBinaryByteOffset=function(){return this.binaryByteOffset};GLBParser.prototype.getBufferView=function(glTFBufferView){var byteOffset=(glTFBufferView.byteOffset||0)+this.binaryByteOffset;return new Uint8Array(this.glbArrayBuffer,byteOffset,glTFBufferView.byteLength)};GLBParser.prototype.getBuffer=function(glTFAccessor){var ArrayType=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[glTFAccessor.componentType];var components=ATTRIBUTE_TYPE_TO_COMPONENTS[glTFAccessor.type];var bytesPerComponent=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[glTFAccessor.componentType];var length=glTFAccessor.count*components;var byteLength=glTFAccessor.count*components*bytesPerComponent;var glTFBufferView=this.json.bufferViews[glTFAccessor.bufferView];assert(byteLength>=0&&glTFAccessor.byteOffset+byteLength<=glTFBufferView.byteLength);var byteOffset=glTFBufferView.byteOffset+this.binaryByteOffset+glTFAccessor.byteOffset;return new ArrayType(this.glbArrayBuffer,byteOffset,length)};GLBParser.prototype.getImageData=function(glTFImage){return{typedArray:this.getBufferView(glTFImage.bufferView),mimeType:glTFImage.mimeType||"image/jpeg"}};GLBParser.prototype.getImage=function(glTFImage){var arrayBufferView=this.getBufferView(glTFImage.bufferView);var mimeType=glTFImage.mimeType||"image/jpeg";var blob=new Blob([arrayBufferView],{type:mimeType});var urlCreator=window.URL||window.webkitURL;var imageUrl=urlCreator.createObjectURL(blob);var img=new Image;img.src=imageUrl;return img};module.exports=GLBParser;GLBParser.parse=function(data){var parser=new GLBParser;return parser.parse(data)};


},{"./decode-utf8.js":19,"./gltf-type-utils.js":20,"./unpack-binary-json.js":22,"./unpack-glb-buffers.js":23,"assert":undefined}],22:[function(require,module,exports){
"use strict";exports.unpackBinaryJson=unpackBinaryJson;function parseJSONPointer(value){if(typeof value==="string"){if(value.indexOf("##/")===0){return value.slice(1)}var matches=value.match(/#\/([a-z]+)\/([0-9]+)/);if(matches){var index=parseInt(matches[2],10);return[matches[1],index]}matches=value.match(/\$\$\$([0-9]+)/);if(matches){var _index=parseInt(matches[1],10);return["accessors",_index]}}return null}function decodeJSONPointer(object,buffers){var pointer=parseJSONPointer(object);if(pointer){var field=pointer[0];var index=pointer[1];var buffer=buffers[field]&&buffers[field][index];if(buffer){return buffer}console.error("Invalid JSON pointer "+object+": #/"+field+"/"+index)}return null}function unpackJsonArraysRecursive(json,topJson,buffers,options){if(options===void 0){options={}}var object=json;var buffer=decodeJSONPointer(object,buffers);if(buffer){return buffer}if(Array.isArray(object)){return object.map(function(element){return unpackJsonArraysRecursive(element,topJson,buffers,options)})}if(object!==null&&typeof object==="object"){var newObject={};for(var key in object){newObject[key]=unpackJsonArraysRecursive(object[key],topJson,buffers,options)}return newObject}return object}function unpackBinaryJson(json,buffers,options){if(options===void 0){options={}}return unpackJsonArraysRecursive(json,json,buffers,options)}


},{}],23:[function(require,module,exports){
"use strict";exports.unpackGLBBuffers=unpackGLBBuffers;var assert=require("assert");var _require=require("./gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require.ATTRIBUTE_TYPE_TO_COMPONENTS,ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=_require.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE,ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=_require.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY;function getArrayBufferAtOffset(arrayBuffer,byteOffset){var length=arrayBuffer.byteLength-byteOffset;var binaryBuffer=new ArrayBuffer(length);var sourceArray=new Uint8Array(arrayBuffer);var binaryArray=new Uint8Array(binaryBuffer);for(var i=0;i<length;i++){binaryArray[i]=sourceArray[byteOffset+i]}return binaryBuffer}function getArrayTypeAndLength(accessor,bufferView){var ArrayType=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[accessor.componentType];var components=ATTRIBUTE_TYPE_TO_COMPONENTS[accessor.type];var bytesPerComponent=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[accessor.componentType];var length=accessor.count*components;var byteLength=accessor.count*components*bytesPerComponent;assert(byteLength>=0&&byteLength<=bufferView.byteLength);return{ArrayType:ArrayType,length:length,byteLength:byteLength}}function unpackAccessors(arrayBuffer,bufferViews,json){var accessors=json.accessors||[];var accessorBuffers=[];for(var i=0;i<accessors.length;++i){var accessor=accessors[i];assert(accessor);var bufferView=bufferViews[accessor.bufferView];if(bufferView){var _getArrayTypeAndLengt=getArrayTypeAndLength(accessor,bufferView),ArrayType=_getArrayTypeAndLengt.ArrayType,length=_getArrayTypeAndLengt.length;var array=new ArrayType(arrayBuffer,bufferView.byteOffset,length);array.accessor=accessor;accessorBuffers.push(array)}}return accessorBuffers}function unpackImages(arrayBuffer,bufferViews,json){var images=json.images||[];var imageBuffers=[];for(var i=0;i<images.length;++i){var image=images[i];assert(image);if(image.bufferView===undefined){imageBuffers.push(null);continue}var bufferView=bufferViews[image.bufferView];assert(bufferView);var array=new Uint8Array(arrayBuffer,bufferView.byteOffset,bufferView.byteLength);array.imate=image;imageBuffers.push(array)}return imageBuffers}function unpackGLBBuffers(arrayBuffer,json,binaryByteOffset){if(binaryByteOffset){arrayBuffer=getArrayBufferAtOffset(arrayBuffer,binaryByteOffset)}var bufferViews=json.bufferViews||[];for(var i=0;i<bufferViews.length;++i){var bufferView=bufferViews[i];assert(bufferView.byteLength>=0)}return{accessors:unpackAccessors(arrayBuffer,bufferViews,json),images:unpackImages(arrayBuffer,bufferViews,json)}}


},{"./gltf-type-utils.js":20,"assert":undefined}],24:[function(require,module,exports){
"use strict";exports.topOfFrame=topOfFrame;exports.on=on;exports.handle=handle;var assert=require("assert");var cbs={};function topOfFrame(){cbs={}}function on(type,code_or_pos,cb){var list=cbs[type]=cbs[type]||[];if(typeof code_or_pos==="number"){list[code_or_pos]=cb}else{list.push([code_or_pos,cb])}}function handle(type,event){var list=cbs[type];if(!list){return}switch(type){case"keydown":case"keyup":if(list[event.keyCode]){list[event.keyCode](type,event)}break;case"mouseup":case"mousedown":{var x=event.pageX;var y=event.pageY;var button=event.button;for(var ii=0;ii<list.length;++ii){var elem=list[ii];var pos=elem[0];if(x>=pos.x&&x<pos.x+pos.w&&y>=pos.y&&y<pos.y+pos.h&&(pos.button<0||pos.button===button)){elem[1](type,event);break}}}break;default:assert(false)}}


},{"assert":undefined}],25:[function(require,module,exports){
"use strict";exports.pointerLocked=pointerLocked;exports.pointerLockEnter=pointerLockEnter;exports.pointerLockExit=pointerLockExit;exports.inputLastTime=inputLastTime;exports.debugGetMouseMoveX=debugGetMouseMoveX;exports.handleTouches=handleTouches;exports.startup=startup;exports.tickInput=tickInput;exports.endFrame=endFrame;exports.tickInputInactive=tickInputInactive;exports.eatAllInput=eatAllInput;exports.eatAllKeyboardInput=eatAllKeyboardInput;exports.mousePos=mousePos;exports.mouseMoved=mouseMoved;exports.mouseWheel=mouseWheel;exports.mouseOver=mouseOver;exports.mouseDown=mouseDown;exports.mousePosIsTouch=mousePosIsTouch;exports.numTouches=numTouches;exports.keyDown=keyDown;exports.keyDownEdge=keyDownEdge;exports.keyUpEdge=keyUpEdge;exports.padGetAxes=padGetAxes;exports.padButtonDown=padButtonDown;exports.padButtonDownEdge=padButtonDownEdge;exports.padButtonUpEdge=padButtonUpEdge;exports.mouseUpEdge=mouseUpEdge;exports.mouseDownEdge=mouseDownEdge;exports.mouseConsumeClicks=mouseConsumeClicks;exports.drag=drag;exports.longPress=longPress;exports.dragDrop=dragDrop;exports.dragOver=dragOver;exports.pad_mode=exports.touch_mode=exports.PAD=exports.KEYS=exports.POINTERLOCK=exports.ANY=void 0;var assert=require("assert");var camera2d=require("./camera2d.js");var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse;var engine=require("./engine.js");var in_event=require("./in_event.js");var local_storage=require("./local_storage.js");var abs=Math.abs,max=Math.max,min=Math.min,sqrt=Math.sqrt;var pointer_lock=require("./pointer_lock.js");var _require2=require("./sound.js"),soundResume=_require2.soundResume;var _require3=require("./vmath.js"),vec2=_require3.vec2,v2add=_require3.v2add,v2copy=_require3.v2copy,v2lengthSq=_require3.v2lengthSq,v2set=_require3.v2set,v2scale=_require3.v2scale,v2sub=_require3.v2sub;var UP_EDGE=0;var UP=0;var DOWN=1;var DOWN_EDGE=2;var TOUCH_AS_MOUSE=true;var map_analog_to_dpad=true;var mouse_log=false;var ANY=-2;exports.ANY=ANY;var POINTERLOCK=-1;exports.POINTERLOCK=POINTERLOCK;var KEYS={BACKSPACE:8,TAB:9,ENTER:13,RETURN:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INS:45,DEL:46,NUMPAD_DIVIDE:111,EQUALS:187,MINUS:189,SLASH:191,TILDE:192};exports.KEYS=KEYS;(function(){for(var ii=1;ii<=12;++ii){KEYS["F"+ii]=111+ii}for(var _ii=48;_ii<=90;++_ii){KEYS[String.fromCharCode(_ii)]=_ii}})();if(typeof Proxy==="function"){exports.KEYS=KEYS=new Proxy(KEYS,{get:function get(target,prop){var ret=target[prop];assert(ret);return ret}})}var PAD={A:0,SELECT:0,B:1,CANCEL:1,X:2,Y:3,LB:4,LEFT_BUMPER:4,RB:5,RIGHT_BUMPER:5,LT:6,LEFT_TRIGGER:6,RT:7,RIGHT_TRIGGER:7,BACK:8,START:9,LEFT_STICK:10,RIGHT_STICK:11,UP:12,DOWN:13,LEFT:14,RIGHT:15,ANALOG_UP:20,ANALOG_LEFT:21,ANALOG_DOWN:22,ANALOG_RIGHT:23};exports.PAD=PAD;var pad_to_touch;var canvas;var key_state_new={};var pad_states=[];var gamepad_data=[];var mouse_pos=vec2();var last_mouse_pos=vec2();var mouse_pos_is_touch=false;var mouse_over_captured=false;var mouse_down=[];var wheel_events=[];var movement_questionable_frames=0;var MOVEMENT_QUESTIONABLE_FRAMES=2;var input_eaten_kb=false;var input_eaten_mouse=false;var touches={};var touch_mode=local_storage.getJSON("touch_mode",false);exports.touch_mode=touch_mode;var pad_mode=!touch_mode&&local_storage.getJSON("pad_mode",false);exports.pad_mode=pad_mode;cmd_parse.registerValue("mouse_log",{type:cmd_parse.TYPE_INT,range:[0,1],get:function get(){return mouse_log},set:function set(v){return mouse_log=v}});function eventTimestamp(event){if(event&&event.timeStamp){if(event.timeStamp<1e12!==engine.hrtime<1e12){return engine.hrtime}return event.timeStamp}return engine.hrtime}function TouchData(pos,touch,button,event){this.delta=vec2();this.total=0;this.cur_pos=pos.slice(0);this.start_pos=pos.slice(0);this.touch=touch;this.button=button;this.start_time=Date.now();this.dispatched=false;this.dispatched_drag=false;this.dispatched_drag_over=false;this.up_edge=0;this.down_edge=0;this.state=DOWN;this.down_time=0;this.origin_time=eventTimestamp(event)}TouchData.prototype.down=function(event,is_edge){if(is_edge){this.down_edge++}this.state=DOWN;this.origin_time=eventTimestamp(event)};var MIN_EVENT_TIME_DELTA=.01;function timeDelta(event,origin_time){var et=eventTimestamp(event);return max(et-origin_time,MIN_EVENT_TIME_DELTA)}function KeyData(){this.down_edge=0;this.origin_time=0;this.down_time=0;this.up_edge=0;this.state=UP}KeyData.prototype.keyUp=function(event){++this.up_edge;this.down_time+=timeDelta(event,this.origin_time);this.state=UP};function setMouseToMid(){v2set(mouse_pos,engine.width*.5/camera2d.domToCanvasRatio(),engine.height*.5/camera2d.domToCanvasRatio())}function pointerLocked(){return pointer_lock.isLocked()}var pointerlock_touch_id="m"+POINTERLOCK;function pointerLockEnter(when){pointer_lock.enter(when)}function onPointerLockEnter(){if(touch_mode){return}var touch_data=touches[pointerlock_touch_id];setMouseToMid();if(touch_data){v2copy(touch_data.start_pos,mouse_pos);touch_data.state=DOWN;touch_data.origin_time=engine.hrtime}else{touch_data=touches[pointerlock_touch_id]=new TouchData(mouse_pos,false,POINTERLOCK,null)}movement_questionable_frames=MOVEMENT_QUESTIONABLE_FRAMES}function pointerLockExit(){var touch_data=touches[pointerlock_touch_id];if(touch_data){v2copy(touch_data.cur_pos,mouse_pos);touch_data.state=UP}pointer_lock.exit();movement_questionable_frames=MOVEMENT_QUESTIONABLE_FRAMES}var last_event;var skip={isTrusted:1,sourceCapabilities:1,path:1,currentTarget:1,view:1};function eventlog(event){if(event===last_event){return}last_event=event;var pairs=[];for(var k in event){var v=event[k];if(!v||typeof v==="function"||k.toUpperCase()===k||skip[k]){continue}pairs.push(k+":"+(v.id||v))}console.log(engine.frame_index+" "+event.type+" "+(pointerLocked()?"ptrlck":"unlckd")+" "+pairs.join(","))}function letEventThrough(event){return event.target&&(event.target.tagName==="INPUT"||event.target.tagName==="TEXTAREA"||event.target.tagName==="LABEL"||String(event.target.className).indexOf("noglov")!==-1)}function ignored(event){if(!letEventThrough(event)){event.preventDefault();event.stopPropagation()}}var ctrl_checked=false;var unload_protected=false;function beforeUnload(e){if(unload_protected&&ctrl_checked){pointerLockExit();e.preventDefault();e.returnValue="Are you sure you want to quit?"}else{engine.releaseCanvas()}}function protectUnload(enable){unload_protected=enable}var last_input_time=0;function inputLastTime(){return last_input_time}function onUserInput(){soundResume();last_input_time=Date.now()}function onKeyUp(event){protectUnload(event.ctrlKey);var code=event.keyCode;if(!letEventThrough(event)){event.stopPropagation();event.preventDefault()}if(code===KEYS.ESC&&pointerLocked()){pointerLockExit()}var ks=key_state_new[code];if(ks&&ks.state===DOWN){ks.keyUp(event)}in_event.handle("keyup",event)}function onKeyDown(event){protectUnload(event.ctrlKey);var code=event.keyCode;var no_stop=letEventThrough(event)||code>=KEYS.F5&&code<=KEYS.F12||code===KEYS.I&&(event.altKey&&event.metaKey||event.ctrlKey&&event.shiftKey);if(!no_stop){event.stopPropagation();event.preventDefault()}onUserInput();var ks=key_state_new[code];if(!ks){ks=key_state_new[code]=new KeyData}if(ks.state!==DOWN){++ks.down_edge;ks.state=DOWN;ks.origin_time=eventTimestamp(event);in_event.handle("keydown",event)}}var mouse_move_x=0;function debugGetMouseMoveX(){var ret=mouse_move_x;mouse_move_x=0;return ret}var mouse_moved=false;var temp_delta=vec2();var last_abs_move=0;var last_abs_move_time=0;function onMouseMove(event,no_stop){if(!letEventThrough(event)&&!no_stop&&event.button!==3){event.preventDefault();event.stopPropagation();if(touch_mode){local_storage.setJSON("touch_mode",false);exports.touch_mode=touch_mode=false}if(pad_mode){local_storage.setJSON("pad_mode",false);exports.pad_mode=pad_mode=false}}mouse_moved=true;mouse_pos[0]=event.pageX;mouse_pos[1]=event.pageY;mouse_pos_is_touch=false;mouse_move_x+=event.movementX||0;var any_movement=false;if(pointerLocked()){setMouseToMid();if(event.movementX||event.movementY){var ts=event.timeStamp||Date.now();var abs_move=abs(event.movementX)+abs(event.movementY);if(abs_move>200&&(abs_move>3*last_abs_move||ts-last_abs_move_time>1e3)){console.log("Ignoring mousemove with sudden large delta: "+event.movementX+","+event.movementY)}else{v2set(temp_delta,event.movementX||0,event.movementY||0);any_movement=true}last_abs_move=abs_move;last_abs_move_time=ts}}else{v2sub(temp_delta,mouse_pos,last_mouse_pos);if(temp_delta[0]||temp_delta[1]){any_movement=true}v2copy(last_mouse_pos,mouse_pos)}if(any_movement&&movement_questionable_frames&&v2lengthSq(temp_delta)>100*100){any_movement=false}if(any_movement){for(var button=POINTERLOCK;button<mouse_down.length;++button){if(mouse_down[button]||button===POINTERLOCK&&pointerLocked()){var touch_data=touches["m"+button];if(touch_data){v2add(touch_data.delta,touch_data.delta,temp_delta);touch_data.total+=abs(temp_delta[0])+abs(temp_delta[1]);v2copy(touch_data.cur_pos,mouse_pos)}}}}}function onMouseDown(event){if(mouse_log){eventlog(event)}onMouseMove(event);onUserInput();var no_click=letEventThrough(event);var button=event.button;mouse_down[button]=true;var touch_id="m"+button;if(touches[touch_id]){v2copy(touches[touch_id].start_pos,mouse_pos)}else{touches[touch_id]=new TouchData(mouse_pos,false,button,event)}touches[touch_id].down(event,!no_click);if(!no_click){in_event.handle("mousedown",event)}if(window.focus){window.focus()}}function onMouseUp(event){if(mouse_log){eventlog(event)}onMouseMove(event);var no_click=letEventThrough(event);var button=event.button;if(mouse_down[button]){var touch_id="m"+button;var touch_data=touches[touch_id];if(touch_data){v2copy(touch_data.cur_pos,mouse_pos);if(!no_click){touch_data.up_edge++}touch_data.state=UP;touch_data.down_time+=timeDelta(event,touch_data.origin_time)}delete mouse_down[button]}if(!no_click){in_event.handle("mouseup",event)}}function onWheel(event){onMouseMove(event,true);var delta=-event.deltaY||event.wheelDelta||-event.detail;wheel_events.push({pos:[event.pageX,event.pageY],delta:delta>0?1:-1,dispatched:false})}var touch_pos=vec2();var released_touch_id=0;function onTouchChange(event){onUserInput();if(!touch_mode){local_storage.set("touch_mode",true);exports.touch_mode=touch_mode=true}if(pad_mode){local_storage.set("pad_mode",false);exports.pad_mode=pad_mode=false}if(event.cancelable!==false){event.preventDefault()}var ct=event.touches;var seen={};var new_count=ct.length;var old_count=new_count;for(var ii=0;ii<new_count;++ii){var touch=ct[ii];var last_touch=touches[touch.identifier];v2set(touch_pos,touch.pageX,touch.pageY);if(!last_touch){last_touch=touches[touch.identifier]=new TouchData(touch_pos,true,0,event);last_touch.down(event,true);--old_count;in_event.handle("mousedown",touch)}else{v2sub(temp_delta,touch_pos,last_touch.cur_pos);v2add(last_touch.delta,last_touch.delta,temp_delta);last_touch.total+=abs(temp_delta[0])+abs(temp_delta[1]);v2copy(last_touch.cur_pos,touch_pos)}seen[touch.identifier]=true;if(TOUCH_AS_MOUSE&&new_count===1){v2copy(mouse_pos,touch_pos);mouse_pos_is_touch=true}}var released_touch;var released_ids=[];for(var id in touches){if(!seen[id]){var _touch=touches[id];if(_touch.touch&&_touch.state===DOWN){++old_count;released_touch=_touch;released_ids.push(id);in_event.handle("mouseup",{pageX:_touch.cur_pos[0],pageY:_touch.cur_pos[1]});_touch.up_edge++;_touch.state=UP;_touch.down_time+=timeDelta(event,_touch.origin_time);_touch.release=true}}}for(var _ii2=0;_ii2<released_ids.length;++_ii2){var _id=released_ids[_ii2];var _touch2=touches[_id];var new_id="r"+ ++released_touch_id;delete touches[_id];touches[new_id]=_touch2}if(TOUCH_AS_MOUSE){if(old_count===1&&new_count===0){delete mouse_down[0];v2copy(mouse_pos,released_touch.cur_pos);mouse_pos_is_touch=true}else if(new_count===1){var _touch3=ct[0];if(!old_count){mouse_down[0]=true}v2set(mouse_pos,_touch3.pageX,_touch3.pageY);mouse_pos_is_touch=true}else if(new_count>1){delete mouse_down[0]}}}function onBlurOrFocus(evt){protectUnload(false);for(var code in key_state_new){var ks=key_state_new[code];if(ks.state===DOWN){ks.keyUp(evt)}}}var ANALOG_MAP={};function genAnalogMap(){if(map_analog_to_dpad){ANALOG_MAP[PAD.LEFT]=PAD.ANALOG_LEFT;ANALOG_MAP[PAD.RIGHT]=PAD.ANALOG_RIGHT;ANALOG_MAP[PAD.UP]=PAD.ANALOG_UP;ANALOG_MAP[PAD.DOWN]=PAD.ANALOG_DOWN}}var passive_param=false;function handleTouches(elem){elem.addEventListener("touchstart",onTouchChange,passive_param);elem.addEventListener("touchmove",onTouchChange,passive_param);elem.addEventListener("touchend",onTouchChange,passive_param);elem.addEventListener("touchcancel",onTouchChange,passive_param)}function startup(_canvas,params){canvas=_canvas;pointer_lock.startup(canvas,onPointerLockEnter);if(params.map_analog_to_dpad!==undefined){map_analog_to_dpad=params.map_analog_to_dpad}pad_to_touch=params.pad_to_touch;genAnalogMap();try{var opts=Object.defineProperty({},"passive",{get:function get(){passive_param={passive:false};return false}});window.addEventListener("test",null,opts);window.removeEventListener("test",null,opts)}catch(e){passive_param=false}window.addEventListener("keydown",onKeyDown,false);window.addEventListener("keyup",onKeyUp,false);window.addEventListener("click",ignored,false);window.addEventListener("contextmenu",ignored,false);window.addEventListener("mousemove",onMouseMove,false);window.addEventListener("mousedown",onMouseDown,false);window.addEventListener("mouseup",onMouseUp,false);if(window.WheelEvent){window.addEventListener("wheel",onWheel,passive_param)}else{window.addEventListener("DOMMouseScroll",onWheel,false);window.addEventListener("mousewheel",onWheel,false)}window.addEventListener("blur",onBlurOrFocus,false);window.addEventListener("focus",onBlurOrFocus,false);handleTouches(canvas);window.addEventListener("beforeunload",beforeUnload,false)}var DEADZONE=.26;var DEADZONE_SQ=DEADZONE*DEADZONE;var NUM_STICKS=2;var PAD_THRESHOLD=.25;function getGamepadData(idx){var gpd=gamepad_data[idx];if(!gpd){gpd=gamepad_data[idx]={id:idx,timestamp:0,sticks:new Array(NUM_STICKS)};for(var ii=0;ii<NUM_STICKS;++ii){gpd.sticks[ii]=vec2()}pad_states[idx]={}}return gpd}function updatePadState(gpd,ps,b,padcode){if(b&&!ps[padcode]){ps[padcode]=DOWN_EDGE;if(touch_mode){local_storage.set("touch_mode",false);exports.touch_mode=touch_mode=false}if(!pad_mode){local_storage.setJSON("pad_mode",true);exports.pad_mode=pad_mode=true}if(padcode===pad_to_touch){var touch_id="g"+gpd.id;if(touches[touch_id]){setMouseToMid();v2copy(touches[touch_id].start_pos,mouse_pos)}else{touches[touch_id]=new TouchData(mouse_pos,false,0,null)}touches[touch_id].down(null,true)}}else if(!b&&ps[padcode]){ps[padcode]=UP_EDGE;if(padcode===pad_to_touch){var _touch_id="g"+gpd.id;var touch_data=touches[_touch_id];if(touch_data){setMouseToMid();v2copy(touch_data.cur_pos,mouse_pos);touch_data.up_edge++;touch_data.state=UP;touch_data.down_time+=max(engine.hrtime-touch_data.origin_time,MIN_EVENT_TIME_DELTA)}}}}function gamepadUpdate(){var gamepads=navigator.gamepads||navigator.webkitGamepads||navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(gamepads){var numGamePads=gamepads.length;for(var ii=0;ii<numGamePads;ii++){var gamepad=gamepads[ii];if(!gamepad){continue}var gpd=getGamepadData(ii);var ps=pad_states[ii];if(gpd.timestamp<gamepad.timestamp){var buttons=gamepad.buttons;gpd.timestamp=gamepad.timestamp;var numButtons=buttons.length;for(var n=0;n<numButtons;n++){var value=buttons[n];if(typeof value==="object"){value=value.value}value=value>.5;updatePadState(gpd,ps,value,n)}}var axes=gamepad.axes;if(axes.length>=NUM_STICKS*2){for(var _n=0;_n<NUM_STICKS;++_n){var pair=gpd.sticks[_n];v2set(pair,axes[_n*2],-axes[_n*2+1]);var magnitude=v2lengthSq(pair);if(magnitude>DEADZONE_SQ){magnitude=sqrt(magnitude);v2scale(pair,pair,1/magnitude);magnitude=min(magnitude,1);magnitude=(magnitude-DEADZONE)/(1-DEADZONE);v2scale(pair,pair,magnitude)}else{v2set(pair,0,0)}if(_n<=1&&pad_to_touch!==undefined){var touch_data=touches["g"+gpd.id];if(touch_data){v2scale(temp_delta,pair,engine.frame_dt);v2add(touch_data.delta,touch_data.delta,temp_delta);touch_data.total+=abs(temp_delta[0])+abs(temp_delta[1]);setMouseToMid();v2copy(touch_data.cur_pos,mouse_pos)}}}updatePadState(gpd,ps,gpd.sticks[0][0]<-PAD_THRESHOLD,PAD.ANALOG_LEFT);updatePadState(gpd,ps,gpd.sticks[0][0]>PAD_THRESHOLD,PAD.ANALOG_RIGHT);updatePadState(gpd,ps,gpd.sticks[0][1]<-PAD_THRESHOLD,PAD.ANALOG_DOWN);updatePadState(gpd,ps,gpd.sticks[0][1]>PAD_THRESHOLD,PAD.ANALOG_UP)}}}}function tickInput(){if(movement_questionable_frames){--movement_questionable_frames}var hrtime=engine.hrtime;for(var code in key_state_new){var ks=key_state_new[code];if(ks.state===DOWN){ks.down_time+=max(hrtime-ks.origin_time,MIN_EVENT_TIME_DELTA);ks.origin_time=hrtime}}for(var touch_id in touches){var touch_data=touches[touch_id];if(touch_data.state===DOWN){touch_data.down_time+=max(hrtime-touch_data.origin_time,MIN_EVENT_TIME_DELTA);touch_data.origin_time=hrtime}}mouse_over_captured=false;gamepadUpdate();in_event.topOfFrame();ctrl_checked=false;if(touches[pointerlock_touch_id]&&!pointerLocked()){pointerLockExit()}}function endFrameTickMap(map){Object.keys(map).forEach(function(keycode){switch(map[keycode]){case DOWN_EDGE:map[keycode]=DOWN;break;case UP_EDGE:delete map[keycode];break;default:}})}function endFrame(skip_mouse){for(var code in key_state_new){var ks=key_state_new[code];if(ks.state===UP){key_state_new[code]=null;delete key_state_new[code]}else{ks.up_edge=0;ks.down_edge=0;ks.down_time=0}}pad_states.forEach(endFrameTickMap);if(!skip_mouse){for(var touch_id in touches){var touch_data=touches[touch_id];if(touch_data.state===UP){touches[touch_id]=null;delete touches[touch_id]}else{touch_data.delta[0]=touch_data.delta[1]=0;touch_data.dispatched=false;touch_data.dispatched_drag=false;touch_data.dispatched_drag_over=false;touch_data.up_edge=0;touch_data.down_edge=0;touch_data.down_time=0}}wheel_events.length=0;input_eaten_mouse=false}input_eaten_kb=false;mouse_moved=false}function tickInputInactive(){in_event.topOfFrame();ctrl_checked=false;endFrame()}function eatAllInput(skip_mouse){endFrame(skip_mouse);if(!skip_mouse){mouse_over_captured=true;input_eaten_mouse=true}input_eaten_kb=true}function eatAllKeyboardInput(){eatAllInput(true)}function mousePos(dst){dst=dst||vec2();camera2d.domToVirtual(dst,mouse_pos);return dst}function mouseMoved(){return mouse_moved}function mousePosParam(param){param=param||{};return{x:param.x===undefined?camera2d.x0Real():param.x,y:param.y===undefined?camera2d.y0Real():param.y,w:param.w===undefined?camera2d.wReal():param.w,h:param.h===undefined?camera2d.hReal():param.h,button:param.button===undefined?ANY:param.button}}var check_pos=vec2();function checkPos(pos,param){if(!camera2d.domToVirtual(check_pos,pos)){return false}return check_pos[0]>=param.x&&(param.w===Infinity||check_pos[0]<param.x+param.w)&&check_pos[1]>=param.y&&(param.h===Infinity||check_pos[1]<param.y+param.h)}function mouseWheel(param){if(input_eaten_mouse||!wheel_events.length){return 0}param=param||{};var pos_param=mousePosParam(param);var ret=0;for(var ii=0;ii<wheel_events.length;++ii){var data=wheel_events[ii];if(data.dispatched){continue}if(checkPos(data.pos,pos_param)){ret+=data.delta;data.dispatched=true}}return ret}function mouseOver(param){if(mouse_over_captured||pointerLocked()&&!(param&&param.allow_pointerlock)){return false}param=param||{};var pos_param=mousePosParam(param);if(!param.peek){for(var id in touches){var touch=touches[id];if(checkPos(touch.cur_pos,pos_param)){touch.down_edge=0;touch.up_edge=0;if(!param||!param.drag_target){touch.dispatched=true}}}}if(checkPos(mouse_pos,pos_param)){if(!param.peek){mouse_over_captured=true}return true}return false}function mouseDown(param){if(input_eaten_mouse){return null}param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;var max_click_dist=param.max_dist||50;for(var touch_id in touches){var touch_data=touches[touch_id];if(touch_data.state!==DOWN||!(button===ANY||button===touch_data.button)||touch_data.total>max_click_dist){continue}if(checkPos(touch_data.cur_pos,pos_param)){return{button:touch_data.button,pos:check_pos.slice(0),start_time:touch_data.start_time}}}return null}function mousePosIsTouch(){return mouse_pos_is_touch}function numTouches(){return Object.keys(touches).length}function keyDown(keycode){if(keycode===KEYS.CTRL){ctrl_checked=true}if(input_eaten_kb){return 0}var ks=key_state_new[keycode];if(!ks){return 0}if(ks.state===DOWN){assert(ks.down_time)}return ks.down_time}function keyDownEdge(keycode,opts){if(opts&&opts.in_event_cb&&!input_eaten_kb){in_event.on("keydown",keycode,opts.in_event_cb)}var ks=key_state_new[keycode];if(!ks){return 0}var r=ks.down_edge;ks.down_edge=0;return r}function keyUpEdge(keycode,opts){if(opts&&opts.in_event_cb&&!input_eaten_kb){in_event.on("keyup",keycode,opts.in_event_cb)}var ks=key_state_new[keycode];if(!ks){return 0}var r=ks.up_edge;ks.up_edge=0;return r}function padGetAxes(out,stickindex,padindex){assert(stickindex>=0&&stickindex<NUM_STICKS);if(padindex===undefined){var sub=vec2();v2set(out,0,0);for(var ii=0;ii<gamepad_data.length;++ii){padGetAxes(sub,stickindex,ii);v2add(out,out,sub)}return}var sticks=getGamepadData(padindex).sticks;v2copy(out,sticks[stickindex])}function padButtonDownInternal(gpd,ps,padcode){if(ps[padcode]){return engine.frame_dt}return 0}function padButtonDownEdgeInternal(gpd,ps,padcode){if(ps[padcode]===DOWN_EDGE){ps[padcode]=DOWN;return engine.frame_dt}return 0}function padButtonUpEdgeInternal(gpd,ps,padcode){if(ps[padcode]===UP_EDGE){delete ps[padcode];return engine.frame_dt}return 0}function padButtonShared(fn,padcode,padindex){assert(padcode!==undefined);var r=0;if(padindex===undefined){for(var ii=0;ii<pad_states.length;++ii){r+=padButtonShared(fn,padcode,ii)}return r}if(input_eaten_mouse){return 0}var gpd=gamepad_data[padindex];if(!gpd){return 0}var ps=pad_states[padindex];r+=ANALOG_MAP[padcode]&&fn(gpd,ps,ANALOG_MAP[padcode])||0;r+=fn(gpd,ps,padcode);return r}function padButtonDown(padcode,padindex){return padButtonShared(padButtonDownInternal,padcode,padindex)}function padButtonDownEdge(padcode,padindex){return padButtonShared(padButtonDownEdgeInternal,padcode,padindex)}function padButtonUpEdge(padcode,padindex){return padButtonShared(padButtonUpEdgeInternal,padcode,padindex)}var start_pos=vec2();var cur_pos=vec2();var delta=vec2();function mouseUpEdge(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;var max_click_dist=param.max_dist||50;for(var touch_id in touches){var touch_data=touches[touch_id];if(!touch_data.up_edge){continue}if(!(button===ANY||button===touch_data.button)||touch_data.total>max_click_dist){continue}if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek){touch_data.up_edge=0}return{button:touch_data.button,pos:check_pos.slice(0),start_time:touch_data.start_time}}}if(param.in_event_cb&&!input_eaten_mouse&&!mouse_over_captured){if(!param.phys){param.phys={}}param.phys.button=typeof param.in_event_button==="number"?param.in_event_button:button;camera2d.virtualToDomPosParam(param.phys,pos_param);in_event.on("mouseup",param.phys,param.in_event_cb)}return false}exports.click=mouseUpEdge;function mouseDownEdge(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;for(var touch_id in touches){var touch_data=touches[touch_id];if(!touch_data.down_edge||!(button===ANY||button===touch_data.button)){continue}if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek){touch_data.down_edge=0}return{button:touch_data.button,pos:check_pos.slice(0),start_time:touch_data.start_time}}}if(param.in_event_cb&&!input_eaten_mouse&&!mouse_over_captured){if(!param.phys){param.phys={}}param.phys.button=button;camera2d.virtualToDomPosParam(param.phys,pos_param);in_event.on("mousedown",param.phys,param.in_event_cb)}return false}function mouseConsumeClicks(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;for(var touch_id in touches){var touch_data=touches[touch_id];if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag){continue}if(checkPos(touch_data.start_pos,pos_param)){touch_data.down_edge=0;touch_data.start_pos[0]=touch_data.start_pos[1]=Infinity;touch_data.total=Infinity}}}function drag(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;var min_dist=param.min_dist||0;for(var touch_id in touches){var touch_data=touches[touch_id];if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag){continue}if(checkPos(touch_data.start_pos,pos_param)){camera2d.domDeltaToVirtual(delta,[touch_data.total/2,touch_data.total/2]);var total=delta[0]+delta[1];if(total<min_dist){continue}if(!param.peek){touch_data.dispatched_drag=true}var is_down_edge=touch_data.down_edge;if(param.eat_clicks){touch_data.down_edge=touch_data.up_edge=0}if(param.payload){touch_data.drag_payload=param.payload}camera2d.domToVirtual(start_pos,touch_data.start_pos);camera2d.domToVirtual(cur_pos,touch_data.cur_pos);camera2d.domDeltaToVirtual(delta,touch_data.delta);return{cur_pos:cur_pos,start_pos:start_pos,delta:delta,total:total,button:touch_data.button,touch:touch_data.touch,start_time:touch_data.start_time,is_down_edge:is_down_edge,down_time:touch_data.down_time}}}return null}function longPress(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;var max_dist=param.max_dist||0;var min_time=param.min_time||500;for(var touch_id in touches){var touch_data=touches[touch_id];if(!(button===ANY||button===touch_data.button)||touch_data.long_press_dispatched){continue}if(checkPos(touch_data.start_pos,pos_param)){camera2d.domDeltaToVirtual(delta,[touch_data.total/2,touch_data.total/2]);var total=delta[0]+delta[1];if(total>max_dist){continue}var time=Date.now()-touch_data.start_time;if(time<min_time){continue}if(!param.peek){touch_data.long_press_dispatched=true}var is_down_edge=touch_data.down_edge;if(param.eat_clicks){touch_data.down_edge=touch_data.up_edge=0}camera2d.domToVirtual(start_pos,touch_data.start_pos);camera2d.domToVirtual(cur_pos,touch_data.cur_pos);camera2d.domDeltaToVirtual(delta,touch_data.delta);return{long_press:true,cur_pos:cur_pos,start_pos:start_pos,delta:delta,total:total,button:touch_data.button,touch:touch_data.touch,start_time:touch_data.start_time,is_down_edge:is_down_edge,down_time:touch_data.down_time}}}return null}function dragDrop(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;for(var touch_id in touches){var touch_data=touches[touch_id];if(!(button===ANY||button===touch_data.button)||touch_data.dispatched||!touch_data.drag_payload){continue}if(!touch_data.up_edge){continue}if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek){touch_data.dispatched_drag_over=true;touch_data.dispatched_drag=true;touch_data.dispatched=true}return{drag_payload:touch_data.drag_payload}}}return null}function dragOver(param){param=param||{};var pos_param=mousePosParam(param);var button=pos_param.button;for(var touch_id in touches){var touch_data=touches[touch_id];if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag_over||!touch_data.drag_payload){continue}if(touch_data.state!==DOWN){continue}if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek){touch_data.dispatched_drag_over=true}camera2d.domToVirtual(cur_pos,touch_data.cur_pos);return{cur_pos:cur_pos,drag_payload:touch_data.drag_payload}}}return null}


},{"./camera2d.js":6,"./cmds.js":8,"./engine.js":11,"./in_event.js":24,"./local_storage.js":27,"./pointer_lock.js":34,"./sound.js":41,"./vmath.js":49,"assert":undefined}],26:[function(require,module,exports){
"use strict";exports.link=link;exports.linkText=linkText;exports.linkTick=linkTick;var engine=require("./engine.js");var camera2d=require("./camera2d.js");var in_event=require("./in_event.js");var input=require("./input.js");var abs=Math.abs;var ui=require("./ui.js");var state_cache={};var good_url=/https?:\/\//;function link(param){var x=param.x,y=param.y,w=param.w,h=param.h,url=param.url,internal=param.internal,allow_modal=param.allow_modal;if(!url.match(good_url)){url=document.location.protocol+"//"+url}var key=x+"_"+y;var state=state_cache[key];if(!state){state=state_cache[key]={clicked:false}}state.frame=engine.frame_index;var rect={x:x,y:y,w:w,h:h};if(camera2d.clipTestRect(rect)){var elem=ui.getElem(allow_modal,state.elem);if(elem!==state.elem){state.elem=elem;if(elem){elem.textContent="";var a_elem=document.createElement("a");a_elem.setAttribute("draggable",false);a_elem.textContent=" ";a_elem.className="glovui_link noglov";a_elem.setAttribute("target","_blank");a_elem.setAttribute("href",url);state.url=url;if(internal){var down_x;var down_y;input.handleTouches(a_elem);a_elem.onmousedown=function(ev){down_x=ev.pageX;down_y=ev.pageY};a_elem.onclick=function(ev){ev.preventDefault();if(down_x){var dist=abs(ev.pageX-down_x)+abs(ev.pageY-down_y);if(dist>50){return}}state.clicked=true;in_event.handle("mouseup",ev)}}elem.appendChild(a_elem);state.a_elem=a_elem}}if(elem){if(url!==state.url){state.a_elem.setAttribute("href",url);state.url=url}var pos=camera2d.htmlPos(rect.x,rect.y);elem.style.left=pos[0]+"%";elem.style.top=pos[1]+"%";var size=camera2d.htmlSize(rect.w,rect.h);elem.style.width=size[0]+"%";elem.style.height=size[1]+"%"}}var clicked=state.clicked;state.clicked=false;return clicked}function linkText(param){var style_link=param.style_link,style_link_hover=param.style_link_hover,x=param.x,y=param.y,z=param.z,font_size=param.font_size,text=param.text,url=param.url;text=text||url;z=z||Z.UI;font_size=font_size||ui.font_height;var w=ui.font.getStringWidth(style_link,font_size,text);var h=font_size;var mouseover=input.mouseOver({x:x,y:y,w:w,h:h,peek:true})&&!input.mousePosIsTouch();var style=mouseover?style_link_hover:style_link;ui.font.drawSized(style,x,y,z,font_size,text);var underline_w=1;ui.drawLine(x,y+h-underline_w,x+w,y+h-underline_w,z-.5,underline_w,.99,style.color_vec4);param.w=w;param.h=h;return link(param)}function linkTick(){for(var key in state_cache){var state=state_cache[key];if(state.frame!==engine.frame_index-1){delete state_cache[key]}}}


},{"./camera2d.js":6,"./engine.js":11,"./in_event.js":24,"./input.js":25,"./ui.js":47}],27:[function(require,module,exports){
"use strict";exports.get=get;exports.set=set;exports.setJSON=setJSON;exports.getJSON=getJSON;exports.clearAll=clearAll;exports.exportAll=exportAll;exports.importAll=importAll;exports.storage_prefix="demo";var lsd=function(){try{localStorage.test="test";return localStorage}catch(e){return{}}}();function get(key){key=exports.storage_prefix+"_"+key;var ret=lsd[key];if(ret==="undefined"){ret=undefined}return ret}function set(key,value){key=exports.storage_prefix+"_"+key;if(value===undefined||value===null){delete lsd[key]}else{lsd[key]=value}}function setJSON(key,value){set(key,JSON.stringify(value))}function getJSON(key,def){var value=get(key);if(value===undefined){return def}try{return JSON.parse(value)}catch(e){}return def}function clearAll(key_prefix){var prefix=new RegExp("^"+exports.storage_prefix+"_"+(key_prefix||""),"u");for(var key in lsd){if(key.match(prefix)){delete lsd[key]}}}function exportAll(){var obj={};var prefix=new RegExp("^"+exports.storage_prefix+"_(.*)","u");for(var key in lsd){var m=key.match(prefix);if(m){var v=lsd[key];if(v&&v!=="undefined"){obj[m[1]]=v}}}return JSON.stringify(obj)}function importAll(serialized){var obj=JSON.parse(serialized);clearAll();for(var key in obj){set(key,obj[key])}}


},{}],28:[function(require,module,exports){
"use strict";exports.mat43=mat43;exports.m43identity=m43identity;exports.m43mul=m43mul;function mat43(){var r=new Float32Array(12);r[0]=r[4]=r[8]=1;return r}function m43identity(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;out[9]=0;out[10]=0;out[11]=0}function m43mul(out,a,b){var a0=a[0];var a1=a[1];var a2=a[2];var a3=a[3];var a4=a[4];var a5=a[5];var a6=a[6];var a7=a[7];var a8=a[8];var a9=a[9];var a10=a[10];var a11=a[11];var b0=b[0];var b1=b[1];var b2=b[2];var b3=b[3];var b4=b[4];var b5=b[5];var b6=b[6];var b7=b[7];var b8=b[8];out[0]=b0*a0+b3*a1+b6*a2;out[1]=b1*a0+b4*a1+b7*a2;out[2]=b2*a0+b5*a1+b8*a2;out[3]=b0*a3+b3*a4+b6*a5;out[4]=b1*a3+b4*a4+b7*a5;out[5]=b2*a3+b5*a4+b8*a5;out[6]=b0*a6+b3*a7+b6*a8;out[7]=b1*a6+b4*a7+b7*a8;out[8]=b2*a6+b5*a7+b8*a8;out[9]=b0*a9+b3*a10+b6*a11+b[9];out[10]=b1*a9+b4*a10+b7*a11+b[10];out[11]=b2*a9+b5*a10+b8*a11+b[11];return out}


},{}],29:[function(require,module,exports){
"use strict";exports.load=load;exports.startup=startup;exports.default_fshader=exports.default_vshader=exports.models=exports.load_count=void 0;var assert=require("assert");var geom=require("./geom.js");var glb_parser=require("./glb/parser.js");var _require=require("./glb/gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require.ATTRIBUTE_TYPE_TO_COMPONENTS;var renderer=require("./engine.js");var shaders=require("./shaders.js");var textures=require("./textures.js");var _require2=require("./vmath.js"),vec4=_require2.vec4;var _require3=require("./webfs.js"),webFSGetFile=_require3.webFSGetFile;var load_count=0;exports.load_count=load_count;var models={};exports.models=models;var default_vshader;exports.default_vshader=default_vshader;var default_fshader;exports.default_fshader=default_fshader;function initShaders(){exports.default_vshader=default_vshader=shaders.create("glov/shaders/default.vp");exports.default_fshader=default_fshader=shaders.create("glov/shaders/default.fp")}function Model(url){this.url=url;var idx=url.lastIndexOf("/");if(idx!==-1){this.base_url=url.slice(0,idx+1)}else{this.base_url=""}}Model.prototype.load=function(){var _this=this;exports.load_count=load_count=load_count+1;var xhr=new XMLHttpRequest;xhr.open("GET",this.url,true);xhr.responseType="arraybuffer";xhr.onload=function(){exports.load_count=load_count=load_count-1;try{var array_buffer=xhr.response;if((xhr.status===200||xhr.status===0)&&array_buffer){_this.parse(array_buffer)}}catch(e){window.onerror("Model loading error","models.js",0,0,e)}};xhr.send(null)};var skip_attr={TANGENT:true};Model.prototype.parse=function(glb_data){var glb=glb_parser.parse(glb_data);if(!glb){return}var glb_json=glb.getJSON();var objs=[];for(var ii=0;ii<glb_json.meshes.length;++ii){var mesh=glb_json.meshes[ii];for(var jj=0;jj<mesh.primitives.length;++jj){var primitives=mesh.primitives[jj];var material=glb_json.materials[primitives.material];var texture=null;if(material){var bct=(material.pbrMetallicRoughness||{}).baseColorTexture||{};var texture_def=glb_json.textures&&glb_json.textures[bct.index]||{};var sampler_def=glb_json.samplers&&glb_json.samplers[texture_def.sampler]||{};var image=glb_json.images&&glb_json.images[texture_def.source]||{};if(image.uri){var params={url:""+this.base_url+image.uri,filter_mag:sampler_def.magFilter,filter_min:sampler_def.minFilter,wrap_s:sampler_def.wrapS,wrap_t:sampler_def.wrapT};texture=textures.load(params)}}var format=[];var buffers=[];var bidx=[];var total_size=0;var vert_count=0;for(var attr in primitives.attributes){if(skip_attr[attr]){continue}assert(shaders.semantic[attr]!==undefined);var _accessor=glb_json.accessors[primitives.attributes[attr]];assert.equal(_accessor.componentType,5126);var geom_format=gl.FLOAT;var geom_count=ATTRIBUTE_TYPE_TO_COMPONENTS[_accessor.type];assert(geom_count);var my_vert_count=_accessor.count;if(!vert_count){vert_count=my_vert_count}else{assert.equal(vert_count,my_vert_count)}format.push([shaders.semantic[attr],geom_format,geom_count]);var buffer=glb.getBuffer(_accessor);buffers.push(buffer);bidx.push(0);total_size+=buffer.length}var verts=new Float32Array(total_size);var idx=0;for(var vert=0;vert<vert_count;++vert){for(var _attr=0;_attr<format.length;++_attr){for(var kk=0;kk<format[_attr][2];++kk){verts[idx++]=buffers[_attr][bidx[_attr]++]}}}var accessor=glb_json.accessors[primitives.indices];assert(accessor);assert.equal(accessor.type,"SCALAR");var idxs=glb.getBuffer(accessor);if(accessor.componentType===5125){assert(vert_count<65536);idxs=new Uint16Array(idxs)}else{assert.equal(accessor.componentType,5123)}objs.push({geom:geom.create(format,verts,idxs,primitives.mode),texture:texture})}}this.data={objs:objs}};Model.prototype.draw=function(mat){renderer.updateMatrices(mat);shaders.bind(default_vshader,default_fshader,{color:vec4(1,1,1,1)});var objs=this.data.objs;for(var ii=0;ii<objs.length;++ii){var obj=objs[ii];if(obj.texture){textures.bind(0,obj.texture)}obj.geom.draw()}};Model.prototype.drawGeom=function(){var objs=this.data.objs;for(var ii=0;ii<objs.length;++ii){var obj=objs[ii];obj.geom.draw()}};function load(url){if(models[url]){return models[url]}var model=models[url]=new Model(url);model.data=models.box.data;model.load();return model}function startup(){initShaders();var model_box=models.box=new Model("box");model_box.parse(webFSGetFile("glov/models/box_textured_embed.glb").buffer)}


},{"./engine.js":11,"./geom.js":18,"./glb/gltf-type-utils.js":20,"./glb/parser.js":21,"./shaders.js":40,"./textures.js":45,"./vmath.js":49,"./webfs.js":51,"assert":undefined}],30:[function(require,module,exports){
"use strict";exports.init=init;exports.buildString=buildString;var _require=require("./filewatch.js"),filewatchStartup=_require.filewatchStartup;var packet=require("../../common/packet.js");var subscription_manager=require("./subscription_manager.js");var WSClient=require("./wsclient.js").WSClient;var wscommon=require("../../common/wscommon.js");var client;var subs;function init(params){params=params||{};if(params.pver){wscommon.PROTOCOL_VERSION=params.pver}if(String(document.location).match(/^https?:\/\/localhost/)){console.log("PacketDebug: ON");packet.default_flags|=packet.PACKET_DEBUG}client=new WSClient(params.path);subs=subscription_manager.create(client,params.cmd_parse);subs.auto_create_user=Boolean(params.auto_create_user);window.subs=subs;exports.subs=subs;exports.client=client;filewatchStartup(client);if(params.engine){params.engine.addTickFunc(function(dt){client.checkDisconnect();subs.tick(dt)})}}var build_timestamp_string=new Date(Number('1609697707517')).toISOString().replace("T"," ").slice(5,-8);function buildString(){return build_timestamp_string}


},{"../../common/packet.js":68,"../../common/wscommon.js":72,"./filewatch.js":14,"./subscription_manager.js":44,"./wsclient.js":53}],31:[function(require,module,exports){
"use strict";exports.create=create;exports.createScalarInterpolator=createScalarInterpolator;var assert=require("assert");var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse;var glov_engine=require("./engine.js");var net=require("./net.js");var perf=require("./perf.js");var settings=require("./settings.js");var util=require("../../common/util.js");var _require2=require("../../common/wscommon.js"),wsstats=_require2.wsstats,wsstats_out=_require2.wsstats_out;var abs=Math.abs,floor=Math.floor,max=Math.max,min=Math.min,PI=Math.PI,sqrt=Math.sqrt;var TWO_PI=PI*2;var EPSILON=.01;var the;settings.register({show_ping:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]}});perf.addMetric({name:"ping",show_stat:"show_ping",labels:{"ping: ":function ping(){if(!the){return""}var pt=the.getPing(2e3);if(!pt||pt.fade<.001){return""}return{value:""+pt.ping.toFixed(1),alpha:min(1,pt.fade*3)}}}});settings.register({show_net:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,2]}});var last_wsstats={msgs:0,bytes:0,time:Date.now(),dm:0,db:0};var last_wsstats_out={msgs:0,bytes:0,time:Date.now(),dm:0,db:0};function bandwidth(stats,last){var now=Date.now();if(now-last.time>1e3){last.dm=stats.msgs-last.msgs;last.db=stats.bytes-last.bytes;last.msgs=stats.msgs;last.bytes=stats.bytes;if(now-last.time>2e3){last.time=now}else{last.time+=1e3}}return(last.db/1024).toFixed(2)+" kb ("+last.dm+")"}perf.addMetric({name:"net",show_stat:"show_net",width:5,labels:{"down: ":bandwidth.bind(null,wsstats,last_wsstats),"up: ":bandwidth.bind(null,wsstats_out,last_wsstats_out)}});var valid_options=["n","dim_pos","dim_rot","send_time","window","snap_factor","smooth_windows","smooth_factor","default_pos","on_pos_update","on_state_update"];function NetPositionManager(options){this.on_channel_data=this.onChannelData.bind(this);this.on_subscribe=this.onChannelSubscribe.bind(this);this.reinit(options)}NetPositionManager.prototype.deinit=function(){if(this.channel){this.channel.removeListener("channel_data",this.on_channel_data);this.channel.removeListener("subscribe",this.on_subscribe)}};NetPositionManager.prototype.onChannelSubscribe=function(data){this.last_send.sending=false;this.last_send.time=0;this.client_id=net.client.id};NetPositionManager.prototype.onChannelData=function(data,mod_key,mod_value){if(mod_key){var m=mod_key.match(/^public\.clients\.([^.]+)\.(.+)$/);if(m){var client_id=m[1];var field=m[2];if(field==="pos"){this.otherClientPosChanged(client_id)}if(this.on_client_change){var pcd=this.per_client_data[client_id];if(pcd){this.on_client_change(pcd,field)}}}if(!mod_value){m=mod_key.match(/^public\.clients\.([^.]+)$/);if(m){delete this.per_client_data[m[1]]}}}else{if(data&&data.public&&data.public.clients){for(var _client_id in data.public.clients){var client_data=data.public.clients[_client_id];if(client_data.pos){this.otherClientPosChanged(_client_id)}}}}};NetPositionManager.prototype.vec=function(fill){var r=new Float64Array(this.n);if(fill){for(var ii=0;ii<this.n;++ii){r[ii]=fill}}return r};NetPositionManager.prototype.vcopy=function(dst,src){for(var ii=0;ii<this.n;++ii){dst[ii]=src[ii]}return dst};NetPositionManager.prototype.arr=function(vec){var arr=new Array(this.n);for(var ii=0;ii<this.n;++ii){arr[ii]=vec[ii]}return arr};NetPositionManager.prototype.vsame=function(a,b){for(var ii=0;ii<this.n;++ii){if(abs(a[ii]-b[ii])>EPSILON){return false}}return true};NetPositionManager.prototype.vlength=function(a){var r=0;for(var ii=0;ii<this.n;++ii){var d=a[ii];r+=d*d}return sqrt(r)};NetPositionManager.prototype.vdist=function(a,b){this.vsub(this.temp_vec,a,b);for(var ii=0;ii<this.dim_rot;++ii){var jj=this.dim_pos+ii;var d=abs(this.temp_vec[jj]);if(d>PI){this.temp_vec[jj]=d-floor((d+PI)/TWO_PI)*TWO_PI}}return this.vlength(this.temp_vec)};NetPositionManager.prototype.vsub=function(dst,a,b){for(var ii=0;ii<this.n;++ii){dst[ii]=a[ii]-b[ii]}return dst};NetPositionManager.prototype.vscale=function(dst,a,scalar){for(var ii=0;ii<this.n;++ii){dst[ii]=a[ii]*scalar}};NetPositionManager.prototype.reinit=function(options){this.deinit();the=this;options=options||{};this.per_client_data={};for(var ii=0;ii<valid_options.length;++ii){var field=valid_options[ii];if(options[field]){this[field]=options[field]}}assert.equal(this.dim_pos+this.dim_rot,this.n);if(!this.default_pos){this.default_pos=this.vec()}if(!this.temp_vec){this.temp_vec=this.vec()}if(!this.temp_delta){this.temp_delta=this.vec()}this.channel=options.channel;this.last_send={pos:this.vec(-1),sending:false,send_time:0};this.ever_received_character=false;this.on_client_change=options.on_client_change;if(this.channel){this.channel.on("channel_data",this.on_channel_data);this.channel.onSubscribe(this.on_subscribe)}};NetPositionManager.prototype.onPositionUpdate=function(cb){this.on_pos_update=cb};NetPositionManager.prototype.onStateUpdate=function(cb){this.on_state_update=cb};function syncPosWithCaller(npm,on_pos_set_cb){npm.vcopy(npm.last_send.pos,npm.default_pos);var new_pos=on_pos_set_cb(npm.last_send.pos);if(new_pos){npm.vcopy(npm.last_send.pos,new_pos)}}NetPositionManager.prototype.checkNet=function(on_pos_set_cb){if(!net.client.connected||!this.channel||!this.channel.data.public){return true}if(net.client.id!==this.client_id){return true}var me=this.channel.getChannelData("public.clients."+this.client_id,{});if(!me.pos||!me.pos.cur||typeof me.pos.cur[0]!=="number"){if(this.ever_received_character){}else{syncPosWithCaller(this,on_pos_set_cb)}this.channel.setChannelData("public.clients."+this.client_id+".pos",{cur:this.arr(this.last_send.pos)});this.ever_received_character=true}else if(!this.ever_received_character){syncPosWithCaller(this,on_pos_set_cb);this.ever_received_character=true}return false};NetPositionManager.prototype.updateMyPos=function(character_pos,anim_state){var _this=this;if(!this.vsame(character_pos,this.last_send.pos)||anim_state!==this.last_send.anim_state){var now=glov_engine.getFrameTimestamp();if(!this.last_send.sending&&(!this.last_send.time||now-this.last_send.time>this.send_time)){this.last_send.sending=true;this.last_send.time=now;this.last_send.hrtime=glov_engine.hrnow();this.last_send.speed=0;if(this.last_send.send_time){var time=now-this.last_send.send_time;this.last_send.speed=this.vdist(this.last_send.pos,character_pos)/time;if(this.last_send.speed<.001){this.last_send.speed=0}}this.last_send.send_time=now;this.vcopy(this.last_send.pos,character_pos);this.last_send.anim_state=anim_state;this.channel.setChannelData("public.clients."+this.client_id+".pos",{cur:this.arr(this.last_send.pos),state:this.last_send.anim_state,speed:this.last_send.speed,q:1},false,function(){_this.last_send.sending=false;var end=glov_engine.getFrameTimestamp();var hrend=glov_engine.hrnow();var round_trip=hrend-_this.last_send.hrtime;_this.ping_time=round_trip;_this.ping_time_time=end;if(round_trip>_this.send_time){_this.last_send.time=end}})}}};NetPositionManager.prototype.getPing=function(max_age){if(!this.ping_time_time){return null}var age=glov_engine.getFrameTimestamp()-this.ping_time_time;if(age>max_age){return null}return{ping:this.ping_time,fade:1-age/max_age}};NetPositionManager.prototype.getPos=function(client_id){var pcd=this.per_client_data[client_id];if(!pcd){return null}return pcd.pos};NetPositionManager.prototype.getPCD=function(client_id){return this.per_client_data[client_id]};NetPositionManager.prototype.otherClientPosChanged=function(client_id){var client_pos=this.channel.getChannelData("public.clients."+client_id+".pos");if(!client_pos||!client_pos.cur||typeof client_pos.cur[0]!=="number"){return}var pcd=this.per_client_data[client_id];if(!pcd){pcd=this.per_client_data[client_id]={};pcd.pos=this.vcopy(this.vec(),client_pos.cur);pcd.net_speed=0;pcd.net_pos=this.vec();pcd.impulse=this.vec();pcd.net_state="idle_down";pcd.anim_state="idle_down"}if(client_pos.state){pcd.net_state=client_pos.state}this.vcopy(pcd.net_pos,client_pos.cur);pcd.net_speed=client_pos.speed;for(var ii=0;ii<this.dim_rot;++ii){var jj=this.dim_pos+ii;while(pcd.pos[jj]>pcd.net_pos[jj]+PI){pcd.pos[jj]-=TWO_PI}while(pcd.pos[jj]<pcd.net_pos[jj]-PI){pcd.pos[jj]+=TWO_PI}}var delta=this.vsub(this.temp_delta,pcd.net_pos,pcd.pos);var dist=this.vlength(delta);if(dist>0){var time_to_dest=dist/pcd.net_speed;if(time_to_dest<this.send_time+this.window){this.vscale(pcd.impulse,delta,pcd.net_speed/dist)}else if(time_to_dest<this.send_time+this.window*this.smooth_windows){var old_speed=this.vlength(pcd.impulse);var specified_speed=pcd.net_speed;var new_speed=max(specified_speed*this.smooth_factor,old_speed);this.vscale(pcd.impulse,delta,new_speed/dist)}else{this.vscale(pcd.impulse,delta,1/(this.send_time+this.window*this.snap_factor))}}};NetPositionManager.prototype.updateOtherClient=function(client_id,dt){var pcd=this.per_client_data[client_id];if(!pcd){return null}var stopped=true;for(var ii=0;ii<this.n;++ii){if(pcd.impulse[ii]){var delta_old=pcd.net_pos[ii]-pcd.pos[ii];var delta_old_sign=util.sign(delta_old);pcd.pos[ii]+=pcd.impulse[ii]*dt;var delta_new=pcd.net_pos[ii]-pcd.pos[ii];var delta_new_sign=util.sign(delta_new);if(delta_new_sign!==delta_old_sign){pcd.pos[ii]=pcd.net_pos[ii];pcd.impulse[ii]=0}else if(ii<this.dim_pos&&pcd.impulse[ii]>.01){stopped=false}}}if(this.on_pos_update){this.on_pos_update(client_id,pcd.pos)}var cur_is_run=pcd.anim_state[0]==="f"||pcd.anim_state[0]==="w";var new_is_idle=pcd.net_state[0]==="i";if(cur_is_run&&new_is_idle&&!stopped){}else{pcd.anim_state=pcd.net_state;if(this.on_state_update){this.on_state_update(client_id,pcd.net_state)}}return pcd};NetPositionManager.prototype.n=2;NetPositionManager.prototype.dim_pos=2;NetPositionManager.prototype.dim_rot=0;NetPositionManager.prototype.send_time=200;NetPositionManager.prototype.window=200;NetPositionManager.prototype.snap_factor=1;NetPositionManager.prototype.smooth_windows=6.5;NetPositionManager.prototype.smooth_factor=1.2;function create(options){return new NetPositionManager(options)}function ScalarInterpolator(tick_time){this.tick_time=tick_time*1.25;this.reset()}ScalarInterpolator.prototype.reset=function(){this.value=undefined;this.target_value=undefined;this.vel=0};ScalarInterpolator.prototype.update=function(dt,new_value){if(this.value===undefined){this.value=new_value;this.target_value=new_value;return}if(new_value!==this.target_value){this.vel=(new_value-this.value)/this.tick_time;this.target_value=new_value}if(this.value!==this.target_value){if(this.vel>0){this.value=min(this.value+this.vel*dt,this.target_value)}else{this.value=max(this.value+this.vel*dt,this.target_value)}}};ScalarInterpolator.prototype.getValue=function(){return this.value};function createScalarInterpolator(tick_time){return new ScalarInterpolator(tick_time)}


},{"../../common/util.js":70,"../../common/wscommon.js":72,"./cmds.js":8,"./engine.js":11,"./net.js":30,"./perf.js":33,"./settings.js":39,"assert":undefined}],32:[function(require,module,exports){
"use strict";exports.preloadParticleData=preloadParticleData;exports.create=create;var assert=require("assert");var sprites=require("./sprites.js");var textures=require("./textures.js");var _require=require("./vmath.js"),vec2=_require.vec2,v2copy=_require.v2copy,v2lerp=_require.v2lerp,v2mul=_require.v2mul;var _require2=require("./vmath.js"),vec3=_require2.vec3,vec4=_require2.vec4,v3add=_require2.v3add,v4copy=_require2.v4copy,v4lerp=_require2.v4lerp,v4mul=_require2.v4mul;var blend_map={alpha:sprites.BLEND_ALPHA,additive:sprites.BLEND_ADDITIVE};function preloadParticleData(particle_data){for(var key in particle_data.defs){var def=particle_data.defs[key];for(var part_name in def.particles){var part_def=def.particles[part_name];textures.load({url:"img/"+part_def.texture+".png"})}}}function normalizeValue(v){if(v instanceof Float32Array&&v.length>=2){return v}else if(typeof v==="number"){return vec2(v,0)}else if(Array.isArray(v)||v instanceof Float32Array){return vec2(v[0]||0,v[1]||0)}else{return assert(false)}}function normalizeValueVec(vec,length){assert(length);assert(Array.isArray(vec));var ret=new Array(length);for(var ii=0;ii<length;++ii){ret[ii]=normalizeValue(vec[ii])}return ret}function normalizeParticle(def,particle_manager){if(!def.normalized){var norm=def.normalized={blend:blend_map[def.blend]||sprites.BLEND_ALPHA,texture:textures.load({url:def.texture?"img/"+def.texture+".png":"img/glov/util_circle.png"}),color:normalizeValueVec(def.color||[1,1,1,1],4),color_track:null,size:normalizeValueVec(def.size||[1,1],2),size_track:null,accel:normalizeValueVec(def.accel||[0,0,0],3),rot:normalizeValue(def.rot||0),rot_vel:normalizeValue(def.rot||0),lifespan:normalizeValue(def.lifespan||1e3),kill_time_accel:normalizeValue(def.kill_time_accel||1)};assert(norm.kill_time_accel[0]>=1);if(def.color_track&&def.color_track.length){assert(def.color_track.length>1);norm.color_track=[];for(var ii=0;ii<def.color_track.length;++ii){var e=def.color_track[ii];assert(typeof e.t==="number");var arr=new Float32Array(5);arr[0]=e.v[0];arr[1]=e.v[1];arr[2]=e.v[2];arr[3]=e.v[3];arr[4]=e.t;norm.color_track.push(arr)}}if(def.size_track&&def.size_track.length){assert(def.size_track.length>1);norm.size_track=[];for(var _ii=0;_ii<def.size_track.length;++_ii){var _e=def.size_track[_ii];assert(typeof _e.t==="number");var _arr=new Float32Array(3);_arr[0]=_e.v[0];_arr[1]=_e.v[1];_arr[2]=_e.t;norm.size_track.push(_arr)}}}return def.normalized}function findParticle(particles,name){assert(particles[name]!==undefined);return particles[name]}function normalizeEmitter(def,part_map){if(!def.normalized){def.normalized={part_idx:findParticle(part_map,def.particle),pos:normalizeValueVec(def.pos||[0,0,0],3),vel:normalizeValueVec(def.vel||[0,0,0],3),emit_rate:normalizeValue(def.emit_rate||10),emit_time:normalizeValueVec(def.emit_time||[0,Infinity],2),emit_initial:normalizeValue(def.emit_initial||1)};var min=def.normalized.emit_rate[0];var max=def.normalized.emit_rate[0]+def.normalized.emit_rate[1];def.normalized.emit_rate[0]=1e3/max;def.normalized.emit_rate[1]=1e3/min;assert(def.normalized.emit_rate[0]>1)}return def.normalized}function normalizeDef(def,particle_manager){if(!def.normalized){var norm=def.normalized={system_lifespan:normalizeValue(def.system_lifespan||Infinity),particles:[],emitters:[]};var part_map={};for(var key in def.particles){part_map[key]=norm.particles.length;norm.particles.push(normalizeParticle(def.particles[key],particle_manager))}for(var _key in def.emitters){norm.emitters.push(normalizeEmitter(def.emitters[_key],part_map))}}return def.normalized}function instValue(v){return v[0]+Math.random()*v[1]}function instValueVec(v){var ret=new Float32Array(v.length);for(var ii=0;ii<v.length;++ii){ret[ii]=instValue(v[ii])}return ret}var temp_color=vec4();var temp_color2=vec4();var temp_size=vec2();var temp_size2=vec2();var ParticleSystem=function(){function ParticleSystem(parent,def_in,pos){assert(pos.length===3);this.parent=parent;this.def=normalizeDef(def_in,parent);this.system_lifespan=instValue(this.def.system_lifespan);assert(this.system_lifespan>0);this.age=0;this.kill_hard=false;this.kill_soft=false;this.pos=vec3(pos[0],pos[1],pos[2]);this.part_sets=[];for(var ii=0;ii<this.def.particles.length;++ii){var def=this.def.particles[ii];var part_set={def:def,parts:[]};this.part_sets.push(part_set)}this.emitters=[];for(var _ii2=0;_ii2<this.def.emitters.length;++_ii2){var _def=this.def.emitters[_ii2];var emitter={def:_def,emit_time:instValueVec(_def.emit_time),countdown:0,started:false,stopped:false};this.emitters.push(emitter)}}var _proto=ParticleSystem.prototype;_proto.tickParticle=function tickParticle(part,dt){var def=part.def;part.age+=dt;var age_norm=part.age/part.lifespan;if(age_norm>=1){return true}var dts=dt/1e3;part.pos[0]+=part.vel[0]*dts;part.pos[1]+=part.vel[1]*dts;part.pos[2]+=part.vel[2]*dts;part.vel[0]+=part.accel[0]*dts;part.vel[1]+=part.accel[1]*dts;part.vel[2]+=part.accel[2]*dts;v4copy(temp_color,part.color,temp_color);if(def.color_track){if(age_norm<def.color_track[0][4]){v4mul(temp_color,temp_color,def.color_track[0])}else if(age_norm>=def.color_track[def.color_track.length-1][4]){v4mul(temp_color,temp_color,def.color_track[def.color_track.length-1])}else{for(var ii=0;ii<def.color_track.length-1;++ii){if(age_norm>=def.color_track[ii][4]&&age_norm<def.color_track[ii+1][4]){var weight=(age_norm-def.color_track[ii][4])/(def.color_track[ii+1][4]-def.color_track[ii][4]);v4lerp(temp_color2,weight,def.color_track[ii],def.color_track[ii+1]);v4mul(temp_color,temp_color,temp_color2);break}}}}v2copy(temp_size,part.size);if(def.size_track){if(age_norm<def.size_track[0][2]){v2mul(temp_size,temp_size,def.size_track[0])}else if(age_norm>=def.size_track[def.size_track.length-1][2]){v2mul(temp_size,temp_size,def.size_track[def.size_track.length-1])}else{for(var _ii3=0;_ii3<def.size_track.length-1;++_ii3){if(age_norm>=def.size_track[_ii3][2]&&age_norm<def.size_track[_ii3+1][2]){var _weight=(age_norm-def.size_track[_ii3][2])/(def.size_track[_ii3+1][2]-def.size_track[_ii3][2]);v2lerp(temp_size2,_weight,def.size_track[_ii3],def.size_track[_ii3+1]);v2mul(temp_size,temp_size,temp_size2);break}}}}var w=temp_size[0];var h=temp_size[1];var x=part.pos[0]-w/2;var y=part.pos[1]-h/2;var z=part.pos[2];sprites.queueraw4([def.texture],x,y,x,y+h,x+w,y+h,x+w,y,z,0,0,1,1,temp_color,null,null,def.blend);return false};_proto.tickPartSet=function tickPartSet(dt_orig,part_set){var parts=part_set.parts;for(var ii=parts.length-1;ii>=0;--ii){var part=parts[ii];var dt=this.kill_soft?dt_orig*part.kill_time_accel:dt_orig;if(this.tickParticle(part,dt)){parts[ii]=parts[parts.length-1];parts.pop()}}};_proto.emitParticle=function emitParticle(init_dt,emitter){var emitter_def=emitter.def;var part_set=this.part_sets[emitter_def.part_idx];var def=part_set.def;var pos=instValueVec(emitter_def.pos,3);v3add(pos,pos,this.pos);var part={def:def,pos:pos,color:instValueVec(def.color,4),size:instValueVec(def.size,4),vel:instValueVec(emitter_def.vel,3),accel:instValueVec(def.accel,3),rot:instValue(def.rot),rot_vel:instValue(def.rot_vel),lifespan:instValue(def.lifespan),kill_time_accel:instValue(def.kill_time_accel),age:0};if(!this.tickParticle(part,init_dt)){part_set.parts.push(part)}};_proto.tickEmitter=function tickEmitter(dt,emitter){var def=emitter.def;if(!emitter.started&&this.age>=emitter.emit_time[0]){emitter.started=true;dt=this.age-emitter.emit_time[0];var num=instValue(def.emit_initial);for(var ii=0;ii<num;++ii){this.emitParticle(dt,emitter)}emitter.countdown=instValue(def.emit_rate)}if(emitter.started&&!emitter.stopped&&!this.kill_soft){var remaining_dt=dt;var emit_dt=dt;if(this.age>=emitter.emit_time[1]){emitter.stopped=true;emit_dt-=this.age-emitter.emit_time[1]}while(emit_dt>=emitter.countdown){emit_dt-=emitter.countdown;remaining_dt-=emitter.countdown;emitter.countdown=instValue(def.emit_rate);this.emitParticle(remaining_dt,emitter)}emitter.countdown-=emit_dt}};_proto.tick=function tick(dt){if(this.kill_hard){return true}for(var ii=this.part_sets.length-1;ii>=0;--ii){this.tickPartSet(dt,this.part_sets[ii])}this.age+=dt;for(var _ii4=0;_ii4<this.emitters.length;++_ii4){this.tickEmitter(dt,this.emitters[_ii4])}return this.age>=this.system_lifespan};_proto.shift=function shift(delta){if(this.def.no_shift){return}this.pos[0]+=delta[0];this.pos[1]+=delta[1];this.pos[2]+=delta[2];for(var ii=0;ii<this.part_sets.length;++ii){var parts=this.part_sets[ii].parts;for(var jj=0;jj<parts.length;++jj){var part=parts[jj];part.pos[0]+=delta[0];part.pos[1]+=delta[1];part.pos[2]+=delta[2]}}};return ParticleSystem}();var ParticleManager=function(){function ParticleManager(){this.systems=[]}var _proto2=ParticleManager.prototype;_proto2.createSystem=function createSystem(def,pos){var system=new ParticleSystem(this,def,pos);this.systems.push(system);return system};_proto2.tick=function tick(dt){for(var ii=this.systems.length-1;ii>=0;--ii){if(this.systems[ii].tick(dt)){this.systems[ii]=this.systems[this.systems.length-1];this.systems.pop()}}};_proto2.killAll=function killAll(){this.systems=[]};_proto2.shift=function shift(delta){for(var ii=0;ii<this.systems.length;++ii){this.systems[ii].shift(delta)}};return ParticleManager}();function create(){return new ParticleManager}


},{"./sprites.js":43,"./textures.js":45,"./vmath.js":49,"assert":undefined}],33:[function(require,module,exports){
"use strict";exports.addMetric=addMetric;exports.draw=draw;var camera2d=require("./camera2d.js");var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse;var engine=require("./engine.js");var glov_font=require("./font.js");var input=require("./input.js");var max=Math.max;var settings=require("./settings.js");var ui=require("./ui.js");var _require2=require("./vmath.js"),vec4=_require2.vec4,v3copy=_require2.v3copy;var metrics=[];var METRIC_PAD=2;var bg_default=vec4(0,0,0,.5);var bg_mouse_over=vec4(0,0,0,.75);var bg_fade=vec4();settings.register({show_metrics:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]},show_fps:{label:"Show FPS",default_value:1,type:cmd_parse.TYPE_INT,range:[0,3]},fps_graph:{label:"FPS Graph",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},fps_window:{label:"FPS Time Window (seconds)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.001,120]}});cmd_parse.register({cmd:"fps",help:"Toggles FPS display",func:function func(str,resp_func){if(settings.show_fps&&settings.show_metrics||str==="0"){settings.set("show_fps",0)}else{settings.set("show_fps",1);settings.set("show_metrics",1)}resp_func()}});var fps_style=glov_font.style({outline_width:2,outline_color:128,color:4294967295});function addMetric(metric){if(metric.show_graph){metric.num_lines=metric.colors.length;metric.history_size=metric.data.history.length/metric.num_lines}metric.num_labels=Object.keys(metric.labels).length;if(metric.interactable===undefined){metric.interactable=engine.DEBUG&&(metric.num_labels>1||metric.show_graph)}metrics.push(metric)}function showMetric(y,metric){var font=engine.font;var pad=METRIC_PAD;var line_height=ui.font_height/settings.render_scale_all;var METRIC_VALUE_WIDTH=line_height*(metric.width||2.5);var x=camera2d.x1Real()-METRIC_VALUE_WIDTH-pad;var y0=y;y+=pad;var max_label_w=0;var max_labels=settings[metric.show_stat];var drew_any=false;var alpha=1;for(var label in metric.labels){var value=metric.labels[label]();if(value){var style=fps_style;if(value.alpha){alpha=value.alpha;value=value.value;style=glov_font.styleAlpha(fps_style,alpha)}var label_w=font.drawSizedAligned(style,x,y,Z.FPSMETER+1,line_height,glov_font.ALIGN.HRIGHT,0,0,label);max_label_w=max(max_label_w,label_w);font.drawSizedAligned(style,x,y,Z.FPSMETER+1,line_height,glov_font.ALIGN.HFIT,METRIC_VALUE_WIDTH,0,value);y+=line_height;drew_any=true}if(!--max_labels){break}}var w=METRIC_VALUE_WIDTH+max_label_w+METRIC_PAD;x-=max_label_w+METRIC_PAD;if(!drew_any){return y-pad}y+=pad;var bg=bg_default;var pos_param={x:x-pad,y:y0,w:w+pad*2,h:y-y0};if(metric.interactable){if(input.mouseUpEdge(pos_param)){if(metric.num_labels>1&&settings[metric.show_stat]<=1){settings.set(metric.show_stat,metric.num_labels)}else if(metric.show_graph&&!settings[metric.show_graph]){settings.set(metric.show_graph,1)}else{if(metric.show_graph){settings.set(metric.show_graph,0)}settings.set(metric.show_stat,1)}}if(input.mouseOver(pos_param)){bg=bg_mouse_over}}if(alpha!==1){bg_fade[3]=bg[3]*alpha;bg=v3copy(bg_fade,bg)}ui.drawRect(pos_param.x,pos_param.y,pos_param.x+pos_param.w,y,Z.FPSMETER,bg);return y}function showMetricGraph(y,metric){var small=engine.game_height<300;var LINE_WIDTH=small?1:3;var LINE_PAD=small?0:1;var LINE_HEIGHT=small?64:128;var NUM_LINES=metric.history_size-1;var w=(LINE_WIDTH+LINE_PAD)*NUM_LINES;var x=camera2d.x1Real()-w;var h=LINE_HEIGHT+LINE_PAD*2;var z=Z.FPSMETER;ui.drawRect(x,y-h,x+w,y,z++,bg_default);x+=LINE_PAD;y-=LINE_PAD;var history_index=metric.data.index;var line_scale=LINE_HEIGHT/metric.line_scale_top;for(var ii=0;ii<NUM_LINES;ii++){var line_index=(ii+history_index+1)%metric.history_size*metric.num_lines;var data=metric.data.history;var bar_max=0;for(var jj=0;jj<metric.num_lines;jj++){var line_jj=data[line_index+jj];var bar_min=void 0;if(metric.bars_stack){bar_min=bar_max;bar_max+=line_jj}else{var lesser=0;for(var kk=0;kk<metric.num_lines;kk++){if(kk===jj){continue}var line_kk=data[line_index+kk];if((line_kk<line_jj||line_kk===line_jj&&kk<jj)&&line_kk>lesser){lesser=line_kk}}bar_min=lesser;bar_max=line_jj}var color=metric.colors[jj];ui.drawRect(x,y-bar_max*line_scale,x+LINE_WIDTH,y-bar_min*line_scale,z,color)}x+=LINE_WIDTH+LINE_PAD}z+=NUM_LINES;y-=LINE_HEIGHT+LINE_PAD;return y}function draw(){camera2d.setAspectFixed(engine.game_width,engine.game_height);var y=camera2d.y0Real();var y_graph=camera2d.y1Real();for(var ii=0;ii<metrics.length;++ii){var metric=metrics[ii];if(settings[metric.show_stat]){y=showMetric(y,metric);y+=METRIC_PAD}if(settings[metric.show_graph]){y_graph=showMetricGraph(y_graph,metric);y_graph-=METRIC_PAD}}}


},{"./camera2d.js":6,"./cmds.js":8,"./engine.js":11,"./font.js":15,"./input.js":25,"./settings.js":39,"./ui.js":47,"./vmath.js":49}],34:[function(require,module,exports){
"use strict";exports.isLocked=isLocked;exports.exit=exit;exports.enter=enter;exports.startup=startup;var user_want_locked=false;var elem;var on_ptr_lock;function isLocked(){return user_want_locked}function pointerLog(msg){console.log("PointerLock: "+msg)}function exit(){pointerLog("Lock exit requested");user_want_locked=false;document.exitPointerLock()}function enter(when){user_want_locked=true;on_ptr_lock();pointerLog("Trying pointer lock in response to "+when);elem.requestPointerLock()}function onPointerLockChange(){if(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement){pointerLog("Lock successful");if(!user_want_locked){pointerLog("User canceled lock");document.exitPointerLock()}}else{if(user_want_locked){pointerLog("Lock lost");user_want_locked=false}}}function onPointerLockError(e){pointerLog("Error");user_want_locked=false}function startup(_elem,_on_ptr_lock){elem=_elem;on_ptr_lock=_on_ptr_lock;elem.requestPointerLock=elem.requestPointerLock||elem.mozRequestPointerLock||elem.webkitRequestPointerLock||function(){};document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||function(){};document.addEventListener("pointerlockchange",onPointerLockChange,false);document.addEventListener("mozpointerlockchange",onPointerLockChange,false);document.addEventListener("webkitpointerlockchange",onPointerLockChange,false);document.addEventListener("pointerlockerror",onPointerLockError,false);document.addEventListener("mozpointerlockerror",onPointerLockError,false);document.addEventListener("webkitpointerlockerror",onPointerLockError,false)}


},{}],35:[function(require,module,exports){
"use strict";var typedarrays=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array];if(!Uint8Array.prototype.slice){typedarrays.forEach(function(ArrayType){Object.defineProperty(ArrayType.prototype,"slice",{value:function value(begin,end){if(end===undefined){end=this.length}if(end<0){end=this.length-end}begin=begin||0;if(begin>=this.length){begin=this.length-1}if(end>this.length){end=this.length}if(end<begin){end=begin}var len=end-begin;var ret=new ArrayType(len);for(var ii=0;ii<len;++ii){ret[ii]=this[begin+ii]}return ret}})})}function cmpDefault(a,b){return a-b}var replacements={join:function join(delim){return Array.prototype.join.call(this,delim)},fill:function fill(value,begin,end){if(end===undefined){end=this.length}for(var ii=begin||0;ii<end;++ii){this[ii]=value}return this},sort:function sort(cmp){Array.prototype.sort.call(this,cmp||cmpDefault)}};var _loop=function _loop(key){if(!Uint8Array.prototype[key]){typedarrays.forEach(function(ArrayType){Object.defineProperty(ArrayType.prototype,key,{value:replacements[key]})})}};for(var key in replacements){_loop(key)}if(!String.prototype.endsWith){Object.defineProperty(String.prototype,"endsWith",{value:function value(test){return this.slice(-test.length)===test}});Object.defineProperty(String.prototype,"startsWith",{value:function value(test){return this.slice(0,test.length)===test}})}


},{}],36:[function(require,module,exports){
"use strict";exports.mashString=mashString;exports.mashI53=mashI53;exports.randCreate=randCreate;function mashString(data){var n=4022871197;for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return n>>>0}function mashI53(data){var n=4022871197;while(data){var byte=data%256;data=(data-byte)/256;n+=byte;var h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return(n>>>0)*2.3283064365386963e-10}function Mash(){this.n=3228327880}Mash.prototype.mash=function(data){var n=this.n+data;var h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296;this.n=n;return(n>>>0)*2.3283064365386963e-10};function Alea(seed){this.reseed(seed)}Alea.prototype.reseed=function(seed){this.c=1;var mash=new Mash;this.s0=.3014581324532628;this.s1=.2643220406025648;this.s2=.7516536582261324;this.s0-=mash.mash(seed);if(this.s0<0){this.s0+=1}this.s1-=mash.mash(seed);if(this.s1<0){this.s1+=1}this.s2-=mash.mash(seed);if(this.s2<0){this.s2+=1}};Alea.prototype.step=function(){var t=2091639*this.s0+this.c*2.3283064365386963e-10;this.s0=this.s1;this.s1=this.s2;return this.s2=t-(this.c=t|0)};Alea.prototype.uint32=function(){return this.step()*4294967296};Alea.prototype.fract53=function(){return this.step()+(this.step()*2097152|0)*11102230246251565e-32};Alea.prototype.random=Alea.prototype.step;Alea.prototype.range=function(range){return this.step()*range|0};Alea.prototype.floatBetween=function(a,b){return a+(b-a)*this.random()};Alea.prototype.exportState=function(){return[this.s0,this.s1,this.s2,this.c]};Alea.prototype.importState=function(i){this.s0=i[0];this.s1=i[1];this.s2=i[2];this.c=i[3]};function randCreate(seed){return new Alea(seed)}


},{}],37:[function(require,module,exports){
"use strict";exports.randFastCreate=randFastCreate;function step2(seed){seed=seed>>>0||22329833666;seed^=seed<<13;seed^=seed>>>17;seed^=seed<<5;seed^=seed<<13;seed^=seed>>>17;seed^=seed<<5;return seed>>>0}function RandSeed2(seed){this.seed=step2(seed)}RandSeed2.prototype.reseed=function(seed){this.seed=step2(seed)};RandSeed2.prototype.step=function(){var seed=this.seed;seed^=seed<<13;seed^=seed>>>17;seed^=seed<<5;return(this.seed=seed>>>0)-1};RandSeed2.prototype.uint32=RandSeed2.prototype.step;RandSeed2.prototype.range=function(range){return this.step()*range*2.3283064376e-10|0};RandSeed2.prototype.random=function(){return this.step()*2.3283064376e-10};RandSeed2.prototype.floatBetween=function(a,b){return a+(b-a)*this.random()};function randFastCreate(seed){return new RandSeed2(seed)}


},{}],38:[function(require,module,exports){
"use strict";exports.setPixelScale=setPixelScale;exports.scrollAreaCreate=scrollAreaCreate;var assert=require("assert");var camera2d=require("./camera2d.js");var engine=require("./engine.js");var input=require("./input.js");var KEYS=input.KEYS,PAD=input.PAD;var max=Math.max,min=Math.min,round=Math.round;var _require=require("./sprites.js"),clipPush=_require.clipPush,clipPop=_require.clipPop;var ui=require("./ui.js");var _require2=require("../../common/util.js"),clamp=_require2.clamp;var _require3=require("./vmath.js"),vec2=_require3.vec2,vec4=_require3.vec4;var MAX_OVERSCROLL=50;var OVERSCROLL_DELAY_WHEEL=180;function darken(color,factor){return vec4(color[0]*factor,color[1]*factor,color[2]*factor,color[3])}var default_pixel_scale=1;function setPixelScale(scale){default_pixel_scale=scale}function ScrollArea(params){this.x=0;this.y=0;this.z=Z.UI;this.w=10;this.h=10;this.rate_scroll_click=ui.font_height;this.pixel_scale=default_pixel_scale;this.top_pad=true;this.color=vec4(1,1,1,1);this.background_color=vec4(.8,.8,.8,1);this.auto_scroll=false;this.focusable_elem=null;this.applyParams(params);this.rate_scroll_wheel=this.rate_scroll_wheel||this.rate_scroll_click*2;this.rollover_color=this.rollover_color||darken(this.color,.75);this.rollover_color_light=this.rollover_color_light||darken(this.color,.95);assert(this.rollover_color_light!==this.color);this.disabled_color=this.disabled_color||this.rollover_color;this.background_color_focused=this.background_color_focused||(this.background_color?vec4(.4,.4,.4,1):null);this.scroll_pos=0;this.overscroll=0;this.overscroll_delay=0;this.grabbed_pos=0;this.grabbed=false;this.drag_start=null;this.began=false;this.last_internal_h=0;this.last_frame=0;this.focused=false;this.was_disabled=false;this.scrollbar_visible=false}ScrollArea.prototype.applyParams=function(params){if(!params){return}for(var f in params){this[f]=params[f]}};ScrollArea.prototype.barWidth=function(){var pixel_scale=this.pixel_scale;var scrollbar_top=ui.sprites.scrollbar_top;return scrollbar_top.uidata.total_w*pixel_scale};ScrollArea.prototype.isFocused=function(){return this.focused};ScrollArea.prototype.begin=function(params){this.applyParams(params);var x=this.x,y=this.y,w=this.w,h=this.h,z=this.z;assert(!this.began||engine.DEBUG);this.began=true;clipPush(z+.05,x,y,w-this.barWidth(),h);var camera_orig_x0=camera2d.x0();var camera_orig_x1=camera2d.x1();var camera_orig_y0=camera2d.y0();var camera_orig_y1=camera2d.y1();var camera_new_x0=-(x-camera_orig_x0);var camera_new_y0=-(y-camera_orig_y0)+round(this.scroll_pos+this.overscroll);var camera_new_x1=camera_new_x0+camera_orig_x1-camera_orig_x0;var camera_new_y1=camera_new_y0+camera_orig_y1-camera_orig_y0;camera2d.push();camera2d.set(camera_new_x0,camera_new_y0,camera_new_x1,camera_new_y1)};ScrollArea.prototype.clampScrollPos=function(){var clamped_pos=clamp(this.scroll_pos,0,this.last_max_value);if(this.scroll_pos<0){this.overscroll=max(this.scroll_pos,-MAX_OVERSCROLL)}else if(this.scroll_pos>this.last_max_value){this.overscroll=min(this.scroll_pos-this.last_max_value,MAX_OVERSCROLL)}this.scroll_pos=clamped_pos};ScrollArea.prototype.keyboardScroll=function(){if(this.was_disabled){return}var modified=false;var pad_shift=input.padButtonDown(PAD.RIGHT_TRIGGER)||input.padButtonDown(PAD.LEFT_TRIGGER);var value=input.keyDownEdge(KEYS.PAGEDOWN)+(pad_shift?input.padButtonDownEdge(PAD.DOWN):0);if(value){this.scroll_pos=min(this.scroll_pos+this.h,this.scroll_pos===this.last_max_value?Infinity:this.last_max_value);modified=true}value=input.keyDownEdge(KEYS.PAGEUP)+(pad_shift?input.padButtonDownEdge(PAD.UP):0);if(value){this.scroll_pos=max(this.scroll_pos-this.h,this.scroll_pos===0?-this.h:0);modified=true}if(modified){this.clampScrollPos()}};var temp_pos=vec2();ScrollArea.prototype.end=function(h){assert(h>=0);h=max(h,1);assert(this.began);this.began=false;camera2d.pop();clipPop();if(this.scroll_pos>h-this.h){this.scroll_pos=max(0,h-this.h+1)}if(this.overscroll){var dt=engine.getFrameDt();if(dt>=this.overscroll_delay){this.overscroll_delay=0;this.overscroll=this.overscroll*max(1-dt*.008,0)}else{this.overscroll_delay-=dt}}var auto_hide=this.auto_hide,pixel_scale=this.pixel_scale,rollover_color=this.rollover_color,rollover_color_light=this.rollover_color_light;var _ui$sprites=ui.sprites,scrollbar_top=_ui$sprites.scrollbar_top,scrollbar_bottom=_ui$sprites.scrollbar_bottom,scrollbar_trough=_ui$sprites.scrollbar_trough,scrollbar_handle=_ui$sprites.scrollbar_handle,scrollbar_handle_grabber=_ui$sprites.scrollbar_handle_grabber;var bar_w=scrollbar_top.uidata.total_w*pixel_scale;var button_h=min(scrollbar_top.uidata.total_h*pixel_scale,this.h/3);var button_h_nopad=this.top_pad?button_h:0;var bar_x0=this.x+this.w-bar_w;var handle_h=this.h/h;handle_h=clamp(handle_h,0,1);var handle_pos=this.h>h?0:this.scroll_pos/(h-this.h);handle_pos=clamp(handle_pos,0,1);var handle_pixel_h=handle_h*(this.h-button_h_nopad*2);var handle_pixel_min_h=scrollbar_handle.uidata.total_h*pixel_scale;handle_pixel_h=max(handle_pixel_h,min(handle_pixel_min_h,button_h/2));var handle_screenpos=round(this.y+button_h_nopad+handle_pos*(this.h-button_h_nopad*2-handle_pixel_h));var top_color=this.color;var bottom_color=this.color;var handle_color=this.color;var trough_color=this.color;var disabled=false;if(!this.h||handle_h===1){disabled=true}this.was_disabled=disabled;var user_moved_this_frame=false;if(disabled){trough_color=top_color=bottom_color=handle_color=this.disabled_color;this.drag_start=null}else{var wheel_delta=input.mouseWheel({x:this.x,y:this.y,w:this.w,h:this.h});if(wheel_delta){this.overscroll_delay=OVERSCROLL_DELAY_WHEEL;this.scroll_pos-=this.rate_scroll_wheel*wheel_delta;user_moved_this_frame=true}var down=input.mouseDownEdge({x:bar_x0,y:handle_screenpos,w:bar_w,h:handle_pixel_h,button:0});if(down){this.grabbed_pos=down.pos[1]-handle_screenpos;this.grabbed=true;handle_color=rollover_color_light}if(this.grabbed){ui.focusSteal(this);user_moved_this_frame=true}var up=this.grabbed&&input.mouseUpEdge({button:0});if(up){this.grabbed=false;var delta=up.pos[1]-(this.y+button_h_nopad)-this.grabbed_pos;this.scroll_pos=(h-this.h)*delta/(this.h-button_h_nopad*2-handle_pixel_h);handle_color=rollover_color_light}if(this.grabbed&&!input.mouseDown({button:0,max_dist:Infinity})){this.grabbed=false}if(this.grabbed){input.mousePos(temp_pos);var _delta=temp_pos[1]-(this.y+button_h_nopad)-this.grabbed_pos;this.scroll_pos=(h-this.h)*_delta/(this.h-button_h_nopad*2-handle_pixel_h);handle_color=rollover_color_light}if(input.mouseOver({x:bar_x0,y:handle_screenpos,w:bar_w,h:handle_pixel_h})){if(handle_color!==rollover_color_light){handle_color=rollover_color}}var button_param={x:bar_x0,y:this.y,w:bar_w,h:button_h,button:0};while(input.mouseUpEdge(button_param)){ui.focusSteal(this);top_color=rollover_color;this.scroll_pos-=this.rate_scroll_click;user_moved_this_frame=true}if(input.mouseOver(button_param)){top_color=rollover_color}button_param.y=this.y+this.h-button_h;while(input.mouseUpEdge(button_param)){ui.focusSteal(this);bottom_color=rollover_color;this.scroll_pos+=this.rate_scroll_click;user_moved_this_frame=true}if(input.mouseOver(button_param)){bottom_color=rollover_color}var click;var bar_param={x:bar_x0,y:this.y,w:bar_w,h:this.h,button:0};while(click=input.mouseUpEdge(bar_param)){ui.focusSteal(this);if(click.pos[1]>handle_screenpos+handle_pixel_h/2){this.scroll_pos+=this.h}else{this.scroll_pos-=this.h}user_moved_this_frame=true}input.mouseOver(bar_param);var drag=input.drag({x:this.x,y:this.y,w:this.w-bar_w,h:this.h,button:0});if(drag){user_moved_this_frame=true;if(this.drag_start===null){this.drag_start=this.scroll_pos}this.scroll_pos=this.drag_start-drag.cur_pos[1]+drag.start_pos[1]}else{this.drag_start=null}}this.focused=!disabled&&ui.focusCheck(this);if(this.focused&&this.focusable_elem){this.focusable_elem.focus()}var maxvalue=max(h-this.h+1,0);this.last_max_value=maxvalue;this.clampScrollPos();if(this.auto_scroll&&(this.last_internal_h!==h||this.last_frame!==engine.getFrameIndex()-1)){if(!user_moved_this_frame){this.scroll_pos=maxvalue;this.overscroll=0}}this.last_internal_h=h;this.last_frame=engine.getFrameIndex();var bg_color=this.focused||this.focusable_elem&&this.focusable_elem.is_focused?this.background_color_focused:this.background_color;if(bg_color){ui.drawRect(this.x,this.y,this.x+this.w,this.y+this.h,this.z,bg_color)}if(disabled&&(auto_hide||!this.h)){this.scrollbar_visible=false;return}this.scrollbar_visible=true;scrollbar_top.draw({x:bar_x0,y:this.y,z:this.z+.2,w:bar_w,h:button_h,color:top_color});scrollbar_bottom.draw({x:bar_x0,y:this.y+this.h-button_h,z:this.z+.2,w:bar_w,h:button_h,color:bottom_color});scrollbar_trough.draw({x:bar_x0,y:this.y+button_h/2,z:this.z+.1,w:bar_w,h:this.h-button_h,color:trough_color});ui.drawVBox({x:bar_x0,y:handle_screenpos,z:this.z+.3,w:bar_w,h:handle_pixel_h},scrollbar_handle,handle_color);var grabber_h=scrollbar_handle_grabber.uidata.total_h*pixel_scale;scrollbar_handle_grabber.draw({x:bar_x0,y:handle_screenpos+(handle_pixel_h-grabber_h)/2,z:this.z+.4,w:bar_w,h:grabber_h,color:handle_color})};ScrollArea.prototype.scrollIntoFocus=function(miny,maxy,h){var old_scroll_pos=this.scroll_pos;var changed=false;miny=max(miny,0);if(miny<this.scroll_pos){this.scroll_pos=miny;changed=true}maxy-=h;if(maxy>this.scroll_pos){this.scroll_pos=maxy;changed=true}if(changed){this.overscroll=old_scroll_pos-this.scroll_pos}};function scrollAreaCreate(params){return new ScrollArea(params)}


},{"../../common/util.js":70,"./camera2d.js":6,"./engine.js":11,"./input.js":25,"./sprites.js":43,"./ui.js":47,"./vmath.js":49,"assert":undefined}],39:[function(require,module,exports){
"use strict";exports.get=get;exports.set=set;exports.setAsync=setAsync;exports.runTimeDefault=runTimeDefault;exports.register=register;var modified={};exports.true=true;var _require=require("../../common/util.js"),titleCase=_require.titleCase;var _require2=require("./cmds.js"),cmd_parse=_require2.cmd_parse;var engine=require("./engine.js");function get(key){return exports[key]}function set(key,value){if(exports[key]!==value){cmd_parse.handle(null,key+" "+value,null)}}function setAsync(key,value){engine.postTick({fn:set.bind(null,key,value)})}function runTimeDefault(key,new_default){if(!modified[key]){exports[key]=new_default}}function register(defs){Object.keys(defs).forEach(function(key){var def=defs[key];exports[key]=def.default_value;cmd_parse.registerValue(key,{type:def.type,label:def.label||titleCase(key.replace(/_/g," ")),range:def.range,get:function get(){return exports[key]},set:function set(v){modified[key]=true;exports[key]=v},store:true,ver:def.ver,help:def.help,usage:def.usage,on_change:def.on_change})})}register({max_fps:{label:"Max FPS",default_value:0,type:cmd_parse.TYPE_FLOAT},render_scale:{label:"Render Scale (3D)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.1,1]},render_scale_mode:{label:"Render Scale Mode",default_value:0,type:cmd_parse.TYPE_INT,range:[0,2]},render_scale_all:{label:"Render Scale (All)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.3333,4]},render_scale_clear:{label:"Render Scale Full Clear",default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]},fov:{default_value:60,type:cmd_parse.TYPE_FLOAT,range:[40,100]}});


},{"../../common/util.js":70,"./cmds.js":8,"./engine.js":11}],40:[function(require,module,exports){
"use strict";exports.addInclude=addInclude;exports.shadersResetState=shadersResetState;exports.create=create;exports.bind=bind;exports.addReservedDefine=addReservedDefine;exports.handleDefinesChanged=handleDefinesChanged;exports.setInternalDefines=setInternalDefines;exports.startup=startup;exports.addGlobal=addGlobal;exports.globals=exports.semantic=exports.MAX_SEMANTIC=void 0;var MAX_SEMANTIC=5;exports.MAX_SEMANTIC=MAX_SEMANTIC;var assert=require("assert");var engine=require("./engine.js");var _require=require("./error_report.js"),errorReportSetDetails=_require.errorReportSetDetails,glovErrorReport=_require.glovErrorReport;var _require2=require("./filewatch.js"),filewatchOn=_require2.filewatchOn;var _require3=require("../../common/util.js"),matchAll=_require3.matchAll;var _require4=require("./textures.js"),texturesUnloadDynamic=_require4.texturesUnloadDynamic;var _require5=require("./webfs.js"),webFSGetFile=_require5.webFSGetFile;var last_id=0;var bound_prog=null;var semantic={ATTR0:0,POSITION:0,ATTR1:1,COLOR:1,COLOR_0:1,ATTR2:2,TEXCOORD:2,TEXCOORD_0:2,ATTR3:3,NORMAL:3,ATTR4:4,TEXCOORD_1:4};exports.semantic=semantic;var globals;exports.globals=globals;var global_defines;var error_fp;var error_vp;var shaders=[];var vp_attr_regex=/attribute [^ ]+ ([^ ;]+);/g;var uniform_regex=/uniform (?:(?:low|medium|high)p )?((?:(?:vec|mat)\d(?:x\d)?|float) [^ ;]+);/g;var sampler_regex=/uniform sampler(?:2D|Cube) ([^ ;]+);/g;var include_regex=/\n#include "([^"]+)"/g;var type_size={float:1,vec2:2*1,vec3:3*1,vec4:4*1,mat3:3*3,mat4:4*4};var includes={};function loadInclude(key){var text=webFSGetFile(includes[key].filename,"text");includes[key].text='\n// from include "'+key+'":\n'+text+"\n"}function addInclude(key,filename){assert(!includes[key]);includes[key]={filename:filename};loadInclude(key)}function shadersResetState(){for(var ii=0;ii<shaders.length;++ii){var shader=shaders[ii];if(shader.programs){for(var fpid in shader.programs){var prog=shader.programs[fpid];for(var jj=0;jj<prog.uniforms.length;++jj){var unif=prog.uniforms[jj];for(var kk=0;kk<unif.size;++kk){unif.value[kk]=NaN}}}}}bound_prog=null;gl.useProgram(null)}function setGLErrorReportDetails(){var details={max_fragment_uniform_vectors:gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS),max_varying_vectors:gl.getParameter(gl.MAX_VARYING_VECTORS),max_vertex_attribs:gl.getParameter(gl.MAX_VERTEX_ATTRIBS),max_vertex_uniform_vectors:gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),vendor:gl.getParameter(gl.VENDOR),renderer:gl.getParameter(gl.RENDERER),webgl:engine.webgl2?2:1};var debug_info=gl.getExtension("WEBGL_debug_renderer_info");if(debug_info){details.renderer_unmasked=gl.getParameter(debug_info.UNMASKED_RENDERER_WEBGL);details.vendor_unmasked=gl.getParameter(debug_info.UNMASKED_VENDOR_WEBGL)}for(var key in details){errorReportSetDetails(key,details[key])}}var report_queued=false;var shader_errors;var shader_errors_any_fatal;function reportShaderError(non_fatal,err){function doReport(){setGLErrorReportDetails();var msg="Shader error(s):\n    "+shader_errors.join("\n    ");if(!shader_errors_any_fatal){glovErrorReport(false,msg,"shaders.js")}else{assert(false,msg)}shader_errors=null}if(!report_queued){setTimeout(doReport,1e3);report_queued=true;shader_errors=[];shader_errors_any_fatal=false}shader_errors_any_fatal=shader_errors_any_fatal||!non_fatal;shader_errors.push(err)}function parseIncludes(text){var supplied_uniforms={};text.replace(uniform_regex,function(str,key){supplied_uniforms[key]=true});text=text.replace(include_regex,function(str,filename){var replacement=includes[filename];if(!replacement){console.error("Could not evaluate "+str);return str}replacement=replacement.text;replacement=replacement.replace(uniform_regex,function(str2,key){if(supplied_uniforms[key]){return"// [removed "+key+"]"}supplied_uniforms[key]=true;return str2});return replacement});return text}var webgl2_header=["#version 300 es","#define WEBGL2"].join("\n");var webgl2_header_fp=[webgl2_header,"#define varying in","out lowp vec4 fragColor;","#define gl_FragColor fragColor","#define texture2D texture","#define textureCube texture",""].join("\n");var webgl2_header_vp=[webgl2_header,"#define varying out","#define attribute in",""].join("\n");function Shader(params){var filename=params.filename,defines=params.defines,non_fatal=params.non_fatal;assert.equal(typeof filename,"string");var type=filename.endsWith(".fp")?gl.FRAGMENT_SHADER:filename.endsWith(".vp")?gl.VERTEX_SHADER:0;assert(type);this.type=type;this.filename=filename;this.non_fatal=non_fatal;this.defines_arr=defines||[];this.defines=this.defines_arr.map(function(a){return"#define "+a+"\n"}).join("");this.shader=gl.createShader(type);this.id=++last_id;if(type===gl.VERTEX_SHADER){this.programs={}}shaders.push(this);this.compile()}Shader.prototype.compile=function(){var type=this.type,filename=this.filename;var header="";var text=webFSGetFile(filename,"text");if(engine.webgl2&&text.indexOf("#pragma WebGL2")!==-1){header=type===gl.VERTEX_SHADER?webgl2_header_vp:webgl2_header_fp}text=""+header+global_defines+this.defines+text;text=parseIncludes(text);text=text.replace(/#pragma WebGL2?/g,"");if(type===gl.VERTEX_SHADER){this.attributes=matchAll(text,vp_attr_regex);this.attributes.forEach(function(v){return assert(semantic[v]!==undefined)})}else{this.samplers=matchAll(text,sampler_regex);var found=[];this.samplers.forEach(function(v){var num=Number(v.slice(-1));assert(!isNaN(num));assert(!found[num]);found[num]=true})}this.uniforms=matchAll(text,uniform_regex);this.uniforms.forEach(function(v){var type_name=v.split(" ")[0];assert(type_size[type_name])});gl.shaderSource(this.shader,text);gl.compileShader(this.shader);if(!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)){this.valid=false;var error_text=gl.getShaderInfoLog(this.shader);if(error_text){error_text=error_text.replace(/\0/g,"").trim()}if(this.defines_arr.length){filename+="("+this.defines_arr.join(",")+")"}console[this.non_fatal?"warn":"error"]("Error compiling "+filename+": "+error_text);reportShaderError(this.non_fatal,filename+": "+error_text);console.log(text.split("\n").map(function(line,idx){return idx+1+": "+line}).join("\n"))}else{this.valid=true}};function create(filename){if(typeof filename==="object"){return new Shader(filename)}return new Shader({filename:filename})}function uniformSetValue(unif){switch(unif.width){case 1:gl.uniform1fv(unif.location,unif.value);break;case 2:gl.uniform2fv(unif.location,unif.value);break;case 3:gl.uniform3fv(unif.location,unif.value);break;case 4:gl.uniform4fv(unif.location,unif.value);break;case 9:gl.uniformMatrix3fv(unif.location,false,unif.value);break;case 16:gl.uniformMatrix4fv(unif.location,false,unif.value);break}}function link(vp,fp){var prog=vp.programs[fp.id]={handle:gl.createProgram(),uniforms:null};if(!prog.handle){assert(false,"gl.createProgram() returned "+prog.handle+(gl.createProgram()?", retry would succeed":""))}gl.attachShader(prog.handle,vp.shader);gl.attachShader(prog.handle,fp.shader);for(var ii=0;ii<vp.attributes.length;++ii){gl.bindAttribLocation(prog.handle,semantic[vp.attributes[ii]],vp.attributes[ii])}gl.linkProgram(prog.handle);prog.valid=gl.getProgramParameter(prog.handle,gl.LINK_STATUS);if(!prog.valid){reportShaderError(false,"Shader link error ("+vp.filename+" & "+fp.filename+"):"+(" "+gl.getProgramInfoLog(prog.handle)));console.error("Shader link error: "+gl.getProgramInfoLog(prog.handle))}gl.useProgram(prog.handle);bound_prog=prog;var uniforms=vp.uniforms.slice(0);for(var _ii=0;_ii<fp.uniforms.length;++_ii){var name=fp.uniforms[_ii];if(uniforms.indexOf(name)===-1){uniforms.push(name)}}prog.uniforms=uniforms.map(function(v){v=v.split(" ");var type=v[0];var name=v[1];var count=1;var m=name.match(/([^[]+)\[(\d+)\]/);if(m){name=m[1];count=Number(m[2])}var location=gl.getUniformLocation(prog.handle,name);if(location===null){return null}var width=type_size[type];var size=width*count;var glob=globals[name];var value=new Float32Array(size);var unif={name:name,size:size,width:width,count:count,value:value,location:location,glob:glob};uniformSetValue(unif);return unif}).filter(function(v){return v});for(var _ii2=0;_ii2<fp.samplers.length;++_ii2){var _name=fp.samplers[_ii2];var num=Number(_name.slice(-1));var location=gl.getUniformLocation(prog.handle,_name);if(location!==null){gl.uniform1i(location,num)}}return prog}function bind(vp,fp,params){var prog=vp.programs[fp.id];if(!prog){prog=link(vp,fp)}if(!prog.valid){prog=link(vp,error_fp);if(!prog.valid){prog=link(error_vp,error_fp)}vp.programs[fp.id]=prog}if(prog!==bound_prog){bound_prog=prog;gl.useProgram(prog.handle)}for(var ii=0;ii<prog.uniforms.length;++ii){var unif=prog.uniforms[ii];var value=params[unif.name]||unif.glob;if(!value){continue}var diff=false;for(var jj=0;jj<unif.size;++jj){if(value[jj]!==unif.value[jj]){diff=true;break}}if(diff){for(var _jj=0;_jj<unif.size;++_jj){unif.value[_jj]=value[_jj]}uniformSetValue(unif)}}}var reserved={WEBGL2:1};function addReservedDefine(key){reserved[key]=1}var internal_defines={};function applyDefines(){global_defines=Object.keys(engine.defines).filter(function(v){return!reserved[v]}).concat(Object.keys(internal_defines)).map(function(v){return"#define "+v+"\n"}).join("")}function shaderReload(){if(shaders.length){window.debugmsg("",true);gl.useProgram(null);for(var ii=0;ii<shaders.length;++ii){var programs=shaders[ii].programs;if(programs){for(var id in programs){gl.deleteProgram(programs[id].handle)}shaders[ii].programs={}}}for(var _ii3=0;_ii3<shaders.length;++_ii3){shaders[_ii3].compile()}texturesUnloadDynamic()}}function handleDefinesChanged(){applyDefines();shaderReload()}function setInternalDefines(new_values){for(var key in new_values){if(new_values[key]){internal_defines[key]=new_values[key]}else{delete internal_defines[key]}}handleDefinesChanged()}function onShaderChange(filename){for(var key in includes){loadInclude(key)}shaderReload()}function startup(_globals){applyDefines();exports.globals=globals=_globals;error_fp=create("glov/shaders/error.fp");error_vp=create("glov/shaders/error.vp");filewatchOn(".fp",onShaderChange);filewatchOn(".vp",onShaderChange)}function addGlobal(key,vec){assert(!globals[key]);globals[key]=vec}


},{"../../common/util.js":70,"./engine.js":11,"./error_report.js":12,"./filewatch.js":14,"./textures.js":45,"./webfs.js":51,"assert":undefined}],41:[function(require,module,exports){
"use strict";exports.soundLoad=soundLoad;exports.soundStartup=soundStartup;exports.soundPause=soundPause;exports.soundResume=soundResume;exports.soundResumed=soundResumed;exports.soundTick=soundTick;exports.soundPlay=soundPlay;exports.soundPlayMusic=soundPlayMusic;exports.soundLoading=soundLoading;exports.FADE=exports.FADE_IN=exports.FADE_OUT=exports.FADE_DEFAULT=void 0;var FADE_DEFAULT=0;exports.FADE_DEFAULT=FADE_DEFAULT;var FADE_OUT=1;exports.FADE_OUT=FADE_OUT;var FADE_IN=2;exports.FADE_IN=FADE_IN;var FADE=FADE_OUT+FADE_IN;exports.FADE=FADE;var assert=require("assert");var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse;var _require2=require("./filewatch.js"),filewatchOn=_require2.filewatchOn;var _require3=require("@jimbly/howler/src/howler.core.js"),Howl=_require3.Howl,Howler=_require3.Howler;var abs=Math.abs,floor=Math.floor,max=Math.max,min=Math.min,random=Math.random;var settings=require("./settings.js");var urlhash=require("./urlhash.js");var _require4=require("../../common/util.js"),defaults=_require4.defaults,ridx=_require4.ridx;var DEFAULT_FADE_RATE=.001;var sounds={};var num_loading=0;var default_params={ext_list:["mp3","wav"],fade_rate:DEFAULT_FADE_RATE};var sound_params;var last_played={};var frame_timestamp=0;var fades=[];var music;var volume_override=1;var volume_override_target=1;settings.register({volume:{default_value:1,type:cmd_parse.TYPE_FLOAT,range:[0,1]}});settings.register({sound:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]}});settings.register({music:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]}});function soundLoad(base,opts,cb){opts=opts||{};if(Array.isArray(base)){assert(!cb);for(var ii=0;ii<base.length;++ii){soundLoad(base[ii],opts)}return}var key=base;if(sounds[key]){if(cb){cb()}return}var m=base.match(/^((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)\.(mp3|ogg|wav|webm)$/);var preferred_ext;if(m){base=m[1];preferred_ext=m[2]}var src="sounds/"+base;var srcs=[];var suffix="";if(opts.for_reload){suffix="?rl="+Date.now()}if(preferred_ext){srcs.push(""+urlhash.getURLBase()+src+"."+preferred_ext+suffix)}for(var _ii=0;_ii<sound_params.ext_list.length;++_ii){var ext=sound_params.ext_list[_ii];if(ext!==preferred_ext){srcs.push(""+urlhash.getURLBase()+src+"."+ext+suffix)}}function tryLoad(idx){if(idx===srcs.length){console.error("Error loading sound "+base+": All fallbacks exhausted, giving up");if(cb){cb("Error loading sound")}return}++num_loading;var once=false;var sound=new Howl({src:srcs.slice(idx),html5:Boolean(opts.streaming),loop:Boolean(opts.loop),volume:0,onload:function onload(){if(!once){--num_loading;once=true;sound.glov_load_opts=opts;sounds[key]=sound;if(cb){cb(null)}}},onloaderror:function onloaderror(id,err,extra){if(idx===srcs.length-1){console.error("Error loading sound "+srcs[idx]+": "+err)}else{console.log("Error loading sound "+srcs[idx]+": "+err+", trying fallback...")}if(!once){--num_loading;once=true;tryLoad(idx+1)}}})}tryLoad(0)}function soundReload(filename){var sound_name=filename.match(/^sounds\/([^.]+)\.\w+$/);sound_name=sound_name&&sound_name[1];if(!sound_name){return}if(!sounds[sound_name]){console.log("Reload trigged for non-existent sound: "+filename);return}var opts=sounds[sound_name].glov_load_opts;opts.for_reload=true;delete sounds[sound_name];soundLoad(sound_name,opts)}function soundStartup(params){sound_params=defaults(params||{},default_params);music=[];for(var ii=0;ii<2;++ii){music.push({sound:null,id:0,current_volume:0,target_volume:0,sys_volume:0,need_play:false})}filewatchOn(".mp3",soundReload);filewatchOn(".ogg",soundReload);filewatchOn(".wav",soundReload);filewatchOn(".webm",soundReload)}function soundPause(){volume_override=volume_override_target=0;soundTick(0)}function soundResume(){volume_override_target=1}function soundResumed(){return!Howler.noAudio&&Howler.safeToPlay}function soundTick(dt){frame_timestamp+=dt;if(volume_override!==volume_override_target){var delta=dt*.004;if(volume_override<volume_override_target){volume_override=min(volume_override+delta,volume_override_target)}else{volume_override=max(volume_override-delta,volume_override_target)}}if(!soundResumed()){return}var max_fade=dt*sound_params.fade_rate;for(var ii=0;ii<music.length;++ii){var mus=music[ii];if(!mus.sound){continue}var target=settings.music?mus.target_volume:0;if(mus.current_volume!==target){var _delta=target-mus.current_volume;var fade_amt=min(abs(_delta),max_fade);if(_delta<0){mus.current_volume=max(target,mus.current_volume-fade_amt)}else{mus.current_volume=min(target,mus.current_volume+fade_amt)}if(!mus.target_volume&&!mus.current_volume){if(!mus.need_play){mus.sound.stop(mus.id)}mus.sound=null}}if(mus.sound){var sys_volume=mus.current_volume*settings.volume*volume_override;if(mus.need_play){mus.need_play=false;mus.id=mus.sound.play();mus.sys_volume=-1}if(mus.sys_volume!==sys_volume){mus.sound.volume(sys_volume,mus.id);mus.sys_volume=sys_volume}}}for(var _ii2=fades.length-1;_ii2>=0;--_ii2){var fade=fades[_ii2];fade.volume=max(0,fade.volume-max_fade);fade.sound.volume(fade.volume*settings.volume*volume_override,fade.id);if(!fade.volume){fade.sound.stop(fade.id);ridx(fades,_ii2)}}}function soundPlay(soundname,volume,as_music){volume=volume||1;if(!as_music&&!settings.sound||as_music&&!settings.music){return null}if(!soundResumed()){return null}if(Array.isArray(soundname)){soundname=soundname[floor(random()*soundname.length)]}var sound=sounds[soundname];if(!sound){return null}var last_played_time=last_played[soundname]||-9e9;if(frame_timestamp-last_played_time<45){return null}var id=sound.play(undefined,volume*settings.volume*volume_override);last_played[soundname]=frame_timestamp;return{stop:sound.stop.bind(sound,id),playing:sound.playing.bind(sound,id),fadeOut:function fadeOut(time){fades.push({volume:volume,sound:sound,id:id,time:time})}}}function soundPlayMusic(soundname,volume,transition){if(!settings.music){return}if(volume===undefined){volume=1}transition=transition||FADE_DEFAULT;soundLoad(soundname,{streaming:true,loop:true},function(err){assert(!err);var sound=sounds[soundname];assert(sound);if(music[0].sound===sound){music[0].target_volume=volume;if(!transition){if(!volume){sound.stop(music[0].id);music[0].sound=null}else{var sys_volume=music[0].sys_volume=volume*settings.volume*volume_override;sound.volume(sys_volume,music[0].id)}}return}if(music[0].current_volume){if(transition&FADE_OUT){var temp=music[1];music[1]=music[0];music[0]=temp;music[1].target_volume=0}}if(music[0].sound){music[0].sound.stop(music[0].id)}music[0].sound=sound;music[0].target_volume=volume;var start_vol=transition&FADE_IN?0:volume;music[0].current_volume=start_vol;if(soundResumed()){var _sys_volume=start_vol*settings.volume*volume_override;music[0].id=sound.play(undefined,_sys_volume);music[0].sys_volume=_sys_volume;music[0].need_play=false}else{music[0].need_play=true}})}function soundLoading(){return num_loading}


},{"../../common/util.js":70,"./cmds.js":8,"./filewatch.js":14,"./settings.js":39,"./urlhash.js":48,"@jimbly/howler/src/howler.core.js":undefined,"assert":undefined}],42:[function(require,module,exports){
"use strict";exports.create=create;var floor=Math.floor,random=Math.random;function GlovSpriteAnimation(params){this.frame=0;this.time=0;this.state=null;this.anim=null;this.anim_idx=0;if(params instanceof GlovSpriteAnimation){this.data=params.data;this.setState(params.state)}else{this.data=params;for(var key in this.data){var anim=this.data[key];if(typeof anim.frames==="number"){anim.frames=[anim.frames]}if(typeof anim.times==="number"){var arr=new Array(anim.frames.length);for(var ii=0;ii<anim.frames.length;++ii){arr[ii]=anim.times}anim.times=arr}anim.total_time=0;for(var _ii=0;_ii<anim.times.length;++_ii){anim.total_time+=anim.times[_ii]}if(anim.loop===undefined){anim.loop=true}}}}function create(params){return new GlovSpriteAnimation(params)}GlovSpriteAnimation.prototype.clone=function(){return new GlovSpriteAnimation(this)};GlovSpriteAnimation.prototype.setState=function(state,force){if(state===this.state&&!force){return this}this.state=state;this.anim=this.data[state];if(this.anim.init_time){this.time=floor(random()*this.anim.init_time)}else{this.time=0}this.anim_idx=0;this.frame=this.anim.frames[this.anim_idx];return this};GlovSpriteAnimation.prototype.progress=function(){if(!this.anim){return 1}var time=this.time;for(var ii=0;ii<this.anim_idx;++ii){time+=this.anim.times[ii]}return time/this.anim.total_time};GlovSpriteAnimation.prototype.update=function(dt){if(!this.anim){return}this.time+=dt;if(this.time>this.anim.times[this.anim_idx]){this.time-=this.anim.times[this.anim_idx];this.anim_idx=this.anim_idx+1;if(this.anim_idx===this.anim.frames.length){if(this.anim.loop){this.anim_idx=this.anim_idx%this.anim.frames.length}else{this.anim=null;return}}this.frame=this.anim.frames[this.anim_idx];if(this.time>=this.anim.times[this.anim_idx]){this.time=this.anim.times[this.anim_idx]-1}}};GlovSpriteAnimation.prototype.getFrame=function(dt){if(dt!==undefined){this.update(dt)}return this.frame};


},{}],43:[function(require,module,exports){
"use strict";exports.spriteQueuePush=spriteQueuePush;exports.spriteQueuePop=spriteQueuePop;exports.queuefn=queuefn;exports.queueraw4=queueraw4;exports.queueraw=queueraw;exports.queuesprite=queuesprite;exports.clip=clip;exports.clipped=clipped;exports.clipPush=clipPush;exports.clipPop=clipPop;exports.clipPause=clipPause;exports.clipResume=clipResume;exports.draw=draw;exports.buildRects=buildRects;exports.create=create;exports.startup=startup;exports.BLEND_ADDITIVE=exports.BLEND_ALPHA=void 0;var assert=require("assert");var camera2d=require("./camera2d.js");var engine=require("./engine.js");var geom=require("./geom.js");var cos=Math.cos,max=Math.max,min=Math.min,round=Math.round,sin=Math.sin;var textures=require("./textures.js");var shaders=require("./shaders.js");var _require=require("../../common/util.js"),nextHighestPowerOfTwo=_require.nextHighestPowerOfTwo;var _require2=require("./vmath.js"),vec2=_require2.vec2,vec4=_require2.vec4;var BLEND_ALPHA=0;exports.BLEND_ALPHA=BLEND_ALPHA;var BLEND_ADDITIVE=1;exports.BLEND_ADDITIVE=BLEND_ADDITIVE;var sprite_vshader;var sprite_fshader;var sprite_dual_fshader;var clip_space=vec4();var sprite_shader_params={clip_space:clip_space};var last_uid=0;var sprite_queue=[];var sprite_freelist=[];var sprite_queue_stack=[];function spriteQueuePush(new_list){assert(sprite_queue_stack.length<10);sprite_queue_stack.push(sprite_queue);sprite_queue=new_list||[]}function spriteQueuePop(for_pause){assert(sprite_queue_stack.length);assert(for_pause||!sprite_queue.length);sprite_queue=sprite_queue_stack.pop()}function SpriteData(){this.data=new Float32Array(16);this.texs=null;this.shader=null;this.shader_params=null;this.x=0;this.y=0;this.z=0;this.blend=0;this.uid=0}function spriteDataAlloc(){if(sprite_freelist.length){return sprite_freelist.pop()}return new SpriteData}function cmpSprite(a,b){if(a.z!==b.z){return a.z-b.z}if(a.y!==b.y){return a.y-b.y}if(a.x!==b.x){return a.x-b.x}return a.uid-b.uid}function queuefn(z,fn){assert(isFinite(z));sprite_queue.push({fn:fn,x:0,y:0,z:z,uid:++last_uid})}function queueraw4(texs,x0,y0,x1,y1,x2,y2,x3,y3,z,u0,v0,u1,v1,color,shader,shader_params,blend){assert(isFinite(z));var elem=spriteDataAlloc();var data=elem.data;data[0]=(x0-camera2d.data[0])*camera2d.data[4];data[1]=(y0-camera2d.data[1])*camera2d.data[5];data[2]=(x1-camera2d.data[0])*camera2d.data[4];data[3]=(y1-camera2d.data[1])*camera2d.data[5];data[4]=(x2-camera2d.data[0])*camera2d.data[4];data[5]=(y2-camera2d.data[1])*camera2d.data[5];data[6]=(x3-camera2d.data[0])*camera2d.data[4];data[7]=(y3-camera2d.data[1])*camera2d.data[5];data[8]=color[0];data[9]=color[1];data[10]=color[2];data[11]=color[3];data[12]=u0;data[13]=v0;data[14]=u1;data[15]=v1;elem.texs=texs;elem.x=data[0];elem.y=data[1];elem.z=z;elem.shader=shader||null;if(shader_params){shader_params.clip_space=sprite_shader_params.clip_space;elem.shader_params=shader_params}else{elem.shader_params=null}elem.blend=blend||0;elem.uid=++last_uid;sprite_queue.push(elem);return elem}function queueraw(texs,x,y,z,w,h,u0,v0,u1,v1,color,shader,shader_params,blend){return queueraw4(texs,x,y,x,y+h,x+w,y+h,x+w,y,z,u0,v0,u1,v1,color,shader,shader_params,blend)}function queuesprite(sprite,x,y,z,w,h,rot,uvs,color,shader,shader_params,nozoom,pixel_perfect){assert(isFinite(z));var elem=spriteDataAlloc();elem.texs=sprite.texs;x=(x-camera2d.data[0])*camera2d.data[4];y=(y-camera2d.data[1])*camera2d.data[5];elem.z=z;w*=camera2d.data[4];h*=camera2d.data[5];if(pixel_perfect){x|=0;y|=0;w|=0;h|=0}elem.x=x;elem.y=y;color=color||sprite.color;var data=elem.data;if(!rot){var x1=x-sprite.origin[0]*w;var y1=y-sprite.origin[1]*h;var x2=x1+w;var y2=y1+h;data[0]=x1;data[1]=y1;data[2]=x1;data[3]=y2;data[4]=x2;data[5]=y2;data[6]=x2;data[7]=y1}else{var dx=sprite.origin[0]*w;var dy=sprite.origin[1]*h;var cosr=cos(rot);var sinr=sin(rot);var _x=x-cosr*dx+sinr*dy;var _y=y-sinr*dx-cosr*dy;var ch=cosr*h;var cw=cosr*w;var sh=sinr*h;var sw=sinr*w;data[0]=_x;data[1]=_y;data[2]=_x-sh;data[3]=_y+ch;data[4]=_x+cw-sh;data[5]=_y+sw+ch;data[6]=_x+cw;data[7]=_y+sw}data[8]=color[0];data[9]=color[1];data[10]=color[2];data[11]=color[3];var ubias=0;var vbias=0;var tex=elem.texs[0];if(!nozoom&&!tex.nozoom){var zoom_level=max((uvs[2]-uvs[0])*tex.width/w,(uvs[3]-uvs[1])*tex.height/h);if(zoom_level<1){if(tex.filter_mag===gl.LINEAR){ubias=vbias=.5}else if(tex.filter_mag===gl.NEAREST&&engine.antialias){ubias=vbias=zoom_level/2}}else if(zoom_level>1){var mipped_texels=zoom_level/2;ubias=vbias=.5+mipped_texels}if(uvs[0]>uvs[2]){ubias*=-1}if(uvs[1]>uvs[3]){vbias*=-1}}data[12]=uvs[0]+ubias/tex.width;data[13]=uvs[1]+vbias/tex.height;data[14]=uvs[2]-ubias/tex.width;data[15]=uvs[3]-vbias/tex.height;elem.uid=++last_uid;elem.shader=shader||null;elem.blend=0;if(shader_params){shader_params.clip_space=sprite_shader_params.clip_space;elem.shader_params=shader_params}else{elem.shader_params=null}sprite_queue.push(elem)}var clip_temp_xy=vec2();var clip_temp_wh=vec2();function clipCoordsScissor(x,y,w,h){camera2d.virtualToCanvas(clip_temp_xy,[x,y]);clip_temp_xy[0]=round(clip_temp_xy[0]);clip_temp_xy[1]=round(clip_temp_xy[1]);camera2d.virtualToCanvas(clip_temp_wh,[x+w,y+h]);clip_temp_wh[0]=round(clip_temp_wh[0])-clip_temp_xy[0];clip_temp_wh[1]=round(clip_temp_wh[1])-clip_temp_xy[1];var gd_h=engine.render_height||engine.height;return[clip_temp_xy[0],gd_h-(clip_temp_xy[1]+clip_temp_wh[1]),clip_temp_wh[0],clip_temp_wh[1]]}function clipCoordsDom(x,y,w,h){var xywh=vec4();camera2d.virtualToDom(xywh,[x+w,y+h]);xywh[2]=xywh[0];xywh[3]=xywh[1];camera2d.virtualToDom(xywh,[x,y]);xywh[0]=round(xywh[0]);xywh[1]=round(xywh[1]);xywh[2]=round(xywh[2])-xywh[0];xywh[3]=round(xywh[3])-xywh[1];return xywh}function clip(z_start,z_end,x,y,w,h){var scissor=clipCoordsScissor(x,y,w,h);queuefn(z_start-.01,function(){gl.enable(gl.SCISSOR_TEST);gl.scissor(scissor[0],scissor[1],scissor[2],scissor[3])});queuefn(z_end-.01,function(){gl.disable(gl.SCISSOR_TEST)})}var clip_stack=[];function clipped(){return clip_stack.length>0}function clipPush(z,x,y,w,h){assert(clip_stack.length<10);var scissor=clipCoordsScissor(x,y,w,h);var dom_clip=clipCoordsDom(x,y,w,h);camera2d.setInputClipping(dom_clip);spriteQueuePush();clip_stack.push({z:z,scissor:scissor,dom_clip:dom_clip})}function clipPop(){assert(clipped());queuefn(Z.TOOLTIP-.1,function(){gl.disable(gl.SCISSOR_TEST)});var _clip_stack$pop=clip_stack.pop(),z=_clip_stack$pop.z,scissor=_clip_stack$pop.scissor;var sprites=sprite_queue;spriteQueuePop(true);if(clip_stack.length){var dom_clip=clip_stack[clip_stack.length-1].dom_clip;camera2d.setInputClipping(dom_clip)}else{camera2d.setInputClipping(null)}queuefn(z,function(){gl.enable(gl.SCISSOR_TEST);gl.scissor(scissor[0],scissor[1],scissor[2],scissor[3]);spriteQueuePush();sprite_queue=sprites;exports.draw();spriteQueuePop()})}var clip_paused;function clipPause(){assert(clipped());assert(!clip_paused);clip_paused=true;spriteQueuePush(sprite_queue_stack[0]);camera2d.setInputClipping(null);clip_stack.push({dom_clip:null})}function clipResume(){assert(clipped());assert(clip_paused);clip_stack.pop();clip_paused=false;assert(clipped());var dom_clip=clip_stack[clip_stack.length-1].dom_clip;spriteQueuePop(true);camera2d.setInputClipping(dom_clip)}function diffTextures(texsa,texsb){if(texsa.length!==texsb.length){return true}for(var ii=0;ii<texsa.length;++ii){if(texsa[ii]!==texsb[ii]){return true}}return false}var batch_state;var sprite_geom;var sprite_buffer;var sprite_buffer_len=0;var sprite_buffer_batch_start=0;var sprite_buffer_idx=0;var last_blend_mode;var last_bound_shader;var MAX_VERT_COUNT=65536;var batches=[];function commit(){if(sprite_buffer_idx===sprite_buffer_batch_start){return}batches.push({state:batch_state,start:sprite_buffer_batch_start,end:sprite_buffer_idx});sprite_buffer_batch_start=sprite_buffer_idx}function commitAndFlush(){commit();if(!batches.length){return}assert(sprite_buffer_idx);sprite_geom.update(sprite_buffer,sprite_buffer_idx);sprite_geom.bind();for(var ii=0;ii<batches.length;++ii){var batch=batches[ii];var state=batch.state,start=batch.start,end=batch.end;if(last_bound_shader!==state.shader||state.shader_params){shaders.bind(sprite_vshader,state.shader||sprite_fshader,state.shader_params||sprite_shader_params);last_bound_shader=state.shader}if(last_blend_mode!==state.blend){last_blend_mode=state.blend;if(last_blend_mode===BLEND_ADDITIVE){gl.blendFunc(gl.SRC_ALPHA,gl.ONE)}else{gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}}textures.bindArray(state.texs);gl.drawElements(sprite_geom.mode,(end-start)*3/2,gl.UNSIGNED_SHORT,start*3)}batches.length=0;sprite_buffer_idx=0;sprite_buffer_batch_start=0}function bufferSpriteData(data){var index=sprite_buffer_idx*8;sprite_buffer_idx+=4;var c1=data[8];var c2=data[9];var c3=data[10];var c4=data[11];var u1=data[12];var v1=data[13];var u2=data[14];var v2=data[15];sprite_buffer[index]=data[0];sprite_buffer[index+1]=data[1];sprite_buffer[index+2]=c1;sprite_buffer[index+3]=c2;sprite_buffer[index+4]=c3;sprite_buffer[index+5]=c4;sprite_buffer[index+6]=u1;sprite_buffer[index+7]=v1;sprite_buffer[index+8]=data[2];sprite_buffer[index+9]=data[3];sprite_buffer[index+10]=c1;sprite_buffer[index+11]=c2;sprite_buffer[index+12]=c3;sprite_buffer[index+13]=c4;sprite_buffer[index+14]=u1;sprite_buffer[index+15]=v2;sprite_buffer[index+16]=data[4];sprite_buffer[index+17]=data[5];sprite_buffer[index+18]=c1;sprite_buffer[index+19]=c2;sprite_buffer[index+20]=c3;sprite_buffer[index+21]=c4;sprite_buffer[index+22]=u2;sprite_buffer[index+23]=v2;sprite_buffer[index+24]=data[6];sprite_buffer[index+25]=data[7];sprite_buffer[index+26]=c1;sprite_buffer[index+27]=c2;sprite_buffer[index+28]=c3;sprite_buffer[index+29]=c4;sprite_buffer[index+30]=u2;sprite_buffer[index+31]=v1}function draw(){if(engine.defines.NOSPRITES){sprite_queue.length=0}if(!sprite_queue.length){return}clip_space[0]=2/engine.viewport[2];clip_space[1]=-2/engine.viewport[3];last_blend_mode=-1;last_bound_shader=-1;if(!sprite_geom){sprite_geom=geom.create([[shaders.semantic.POSITION,gl.FLOAT,2,false],[shaders.semantic.COLOR,gl.FLOAT,4,false],[shaders.semantic.TEXCOORD,gl.FLOAT,2,false]],[],null,geom.QUADS);sprite_buffer=new Float32Array(1024);sprite_buffer_len=sprite_buffer.length/8}sprite_queue.sort(cmpSprite);batch_state=null;assert.equal(sprite_buffer_idx,0);assert.equal(sprite_buffer_batch_start,0);assert.equal(batches.length,0);for(var ii=0;ii<sprite_queue.length;++ii){var elem=sprite_queue[ii];if(elem.fn){commitAndFlush();batch_state=null;elem.fn();last_bound_shader=-1;last_blend_mode=-1;assert.equal(sprite_buffer_idx,0);assert.equal(sprite_buffer_batch_start,0);assert.equal(batches.length,0);clip_space[0]=2/engine.viewport[2];clip_space[1]=-2/engine.viewport[3]}else{if(!batch_state||diffTextures(elem.texs,batch_state.texs)||elem.shader!==batch_state.shader||elem.shader_params!==batch_state.shader_params||elem.blend!==batch_state.blend){commit();batch_state=elem}if(sprite_buffer_idx+4>sprite_buffer_len){commitAndFlush();if(sprite_buffer_len!==MAX_VERT_COUNT){var new_length=min(sprite_buffer_len*1.25+3&~3,MAX_VERT_COUNT);sprite_buffer_len=new_length;sprite_buffer=new Float32Array(new_length*8)}}bufferSpriteData(elem.data);sprite_freelist.push(elem)}}commitAndFlush();sprite_queue.length=0;if(last_blend_mode!==BLEND_ALPHA){gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}}function buildRects(ws,hs){var rects=[];var total_w=0;for(var ii=0;ii<ws.length;++ii){total_w+=ws[ii]}var total_h=0;for(var _ii=0;_ii<hs.length;++_ii){total_h+=hs[_ii]}var tex_w=nextHighestPowerOfTwo(total_w);var tex_h=nextHighestPowerOfTwo(total_h);var wh=[];for(var _ii2=0;_ii2<ws.length;++_ii2){wh.push(ws[_ii2]/total_h)}var hw=[];for(var _ii3=0;_ii3<hs.length;++_ii3){hw.push(hs[_ii3]/total_w)}var aspect=[];var non_square=false;var y=0;for(var jj=0;jj<hs.length;++jj){var x=0;for(var _ii4=0;_ii4<ws.length;++_ii4){var r=vec4(x/tex_w,y/tex_h,(x+ws[_ii4])/tex_w,(y+hs[jj])/tex_h);rects.push(r);var asp=ws[_ii4]/hs[jj];if(asp!==1){non_square=true}aspect.push(asp);x+=ws[_ii4]}y+=hs[jj]}return{widths:ws,heights:hs,wh:wh,hw:hw,rects:rects,aspect:non_square?aspect:null,total_w:total_w,total_h:total_h}}function Sprite(params){var _this=this;if(params.texs){this.texs=params.texs}else{var ext=params.ext||".png";this.texs=[];if(params.tex){this.texs.push(params.tex)}else if(params.layers){assert(params.name);this.texs=[];for(var ii=0;ii<params.layers;++ii){this.texs.push(textures.load({url:"img/"+params.name+"_"+ii+ext,filter_min:params.filter_min,filter_mag:params.filter_mag,wrap_s:params.wrap_s,wrap_t:params.wrap_t}))}}else if(params.name){this.texs.push(textures.load({url:"img/"+params.name+ext,filter_min:params.filter_min,filter_mag:params.filter_mag,wrap_s:params.wrap_s,wrap_t:params.wrap_t}))}else{assert(params.url);this.texs.push(textures.load(params))}}this.origin=params.origin||vec2(0,0);this.size=params.size||vec2(1,1);this.color=params.color||vec4(1,1,1,1);this.uvs=params.uvs||vec4(0,0,1,1);if(!params.uvs){this.texs[0].onLoad(function(tex){_this.uvs[2]=tex.src_width/tex.width;_this.uvs[3]=tex.src_height/tex.height})}if(params.ws){this.uidata=buildRects(params.ws,params.hs)}this.shader=params.shader||null}Sprite.prototype.draw=function(params){if(params.w===0||params.h===0){return}var w=(params.w||1)*this.size[0];var h=(params.h||1)*this.size[1];var uvs=typeof params.frame==="number"?this.uidata.rects[params.frame]:params.uvs||this.uvs;queuesprite(this,params.x,params.y,params.z||Z.UI,w,h,params.rot,uvs,params.color||this.color,params.shader||this.shader,params.shader_params,params.nozoom,params.pixel_perfect)};Sprite.prototype.drawDualTint=function(params){params.shader=sprite_dual_fshader;params.shader_params={color1:params.color1};this.draw(params)};function create(params){return new Sprite(params)}function startup(){clip_space[2]=-1;clip_space[3]=1;sprite_vshader=shaders.create("glov/shaders/sprite.vp");sprite_fshader=shaders.create("glov/shaders/sprite.fp");sprite_dual_fshader=shaders.create("glov/shaders/sprite_dual.fp")}


},{"../../common/util.js":70,"./camera2d.js":6,"./engine.js":11,"./geom.js":18,"./shaders.js":40,"./textures.js":45,"./vmath.js":49,"assert":undefined}],44:[function(require,module,exports){
"use strict";exports.create=create;var assert=require("assert");var dot_prop=require("dot-prop");var EventEmitter=require("../../common/tiny-events.js");var _require=require("./fbinstant.js"),fbGetLoginInfo=_require.fbGetLoginInfo;var local_storage=require("./local_storage.js");var md5=require("../../common/md5.js");var _require2=require("../../common/packet.js"),isPacket=_require2.isPacket;var util=require("../../common/util.js");function ClientChannelWorker(subs,channel_id,base_handlers){EventEmitter.call(this);this.subs=subs;this.channel_id=channel_id;this.subscriptions=0;this.subscribe_failed=false;this.got_subscribe=false;this.immediate_subscribe=0;this.channel_data_ver=0;this.handlers=Object.create(base_handlers);this.data={}}util.inherits(ClientChannelWorker,EventEmitter);ClientChannelWorker.prototype.onSubscribe=function(cb){assert(this.subscriptions||this.autosubscribed);this.on("subscribe",cb);if(this.got_subscribe){cb(this.data)}};ClientChannelWorker.prototype.onceSubscribe=function(cb){assert(this.subscriptions||this.autosubscribed);if(this.got_subscribe){cb(this.data)}else{this.once("subscribe",cb)}};ClientChannelWorker.prototype.handleChannelData=function(data,resp_func){var _this=this;console.log("got channel_data("+this.channel_id+"):  "+JSON.stringify(data));this.data=data;++this.channel_data_ver;this.emit("channel_data",this.data);this.got_subscribe=true;this.emit("subscribe",this.data);var channel_type=this.channel_id.split(".")[0];var cmd_list=this.subs.cmds_fetched_by_type;if(cmd_list&&!cmd_list[channel_type]){cmd_list[channel_type]=true;this.send("cmdparse","cmd_list",function(err,resp){if(err){console.error("Error getting cmd_list for "+channel_type);delete cmd_list[channel_type]}else{_this.subs.cmd_parse.addServerCommands(resp)}})}resp_func()};ClientChannelWorker.prototype.handleApplyChannelData=function(data,resp_func){if(data.value===undefined){dot_prop.delete(this.data,data.key)}else{dot_prop.set(this.data,data.key,data.value)}++this.channel_data_ver;this.emit("channel_data",this.data,data.key,data.value);resp_func()};ClientChannelWorker.prototype.getChannelData=function(key,default_value){return dot_prop.get(this.data,key,default_value)};ClientChannelWorker.prototype.setChannelData=function(key,value,skip_predict,resp_func){if(!skip_predict){dot_prop.set(this.data,key,value)}var q=value&&value.q||undefined;var pak=this.subs.client.pak("set_channel_data");pak.writeAnsiString(this.channel_id);pak.writeBool(q);pak.writeAnsiString(key);pak.writeJSON(value);pak.send(resp_func)};ClientChannelWorker.prototype.removeMsgHandler=function(msg,cb){assert(this.handlers[msg]===cb);delete this.handlers[msg]};ClientChannelWorker.prototype.onMsg=function(msg,cb){assert(!this.handlers[msg]||this.handlers[msg]===cb);this.handlers[msg]=cb};ClientChannelWorker.prototype.pak=function(msg){var pak=this.subs.client.pak("channel_msg");pak.writeAnsiString(this.channel_id);pak.writeAnsiString(msg);return pak};ClientChannelWorker.prototype.send=function(msg,data,resp_func,old_fourth){assert(!resp_func||typeof resp_func==="function");assert(!old_fourth);this.subs.client.send("channel_msg",{channel_id:this.channel_id,msg:msg,data:data},resp_func)};ClientChannelWorker.prototype.cmdParse=function(cmd,resp_func){this.send("cmdparse",cmd,resp_func)};function SubscriptionManager(client,cmd_parse){EventEmitter.call(this);this.client=client;this.channels={};this.logged_in=false;this.login_credentials=null;this.logged_in_username=null;this.was_logged_in=false;this.logging_in=false;this.logging_out=false;this.auto_create_user=false;this.cmd_parse=cmd_parse;if(cmd_parse){this.cmds_fetched_by_type={}}this.base_handlers={};this.channel_handlers={};this.first_connect=true;this.server_time=0;this.server_time_interp=0;client.onMsg("connect",this.handleConnect.bind(this));client.onMsg("channel_msg",this.handleChannelMessage.bind(this));client.onMsg("server_time",this.handleServerTime.bind(this));client.onMsg("chat_broadcast",this.handleChatBroadcast.bind(this));client.onMsg("restarting",this.handleRestarting.bind(this));if(cmd_parse){client.onMsg("csr_to_client",this.handleCSRToClient.bind(this))}this.onChannelMsg(null,"channel_data",ClientChannelWorker.prototype.handleChannelData);this.onChannelMsg(null,"apply_channel_data",ClientChannelWorker.prototype.handleApplyChannelData)}util.inherits(SubscriptionManager,EventEmitter);SubscriptionManager.prototype.onceConnected=function(cb){if(this.client.connected){return void cb()}this.once("connect",cb)};SubscriptionManager.prototype.getBaseHandlers=function(channel_type){var handlers=this.channel_handlers[channel_type];if(!handlers){handlers=this.channel_handlers[channel_type]=Object.create(this.base_handlers)}return handlers};SubscriptionManager.prototype.onChannelMsg=function(channel_type,msg,cb){var handlers=channel_type?this.getBaseHandlers(channel_type):this.base_handlers;assert(!handlers[msg]);handlers[msg]=cb};SubscriptionManager.prototype.handleChatBroadcast=function(data){console.error("["+data.src+"] "+data.msg);this.emit("chat_broadcast",data)};SubscriptionManager.prototype.handleRestarting=function(data){this.restarting=data;this.emit("restarting",data)};SubscriptionManager.prototype.handleConnect=function(data){var reconnect=false;if(this.first_connect){this.first_connect=false}else{reconnect=true}this.restarting=Boolean(data.restarting);if(!this.client.connected||this.client.socket.readyState!==1){return}var subs=this;function resub(){var _loop=function _loop(channel_id){var channel=subs.channels[channel_id];if(channel.subscriptions){subs.client.send("subscribe",channel_id,function(err){if(err){channel.subscribe_failed=true;console.error("Error subscribing to "+channel_id+": "+err);channel.emit("subscribe_fail",err)}})}};for(var channel_id in subs.channels){_loop(channel_id)}subs.emit("connect",reconnect)}if(this.logging_in){}else if(this.was_logged_in){this.loginInternal(this.login_credentials,function(err){if(err&&err==="ERR_FAILALL_DISCONNECT"){}else if(err){assert(false,err)}else{resub()}})}else{if(window.FBInstant){this.loginFacebook(function(){})}else if(local_storage.get("name")&&local_storage.get("password")){this.login(local_storage.get("name"),local_storage.get("password"),function(){})}resub()}};SubscriptionManager.prototype.handleChannelMessage=function(pak,resp_func){assert(isPacket(pak));var channel_id=pak.readAnsiString();var msg=pak.readAnsiString();var is_packet=pak.readBool();var data=is_packet?pak:pak.readJSON();if(!data||!data.q){var debug_msg;if(!is_packet){debug_msg=JSON.stringify(data)}else if(typeof data.contents==="function"){debug_msg=data.contents()}else{debug_msg="(pak)"}console.log("got channel_msg("+channel_id+") "+msg+": "+debug_msg)}var channel=this.getChannel(channel_id);var handler=channel.handlers[msg];if(!handler){console.error("no handler for channel_msg("+channel_id+") "+msg+": "+JSON.stringify(data));return}handler.call(channel,data,resp_func)};SubscriptionManager.prototype.handleServerTime=function(pak){this.server_time=pak.readInt();if(this.server_time<this.server_time_interp&&this.server_time>this.server_time_interp-250){}else{this.server_time_interp=this.server_time}};SubscriptionManager.prototype.getServerTime=function(){return this.server_time_interp};SubscriptionManager.prototype.tick=function(dt){this.server_time_interp+=dt;for(var channel_id in this.channels){var channel=this.channels[channel_id];if(channel.immediate_subscribe){if(dt>=channel.immediate_subscribe){channel.immediate_subscribe=0;this.unsubscribe(channel_id)}else{channel.immediate_subscribe-=dt}}}};SubscriptionManager.prototype.subscribe=function(channel_id){this.getChannel(channel_id,true)};SubscriptionManager.prototype.getChannel=function(channel_id,do_subscribe){var channel=this.channels[channel_id];if(!channel){var channel_type=channel_id.split(".")[0];var handlers=this.getBaseHandlers(channel_type);channel=this.channels[channel_id]=new ClientChannelWorker(this,channel_id,handlers)}if(do_subscribe){channel.subscriptions++;if(this.client.connected&&channel.subscriptions===1){channel.subscribe_failed=false;this.client.send("subscribe",channel_id,function(err){if(err){channel.subscribe_failed=true;console.error("Error subscribing to "+channel_id+": "+err);channel.emit("subscribe_fail",err)}})}}return channel};SubscriptionManager.prototype.getUserId=function(){return this.loggedIn()};SubscriptionManager.prototype.getMyUserChannel=function(){var user_id=this.loggedIn();if(!user_id){return null}var channel=this.getChannel("user."+user_id);if(!this.logging_out){channel.autosubscribed=true}return channel};SubscriptionManager.prototype.unsubscribe=function(channel_id){var channel=this.channels[channel_id];assert(channel);assert(channel.subscriptions);channel.subscriptions--;if(!channel.subscriptions){channel.got_subscribe=false}if(this.client.connected&&!channel.subscriptions&&!channel.subscribe_failed){this.client.send("unsubscribe",channel_id)}};SubscriptionManager.prototype.getChannelImmediate=function(channel_id,timeout){timeout=timeout||6e4;var channel=this.getChannel(channel_id);if(!channel.immediate_subscribe){this.subscribe(channel_id)}channel.immediate_subscribe=timeout;return channel};SubscriptionManager.prototype.onLogin=function(cb){this.on("login",cb);if(this.logged_in){return void cb()}};SubscriptionManager.prototype.loggedIn=function(){return this.logged_in?this.logged_in_username||"missing_name":false};SubscriptionManager.prototype.handleLoginResponse=function(resp_func,err,resp){var _this2=this;this.logging_in=false;if(!err){this.logged_in_username=resp.user_id;this.logged_in_display_name=resp.display_name;this.logged_in=true;this.was_logged_in=true;var user_channel=this.getMyUserChannel();user_channel.onceSubscribe(function(){if(!_this2.did_master_subscribe&&user_channel.getChannelData("public.permissions.sysadmin")){_this2.did_master_subscribe=true;_this2.subscribe("master.master")}});this.emit("login")}else{this.emit("login_fail",err)}resp_func(err)};SubscriptionManager.prototype.loginInternal=function(login_credentials,resp_func){var _this3=this;if(this.logging_in){return void resp_func("Login already in progress")}this.logging_in=true;this.logged_in=false;if(login_credentials.fb){fbGetLoginInfo(function(err,result){if(err){return void _this3.handleLoginResponse(resp_func,err)}_this3.client.send("login_facebook",result,_this3.handleLoginResponse.bind(_this3,resp_func))})}else{this.client.send("login",{user_id:login_credentials.user_id,password:md5(this.client.secret+login_credentials.password)},this.handleLoginResponse.bind(this,resp_func))}};SubscriptionManager.prototype.userCreateInternal=function(params,resp_func){if(this.logging_in){return resp_func("Login already in progress")}this.logging_in=true;this.logged_in=false;return this.client.send("user_create",params,this.handleLoginResponse.bind(this,resp_func))};function hashedPassword(user_id,password){if(password.split("$$")[0]==="prehashed"){password=password.split("$$")[1]}else{password=md5(md5(user_id.toLowerCase())+password)}return password}SubscriptionManager.prototype.login=function(username,password,resp_func){var _this4=this;username=(username||"").trim();if(!username){return resp_func("Missing username")}password=(password||"").trim();if(!password){return resp_func("Missing password")}var hashed_password=hashedPassword(username,password);if(hashed_password!==password){local_storage.set("password","prehashed$$"+hashed_password)}this.login_credentials={user_id:username,password:hashed_password};if(!this.auto_create_user){return this.loginInternal(this.login_credentials,resp_func)}return this.loginInternal(this.login_credentials,function(err,data){if(!err||err!=="ERR_USER_NOT_FOUND"){return void resp_func(err,data)}_this4.userCreate({user_id:username,password:password,password_confirm:password,email:"autocreate@glovjs.org"},resp_func)})};SubscriptionManager.prototype.loginFacebook=function(resp_func){this.login_credentials={fb:true};return this.loginInternal(this.login_credentials,resp_func)};SubscriptionManager.prototype.userCreate=function(params,resp_func){params.user_id=(params.user_id||"").trim();if(!params.user_id){return resp_func("Missing username")}params.password=(params.password||"").trim();if(!params.password){return resp_func("Missing password")}params.password_confirm=(params.password_confirm||"").trim();if(!this.auto_create_user&&!params.password_confirm){return resp_func("Missing password confirmation")}params.email=(params.email||"").trim();if(!this.auto_create_user&&!params.email){return resp_func("Missing email")}params.display_name=(params.display_name||"").trim();var hashed_password=hashedPassword(params.user_id,params.password);if(hashed_password!==params.password){local_storage.set("password","prehashed$$"+hashed_password)}var hashed_password_confirm=hashedPassword(params.user_id,params.password_confirm);if(hashed_password!==hashed_password_confirm){return resp_func("Passwords do not match")}this.login_credentials={user_id:params.user_id,password:hashed_password};return this.userCreateInternal({display_name:params.display_name||params.user_id,user_id:params.user_id,email:params.email,password:hashed_password},resp_func)};SubscriptionManager.prototype.logout=function(){var _this5=this;assert(this.logged_in);assert(!this.logging_in);assert(!this.logging_out);if(this.did_master_subscribe){this.did_master_subscribe=false;this.unsubscribe("master.master")}for(var channel_id in this.channels){var channel=this.channels[channel_id];if(channel.immediate_subscribe){channel.immediate_subscribe=0;this.unsubscribe(channel_id)}assert(!channel.subscriptions,"Remaining active subscription for "+channel_id);if(channel.autosubscribed){channel.autosubscribed=false}}this.logging_out=true;this.client.send("logout",null,function(err){_this5.logging_out=false;if(!err){local_storage.set("password",undefined);_this5.logged_in=false;_this5.logged_in_username=null;_this5.was_logged_in=false;_this5.login_credentials=null;_this5.emit("logout")}})};SubscriptionManager.prototype.serverLog=function(type,data){this.client.send("log",{type:type,data:data})};SubscriptionManager.prototype.sendCmdParse=function(command,resp_func){var _this6=this;this.onceConnected(function(){var pak=_this6.client.pak("cmd_parse_auto");pak.writeString(command);pak.send(resp_func)})};SubscriptionManager.prototype.handleCSRToClient=function(pak,resp_func){var _this7=this;var cmd=pak.readString();var access=pak.readJSON();this.cmd_parse.handle({access:access},cmd,function(err,resp){if(err&&_this7.cmd_parse.was_not_found){return resp_func(null,{found:0,err:err})}return resp_func(err,{found:1,resp:resp})})};function create(client,cmd_parse){return new SubscriptionManager(client,cmd_parse)}


},{"../../common/md5.js":67,"../../common/packet.js":68,"../../common/tiny-events.js":69,"../../common/util.js":70,"./fbinstant.js":13,"./local_storage.js":27,"assert":undefined,"dot-prop":undefined}],45:[function(require,module,exports){
"use strict";exports.defaultFilters=defaultFilters;exports.bind=bind;exports.bindArray=bindArray;exports.isArrayBound=isArrayBound;exports.texturesResetState=texturesResetState;exports.getExternalTextureURL=getExternalTextureURL;exports.setExternalTextureBaseURL=setExternalTextureBaseURL;exports.createForCapture=createForCapture;exports.load=load;exports.cname=cname;exports.findTexForReplacement=findTexForReplacement;exports.texturesTick=texturesTick;exports.texturesUnloadDynamic=texturesUnloadDynamic;exports.startup=startup;exports.format=exports.load_count=exports.textures=void 0;var assert=require("assert");var engine=require("./engine.js");var _require=require("./filewatch.js"),filewatchOn=_require.filewatchOn;var local_storage=require("./local_storage.js");var settings=require("./settings.js");var urlhash=require("./urlhash.js");var _require2=require("../../common/util.js"),callEach=_require2.callEach,isPowerOfTwo=_require2.isPowerOfTwo,nextHighestPowerOfTwo=_require2.nextHighestPowerOfTwo,ridx=_require2.ridx;var TEX_UNLOAD_TIME=5*60*1e3;var textures={};exports.textures=textures;var load_count=0;exports.load_count=load_count;var aniso=4;var max_aniso=0;var aniso_enum;var default_filter_min;var default_filter_mag;var cube_faces=[{target:"TEXTURE_CUBE_MAP_NEGATIVE_X",pos:[0,1]},{target:"TEXTURE_CUBE_MAP_POSITIVE_X",pos:[0,0]},{target:"TEXTURE_CUBE_MAP_NEGATIVE_Y",pos:[1,0]},{target:"TEXTURE_CUBE_MAP_POSITIVE_Y",pos:[1,1]},{target:"TEXTURE_CUBE_MAP_NEGATIVE_Z",pos:[2,0]},{target:"TEXTURE_CUBE_MAP_POSITIVE_Z",pos:[2,1]}];var format={R8:{count:1},RGB8:{count:3},RGBA8:{count:4}};exports.format=format;function defaultFilters(min,mag){default_filter_min=min;default_filter_mag=mag}var bound_unit=null;var bound_tex=[];var handle_loading;var handle_error;var frame_timestamp;function setUnit(unit){if(unit!==bound_unit){gl.activeTexture(gl.TEXTURE0+unit);bound_unit=unit}}function bindHandle(unit,target,handle){if(bound_tex[unit]!==handle){setUnit(unit);gl.bindTexture(target,handle);bound_tex[unit]=handle}}function unbindAll(target){for(var unit=0;unit<bound_tex.length;++unit){setUnit(unit);gl.bindTexture(target,target===gl.TEXTURE_2D?handle_loading:null);bound_tex[unit]=null}}function bind(unit,tex){tex.last_use=frame_timestamp;bindHandle(unit,tex.target,tex.eff_handle)}function bindArray(texs){for(var ii=0;ii<texs.length;++ii){var tex=texs[ii];tex.last_use=frame_timestamp;var handle=tex.eff_handle;if(bound_tex[ii]!==handle){if(ii!==bound_unit){gl.activeTexture(gl.TEXTURE0+ii);bound_unit=ii}gl.bindTexture(tex.target,handle);bound_tex[ii]=handle}}}function isArrayBound(texs){for(var ii=0;ii<texs.length;++ii){var tex=texs[ii];var handle=tex.eff_handle;if(bound_tex[ii]!==handle){return false}}return true}function texturesResetState(){bound_unit=-1;if(engine.webgl2){unbindAll(gl.TEXTURE_2D_ARRAY)}unbindAll(gl.TEXTURE_2D);setUnit(0);gl.getError()}var auto_unload_textures=[];function Texture(params){this.name=params.name;this.loaded=false;this.load_fail=false;this.target=params.target||gl.TEXTURE_2D;this.is_array=this.target===gl.TEXTURE_2D_ARRAY;this.is_cube=this.target===gl.TEXTURE_CUBE_MAP;this.handle=gl.createTexture();this.eff_handle=handle_loading;this.setSamplerState(params);this.src_width=this.src_height=1;this.width=this.height=1;this.nozoom=params.nozoom||false;this.on_load=[];this.gpu_mem=0;this.soft_error=params.soft_error||false;this.last_use=frame_timestamp;this.auto_unload=params.auto_unload||false;if(this.auto_unload){auto_unload_textures.push(this)}this.format=params.format||format.RGBA8;if(params.data){var err=this.updateData(params.width,params.height,params.data);if(err){assert(false,"Error loading "+params.name+": GLError("+err+")")}}else{unbindAll(this.target);if(params.url){this.url=params.url;this.loadURL(params.url)}}}Texture.prototype.updateGPUMem=function(){var new_size=this.width*this.height*this.format.count;if(this.mipmaps){new_size*=1.5}var diff=new_size-this.gpu_mem;engine.perf_state.gpu_mem.tex+=diff;this.gpu_mem=diff};function bindForced(tex){var target=tex.target;setUnit(0);bound_tex[0]=null;bindHandle(0,target,tex.handle)}Texture.prototype.setSamplerState=function(params){var target=this.target;bindForced(this);this.filter_min=params.filter_min||default_filter_min;this.filter_mag=params.filter_mag||default_filter_mag;gl.texParameteri(target,gl.TEXTURE_MIN_FILTER,this.filter_min);gl.texParameteri(target,gl.TEXTURE_MAG_FILTER,this.filter_mag);this.wrap_s=params.wrap_s||gl.REPEAT;this.wrap_t=params.wrap_t||gl.REPEAT;gl.texParameteri(target,gl.TEXTURE_WRAP_S,this.wrap_s);gl.texParameteri(target,gl.TEXTURE_WRAP_T,this.wrap_t);this.mipmaps=this.filter_min>=9984&&this.filter_min<=9987;if(max_aniso){if(this.mipmaps&&params.filter_mag!==gl.NEAREST){gl.texParameterf(gl.TEXTURE_2D,aniso_enum,aniso)}else{gl.texParameterf(gl.TEXTURE_2D,aniso_enum,1)}}};Texture.prototype.updateData=function updateData(w,h,data){assert(!this.destroyed);bindForced(this);this.last_use=frame_timestamp;this.src_width=w;this.src_height=h;this.width=w;this.height=h;for(var ii=0;ii<10&&gl.getError();++ii){}var np2=(!isPowerOfTwo(w)||!isPowerOfTwo(h))&&!this.is_array&&!this.is_cube&&!(!this.mipmaps&&this.wrap_s===gl.CLAMP_TO_EDGE&&this.wrap_t===gl.CLAMP_TO_EDGE);if(np2){this.width=nextHighestPowerOfTwo(w);this.height=nextHighestPowerOfTwo(h);gl.texImage2D(this.target,0,this.format.internal_type,this.width,this.height,0,this.format.internal_type,this.format.gl_type,null)}if(data instanceof Uint8Array){assert(data.length>=w*h*this.format.count);assert(!this.is_cube);if(this.is_array){var num_images=h/w;gl.texImage3D(this.target,0,this.format.internal_type,w,w,num_images,0,this.format.internal_type,this.format.gl_type,data)}else if(np2){gl.texSubImage2D(this.target,0,0,0,w,h,this.format.internal_type,this.format.gl_type,data)}else{gl.texImage2D(this.target,0,this.format.internal_type,w,h,0,this.format.internal_type,this.format.gl_type,data)}}else{assert(data.width);if(this.is_cube){assert.equal(w*2,h*3);var tex_size=h/2;var canvas=document.createElement("canvas");canvas.width=tex_size;canvas.height=tex_size;var ctx=canvas.getContext("2d");for(var _ii=0;_ii<cube_faces.length;++_ii){var face=cube_faces[_ii];ctx.drawImage(data,face.pos[0]*tex_size,face.pos[1]*tex_size,tex_size,tex_size,0,0,tex_size,tex_size);gl.texImage2D(gl[face.target],0,this.format.internal_type,this.format.internal_type,this.format.gl_type,canvas)}}else if(this.is_array){var _num_images=h/w;gl.texImage3D(this.target,0,this.format.internal_type,w,w,_num_images,0,this.format.internal_type,this.format.gl_type,data);if(gl.getError()){var _canvas=document.createElement("canvas");_canvas.width=w;_canvas.height=h;var _ctx=_canvas.getContext("2d");_ctx.drawImage(data,0,0);gl.texImage3D(this.target,0,this.format.internal_type,w,w,_num_images,0,this.format.internal_type,this.format.gl_type,_canvas)}}else if(np2){if(w!==this.width){gl.texSubImage2D(this.target,0,1,0,this.format.internal_type,this.format.gl_type,data)}if(h!==this.height){gl.texSubImage2D(this.target,0,0,1,this.format.internal_type,this.format.gl_type,data)}gl.texSubImage2D(this.target,0,0,0,this.format.internal_type,this.format.gl_type,data)}else{gl.texImage2D(this.target,0,this.format.internal_type,this.format.internal_type,this.format.gl_type,data)}}var gl_err=gl.getError();if(gl_err){return gl_err}if(this.mipmaps){gl.generateMipmap(this.target);gl_err=gl.getError();if(gl_err){return gl_err}}this.updateGPUMem();this.eff_handle=this.handle;this.loaded=true;callEach(this.on_load,this.on_load=null,this);return 0};Texture.prototype.onLoad=function(cb){if(this.loaded){cb(this)}else{this.on_load.push(cb)}};var texture_base_url="";function getExternalTextureURL(url){if(!url.match(/^.{2,7}:/)){url=""+(texture_base_url||urlhash.getURLBase())+url}return url}function setExternalTextureBaseURL(base_url){texture_base_url=base_url}var TEX_RETRY_COUNT=4;Texture.prototype.loadURL=function loadURL(url,filter){var tex=this;assert(!tex.destroyed);if(!url.match(/^.{2,7}:/)){url=""+urlhash.getURLBase()+url}var load_gen=tex.load_gen=(tex.load_gen||0)+1;function tryLoad(next){var did_next=false;function done(img){if(!did_next){did_next=true;return void next(img)}}var img=new Image;img.onload=function(){done(img)};function fail(){done(null)}img.onerror=fail;img.crossOrigin="anonymous";img.src=url}exports.load_count=load_count=load_count+1;var retries=0;function handleLoad(img){if(tex.load_gen!==load_gen||tex.destroyed){exports.load_count=load_count=load_count-1;return}var err_details="";if(img){tex.format=format.RGBA8;if(filter){img=filter(tex,img)}var _err=tex.updateData(img.width,img.height,img);if(_err){err_details=": GLError("+_err+")";if(tex.is_array&&(String(_err)==="1282"||String(_err)==="1281")&&engine.webgl2&&!engine.DEBUG){local_storage.setJSON("webgl2_disable",{ua:navigator.userAgent,ts:Date.now()});console.error('Error loading array texture "'+url+'"'+err_details+", reloading without WebGL2..");engine.reloadSafe();return}if(!tex.for_reload){retries=TEX_RETRY_COUNT}}else{exports.load_count=load_count=load_count-1;return}}var err='Error loading texture "'+url+'"'+err_details;retries++;if(retries>TEX_RETRY_COUNT){exports.load_count=load_count=load_count-1;tex.eff_handle=handle_error;tex.load_fail=true;console.error(""+err+(err_details?"":", retries failed"));if(tex.soft_error){tex.err="Load failed"}else{assert(false,err)}return}console.error(err+", retrying... ");setTimeout(tryLoad.bind(null,handleLoad),100*retries*retries)}tryLoad(handleLoad)};Texture.prototype.allocFBO=function(w,h,need_depth){var fbo_format=settings.fbo_rgba?gl.RGBA:gl.RGB;bindForced(this);gl.texImage2D(this.target,0,fbo_format,w,h,0,fbo_format,gl.UNSIGNED_BYTE,null);this.fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.handle,0);this.last_use=frame_timestamp;this.src_width=this.width=w;this.src_height=this.height=h;this.updateGPUMem()};Texture.prototype.captureStart=function(w,h){assert(!this.capture);this.capture={w:w,h:h};if(this.fbo){gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)}};Texture.prototype.captureEnd=function(filter_linear,wrap){assert(this.capture);var capture=this.capture;this.capture=null;if(this.fbo){gl.bindFramebuffer(gl.FRAMEBUFFER,null)}else{this.copyTexImage(0,0,capture.w,capture.h)}var filter=filter_linear?gl.LINEAR:gl.NEAREST;this.setSamplerState({filter_min:filter,filter_mag:filter,wrap_s:wrap?gl.REPEAT:gl.CLAMP_TO_EDGE,wrap_t:wrap?gl.REPEAT:gl.CLAMP_TO_EDGE})};Texture.prototype.copyTexImage=function(x,y,w,h){assert(!this.destroyed);assert(w&&h);bindHandle(0,this.target,this.handle);gl.copyTexImage2D(this.target,0,gl.RGB,x,y,w,h,0);this.last_use=frame_timestamp;this.src_width=this.width=w;this.src_height=this.height=h;this.updateGPUMem()};Texture.prototype.destroy=function(){if(this.destroyed){return}assert(this.name);var auto_unload=this.auto_unload;if(auto_unload){this.auto_unload=null;var idx=auto_unload_textures.indexOf(this);assert(idx!==-1);ridx(auto_unload_textures,idx)}delete textures[this.name];unbindAll(this.target);gl.deleteTexture(this.handle);if(this.fbo){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.deleteFramebuffer(this.fbo)}this.width=this.height=0;this.updateGPUMem();this.destroyed=true;if(typeof auto_unload==="function"){auto_unload()}};function create(params){assert(params.name);var texture=new Texture(params);textures[params.name]=texture;return texture}var last_temporary_id=0;function createForCapture(unique_name,auto_unload){var name=unique_name||"screen_temporary_tex_"+ ++last_temporary_id;assert(!textures[name]);var texture=create({filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,format:format.RGB8,name:name,auto_unload:auto_unload});texture.loaded=true;texture.eff_handle=texture.handle;return texture}function load(params){var key=params.name=params.name||params.url;assert(key);var tex=textures[key];if(!tex){tex=create(params)}tex.last_use=frame_timestamp;return tex}function cname(key){var idx=key.lastIndexOf("/");if(idx!==-1){key=key.slice(idx+1)}idx=key.indexOf(".");if(idx!==-1){key=key.slice(0,idx)}return key.toLowerCase()}function findTexForReplacement(search_key){search_key=cname(search_key);for(var key in textures){var compare_key=cname(key);if(compare_key===search_key){return textures[key]}}return null}var tick_next_tex=0;function texturesTick(){frame_timestamp=engine.frame_timestamp;var len=auto_unload_textures.length;if(!len){return}if(tick_next_tex>=len){tick_next_tex=0}var tex=auto_unload_textures[tick_next_tex];if(tex.last_use<frame_timestamp-TEX_UNLOAD_TIME){console.log("Unloading texture "+tex.name);tex.destroy()}else{++tick_next_tex}}function texturesUnloadDynamic(){while(auto_unload_textures.length){auto_unload_textures[0].destroy()}}function textureReload(filename){var tex=textures[filename];if(tex&&tex.url){tex.for_reload=true;tex.loadURL(tex.url+"?rl="+Date.now());return true}return false}function startup(){default_filter_min=gl.LINEAR_MIPMAP_LINEAR;default_filter_mag=gl.LINEAR;format.R8.internal_type=gl.LUMINANCE;format.R8.gl_type=gl.UNSIGNED_BYTE;format.RGB8.internal_type=gl.RGB;format.RGB8.gl_type=gl.UNSIGNED_BYTE;format.RGBA8.internal_type=gl.RGBA;format.RGBA8.gl_type=gl.UNSIGNED_BYTE;var ext_anisotropic=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(ext_anisotropic){aniso_enum=ext_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT;aniso=max_aniso=gl.getParameter(ext_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}handle_error=load({name:"error",width:2,height:2,nozoom:true,format:format.RGBA8,filter_mag:gl.NEAREST,data:new Uint8Array([255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255])}).handle;handle_loading=load({name:"loading",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([127,127,127,255,0,0,0,255,64,64,64,255,127,127,127,255])}).handle;load({name:"white",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])});load({name:"invisible",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])});filewatchOn(".png",textureReload)}


},{"../../common/util.js":70,"./engine.js":11,"./filewatch.js":14,"./local_storage.js":27,"./settings.js":39,"./urlhash.js":48,"assert":undefined}],46:[function(require,module,exports){
"use strict";exports.queue=queue;exports.render=render;exports.active=active;exports.fade=fade;exports.splitScreen=splitScreen;exports.pixelate=pixelate;exports.randomTransition=randomTransition;exports.CONTINUE=exports.REMOVE=exports.IMMEDIATE=void 0;var assert=require("assert");var camera2d=require("./camera2d.js");var glov_engine=require("./engine.js");var _require=require("./effects.js"),applyCopy=_require.applyCopy,effectsQueue=_require.effectsQueue,effectsIsFinal=_require.effectsIsFinal;var _require2=require("./framebuffer.js"),framebufferCapture=_require2.framebufferCapture,framebufferStart=_require2.framebufferStart,framebufferEnd=_require2.framebufferEnd,temporaryTextureClaim=_require2.temporaryTextureClaim;var floor=Math.floor,min=Math.min,pow=Math.pow,random=Math.random;var sprites=require("./sprites.js");var shaders=require("./shaders.js");var textures=require("./textures.js");var glov_ui=require("./ui.js");var _require3=require("../../common/util.js"),easeOut=_require3.easeOut;var _require4=require("./vmath.js"),unit_vec=_require4.unit_vec,vec4=_require4.vec4;var transitions=[];var IMMEDIATE="immediate";exports.IMMEDIATE=IMMEDIATE;var REMOVE="remove";exports.REMOVE=REMOVE;var CONTINUE="continue";exports.CONTINUE=CONTINUE;var shader_data={transition_pixelate:{fp:"glov/shaders/transition_pixelate.fp"}};function getShader(key){var elem=shader_data[key];if(!elem.shader){elem.shader=shaders.create(elem.fp)}return elem.shader}function GlovTransition(z,func){this.z=z;this.capture=null;this.func=func;this.accum_time=0}function transitionCapture(trans){assert(!trans.capture);trans.capture=textures.createForCapture();framebufferCapture(trans.capture)}function transitionCaptureFramebuffer(trans){assert(!trans.capture);trans.capture=framebufferEnd();temporaryTextureClaim(trans.capture);if(trans.capture.fbo){applyCopy({source:trans.capture,final:effectsIsFinal()})}else{framebufferStart({width:trans.capture.width,height:trans.capture.height,final:effectsIsFinal()})}}function queue(z,fn){assert(!glov_engine.had_3d_this_frame);var immediate=false;if(z===IMMEDIATE){immediate=true;z=Z.TRANSITION_FINAL}for(var ii=0;ii<transitions.length;++ii){var _trans=transitions[ii];if(_trans.z===z){assert(_trans.capture);if(!_trans.capture){return false}}}var trans=new GlovTransition(z,fn);transitions.push(trans);if(immediate){transitionCapture(trans)}else{effectsQueue(z+Z.TRANSITION_RANGE,transitionCaptureFramebuffer.bind(null,trans))}return true}function destroyTexture(tex){tex.destroy()}function render(dt){dt=min(dt,100);for(var trans_idx=0;trans_idx<transitions.length;++trans_idx){var trans=transitions[trans_idx];trans.accum_time+=dt;assert(trans.capture);var force_end=trans_idx<transitions.length-1;var ret=trans.func(trans.z,trans.capture,trans.accum_time,force_end);if(ret===REMOVE){setTimeout(destroyTexture.bind(null,trans.capture),0);transitions.splice(trans_idx,1);trans_idx--}}}function active(){return transitions.length}function glovTransitionFadeFunc(fade_time,z,initial,ms_since_start,force_end){var progress=min(ms_since_start/fade_time,1);var alpha=1-easeOut(progress,2);var color=vec4(1,1,1,alpha);camera2d.setNormalized();sprites.queueraw4([initial],0,0,0,1,1,1,1,0,z,0,1,1,0,color);if(force_end||progress===1){return REMOVE}return CONTINUE}function glovTransitionSplitScreenFunc(time,border_width,slide_window,z,tex,ms_since_start,force_end){var border_color=vec4(1,1,1,1);var progress=easeOut(min(ms_since_start/time,1),2);camera2d.setNormalized();var uvs=[[0,1],[1,0]];var xoffs=progress;var v_half=uvs[0][1]+(uvs[1][1]-uvs[0][1])/2;if(slide_window){sprites.queueraw([tex],0,0,z,1-xoffs,1/2,0,uvs[0][1],uvs[1][0]*(1-progress),v_half,unit_vec);sprites.queueraw([tex],0+xoffs,1/2,z,1-xoffs,1/2,uvs[1][0]*progress,v_half,uvs[1][0],uvs[1][1],unit_vec)}else{sprites.queueraw([tex],0-xoffs,0,z,1,1/2,uvs[0][0],uvs[0][1],uvs[1][0],v_half,unit_vec);sprites.queueraw([tex],0+xoffs,1/2,z,1,1/2,uvs[0][0],v_half,uvs[1][0],uvs[1][1],unit_vec)}var border_grow_progress=min(progress*4,1);border_color[3]=border_grow_progress;border_width*=border_grow_progress;glov_ui.drawRect(0,.5-border_width,1-xoffs,.5,z+1,border_color);glov_ui.drawRect(1-xoffs-border_width,0,1-xoffs,.5,z+1,border_color);glov_ui.drawRect(xoffs,.5,1,.5+border_width,z+1,border_color);glov_ui.drawRect(xoffs,.5,xoffs+border_width,1,z+1,border_color);if(force_end||progress===1){return REMOVE}return CONTINUE}var render_scale=1;var transition_pixelate_textures=[null];function transitionPixelateCapture(){var tex=framebufferEnd();framebufferStart({width:tex.width,height:tex.height,final:effectsIsFinal()});transition_pixelate_textures[0]=tex}function glovTransitionPixelateFunc(time,z,tex,ms_since_start,force_end){var gd_width=glov_engine.width;var progress=min(ms_since_start/time,1);camera2d.setNormalized();transition_pixelate_textures[0]=tex;if(progress>.5){effectsQueue(z,transitionPixelateCapture)}var partial_progress=(progress>.5?1-progress:progress)*2;var pixel_scale=pow(2,floor(partial_progress*8.9))/1024*gd_width*render_scale;var param0=vec4(tex.width/pixel_scale,tex.height/pixel_scale,pixel_scale/tex.width,pixel_scale/tex.height);var param1=vec4(.5/tex.width,.5/tex.height,(tex.texSizeX-1)/tex.width,(tex.texSizeY-1)/tex.height);sprites.queueraw(transition_pixelate_textures,0,0,z+1,1,1,0,1,1,0,unit_vec,getShader("transition_pixelate"),{param0:param0,param1:param1});if(force_end||progress===1){return REMOVE}return CONTINUE}function fade(fade_time){return glovTransitionFadeFunc.bind(null,fade_time)}function splitScreen(time,border_width,slide_window){border_width/=camera2d.w();return glovTransitionSplitScreenFunc.bind(null,time,border_width,slide_window)}function pixelate(fade_time){return glovTransitionPixelateFunc.bind(null,fade_time)}function randomTransition(fade_time_scale){fade_time_scale=fade_time_scale||1;var idx=floor(random()*3);switch(idx){case 0:return fade(500*fade_time_scale);case 1:return splitScreen(250*fade_time_scale,2,false);case 2:return pixelate(750*fade_time_scale);default:assert(0)}return null}


},{"../../common/util.js":70,"./camera2d.js":6,"./effects.js":10,"./engine.js":11,"./framebuffer.js":16,"./shaders.js":40,"./sprites.js":43,"./textures.js":45,"./ui.js":47,"./vmath.js":49,"assert":undefined}],47:[function(require,module,exports){
"use strict";exports.focuslog=focuslog;exports.makeColorSet=makeColorSet;exports.addHook=addHook;exports.colorSetSetShades=colorSetSetShades;exports.loadUISprite=loadUISprite;exports.startup=startup;exports.getElem=getElem;exports.bindSounds=bindSounds;exports.drawHBox=drawHBox;exports.drawVBox=drawVBox;exports.drawBox=drawBox;exports.playUISound=playUISound;exports.setMouseOver=setMouseOver;exports.focusSteal=focusSteal;exports.focusCanvas=focusCanvas;exports.isFocusedPeek=isFocusedPeek;exports.isFocused=isFocused;exports.focusNext=focusNext;exports.focusPrev=focusPrev;exports.focusCheck=focusCheck;exports.panel=panel;exports.drawTooltip=drawTooltip;exports.checkHooks=checkHooks;exports.buttonShared=buttonShared;exports.buttonTextDraw=buttonTextDraw;exports.buttonText=buttonText;exports.buttonImage=buttonImage;exports.print=print;exports.modalDialog=modalDialog;exports.modalDialogClear=modalDialogClear;exports.modalTextEntry=modalTextEntry;exports.createEditBox=createEditBox;exports.setSliderDefaultShrink=setSliderDefaultShrink;exports.slider=slider;exports.isMenuUp=isMenuUp;exports.tickUI=tickUI;exports.endFrame=endFrame;exports.cleanupDOMElems=cleanupDOMElems;exports.menuUp=menuUp;exports.provideUserString=provideUserString;exports.drawRect=drawRect;exports.drawRect2=drawRect2;exports.drawElipse=drawElipse;exports.drawCircle=drawCircle;exports.drawHollowCircle=drawHollowCircle;exports.drawLine=drawLine;exports.drawHollowRect=drawHollowRect;exports.drawHollowRect2=drawHollowRect2;exports.drawCone=drawCone;exports.scaleSizes=scaleSizes;exports.setPanelPixelScale=setPanelPixelScale;exports.setModalSizes=setModalSizes;exports.setFontHeight=setFontHeight;exports.setTooltipWidth=setTooltipWidth;exports.slider_dragging=exports.button_last_color=exports.menu_up=exports.touch_changed_focus=exports.button_click=exports.button_focused=exports.button_mouseover=exports.modal_font_style=exports.color_panel=exports.color_button=exports.sprites=exports.title_font=exports.font=exports.font_style_normal=exports.font_style_focused=exports.tooltip_pad=exports.tooltip_width=exports.tooltip_panel_pixel_scale=exports.panel_pixel_scale=exports.modal_pad=exports.modal_title_scale=exports.modal_y0=exports.modal_width=exports.button_img_size=exports.modal_button_width=exports.button_width=exports.font_height=exports.button_height=void 0;window.Z=window.Z||{};Z.BORDERS=Z.BORDERS||90;Z.UI=Z.UI||100;Z.MODAL=Z.MODAL||1e3;Z.TOOLTIP=Z.TOOLTIP||2e3;Z.DEBUG=Z.DEBUG||9800;Z.TRANSITION_FINAL=Z.TRANSITION_FINAL||9900;Z.TRANSITION_RANGE=Z.TRANSITION_RANGE||10;Z.FPSMETER=Z.FPSMETER||1e4;var assert=require("assert");var camera2d=require("./camera2d.js");var glov_edit_box=require("./edit_box.js");var effects=require("./effects.js");var effectsQueue=effects.effectsQueue;var glov_engine=require("./engine.js");var glov_font=require("./font.js");var glov_input=require("./input.js");var _require=require("./link.js"),linkTick=_require.linkTick;var abs=Math.abs,max=Math.max,min=Math.min,round=Math.round,sqrt=Math.sqrt;var _require2=require("./sound.js"),soundLoad=_require2.soundLoad,soundPlay=_require2.soundPlay;var glov_sprites=require("./sprites.js");var textures=require("./textures.js");var _require3=require("../../common/util.js"),clamp=_require3.clamp,clone=_require3.clone,lerp=_require3.lerp,merge=_require3.merge;var _require4=require("./mat43.js"),mat43=_require4.mat43,m43identity=_require4.m43identity,m43mul=_require4.m43mul;var _require5=require("./vmath.js"),vec2=_require5.vec2,vec4=_require5.vec4,v4scale=_require5.v4scale,unit_vec=_require5.unit_vec;var MODAL_DARKEN=.75;var KEYS;var PAD;var menu_fade_params_default={blur:[.125,.865],saturation:[.5,.1],brightness:[1,1-MODAL_DARKEN],fallback_darken:vec4(0,0,0,MODAL_DARKEN),z:Z.MODAL};function focuslog(){}var color_set_shades=vec4(1,.8,.7,.4);function makeColorSet(color){var ret={regular:vec4(),rollover:vec4(),down:vec4(),disabled:vec4()};v4scale(ret.regular,color,color_set_shades[0]);v4scale(ret.rollover,color,color_set_shades[1]);v4scale(ret.down,color,color_set_shades[2]);v4scale(ret.disabled,color,color_set_shades[3]);for(var field in ret){ret[field][3]=color[3]}return ret}var hooks=[];function addHook(draw,click){hooks.push({draw:draw,click:click})}function doBlurEffect(factor){effects.applyGaussianBlur({blur:factor})}var desaturate_xform=mat43();var desaturate_tmp=mat43();function doDesaturateEffect(saturation,brightness){m43identity(desaturate_xform);effects.saturationMatrix(desaturate_tmp,saturation);m43mul(desaturate_xform,desaturate_xform,desaturate_tmp);effects.brightnessScaleMatrix(desaturate_tmp,brightness);m43mul(desaturate_xform,desaturate_xform,desaturate_tmp);effects.applyColorMatrix({colorMatrix:desaturate_xform})}var button_height=32;exports.button_height=button_height;var font_height=24;exports.font_height=font_height;var button_width=200;exports.button_width=button_width;var modal_button_width=100;exports.modal_button_width=modal_button_width;var button_img_size=button_height;exports.button_img_size=button_img_size;var modal_width=600;exports.modal_width=modal_width;var modal_y0=200;exports.modal_y0=modal_y0;var modal_title_scale=1.2;exports.modal_title_scale=modal_title_scale;var modal_pad=16;exports.modal_pad=modal_pad;var panel_pixel_scale=32/13;exports.panel_pixel_scale=panel_pixel_scale;var tooltip_panel_pixel_scale=panel_pixel_scale;exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale;var tooltip_width=400;exports.tooltip_width=tooltip_width;var tooltip_pad=8;exports.tooltip_pad=tooltip_pad;var font_style_focused=glov_font.style(null,{color:255,outline_width:2,outline_color:4294967295});exports.font_style_focused=font_style_focused;var font_style_normal=glov_font.styleColored(null,255);exports.font_style_normal=font_style_normal;var font;exports.font=font;var title_font;exports.title_font=title_font;var sprites={};exports.sprites=sprites;var color_button=makeColorSet([1,1,1,1]);exports.color_button=color_button;var color_panel=vec4(1,1,.75,1);exports.color_panel=color_panel;var modal_font_style=glov_font.styleColored(null,255);exports.modal_font_style=modal_font_style;var sounds={};var button_mouseover=false;exports.button_mouseover=button_mouseover;var button_focused=false;exports.button_focused=button_focused;var button_click=null;exports.button_click=button_click;var touch_changed_focus=false;exports.touch_changed_focus=touch_changed_focus;var last_frame_button_mouseover=false;var frame_button_mouseover=false;var modal_dialog=null;var modal_stealing_focus=false;var menu_up=false;exports.menu_up=menu_up;var menu_fade_params=merge({},menu_fade_params_default);var menu_up_time=0;exports.this_frame_edit_boxes=[];var last_frame_edit_boxes=[];var dom_elems=[];var dom_elems_issued=0;var button_keys;var focused_last_frame;var focused_this_frame;var focused_key_not;var focused_key;var focused_key_prev1;var focused_key_prev2;var pad_focus_left;var pad_focus_right;function colorSetSetShades(rollover,down,disabled){color_set_shades[1]=rollover;color_set_shades[2]=down;color_set_shades[3]=disabled;exports.color_button=color_button=makeColorSet([1,1,1,1])}function loadUISprite(name,ws,hs,overrides,only_override){var override=overrides&&overrides[name];if(override===null){}else if(override){sprites[name]=glov_sprites.create({name:override[0],ws:override[1],hs:override[2]})}else if(!only_override){sprites[name]=glov_sprites.create({name:"ui/"+name,ws:ws,hs:hs})}}function startup(param){exports.font=font=param.font;exports.title_font=title_font=param.title_font||font;var overrides=param.ui_sprites;KEYS=glov_input.KEYS;PAD=glov_input.PAD;if(param.pad_focus_dpad){pad_focus_left=PAD.LEFT;pad_focus_right=PAD.RIGHT}else{pad_focus_left=PAD.LEFT_BUMPER;pad_focus_right=PAD.RIGHT_BUMPER}loadUISprite("button",[4,5,4],[13],overrides);sprites.button_regular=sprites.button;loadUISprite("button_rollover",[4,5,4],[13],overrides,true);loadUISprite("button_down",[4,5,4],[13],overrides);loadUISprite("button_disabled",[4,5,4],[13],overrides);loadUISprite("panel",[3,2,3],[3,10,3],overrides);loadUISprite("menu_entry",[4,5,4],[13],overrides);loadUISprite("menu_selected",[4,5,4],[13],overrides);loadUISprite("menu_down",[4,5,4],[13],overrides);loadUISprite("menu_header",[4,5,12],[13],overrides);loadUISprite("slider",[6,2,6],[13],overrides);loadUISprite("slider_handle",[9],[13],overrides);loadUISprite("scrollbar_bottom",[11],[13],overrides);loadUISprite("scrollbar_trough",[11],[8],overrides);loadUISprite("scrollbar_top",[11],[13],overrides);loadUISprite("scrollbar_handle_grabber",[11],[13],overrides);loadUISprite("scrollbar_handle",[11],[3,7,3],overrides);sprites.white=glov_sprites.create({url:"white"});button_keys={ok:{key:[KEYS.O],pad:[PAD.X],low_key:[KEYS.ESC]},cancel:{key:[KEYS.ESC],pad:[PAD.B,PAD.Y]}};button_keys.yes=clone(button_keys.ok);button_keys.yes.key.push(KEYS.Y);button_keys.no=clone(button_keys.cancel);button_keys.no.key.push(KEYS.N)}var dynamic_text_elem;var per_frame_dom_alloc=[0,0,0,0,0,0,0];function getElem(allow_modal,last_elem){if(modal_dialog&&!allow_modal){return null}if(dom_elems_issued>=dom_elems.length||!last_elem){var _elem=document.createElement("div");if(glov_engine.DEBUG&&!glov_engine.resizing()){per_frame_dom_alloc[glov_engine.frame_index%per_frame_dom_alloc.length]=1;var sum=0;for(var ii=0;ii<per_frame_dom_alloc.length;++ii){sum+=per_frame_dom_alloc[ii]}assert(sum<per_frame_dom_alloc.length)}_elem.setAttribute("class","glovui_dynamic");if(!dynamic_text_elem){dynamic_text_elem=document.getElementById("dynamic_text")}dynamic_text_elem.appendChild(_elem);dom_elems.push(_elem);last_elem=_elem}if(dom_elems[dom_elems_issued]!==last_elem){for(var _ii=dom_elems_issued+1;_ii<dom_elems.length;++_ii){if(dom_elems[_ii]===last_elem){dom_elems[_ii]=dom_elems[dom_elems_issued];dom_elems[dom_elems_issued]=last_elem}}}var elem=dom_elems[dom_elems_issued];dom_elems_issued++;return elem}function bindSounds(_sounds){sounds=_sounds;for(var key in sounds){soundLoad(sounds[key])}}function drawHBox(coords,s,color){var uidata=s.uidata;var ws=[uidata.wh[0]*coords.h,0,uidata.wh[2]*coords.h];var x=coords.x;ws[1]=max(0,coords.w-ws[0]-ws[2]);for(var ii=0;ii<ws.length;++ii){var my_w=ws[ii];s.draw({x:x,y:coords.y,z:coords.z,color:color,w:my_w,h:coords.h,uvs:uidata.rects[ii]});x+=my_w}}function drawVBox(coords,s,color){var uidata=s.uidata;var hs=[uidata.hw[0]*coords.w,0,uidata.hw[2]*coords.w];var y=coords.y;hs[1]=max(0,coords.h-hs[0]-hs[2]);for(var ii=0;ii<hs.length;++ii){var my_h=hs[ii];s.draw({x:coords.x,y:y,z:coords.z,color:color,w:coords.w,h:my_h,uvs:uidata.rects[ii]});y+=my_h}}function drawBox(coords,s,pixel_scale,color){var uidata=s.uidata;var scale=pixel_scale;var ws=[uidata.widths[0]*scale,0,uidata.widths[2]*scale];ws[1]=max(0,coords.w-ws[0]-ws[2]);var hs=[uidata.heights[0]*scale,0,uidata.heights[2]*scale];hs[1]=max(0,coords.h-hs[0]-hs[2]);var x=coords.x;for(var ii=0;ii<ws.length;++ii){var my_w=ws[ii];if(my_w){var y=coords.y;for(var jj=0;jj<hs.length;++jj){var my_h=hs[jj];if(my_h){s.draw({x:x,y:y,z:coords.z,color:color,w:my_w,h:my_h,uvs:uidata.rects[jj*3+ii],nozoom:true});y+=my_h}}x+=my_w}}}function playUISound(name,volume){if(name==="select"){name="button_click"}if(sounds[name]){soundPlay(sounds[name],volume)}}function setMouseOver(key,quiet){if(last_frame_button_mouseover!==key&&frame_button_mouseover!==key&&!quiet){playUISound("rollover")}frame_button_mouseover=key;exports.button_mouseover=button_mouseover=true}function focusSteal(key){if(key!==focused_key){focuslog("focusSteal ",key)}focused_this_frame=true;focused_key=key}function focusCanvas(){focusSteal("canvas")}function isFocusedPeek(key){return focused_key===key}function isFocused(key){if(key!==focused_key_prev2){focused_key_prev1=focused_key_prev2;focused_key_prev2=key}if(key===focused_key||key!==focused_key_not&&!focused_this_frame&&!focused_last_frame){if(key!==focused_key){focuslog("isFocused->focusSteal")}focusSteal(key);return true}return false}function focusNext(key){focuslog("focusNext ",key);playUISound("rollover");focused_key=null;focused_last_frame=focused_this_frame=false;focused_key_not=key;glov_input.eatAllInput(true)}function focusPrev(key){focuslog("focusPrev ",key);playUISound("rollover");if(key===focused_key_prev2){focusSteal(focused_key_prev1)}else{focusSteal(focused_key_prev2)}glov_input.eatAllInput(true)}function focusCheck(key){if(modal_stealing_focus){return false}var focused=isFocused(key);if(focused){if(glov_input.keyDownEdge(KEYS.TAB)){if(glov_input.keyDown(KEYS.SHIFT)){focusPrev(key)}else{focusNext(key);focused=false}}if(glov_input.padButtonDownEdge(pad_focus_right)){focusNext(key);focused=false}if(glov_input.padButtonDownEdge(pad_focus_left)){focusPrev(key)}}return focused}function panel(param){assert(typeof param.x==="number");assert(typeof param.y==="number");assert(typeof param.w==="number");assert(typeof param.h==="number");param.z=param.z||Z.UI-1;var color=param.color||color_panel;drawBox(param,sprites.panel,param.pixel_scale||panel_pixel_scale,color);glov_input.click(param);glov_input.mouseOver(param)}function drawTooltip(param){assert(typeof param.x==="number");assert(typeof param.y==="number");assert(typeof param.tooltip==="string");var tooltip_w=param.tooltip_width||tooltip_width;var x=param.x;if(x+tooltip_w>camera2d.x1()){x=camera2d.x1()-tooltip_w}var z=param.z||Z.TOOLTIP;var tooltip_y0=param.y;var eff_tooltip_pad=param.tooltip_pad||tooltip_pad;var w=tooltip_w-eff_tooltip_pad*2;if(param.tooltip_above){tooltip_y0-=font_height*font.numLines(modal_font_style,w,0,font_height,param.tooltip)+eff_tooltip_pad*2}var y=tooltip_y0+eff_tooltip_pad;y+=font.drawSizedWrapped(modal_font_style,x+eff_tooltip_pad,y,z+1,w,0,font_height,param.tooltip);y+=eff_tooltip_pad;var pixel_scale=param.pixel_scale||tooltip_panel_pixel_scale;panel({x:x,y:tooltip_y0,z:z,w:tooltip_w,h:y-tooltip_y0,pixel_scale:pixel_scale})}function checkHooks(param,click){if(param.hook){for(var ii=0;ii<hooks.length;++ii){if(click){hooks[ii].click(param)}hooks[ii].draw(param)}}}function buttonShared(param){param.z=param.z||Z.UI;var state="regular";var ret=false;if(param.draw_only){return{ret:ret,state:state}}var key=param.key||param.x+"_"+param.y;var rollover_quiet=param.rollover_quiet;var focused=!param.disabled&&!param.no_focus&&focusCheck(key);var key_opts=param.in_event_cb?{in_event_cb:param.in_event_cb}:null;exports.button_mouseover=button_mouseover=false;if(param.disabled){if(glov_input.mouseOver(param)){if(param.disabled_mouseover){setMouseOver(key,rollover_quiet)}}state="disabled"}else if(param.drag_target&&(ret=glov_input.dragDrop(param))){if(!glov_input.mousePosIsTouch()){setMouseOver(key,rollover_quiet)}if(!param.no_focus){focusSteal(key);focused=true}exports.button_click=button_click={drag:true}}else if((exports.button_click=button_click=glov_input.click(param))||param.long_press&&(exports.button_click=button_click=glov_input.longPress(param))){if(param.touch_twice&&!focused&&glov_input.mousePosIsTouch()){exports.touch_changed_focus=touch_changed_focus=true;setMouseOver(key,rollover_quiet)}else{ret=true}if(!param.no_focus){focusSteal(key);focused=true}}else if(param.drag_target&&glov_input.dragOver(param)){setMouseOver(key,rollover_quiet);state=glov_input.mouseDown({max_dist:Infinity})?"down":"rollover"}else if(param.drag_over&&glov_input.dragOver(param)){}else if(glov_input.mouseOver(param)){state=glov_input.mouseDown(param)?"down":"rollover";if(!glov_input.mousePosIsTouch()||state==="down"){setMouseOver(key,rollover_quiet)}}exports.button_focused=button_focused=focused;if(focused){if(glov_input.keyDownEdge(KEYS.SPACE,key_opts)||glov_input.keyDownEdge(KEYS.RETURN,key_opts)||glov_input.padButtonDownEdge(PAD.A)){exports.button_click=button_click={kb:true};ret=true}}if(ret){state="down";playUISound("button_click")}if(button_mouseover&&param.tooltip){drawTooltip({x:param.x,y:param.tooltip_above?param.y-2:param.y+param.h+2,tooltip_above:param.tooltip_above,tooltip:param.tooltip,tooltip_width:param.tooltip_width})}param.z+=param.z_bias&&param.z_bias[state]||0;checkHooks(param,ret);return{ret:ret,state:state,focused:focused}}var button_last_color;exports.button_last_color=button_last_color;function buttonTextDraw(param,state,focused){var colors=param.colors||color_button;var color=exports.button_last_color=button_last_color=colors[state];var base_name=param.base_name||"button";var sprite_name=base_name+"_"+state;var sprite=sprites[sprite_name];if(!sprite){sprite=sprites[base_name]}drawHBox(param,sprite,color);var hpad=min(param.font_height*.25,param.w*.1);font.drawSizedAligned(focused?font_style_focused:font_style_normal,param.x+hpad+1,param.y+1,param.z+.1,param.font_height,glov_font.ALIGN.HCENTERFIT|glov_font.ALIGN.VCENTER,param.w-hpad*2,param.h,param.text)}function buttonText(param){assert(typeof param.x==="number");assert(typeof param.y==="number");assert(typeof param.text==="string");param.w=param.w||button_width;param.h=param.h||button_height;param.font_height=param.font_height||font_height;var _buttonShared=buttonShared(param),ret=_buttonShared.ret,state=_buttonShared.state,focused=_buttonShared.focused;buttonTextDraw(param,state,focused);return ret}function buttonImage(param){assert(typeof param.x==="number");assert(typeof param.y==="number");assert(param.img&&param.img.draw);param.z=param.z||Z.UI;param.w=param.w||button_img_size;param.h=param.h||param.w||button_img_size;param.shrink=param.shrink||.75;var uvs=param.img_rect;if(typeof param.frame==="number"){uvs=param.img.uidata.rects[param.frame]}var _buttonShared2=buttonShared(param),ret=_buttonShared2.ret,state=_buttonShared2.state;var colors=param.colors||color_button;var color=exports.button_last_color=button_last_color=colors[state];if(!param.no_bg){var base_name=param.base_name||"button";var sprite_name=base_name+"_"+state;var sprite=sprites[sprite_name];if(!sprite){sprite=sprites[base_name]}drawHBox(param,sprite,color)}var img_origin=param.img.origin;var img_w=param.img.size[0];var img_h=param.img.size[1];var aspect=img_w/img_h;if(typeof param.frame==="number"){aspect=param.img.uidata.aspect?param.img.uidata.aspect[param.frame]:1}var largest_w_horiz=param.w*param.shrink;var largest_w_vert=param.h*param.shrink*aspect;img_w=min(largest_w_horiz,largest_w_vert);img_h=img_w/aspect;var pad_top=(param.h-img_h)/2;var draw_param={x:param.x+(param.left_align?pad_top:(param.w-img_w)/2)+img_origin[0]*img_w,y:param.y+pad_top+img_origin[1]*img_h,z:param.z+.1,color:param.img_color||param.color1&&param.color||color,color1:param.color1,w:img_w/param.img.size[0],h:img_h/param.img.size[1],uvs:uvs,rot:param.rotation};if(param.flip){var x=draw_param.x,w=draw_param.w;draw_param.x=x+w;draw_param.w=-w}if(param.color1){param.img.drawDualTint(draw_param)}else{param.img.draw(draw_param)}return ret}function print(style,x,y,z,text){return font.drawSized(style,x,y,z,font_height,text)}function modalDialog(param){assert(!param.title||typeof param.title==="string");assert(!param.text||typeof param.text==="string");assert(!param.buttons||typeof param.buttons==="object");modal_dialog=param}function modalDialogClear(){modal_dialog=null}var dom_requirement=vec2(24,24);var virtual_size=vec2();function modalDialogRun(){camera2d.domDeltaToVirtual(virtual_size,dom_requirement);var fullscreen_mode=false;var eff_font_height=modal_dialog.font_height||font_height;var eff_button_height=button_height;var pad=modal_pad;var vpad=modal_pad*.5;var general_scale=1;if(virtual_size[0]>.1*camera2d.h()&&camera2d.w()>camera2d.h()*2){fullscreen_mode=true;eff_button_height=eff_font_height;vpad=pad=4;var old_h=camera2d.h();camera2d.push();camera2d.setAspectFixed2(1,eff_font_height*(modal_title_scale+2)+pad*4.5);general_scale=camera2d.h()/old_h}var _modal_dialog=modal_dialog,buttons=_modal_dialog.buttons,click_anywhere=_modal_dialog.click_anywhere;var keys=Object.keys(buttons||{});var game_width=camera2d.x1()-camera2d.x0();var eff_modal_width=fullscreen_mode?game_width:modal_dialog.width||modal_width;var eff_button_width=modal_dialog.button_width||modal_button_width;var max_total_button_width=eff_modal_width*2/3;eff_button_width=min(eff_button_width,max_total_button_width/keys.length);var text_w=eff_modal_width-pad*2;var x0=camera2d.x0()+round((game_width-eff_modal_width)/2);var x=x0+pad;var y0=fullscreen_mode?0:modal_dialog.y0||modal_y0;var y=round(y0+pad);if(glov_input.pointerLocked()){glov_input.pointerLockExit()}if(modal_dialog.title){if(fullscreen_mode){title_font.drawSizedAligned(modal_font_style,x,y,Z.MODAL,eff_font_height*modal_title_scale,glov_font.ALIGN.HFIT,text_w,0,modal_dialog.title);y+=eff_font_height*modal_title_scale}else{y+=title_font.drawSizedWrapped(modal_font_style,x,y,Z.MODAL,text_w,0,eff_font_height*modal_title_scale,modal_dialog.title)}y=round(y+vpad*1.5)}if(modal_dialog.text){if(fullscreen_mode){font.drawSizedAligned(modal_font_style,x,y,Z.MODAL,eff_font_height,glov_font.ALIGN.HFIT,text_w,0,modal_dialog.text);y+=eff_font_height}else{y+=font.drawSizedWrapped(modal_font_style,x,y,Z.MODAL,text_w,0,eff_font_height,modal_dialog.text)}y=round(y+vpad)}var tick_key;if(modal_dialog.tick){var avail_width=eff_modal_width-pad*2;if(fullscreen_mode){avail_width-=(pad+eff_button_width)*keys.length}var param={x:x,y:y,modal_width:eff_modal_width,avail_width:avail_width,font_height:eff_font_height,fullscreen_mode:fullscreen_mode};tick_key=modal_dialog.tick(param);y=param.y}x=x0+eff_modal_width-(pad+eff_button_width)*keys.length;var did_button=-1;for(var ii=0;ii<keys.length;++ii){var key=keys[ii];var eff_button_keys=button_keys[key.toLowerCase()];var pressed=0;if(eff_button_keys){for(var jj=0;jj<eff_button_keys.key.length;++jj){pressed+=glov_input.keyDownEdge(eff_button_keys.key[jj]);if(eff_button_keys.key[jj]===tick_key){pressed++}}for(var _jj=0;_jj<eff_button_keys.pad.length;++_jj){pressed+=glov_input.padButtonDownEdge(eff_button_keys.pad[_jj])}}if(click_anywhere&&ii===0&&glov_input.click()){++pressed}if(pressed){did_button=ii}if(buttonText({x:x,y:y,z:Z.MODAL,w:eff_button_width,h:eff_button_height,text:key})){did_button=ii}x=round(x+pad+eff_button_width)}if(did_button===-1){for(var _ii2=0;_ii2<keys.length;++_ii2){var _key=keys[_ii2];var _eff_button_keys=button_keys[_key.toLowerCase()];if(_eff_button_keys&&_eff_button_keys.low_key){for(var _jj2=0;_jj2<_eff_button_keys.low_key.length;++_jj2){if(glov_input.keyDownEdge(_eff_button_keys.low_key[_jj2])||_eff_button_keys.low_key[_jj2]===tick_key){did_button=_ii2}}}}}if(did_button!==-1){var _key2=keys[did_button];playUISound("button_click");modal_dialog=null;if(buttons[_key2]){buttons[_key2]()}}y+=eff_button_height;y=round(y+vpad+pad);panel({x:x0,y:y0,z:Z.MODAL-1,w:eff_modal_width,h:(fullscreen_mode?camera2d.y1():y)-y0,pixel_scale:panel_pixel_scale*general_scale});glov_input.eatAllInput();modal_stealing_focus=true;if(fullscreen_mode){camera2d.pop()}}function modalTextEntry(param){var eb=glov_edit_box.create({allow_modal:true,initial_focus:true,spellcheck:false,initial_select:true,text:param.edit_text,max_len:param.max_len,esc_clears:false});var buttons={};for(var key in param.buttons){var val=param.buttons[key];if(typeof val==="function"){val=function(old_fn){return function(){old_fn(eb.getText())}}(val)}buttons[key]=val}param.buttons=buttons;param.text=""+(param.text||"");var old_tick=param.tick;param.tick=function(params){var eb_ret=eb.run({x:params.x,y:params.y,w:params.avail_width||param.edit_w,font_height:params.font_height});if(!params.fullscreen_mode){params.y+=params.font_height+modal_pad}var ret;if(eb_ret===eb.SUBMIT){ret=KEYS.O}else if(eb_ret===eb.CANCEL){ret=KEYS.ESC}if(old_tick){ret=old_tick(params)||ret}return ret};modalDialog(param)}function createEditBox(param){return glov_edit_box.create(param)}var slider_default_vshrink=1;var slider_default_handle_shrink=1;function setSliderDefaultShrink(vshrink,handle_shrink){slider_default_vshrink=vshrink;slider_default_handle_shrink=handle_shrink}var color_slider_handle=vec4(1,1,1,1);var color_slider_handle_grab=vec4(.5,.5,.5,1);var color_slider_handle_over=vec4(.75,.75,.75,1);var slider_dragging=false;exports.slider_dragging=slider_dragging;function slider(value,param){assert(typeof param.x==="number");assert(typeof param.y==="number");assert(param.min<param.max);param.z=param.z||Z.UI;param.w=param.w||button_width;param.h=param.h||button_height;var vshrink=param.vshrink||slider_default_vshrink;var handle_shrink=param.handle_shrink||slider_default_handle_shrink;var disabled=param.disabled||false;var handle_h=param.h*handle_shrink;var handle_w=sprites.slider_handle.uidata.wh[0]*handle_h;exports.slider_dragging=slider_dragging=false;var shrinkdiff=handle_shrink-vshrink+.4;drawHBox({x:param.x+param.h*shrinkdiff/2,y:param.y+param.h*(1-vshrink)/2,w:param.w-param.h*shrinkdiff,h:param.h*vshrink},sprites.slider,param.color);var xoffs=round(max(sprites.slider.uidata.wh[0]*param.h*vshrink,handle_w)/2);var draggable_width=param.w-xoffs*2;var drag=!disabled&&glov_input.drag(param);var grabbed=Boolean(drag);var click=glov_input.click(param);if(click){grabbed=false;value=(click.pos[0]-(param.x+xoffs))/draggable_width;value=param.min+(param.max-param.min)*clamp(value,0,1);playUISound("button_click")}else if(grabbed){value=(drag.cur_pos[0]-(param.x+xoffs))/draggable_width;value=param.min+(param.max-param.min)*clamp(value,0,1);glov_input.mouseOver();exports.slider_dragging=slider_dragging=true}var rollover=!disabled&&glov_input.mouseOver(param);var handle_center_pos=param.x+xoffs+draggable_width*(value-param.min)/(param.max-param.min);var handle_x=handle_center_pos-handle_w/2;var handle_y=param.y+param.h/2-handle_h/2;var handle_color=color_slider_handle;if(grabbed){handle_color=color_slider_handle_grab}else if(rollover){handle_color=color_slider_handle_over}sprites.slider_handle.draw({x:handle_x,y:handle_y,z:param.z+.1,w:handle_w,h:handle_h,color:handle_color,frame:0});return value}var pp_bad_frames=0;function isMenuUp(){return modal_dialog||menu_up}function tickUI(dt){last_frame_button_mouseover=frame_button_mouseover;frame_button_mouseover=false;focused_last_frame=focused_this_frame;focused_this_frame=false;focused_key_not=null;modal_stealing_focus=false;exports.touch_changed_focus=touch_changed_focus=false;per_frame_dom_alloc[glov_engine.frame_index%per_frame_dom_alloc.length]=0;last_frame_edit_boxes=exports.this_frame_edit_boxes;exports.this_frame_edit_boxes=[];linkTick();dom_elems_issued=0;var pp_this_frame=false;if(modal_dialog||menu_up){var params=menu_fade_params;if(!menu_up){params=menu_fade_params_default}menu_up_time+=dt;var factor=min(menu_up_time/500,1);if(glov_engine.postprocessing&&!glov_engine.defines.NOPP){var blur_factor=lerp(factor,params.blur[0],params.blur[1]);if(blur_factor){effectsQueue(params.z-2,doBlurEffect.bind(null,blur_factor))}var saturation=lerp(factor,params.saturation[0],params.saturation[1]);var brightness=lerp(factor,params.brightness[0],params.brightness[1]);if(saturation!==1||brightness!==1){effectsQueue(params.z-1,doDesaturateEffect.bind(null,saturation,brightness))}pp_this_frame=true}else{sprites.white.draw({x:camera2d.x0Real(),y:camera2d.y0Real(),z:params.z-2,color:params.fallback_darken,w:camera2d.wReal(),h:camera2d.hReal()})}}else{menu_up_time=0}exports.menu_up=menu_up=false;if(!glov_engine.is_loading&&glov_engine.getFrameDtActual()>50&&pp_this_frame){pp_bad_frames=(pp_bad_frames||0)+1;if(pp_bad_frames>=6){glov_engine.postprocessingAllow(false)}}else if(pp_bad_frames){pp_bad_frames=0}if(modal_dialog){modalDialogRun()}}function endFrame(){if(glov_input.click({x:-Infinity,y:-Infinity,w:Infinity,h:Infinity})){focusSteal("canvas")}for(var ii=0;ii<last_frame_edit_boxes.length;++ii){var edit_box=last_frame_edit_boxes[ii];var idx=exports.this_frame_edit_boxes.indexOf(edit_box);if(idx===-1){edit_box.unrun()}}while(dom_elems_issued<dom_elems.length){var elem=dom_elems.pop();dynamic_text_elem.removeChild(elem)}}function cleanupDOMElems(){while(dom_elems.length){var elem=dom_elems.pop();dynamic_text_elem.removeChild(elem)}}function menuUp(param){merge(menu_fade_params,menu_fade_params_default);if(param){merge(menu_fade_params,param)}exports.menu_up=menu_up=true;modal_stealing_focus=true;glov_input.eatAllInput()}function copyTextToClipboard(text){var textArea=document.createElement("textarea");textArea.style.position="fixed";textArea.style.top=0;textArea.style.left=0;textArea.style.width="2em";textArea.style.height="2em";textArea.style.border="none";textArea.style.outline="none";textArea.style.boxShadow="none";textArea.style.background="transparent";textArea.value=text;document.body.appendChild(textArea);textArea.focus();textArea.select();var ret=false;try{ret=document.execCommand("copy")}catch(err){}document.body.removeChild(textArea);return ret}function provideUserString(title,thing,str){var copy_success=copyTextToClipboard(str);modalTextEntry({edit_w:400,edit_text:str,title:title,text:copy_success?thing+" copied to clipboard!":"Copy to clipboard FAILED, please copy from below\n",buttons:{OK:null}})}function drawRect(x0,y0,x1,y1,z,color){var mx=min(x0,x1);var my=min(y0,y1);var Mx=max(x0,x1);var My=max(y0,y1);sprites.white.draw({x:mx,y:my,z:z,color:color,w:Mx-mx,h:My-my})}function drawRect2(param){drawRect(param.x,param.y,param.x+param.w,param.y+param.h,param.z,param.color)}function spreadTechParams(spread){spread=min(max(spread,0),.99);var tech_params={param0:vec4(0,0,0,0)};tech_params.param0[0]=1/(1-spread);tech_params.param0[1]=-.5*tech_params.param0[0]+.5;return tech_params}function drawElipseInternal(sprite,x0,y0,x1,y1,z,spread,tu0,tv0,tu1,tv1,color,blend){glov_sprites.queueraw(sprite.texs,x0,y0,z,x1-x0,y1-y0,tu0,tv0,tu1,tv1,color,glov_font.font_shaders.font_aa,spreadTechParams(spread),blend)}function drawCircleInternal(sprite,x,y,z,r,spread,tu0,tv0,tu1,tv1,color,blend){var x0=x-r*2+r*4*tu0;var x1=x-r*2+r*4*tu1;var y0=y-r*2+r*4*tv0;var y1=y-r*2+r*4*tv1;drawElipseInternal(sprite,x0,y0,x1,y1,z,spread,tu0,tv0,tu1,tv1,color,blend)}function initCircleSprite(){var CIRCLE_SIZE=32;var data=new Uint8Array(CIRCLE_SIZE*CIRCLE_SIZE);var midp=(CIRCLE_SIZE-1)/2;for(var i=0;i<CIRCLE_SIZE;i++){for(var j=0;j<CIRCLE_SIZE;j++){var d=sqrt((i-midp)*(i-midp)+(j-midp)*(j-midp))/midp;var v=clamp(1-d,0,1);data[i+j*CIRCLE_SIZE]=v*255}}sprites.circle=glov_sprites.create({url:"circle",width:CIRCLE_SIZE,height:CIRCLE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}function drawElipse(x0,y0,x1,y1,z,spread,color,blend){if(!sprites.circle){initCircleSprite()}drawElipseInternal(sprites.circle,x0,y0,x1,y1,z,spread,0,0,1,1,color,blend)}function drawCircle(x,y,z,r,spread,color,blend){if(!sprites.circle){initCircleSprite()}drawCircleInternal(sprites.circle,x,y,z,r,spread,0,0,1,1,color,blend)}function drawHollowCircle(x,y,z,r,spread,color,blend){if(!sprites.hollow_circle){var CIRCLE_SIZE=128;var LINE_W=2;var data=new Uint8Array(CIRCLE_SIZE*CIRCLE_SIZE);var midp=(CIRCLE_SIZE-1)/2;for(var i=0;i<CIRCLE_SIZE;i++){for(var j=0;j<CIRCLE_SIZE;j++){var d=sqrt((i-midp)*(i-midp)+(j-midp)*(j-midp))/midp;var v=clamp(1-d,0,1);if(v>.5){v=1-v}v+=LINE_W/CIRCLE_SIZE;data[i+j*CIRCLE_SIZE]=v*255}}sprites.hollow_circle=glov_sprites.create({url:"hollow_circle",width:CIRCLE_SIZE,height:CIRCLE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}drawCircleInternal(sprites.hollow_circle,x,y,z,r,spread,0,0,1,1,color,blend)}function drawLine(x0,y0,x1,y1,z,w,spread,color){if(!sprites.line){var LINE_SIZE=32;var data=new Uint8Array(LINE_SIZE*LINE_SIZE);var midp=(LINE_SIZE-1)/2;for(var i=0;i<LINE_SIZE;i++){for(var j=0;j<LINE_SIZE;j++){var d=abs((i-midp)/midp);var v=clamp(1-d,0,1);data[i+j*LINE_SIZE]=v*255}}sprites.line=glov_sprites.create({url:"line",width:LINE_SIZE,height:LINE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}var dx=x1-x0;var dy=y1-y0;var length=Math.sqrt(dx*dx+dy*dy);dx/=length;dy/=length;var tangx=-dy*w;var tangy=dx*w;glov_sprites.queueraw4(sprites.line.texs,x0+tangx,y0+tangy,x1+tangx,y1+tangy,x1-tangx,y1-tangy,x0-tangx,y0-tangy,z,0,0,1,1,color,glov_font.font_shaders.font_aa,spreadTechParams(spread))}function drawHollowRect(x0,y0,x1,y1,z,w,spread,color){drawLine(x0,y0,x1,y0,z,w,spread,color);drawLine(x1,y0,x1,y1,z,w,spread,color);drawLine(x1,y1,x0,y1,z,w,spread,color);drawLine(x0,y1,x0,y0,z,w,spread,color)}function drawHollowRect2(param){drawHollowRect(param.x,param.y,param.x+param.w,param.y+param.h,param.z||Z.UI,param.line_width||1,param.spread||1,param.color||unit_vec)}function drawCone(x0,y0,x1,y1,z,w0,w1,spread,color){if(!sprites.cone){var CONE_SIZE=32;var data=new Uint8Array(CONE_SIZE*CONE_SIZE);var midp=(CONE_SIZE-1)/2;for(var i=0;i<CONE_SIZE;i++){for(var j=0;j<CONE_SIZE;j++){var _dx=0;var _dy=0;var d=0;if(i>midp){_dx=(i-midp)/midp;_dy=abs(j-midp)/midp;var dCircle=sqrt(_dx*_dx+_dy*_dy);d=_dx*dCircle}var v=clamp(1-d,0,1);data[i+j*CONE_SIZE]=v*255}}sprites.cone=glov_sprites.create({url:"cone",width:CONE_SIZE,height:CONE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}var dx=x1-x0;var dy=y1-y0;var length=Math.sqrt(dx*dx+dy*dy);dx/=length;dy/=length;var tangx=-dy;var tangy=dx;glov_sprites.queueraw4(sprites.cone.texs,x0-tangx*w0,y0-tangy*w0,x0+tangx*w0,y0+tangy*w0,x1+tangx*w1,y1+tangy*w1,x1-tangx*w1,y1-tangy*w1,z,0,0,1,1,color,glov_font.font_shaders.font_aa,spreadTechParams(spread))}function scaleSizes(scale){exports.button_height=button_height=round(32*scale);exports.font_height=font_height=round(24*scale);exports.button_width=button_width=round(200*scale);exports.button_img_size=button_img_size=button_height;exports.modal_button_width=modal_button_width=round(button_width/2);exports.modal_width=modal_width=round(600*scale);exports.modal_y0=modal_y0=round(200*scale);exports.modal_title_scale=modal_title_scale=1.2;exports.modal_pad=modal_pad=round(16*scale);exports.tooltip_width=tooltip_width=round(400*scale);exports.tooltip_pad=tooltip_pad=round(8*scale);exports.panel_pixel_scale=panel_pixel_scale=button_height/13;exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=panel_pixel_scale}function setPanelPixelScale(scale){exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=exports.panel_pixel_scale=panel_pixel_scale=scale}function setModalSizes(_modal_button_width,width,y0,title_scale,pad){exports.modal_button_width=modal_button_width=_modal_button_width||round(button_width/2);exports.modal_width=modal_width=width||600;exports.modal_y0=modal_y0=y0||200;exports.modal_title_scale=modal_title_scale=title_scale||1.2;exports.modal_pad=modal_pad=pad||modal_pad}function setFontHeight(_font_height){exports.font_height=font_height=_font_height}function setTooltipWidth(_tooltip_width,_tooltip_panel_pixel_scale){exports.tooltip_width=tooltip_width=_tooltip_width;exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=_tooltip_panel_pixel_scale;exports.tooltip_pad=tooltip_pad=modal_pad/2*_tooltip_panel_pixel_scale}scaleSizes(1);


},{"../../common/util.js":70,"./camera2d.js":6,"./edit_box.js":9,"./effects.js":10,"./engine.js":11,"./font.js":15,"./input.js":25,"./link.js":26,"./mat43.js":28,"./sound.js":41,"./sprites.js":43,"./textures.js":45,"./vmath.js":49,"assert":undefined}],48:[function(require,module,exports){
"use strict";exports.getURLBase=getURLBase;exports.getURLPageBase=getURLPageBase;exports.setAPIPath=setAPIPath;exports.getAPIPath=getAPIPath;exports.onChange=onChange;exports.refreshTitle=refreshTitle;exports.onURLChange=onURLChange;exports.startup=startup;exports.route=route;exports.register=register;exports.set=set;exports.get=get;exports.go=go;exports.TYPE_STRING=exports.TYPE_SET=void 0;var assert=require("assert");var _require=require("../../common/util.js"),callEach=_require.callEach;var HISTORY_UPDATE_TIME=1e3;var TYPE_SET="set";exports.TYPE_SET=TYPE_SET;var TYPE_STRING="string";exports.TYPE_STRING=TYPE_STRING;var params={};var title_suffix="";var page_base=(document.location.href||"").match(/^[^#?]+/)[0];if(!page_base.endsWith("/")){page_base+="?"}var url_base=page_base.replace(/[^/]*$/,"");var on_change=[];function getURLBase(){return url_base}function getURLPageBase(){return page_base}var api_path;function setAPIPath(path){api_path=path}function getAPIPath(){return api_path||getURLBase()+"api/"}function onChange(cb){on_change.push(cb)}function cmpNumKeys(a,b){var d=b.keys.length-a.keys.length;if(d){return d}for(var ii=0;ii<a.keys.length;++ii){if(a.keys[ii]<b.keys[ii]){return-1}else if(a.keys[ii]>b.keys[ii]){return 1}}assert(false);return 0}var route_param_regex=/:(\w+)/g;var routes=[];function queryString(){var href=String(document.location);return href.slice(page_base.length)}var regex_value=/[^\w]\w+=([^&]+)/;function getValue(query_string,opts){if(opts.routes){for(var ii=0;ii<opts.routes.length;++ii){var r=opts.routes[ii];var _m=query_string.match(r.regex);if(_m){var idx=r.keys.indexOf(opts.key);return _m[1+idx]}}}var m=query_string.match(opts.regex)||[];if(opts.type===TYPE_SET){var _r={};for(var _ii=0;_ii<m.length;++_ii){var m2=m[_ii].match(regex_value);assert(m2);_r[m2[1]]=1}return _r}else{return m[1]||opts.def}}var last_history_str=null;function goInternal(query_string){var hidden={};for(var key in params){var opts=params[key];if(opts.hides){if(getValue(query_string,opts)){for(var otherkey in opts.hides){hidden[otherkey]=1}}}}var dirty={};for(var _key in params){if(hidden[_key]){continue}var _opts=params[_key];var new_value=getValue(query_string,_opts);if(_opts.type===TYPE_SET){for(var v in new_value){if(!_opts.value[v]){_opts.value[v]=1;dirty[_key]=true}}for(var _v in _opts.value){if(!new_value[_v]){delete _opts.value[_v];dirty[_key]=true}}}else{if(new_value!==_opts.value){dirty[_key]=true;_opts.value=new_value}}}for(var _key2 in dirty){var _opts2=params[_key2];if(_opts2.change){_opts2.change(_opts2.value)}}callEach(on_change)}var eff_title;function toString(){eff_title="";var values=[];var hidden={};for(var key in params){var opts=params[key];if(opts.hides&&opts.value){for(var otherkey in opts.hides){hidden[otherkey]=1}}}var root_value="";outer:for(var ii=0;ii<routes.length;++ii){var r=routes[ii];var route_title="";for(var jj=0;jj<r.keys.length;++jj){var _key3=r.keys[jj];if(hidden[_key3]){continue outer}var _opts3=params[_key3];if(_opts3.hide_values[_opts3.value]){continue outer}if(!route_title&&_opts3.title){route_title=_opts3.title(_opts3.value)}}root_value=r.route_string.replace(route_param_regex,function(ignored,key){hidden[key]=true;return String(params[key].value)});if(!eff_title&&route_title){eff_title=route_title}break}for(var _key4 in params){if(hidden[_key4]){continue}var _opts4=params[_key4];if(_opts4.type===TYPE_SET){for(var v in _opts4.value){values.push(_key4+"="+v)}}else{if(!_opts4.hide_values[_opts4.value]){values.push(_key4+"="+_opts4.value);if(!eff_title&&_opts4.title){eff_title=_opts4.title(_opts4.value)}}}}if(title_suffix){if(eff_title){eff_title=eff_title+" | "+title_suffix}else{eff_title=title_suffix}}return""+root_value+(values.length?"?":"")+values.join("&")}function refreshTitle(){toString();if(eff_title&&eff_title!==document.title){document.title=eff_title}}function periodicRefreshTitle(){refreshTitle();setTimeout(periodicRefreshTitle,1e3)}function onPopState(){var query_string=queryString();last_history_str=query_string;goInternal(query_string);refreshTitle()}var on_url_change;function onURLChange(cb){on_url_change=cb}var last_history_set_time=0;var scheduled=false;var need_push_state=false;function updateHistory(new_need_push_state){var new_str=toString();if(last_history_str===new_str){return}need_push_state=need_push_state||new_need_push_state;last_history_str=new_str;if(scheduled){return}var delay=HISTORY_UPDATE_TIME;if(Date.now()-last_history_set_time>HISTORY_UPDATE_TIME){delay=1}scheduled=true;setTimeout(function(){scheduled=false;last_history_set_time=Date.now();var url=""+page_base+last_history_str;if(url.endsWith("?")){url=url.slice(0,-1)}try{if(need_push_state){need_push_state=false;window.history.pushState(undefined,eff_title,url)}else{window.history.replaceState(undefined,eff_title,url)}}catch(e){}if(eff_title){document.title=eff_title}if(on_url_change){on_url_change()}},delay)}function startup(param){assert(!title_suffix);title_suffix=param.title_suffix;updateHistory(false);if(title_suffix){refreshTitle();setTimeout(periodicRefreshTitle,1e3)}}function route(route_string){var keys=[];var base=route_string.replace(route_param_regex,function(ignored,match){keys.push(match);return"([^/&?]+)"});var regex=new RegExp("^"+base+"(?:$|\\?)");var new_route={route_string:route_string,regex:regex,keys:keys};for(var ii=0;ii<keys.length;++ii){var opts=params[keys[ii]];assert(opts);opts.routes=opts.routes||[];opts.routes.push(new_route);opts.value=getValue(queryString(),opts)}routes.push(new_route);routes.sort(cmpNumKeys)}function register(opts){assert(opts.key);assert(!params[opts.key]);opts.type=opts.type||TYPE_STRING;var regex_search="(?:[^\\w])"+opts.key+"=([^&]+)";var regex_type="";if(opts.type===TYPE_SET){regex_type="g"}else{opts.def=opts.def||"";opts.hide_values=opts.hide_values||{};opts.hide_values[opts.def]=true}opts.regex=new RegExp(regex_search,regex_type);params[opts.key]=opts;opts.value=getValue(queryString(),opts);var ret=opts.value;if(opts.type===TYPE_SET&&typeof Proxy==="function"){ret=new Proxy(opts.value,{set:function set(target,prop,value){if(value){target[prop]=1}else{delete target[prop]}updateHistory();return true}})}if(!window.onpopstate){window.onpopstate=onPopState}return ret}function set(key,value,value2){var opts=params[key];assert(opts);if(opts.type===TYPE_SET){if(Boolean(opts.value[value])!==Boolean(value2)){opts.value[value]=value2?1:0;updateHistory(opts.push)}}else{if(opts.value!==value){opts.value=value;updateHistory(opts.push)}}}function get(key){var opts=params[key];assert(opts);return opts.value}function go(query_string){goInternal(query_string);updateHistory(true)}


},{"../../common/util.js":70,"assert":undefined}],49:[function(require,module,exports){
"use strict";exports.vec1=vec1;exports.vec2=vec2;exports.vec3=vec3;exports.vec4=vec4;exports.v2abs=v2abs;exports.v2add=v2add;exports.v2addScale=v2addScale;exports.v2copy=v2copy;exports.v2distSq=v2distSq;exports.v2div=v2div;exports.v2floor=v2floor;exports.v2lengthSq=v2lengthSq;exports.v2lerp=v2lerp;exports.v2mul=v2mul;exports.v2normalize=v2normalize;exports.v2same=v2same;exports.v2scale=v2scale;exports.v2set=v2set;exports.v2sub=v2sub;exports.v3add=v3add;exports.v3iAdd=v3iAdd;exports.v3addScale=v3addScale;exports.v3copy=v3copy;exports.v3cross=v3cross;exports.v3determinant=v3determinant;exports.v3dot=v3dot;exports.v3distSq=v3distSq;exports.v3dist=v3dist;exports.v3div=v3div;exports.v3iFloor=v3iFloor;exports.v3floor=v3floor;exports.v3lengthSq=v3lengthSq;exports.v3lerp=v3lerp;exports.v3iMax=v3iMax;exports.v3iMin=v3iMin;exports.v3mul=v3mul;exports.v3mulMat4=v3mulMat4;exports.v3normalize=v3normalize;exports.v3iNormalize=v3iNormalize;exports.v3perspectiveProject=v3perspectiveProject;exports.v3round=v3round;exports.v3same=v3same;exports.v3scale=v3scale;exports.v3set=v3set;exports.v3sub=v3sub;exports.v3iScale=v3iScale;exports.v3iSub=v3iSub;exports.v3zero=v3zero;exports.v4add=v4add;exports.v4clone=v4clone;exports.v4copy=v4copy;exports.v4lerp=v4lerp;exports.v4mul=v4mul;exports.v4mulAdd=v4mulAdd;exports.v4same=v4same;exports.v4scale=v4scale;exports.v4set=v4set;exports.v4zero=v4zero;exports.zaxis=exports.yaxis=exports.xaxis=exports.identity_mat4=exports.identity_mat3=exports.zero_vec=exports.half_vec=exports.unit_vec=void 0;exports.mat3=require("gl-mat3/create");exports.mat4=require("gl-mat4/create");var abs=Math.abs,max=Math.max,min=Math.min,floor=Math.floor,round=Math.round,sqrt=Math.sqrt;function vec1(v){return new Float64Array([v])}function vec2(a,b){var r=new Float64Array(2);if(a||b){r[0]=a;r[1]=b}return r}function vec3(a,b,c){var r=new Float64Array(3);if(a||b||c){r[0]=a;r[1]=b;r[2]=c}return r}function vec4(a,b,c,d){var r=new Float64Array(4);if(a||b||c||d){r[0]=a;r[1]=b;r[2]=c;r[3]=d}return r}function frozenVec4(a,b,c,d){return vec4(a,b,c,d)}var unit_vec=frozenVec4(1,1,1,1);exports.unit_vec=unit_vec;var half_vec=frozenVec4(.5,.5,.5,.5);exports.half_vec=half_vec;var zero_vec=frozenVec4(0,0,0,0);exports.zero_vec=zero_vec;var identity_mat3=exports.mat3();exports.identity_mat3=identity_mat3;var identity_mat4=exports.mat4();exports.identity_mat4=identity_mat4;var xaxis=frozenVec4(1,0,0,0);exports.xaxis=xaxis;var yaxis=frozenVec4(0,1,0,0);exports.yaxis=yaxis;var zaxis=frozenVec4(0,0,1,0);exports.zaxis=zaxis;function v2abs(out,a){out[0]=abs(a[0]);out[1]=abs(a[1]);return out}function v2add(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out}function v2addScale(out,a,b,s){out[0]=a[0]+b[0]*s;out[1]=a[1]+b[1]*s;return out}function v2copy(out,a){out[0]=a[0];out[1]=a[1];return out}function v2distSq(a,b){return(a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1])}function v2div(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out}function v2floor(out,a){out[0]=floor(a[0]);out[1]=floor(a[1]);return out}function v2lengthSq(a){return a[0]*a[0]+a[1]*a[1]}function v2lerp(out,t,a,b){var it=1-t;out[0]=it*a[0]+t*b[0];out[1]=it*a[1]+t*b[1];return out}function v2mul(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out}function v2normalize(out,a){var len=a[0]*a[0]+a[1]*a[1];if(len>0){len=1/sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out}function v2same(a,b){return a[0]===b[0]&&a[1]===b[1]}function v2scale(out,a,s){out[0]=a[0]*s;out[1]=a[1]*s;return out}function v2set(out,a,b){out[0]=a;out[1]=b;return out}function v2sub(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out}function v3add(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out}function v3iAdd(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a}function v3addScale(out,a,b,s){out[0]=a[0]+b[0]*s;out[1]=a[1]+b[1]*s;out[2]=a[2]+b[2]*s;return out}function v3copy(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out}function v3cross(out,a,b){var a0=a[0];var a1=a[1];var a2=a[2];var b0=b[0];var b1=b[1];var b2=b[2];out[0]=a1*b2-a2*b1;out[1]=a2*b0-a0*b2;out[2]=a0*b1-a1*b0;return out}function v3determinant(a,b,c){var a00=a[0];var a01=b[0];var a02=c[0];var a10=a[1];var a11=b[1];var a12=c[1];var a20=a[2];var a21=b[2];var a22=c[2];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)}function v3dot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function v3distSq(a,b){return(a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1])+(a[2]-b[2])*(a[2]-b[2])}function v3dist(a,b){return sqrt(v3distSq(a,b))}function v3div(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out}function v3iFloor(a){a[0]=floor(a[0]);a[1]=floor(a[1]);a[2]=floor(a[2]);return a}function v3floor(out,a){out[0]=floor(a[0]);out[1]=floor(a[1]);out[2]=floor(a[2]);return out}function v3lengthSq(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]}function v3lerp(out,t,a,b){var it=1-t;out[0]=it*a[0]+t*b[0];out[1]=it*a[1]+t*b[1];out[2]=it*a[2]+t*b[2];return out}function v3iMax(a,b){a[0]=max(a[0],b[0]);a[1]=max(a[1],b[1]);a[2]=max(a[2],b[2]);return a}function v3iMin(a,b){a[0]=min(a[0],b[0]);a[1]=min(a[1],b[1]);a[2]=min(a[2],b[2]);return a}function v3mul(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out}function v3mulMat4(out,a,m){var x=a[0];var y=a[1];var z=a[2];out[0]=x*m[0]+y*m[4]+z*m[8];out[1]=x*m[1]+y*m[5]+z*m[9];out[2]=x*m[2]+y*m[6]+z*m[10];return out}function v3normalize(out,a){var len=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];if(len>0){len=1/sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out}function v3iNormalize(a){var len=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];if(len>0){len=1/sqrt(len);a[0]*=len;a[1]*=len;a[2]*=len}return a}function v3perspectiveProject(out,a,m){var x=a[0];var y=a[1];var z=a[2];var w=m[3]*x+m[7]*y+m[11]*z+m[15];var invw=.5/(w||1e-5);out[0]=(m[0]*x+m[4]*y+m[8]*z+m[12])*invw+.5;out[1]=(m[1]*x+m[5]*y+m[9]*z+m[13])*-invw+.5;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out}function v3round(out,a){out[0]=round(a[0]);out[1]=round(a[1]);out[2]=round(a[2]);return out}function v3same(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]}function v3scale(out,a,s){out[0]=a[0]*s;out[1]=a[1]*s;out[2]=a[2]*s;return out}function v3set(out,a,b,c){out[0]=a;out[1]=b;out[2]=c;return out}function v3sub(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out}function v3iScale(a,s){a[0]*=s;a[1]*=s;a[2]*=s;return a}function v3iSub(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a}function v3zero(out){out[0]=out[1]=out[2]=0;return out}function v4add(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out}function v4clone(a){return a.slice(0)}function v4copy(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out}function v4lerp(out,t,a,b){var it=1-t;out[0]=it*a[0]+t*b[0];out[1]=it*a[1]+t*b[1];out[2]=it*a[2]+t*b[2];out[3]=it*a[3]+t*b[3];return out}function v4mul(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out}function v4mulAdd(out,a,b,c){out[0]=a[0]*b[0]+c[0];out[1]=a[1]*b[1]+c[1];out[2]=a[2]*b[2]+c[2];out[3]=a[3]*b[3]+c[3];return out}function v4same(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}function v4scale(out,a,s){out[0]=a[0]*s;out[1]=a[1]*s;out[2]=a[2]*s;out[3]=a[3]*s;return out}function v4set(out,a,b,c,d){out[0]=a;out[1]=b;out[2]=c;out[3]=d;return out}function v4zero(out){out[0]=out[1]=out[2]=out[3]=0;return out}


},{"gl-mat3/create":undefined,"gl-mat4/create":undefined}],50:[function(require,module,exports){
"use strict";var floor=Math.floor;var offs=0;function now(){return Date.now()+offs}module.exports=exports=now;exports.now=now;exports.sync=function(server_time){offs=server_time-Date.now()};exports.seconds=function(){return floor(now()/1e3)-1577836800};


},{}],51:[function(require,module,exports){
"use strict";exports.webFSGetFile=webFSGetFile;exports.webFSExists=webFSExists;exports.webFSReportUnused=webFSReportUnused;var assert=require("assert");var _require=require("./filewatch.js"),filewatchOn=_require.filewatchOn,filewatchTriggerChange=_require.filewatchTriggerChange;var urlhash=require("./urlhash.js");var fs=window.glov_webfs=window.glov_webfs||{};var decoded={};var used={};function decode(data){var len=data[0];var str=data[1];var u8=new Uint8Array(len);var idxo=0;var idxi=0;while(idxo<len){var byte=str.charCodeAt(idxi++);if(byte===126){byte=0}else if(byte===27){byte=str.charCodeAt(idxi++)}u8[idxo++]=byte}assert.equal(idxi,str.length);assert.equal(idxo,len);return u8}function webFSGetFile(filename,encoding){var ret=decoded[filename];if(ret){return ret}used[filename]=true;var data=fs[filename];assert(data,"Error loading file: "+filename);if(encoding==="text"){ret=data[1]}else{ret=decode(data)}decoded[filename]=ret;return ret}function webFSExists(filename){return Boolean(fs[filename])}var report_ignore_regex=/\.(fp|vp|vm)$/;function webFSReportUnused(){var tot_size=0;for(var filename in fs){if(!used[filename]&&!filename.match(report_ignore_regex)){console.warn("WebFS file bundled but unreferenced: "+filename);tot_size+=fs[filename][0]}}if(tot_size){console.warn("WebFS wasting "+tot_size+" bytes")}}function webFSReload(){window.glov_webfs={};var scriptTag=document.createElement("script");scriptTag.src=urlhash.getURLBase()+"fsdata.js?rl="+Date.now();scriptTag.onload=function(){if(window.glov_webfs){var old_fs=fs;fs=window.glov_webfs;decoded={};used={};for(var key in fs){var old_value=old_fs[key];var new_value=fs[key];for(var ii=0;ii<new_value.length;++ii){if(!old_value||new_value[ii]!==old_value[ii]){filewatchTriggerChange(key);break}}}}};document.getElementsByTagName("head")[0].appendChild(scriptTag)}filewatchOn("fsdata.js",webFSReload);


},{"./filewatch.js":14,"./urlhash.js":48,"assert":undefined}],52:[function(require,module,exports){
"use strict";exports.profanityStartup=profanityStartup;exports.profanityFilter=profanityFilter;var _require=require("../rand_alea.js"),mashString=_require.mashString;var _require2=require("../rand_fast.js"),randFastCreate=_require2.randFastCreate;var _require3=require("../../../common/words/profanity_common.js"),profanityFilterCommon=_require3.profanityFilterCommon,profanityCommonStartup=_require3.profanityCommonStartup;var _require4=require("../webfs.js"),webFSGetFile=_require4.webFSGetFile;var non_profanity;function profanityStartup(){non_profanity=webFSGetFile("glov/words/replacements.txt","text").split("\n").filter(function(a){return a});profanityCommonStartup(webFSGetFile("../common/words/filter.gkg","text"))}var rand=randFastCreate();var last_word;function randWord(){if(last_word===-1){last_word=rand.range(non_profanity.length)}else{var choice=rand.range(non_profanity.length-1);last_word=choice<last_word?choice:choice+1}return non_profanity[last_word]}function profanityFilter(user_str){last_word=-1;rand.seed=mashString(user_str);return profanityFilterCommon(user_str,randWord)}


},{"../../../common/words/profanity_common.js":71,"../rand_alea.js":36,"../rand_fast.js":37,"../webfs.js":51}],53:[function(require,module,exports){
"use strict";exports.WSClient=WSClient;var ack=require("../../common/ack.js");var ackInitReceiver=ack.ackInitReceiver;var assert=require("assert");var _require=require("./error_report.js"),errorReportSetDetails=_require.errorReportSetDetails;var min=Math.min;var urlhash=require("./urlhash.js");var walltime=require("./walltime.js");var wscommon=require("../../common/wscommon.js");var wsHandleMessage=wscommon.wsHandleMessage;function WSClient(path){this.id=null;this.my_ids={};this.handlers={};this.socket=null;this.connected=false;this.disconnected=false;this.retry_scheduled=false;this.retry_count=0;this.disconnect_time=Date.now();this.last_receive_time=Date.now();this.idle_counter=0;this.last_send_time=Date.now();this.auto_path=!path;ackInitReceiver(this);if(this.auto_path){path=document.location.toString().match(/^[^#?]+/)[0];if(path.slice(-1)!=="/"){var idx=path.lastIndexOf("/");if(idx!==-1){var filename=path.slice(idx+1);if(filename.indexOf(".")!==-1){path=path.slice(0,idx+1)}else{path+="/"}}else{path+="/"}}path=path.replace(/^http/,"ws");this.path=path+"ws"}else{this.path=path}if(path.match(/:\d+\//)){this.path2=this.path}else if(path.match(/^ws:/)){this.path2=this.path.replace(/^ws:/,"wss:")}else{this.path2=this.path}this.connect(false);this.onMsg("cack",this.onConnectAck.bind(this));this.onMsg("app_ver",this.onAppVer.bind(this));this.onMsg("error",this.onError.bind(this))}WSClient.prototype.timeSinceDisconnect=function(){return Date.now()-this.disconnect_time};WSClient.prototype.onAppVer=function(ver){if(ver!=='1609697707517'){if(this.on_app_ver_mismatch){this.on_app_ver_mismatch()}else{if(this.auto_path){console.error("App version mismatch (server: "+ver+", client: "+'1609697707517'+"), reloading");if(window.reloadSafe){window.reloadSafe()}else{document.location.reload()}}else{console.warn("App version mismatch (server: "+ver+", client: "+'1609697707517'+"), ignoring")}}}};WSClient.prototype.onConnectAck=function(data,resp_func){var client=this;walltime.sync(data.time);client.connected=true;client.disconnected=false;client.id=data.id;client.my_ids[data.id]=true;errorReportSetDetails("client_id",client.id);client.secret=data.secret;if(data.app_ver){client.onAppVer(data.app_ver)}assert(client.handlers.connect);client.handlers.connect(client,{client_id:client.id,restarting:data.restarting});resp_func()};WSClient.prototype.pak=function(msg){return wscommon.wsPak(msg,null,this)};WSClient.prototype.send=function(msg,data,resp_func){wscommon.sendMessage.call(this,msg,data,resp_func)};WSClient.prototype.onError=function(e){console.error("WSClient Error");console.error(e);throw e};WSClient.prototype.onMsg=function(msg,cb){assert.ok(!this.handlers[msg]);this.handlers[msg]=function wrappedCallback(client,data,resp_func){return cb(data,resp_func)}};WSClient.prototype.checkForNewAppVersion=function(){var _this=this;if(this.app_ver_check_in_progress){return}this.app_ver_check_in_progress=true;var xhr=new XMLHttpRequest;xhr.open("GET",urlhash.getURLBase()+"app.ver.json",true);xhr.onload=function(){_this.app_ver_check_in_progress=false;var text;try{text=xhr.responseText;var obj=JSON.parse(text);if(obj&&obj.ver){_this.onAppVer(obj.ver)}}catch(e){console.error("Received invalid response when checking app version:",text||"<empty response>");if(!_this.delayed_recheck){_this.delayed_recheck=true;setTimeout(function(){_this.delayed_recheck=false;_this.checkForNewAppVersion()},1e3)}}};xhr.onerror=function(){_this.app_ver_check_in_progress=false};xhr.send(null)};WSClient.prototype.retryConnection=function(){var client=this;assert(!client.socket);assert(!client.retry_scheduled);client.retry_scheduled=true;++client.retry_count;this.checkForNewAppVersion();setTimeout(function(){assert(client.retry_scheduled);assert(!client.socket);client.retry_scheduled=false;client.connect(true)},min(client.retry_count*client.retry_count*100,15e3))};WSClient.prototype.checkDisconnect=function(){if(this.connected&&this.socket.readyState!==1){this.on_close();assert(!this.connected)}};WSClient.prototype.connect=function(for_reconnect){var client=this;var path=(client.retry_count%2?client.path2:client.path)+"?pver="+wscommon.PROTOCOL_VERSION+(for_reconnect&&client.id&&client.secret?"&reconnect="+client.id+"&secret="+client.secret:"");var socket=new WebSocket(path);socket.binaryType="arraybuffer";client.socket=socket;function guard(fn){return function(){if(client.socket!==socket){return}fn.apply(void 0,arguments)}}function abort(skip_close){client.socket=null;if(client.connected){client.disconnect_time=Date.now();client.disconnected=true;errorReportSetDetails("disconnected",1)}client.connected=false;if(!skip_close){try{socket.close()}catch(e){}}ack.failAll(client)}function retry(skip_close){abort(skip_close);client.retryConnection()}var connected=false;client.socket.addEventListener("error",guard(function(err){if(!connected){console.log("WebSocket error during initial connection, retrying...",err);retry()}else{console.error("WebSocket error",err)}}));client.socket.addEventListener("message",guard(function(message){assert(message.data instanceof ArrayBuffer);wsHandleMessage(client,new Uint8Array(message.data))}));client.socket.addEventListener("open",guard(function(){console.log("WebSocket open");connected=true;client.retry_count=0}));client.on_close=guard(function(){console.log("WebSocket close, retrying connection...");retry(true)});client.socket.addEventListener("close",client.on_close);var doPing=guard(function(){if(Date.now()-client.last_send_time>wscommon.PING_TIME&&client.connected&&client.socket.readyState===1){client.send("ping")}setTimeout(doPing,wscommon.PING_TIME)});setTimeout(doPing,wscommon.PING_TIME)};


},{"../../common/ack.js":62,"../../common/wscommon.js":72,"./error_report.js":12,"./urlhash.js":48,"./walltime.js":50,"assert":undefined}],54:[function(require,module,exports){
module.exports={"font_size":8,"imageW":128,"imageH":128,"spread":2,"noFilter":1,"channels":1,"char_infos":[{"c":32,"x0":61,"y0":63,"xpad":4,"w":0,"h":0},{"c":33,"x0":92,"y0":2,"yoffs":1,"xpad":1,"w":1,"h":5},{"c":34,"x0":16,"y0":63,"yoffs":1,"xpad":1,"w":3,"h":2},{"c":35,"x0":98,"y0":2,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":36,"x0":38,"y0":2,"yoffs":1,"xpad":1,"w":4,"h":6},{"c":37,"x0":108,"y0":2,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":38,"x0":118,"y0":2,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":39,"x0":24,"y0":63,"yoffs":1,"xpad":1,"w":1,"h":2},{"c":40,"x0":2,"y0":14,"yoffs":1,"xpad":1,"w":2,"h":5},{"c":41,"x0":9,"y0":14,"yoffs":1,"xpad":1,"w":2,"h":5},{"c":42,"x0":109,"y0":54,"yoffs":1,"xpad":1,"w":3,"h":3},{"c":43,"x0":117,"y0":54,"yoffs":2,"xpad":1,"w":3,"h":3},{"c":44,"x0":30,"y0":63,"yoffs":5,"xpad":1,"w":2,"h":2},{"c":45,"x0":67,"y0":63,"yoffs":3,"xpad":1,"w":3,"h":1},{"c":46,"x0":75,"y0":63,"yoffs":5,"xpad":1,"w":1,"h":1},{"c":47,"x0":16,"y0":14,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":48,"x0":26,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":49,"x0":35,"y0":14,"yoffs":1,"xpad":2,"w":3,"h":5},{"c":50,"x0":42,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":51,"x0":51,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":52,"x0":60,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":53,"x0":69,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":54,"x0":78,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":55,"x0":87,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":56,"x0":96,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":57,"x0":105,"y0":14,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":58,"x0":2,"y0":63,"yoffs":2,"xpad":1,"w":1,"h":3},{"c":59,"x0":115,"y0":44,"yoffs":2,"xpad":1,"w":1,"h":4},{"c":60,"x0":114,"y0":14,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":61,"x0":8,"y0":63,"yoffs":2,"xpad":1,"w":3,"h":3},{"c":62,"x0":122,"y0":14,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":63,"x0":2,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":64,"x0":11,"y0":24,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":65,"x0":21,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":66,"x0":30,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":67,"x0":39,"y0":24,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":68,"x0":47,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":69,"x0":56,"y0":24,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":70,"x0":64,"y0":24,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":71,"x0":72,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":72,"x0":81,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":73,"x0":90,"y0":24,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":74,"x0":98,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":75,"x0":107,"y0":24,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":76,"x0":116,"y0":24,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":77,"x0":2,"y0":34,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":78,"x0":12,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":79,"x0":21,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":80,"x0":30,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":81,"x0":47,"y0":2,"yoffs":1,"xpad":1,"w":4,"h":6},{"c":82,"x0":39,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":83,"x0":48,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":84,"x0":57,"y0":34,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":85,"x0":65,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":86,"x0":74,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":87,"x0":83,"y0":34,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":88,"x0":93,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":89,"x0":102,"y0":34,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":90,"x0":111,"y0":34,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":91,"x0":119,"y0":34,"yoffs":1,"xpad":1,"w":2,"h":5},{"c":92,"x0":2,"y0":44,"yoffs":1,"xpad":1,"w":5,"h":5},{"c":93,"x0":12,"y0":44,"yoffs":1,"xpad":1,"w":2,"h":5},{"c":94,"x0":37,"y0":63,"yoffs":1,"xpad":1,"w":3,"h":2},{"c":95,"x0":81,"y0":63,"yoffs":5,"xpad":1,"w":4,"h":1},{"c":96,"x0":45,"y0":63,"yoffs":1,"xpad":1,"w":2,"h":2},{"c":97,"x0":121,"y0":44,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":98,"x0":19,"y0":44,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":99,"x0":2,"y0":54,"yoffs":2,"xpad":1,"w":3,"h":4},{"c":100,"x0":28,"y0":44,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":101,"x0":10,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":102,"x0":37,"y0":44,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":103,"x0":56,"y0":2,"yoffs":2,"xpad":1,"w":4,"h":6},{"c":104,"x0":45,"y0":44,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":105,"x0":54,"y0":44,"yoffs":1,"xpad":1,"w":1,"h":5},{"c":106,"x0":2,"y0":2,"yoffs":1,"xpad":1,"w":2,"h":7},{"c":107,"x0":60,"y0":44,"yoffs":1,"xpad":1,"w":4,"h":5},{"c":108,"x0":69,"y0":44,"yoffs":1,"xpad":1,"w":1,"h":5},{"c":109,"x0":19,"y0":54,"yoffs":2,"xpad":1,"w":5,"h":4},{"c":110,"x0":29,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":111,"x0":38,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":112,"x0":65,"y0":2,"yoffs":2,"xpad":1,"w":4,"h":6},{"c":113,"x0":74,"y0":2,"yoffs":2,"xpad":1,"w":4,"h":6},{"c":114,"x0":47,"y0":54,"yoffs":2,"xpad":1,"w":3,"h":4},{"c":115,"x0":55,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":116,"x0":75,"y0":44,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":117,"x0":64,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":118,"x0":73,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":119,"x0":82,"y0":54,"yoffs":2,"xpad":1,"w":5,"h":4},{"c":120,"x0":92,"y0":54,"yoffs":2,"xpad":1,"w":3,"h":4},{"c":121,"x0":83,"y0":2,"yoffs":2,"xpad":1,"w":4,"h":6},{"c":122,"x0":100,"y0":54,"yoffs":2,"xpad":1,"w":4,"h":4},{"c":123,"x0":83,"y0":44,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":124,"x0":91,"y0":44,"yoffs":1,"xpad":1,"w":1,"h":5},{"c":125,"x0":97,"y0":44,"yoffs":1,"xpad":1,"w":3,"h":5},{"c":126,"x0":52,"y0":63,"yoffs":1,"xpad":1,"w":4,"h":2},{"c":160,"x0":90,"y0":63,"xpad":3,"w":1,"h":1},{"c":65533,"x0":105,"y0":44,"yoffs":2,"xpad":1,"w":5,"h":5},{"c":128263,"x0":9,"y0":2,"yoffs":1,"xpad":1,"w":10,"h":7},{"c":128264,"x0":24,"y0":2,"yoffs":1,"xpad":1,"w":9,"h":7}]}
},{}],55:[function(require,module,exports){
module.exports={"font_size":16,"imageW":1024,"imageH":64,"spread":2,"noFilter":1,"channels":1,"char_infos":[{"c":32,"x0":172,"y0":21,"xpad":8,"w":0,"h":0},{"c":33,"x0":137,"y0":2,"yoffs":3,"xpad":2,"w":2,"h":10},{"c":34,"x0":81,"y0":21,"yoffs":3,"xpad":2,"w":6,"h":4},{"c":35,"x0":144,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":36,"x0":59,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":12},{"c":37,"x0":159,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":38,"x0":174,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":39,"x0":92,"y0":21,"yoffs":3,"xpad":2,"w":2,"h":4},{"c":40,"x0":189,"y0":2,"yoffs":3,"xpad":2,"w":4,"h":10},{"c":41,"x0":198,"y0":2,"yoffs":3,"xpad":2,"w":4,"h":10},{"c":42,"x0":41,"y0":21,"yoffs":3,"xpad":2,"w":6,"h":6},{"c":43,"x0":52,"y0":21,"yoffs":5,"xpad":2,"w":6,"h":6},{"c":44,"x0":99,"y0":21,"yoffs":11,"xpad":2,"w":4,"h":4},{"c":45,"x0":141,"y0":21,"yoffs":7,"xpad":2,"w":6,"h":2},{"c":46,"x0":152,"y0":21,"yoffs":11,"xpad":2,"w":2,"h":2},{"c":47,"x0":207,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":48,"x0":222,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":49,"x0":235,"y0":2,"yoffs":3,"xpad":6,"w":4,"h":10},{"c":50,"x0":244,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":51,"x0":257,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":52,"x0":270,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":53,"x0":283,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":54,"x0":296,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":55,"x0":309,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":56,"x0":322,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":57,"x0":335,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":58,"x0":63,"y0":21,"yoffs":5,"xpad":2,"w":2,"h":6},{"c":59,"x0":877,"y0":2,"yoffs":5,"xpad":2,"w":2,"h":8},{"c":60,"x0":348,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":61,"x0":70,"y0":21,"yoffs":5,"xpad":2,"w":6,"h":6},{"c":62,"x0":359,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":63,"x0":370,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":64,"x0":383,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":65,"x0":398,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":66,"x0":411,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":67,"x0":424,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":68,"x0":435,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":69,"x0":448,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":70,"x0":459,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":71,"x0":470,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":72,"x0":483,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":73,"x0":496,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":74,"x0":507,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":75,"x0":520,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":76,"x0":533,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":77,"x0":544,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":78,"x0":559,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":79,"x0":572,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":80,"x0":585,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":81,"x0":72,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":12},{"c":82,"x0":598,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":83,"x0":611,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":84,"x0":624,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":85,"x0":635,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":86,"x0":648,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":87,"x0":661,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":88,"x0":676,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":89,"x0":689,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":90,"x0":702,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":91,"x0":713,"y0":2,"yoffs":3,"xpad":2,"w":4,"h":10},{"c":92,"x0":722,"y0":2,"yoffs":3,"xpad":2,"w":10,"h":10},{"c":93,"x0":737,"y0":2,"yoffs":3,"xpad":2,"w":4,"h":10},{"c":94,"x0":108,"y0":21,"yoffs":3,"xpad":2,"w":6,"h":4},{"c":95,"x0":159,"y0":21,"yoffs":11,"xpad":2,"w":8,"h":2},{"c":96,"x0":119,"y0":21,"yoffs":3,"xpad":2,"w":4,"h":4},{"c":97,"x0":884,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":98,"x0":746,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":99,"x0":897,"y0":2,"yoffs":5,"xpad":2,"w":6,"h":8},{"c":100,"x0":759,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":101,"x0":908,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":102,"x0":772,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":103,"x0":85,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":12},{"c":104,"x0":783,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":105,"x0":796,"y0":2,"yoffs":3,"xpad":2,"w":2,"h":10},{"c":106,"x0":2,"y0":2,"yoffs":3,"xpad":2,"w":4,"h":14},{"c":107,"x0":803,"y0":2,"yoffs":3,"xpad":2,"w":8,"h":10},{"c":108,"x0":816,"y0":2,"yoffs":3,"xpad":2,"w":2,"h":10},{"c":109,"x0":921,"y0":2,"yoffs":5,"xpad":2,"w":10,"h":8},{"c":110,"x0":936,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":111,"x0":949,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":112,"x0":98,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":12},{"c":113,"x0":111,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":12},{"c":114,"x0":962,"y0":2,"yoffs":5,"xpad":2,"w":6,"h":8},{"c":115,"x0":973,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":116,"x0":823,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":117,"x0":986,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":118,"x0":999,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":119,"x0":2,"y0":21,"yoffs":5,"xpad":2,"w":10,"h":8},{"c":120,"x0":17,"y0":21,"yoffs":5,"xpad":2,"w":6,"h":8},{"c":121,"x0":124,"y0":2,"yoffs":5,"xpad":2,"w":8,"h":12},{"c":122,"x0":28,"y0":21,"yoffs":5,"xpad":2,"w":8,"h":8},{"c":123,"x0":834,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":124,"x0":845,"y0":2,"yoffs":3,"xpad":2,"w":2,"h":10},{"c":125,"x0":852,"y0":2,"yoffs":3,"xpad":2,"w":6,"h":10},{"c":126,"x0":128,"y0":21,"yoffs":3,"xpad":2,"w":8,"h":4},{"c":160,"x0":178,"y0":21,"xpad":7,"w":1,"h":1},{"c":65533,"x0":863,"y0":2,"yoffs":3,"xpad":1,"w":9,"h":10},{"c":128263,"x0":11,"y0":2,"yoffs":1,"xpad":1,"w":19,"h":14},{"c":128264,"x0":35,"y0":2,"yoffs":1,"xpad":1,"w":19,"h":14}]}
},{}],56:[function(require,module,exports){
module.exports={"font_size":32,"imageW":1024,"imageH":512,"spread":8,"channels":1,"char_infos":[{"c":13,"x0":307,"y0":381,"w":1,"h":1},{"c":32,"x0":325,"y0":381,"xpad":6.10156,"w":1,"h":1},{"c":33,"x0":436,"y0":230,"yoffs":4,"xpad":1.13281,"w":6,"h":22},{"c":34,"x0":879,"y0":347,"yoffs":4,"w":10,"h":8},{"c":35,"x0":673,"y0":309,"yoffs":10,"w":16,"h":17},{"c":36,"x0":215,"y0":8,"yoffs":1,"xpad":1.32031,"w":15,"h":29},{"c":37,"x0":933,"y0":148,"yoffs":4,"xpad":0.773438,"w":26,"h":23},{"c":38,"x0":976,"y0":148,"yoffs":4,"xpad":0.570313,"w":20,"h":23},{"c":39,"x0":906,"y0":347,"yoffs":4,"w":5,"h":8},{"c":40,"x0":8,"y0":190,"yoffs":5,"w":8,"h":23},{"c":41,"x0":33,"y0":190,"yoffs":5,"xpad":0.890625,"w":7,"h":23},{"c":42,"x0":645,"y0":347,"yoffs":2,"w":11,"h":11},{"c":43,"x0":706,"y0":309,"yoffs":9,"xpad":0.414063,"w":15,"h":17},{"c":44,"x0":928,"y0":347,"yoffs":22,"w":5,"h":8},{"c":45,"x0":252,"y0":381,"yoffs":16,"w":9,"h":3},{"c":46,"x0":156,"y0":381,"yoffs":22,"w":5,"h":4},{"c":47,"x0":57,"y0":190,"yoffs":4,"w":13,"h":23},{"c":48,"x0":459,"y0":230,"yoffs":5,"xpad":0.671875,"w":17,"h":22},{"c":49,"x0":402,"y0":270,"yoffs":5,"xpad":5.67188,"w":12,"h":21},{"c":50,"x0":431,"y0":270,"yoffs":5,"xpad":1.67188,"w":16,"h":21},{"c":51,"x0":493,"y0":230,"yoffs":5,"xpad":1.67188,"w":16,"h":22},{"c":52,"x0":464,"y0":270,"yoffs":5,"xpad":0.671875,"w":17,"h":21},{"c":53,"x0":526,"y0":230,"yoffs":5,"xpad":1.67188,"w":16,"h":22},{"c":54,"x0":559,"y0":230,"yoffs":5,"xpad":0.671875,"w":17,"h":22},{"c":55,"x0":498,"y0":270,"yoffs":5,"xpad":1.67188,"w":16,"h":21},{"c":56,"x0":593,"y0":230,"yoffs":5,"xpad":0.671875,"w":17,"h":22},{"c":57,"x0":627,"y0":230,"yoffs":5,"xpad":0.671875,"w":17,"h":22},{"c":58,"x0":401,"y0":347,"yoffs":12,"w":5,"h":14},{"c":59,"x0":651,"y0":309,"yoffs":12,"w":5,"h":18},{"c":60,"x0":867,"y0":103,"yoffs":4,"w":12,"h":25},{"c":61,"x0":847,"y0":347,"yoffs":14,"w":15,"h":9},{"c":62,"x0":896,"y0":103,"yoffs":4,"w":12,"h":25},{"c":63,"x0":661,"y0":230,"yoffs":4,"xpad":0.195313,"w":12,"h":22},{"c":64,"x0":87,"y0":190,"yoffs":7,"xpad":1.21094,"w":23,"h":23},{"c":65,"x0":531,"y0":270,"yoffs":5,"w":19,"h":21},{"c":66,"x0":567,"y0":270,"yoffs":5,"xpad":0.882813,"w":18,"h":21},{"c":67,"x0":690,"y0":230,"yoffs":5,"xpad":0.945313,"w":17,"h":22},{"c":68,"x0":602,"y0":270,"yoffs":5,"xpad":1.01563,"w":20,"h":21},{"c":69,"x0":639,"y0":270,"yoffs":5,"xpad":0.617188,"w":16,"h":21},{"c":70,"x0":672,"y0":270,"yoffs":5,"w":15,"h":21},{"c":71,"x0":724,"y0":230,"yoffs":5,"xpad":1.75,"w":18,"h":22},{"c":72,"x0":704,"y0":270,"yoffs":5,"xpad":2.53906,"w":18,"h":21},{"c":73,"x0":739,"y0":270,"yoffs":5,"xpad":2.54688,"w":6,"h":21},{"c":74,"x0":759,"y0":230,"yoffs":5,"xpad":2.75781,"w":6,"h":22},{"c":75,"x0":762,"y0":270,"yoffs":5,"w":19,"h":21},{"c":76,"x0":798,"y0":270,"yoffs":5,"w":16,"h":21},{"c":77,"x0":831,"y0":270,"yoffs":5,"xpad":2.27344,"w":21,"h":21},{"c":78,"x0":869,"y0":270,"yoffs":5,"xpad":2.74219,"w":19,"h":21},{"c":79,"x0":127,"y0":190,"yoffs":4,"xpad":1.22656,"w":21,"h":23},{"c":80,"x0":905,"y0":270,"yoffs":5,"xpad":0.828125,"w":17,"h":21},{"c":81,"x0":165,"y0":190,"yoffs":4,"xpad":1.22656,"w":21,"h":23},{"c":82,"x0":939,"y0":270,"yoffs":5,"w":19,"h":21},{"c":83,"x0":203,"y0":190,"yoffs":4,"xpad":1.32031,"w":15,"h":23},{"c":84,"x0":975,"y0":270,"yoffs":5,"w":17,"h":21},{"c":85,"x0":782,"y0":230,"yoffs":5,"xpad":2.04688,"w":19,"h":22},{"c":86,"x0":8,"y0":309,"yoffs":5,"w":19,"h":21},{"c":87,"x0":44,"y0":309,"yoffs":5,"w":30,"h":21},{"c":88,"x0":818,"y0":230,"yoffs":5,"w":20,"h":22},{"c":89,"x0":91,"y0":309,"yoffs":5,"w":18,"h":21},{"c":90,"x0":126,"y0":309,"yoffs":5,"xpad":0.226563,"w":17,"h":21},{"c":91,"x0":925,"y0":103,"yoffs":4,"w":9,"h":25},{"c":92,"x0":235,"y0":190,"yoffs":4,"w":13,"h":23},{"c":93,"x0":951,"y0":103,"yoffs":4,"xpad":1.70313,"w":7,"h":25},{"c":94,"x0":950,"y0":347,"yoffs":14,"xpad":0.1875,"w":13,"h":8},{"c":95,"x0":278,"y0":381,"yoffs":23,"xpad":0.4375,"w":12,"h":3},{"c":96,"x0":57,"y0":381,"yoffs":3,"w":6,"h":6},{"c":97,"x0":738,"y0":309,"yoffs":10,"xpad":1.29688,"w":14,"h":17},{"c":98,"x0":265,"y0":190,"yoffs":4,"xpad":0.890625,"w":16,"h":23},{"c":99,"x0":769,"y0":309,"yoffs":10,"xpad":0.273438,"w":14,"h":17},{"c":100,"x0":298,"y0":190,"yoffs":4,"xpad":2.07031,"w":15,"h":23},{"c":101,"x0":800,"y0":309,"yoffs":10,"xpad":1.04688,"w":15,"h":17},{"c":102,"x0":855,"y0":230,"yoffs":4,"w":10,"h":22},{"c":103,"x0":330,"y0":190,"yoffs":10,"xpad":2.07031,"w":15,"h":23},{"c":104,"x0":882,"y0":230,"yoffs":4,"xpad":1.10156,"w":16,"h":22},{"c":105,"x0":160,"y0":309,"yoffs":5,"xpad":1.34375,"w":6,"h":21},{"c":106,"x0":78,"y0":57,"yoffs":5,"xpad":1.07031,"w":7,"h":28},{"c":107,"x0":915,"y0":230,"yoffs":4,"xpad":0.171875,"w":15,"h":22},{"c":108,"x0":947,"y0":230,"yoffs":4,"xpad":1.46875,"w":6,"h":22},{"c":109,"x0":50,"y0":347,"yoffs":10,"xpad":1.14063,"w":25,"h":16},{"c":110,"x0":92,"y0":347,"yoffs":10,"xpad":2.03906,"w":15,"h":16},{"c":111,"x0":832,"y0":309,"yoffs":10,"xpad":0.828125,"w":16,"h":17},{"c":112,"x0":362,"y0":190,"yoffs":10,"xpad":0.890625,"w":16,"h":23},{"c":113,"x0":395,"y0":190,"yoffs":10,"xpad":2.07031,"w":15,"h":23},{"c":114,"x0":184,"y0":347,"yoffs":11,"xpad":0.203125,"w":10,"h":15},{"c":115,"x0":865,"y0":309,"yoffs":10,"xpad":0.28125,"w":13,"h":17},{"c":116,"x0":587,"y0":309,"yoffs":7,"xpad":0.234375,"w":10,"h":20},{"c":117,"x0":124,"y0":347,"yoffs":11,"xpad":1.64844,"w":15,"h":16},{"c":118,"x0":211,"y0":347,"yoffs":11,"w":15,"h":15},{"c":119,"x0":243,"y0":347,"yoffs":11,"w":23,"h":15},{"c":120,"x0":283,"y0":347,"yoffs":11,"w":16,"h":15},{"c":121,"x0":970,"y0":230,"yoffs":11,"w":15,"h":22},{"c":122,"x0":316,"y0":347,"yoffs":11,"xpad":0.851563,"w":13,"h":15},{"c":123,"x0":1002,"y0":230,"yoffs":6,"w":9,"h":22},{"c":124,"x0":8,"y0":8,"w":7,"h":32},{"c":125,"x0":8,"y0":270,"yoffs":6,"xpad":0.460938,"w":8,"h":22},{"c":126,"x0":127,"y0":381,"yoffs":16,"xpad":0.3125,"w":12,"h":5},{"c":144,"x0":980,"y0":347,"yoffs":-5,"w":14,"h":8},{"c":160,"x0":343,"y0":381,"xpad":6.10156,"w":1,"h":1},{"c":161,"x0":33,"y0":270,"yoffs":4,"xpad":1.13281,"w":6,"h":22},{"c":162,"x0":427,"y0":190,"yoffs":7,"xpad":0.273438,"w":14,"h":23},{"c":163,"x0":183,"y0":309,"yoffs":5,"xpad":0.304688,"w":14,"h":21},{"c":164,"x0":614,"y0":309,"yoffs":9,"xpad":0.328125,"w":20,"h":20},{"c":165,"x0":214,"y0":309,"yoffs":5,"w":18,"h":21},{"c":166,"x0":458,"y0":190,"yoffs":4,"xpad":2.10156,"w":6,"h":23},{"c":167,"x0":102,"y0":57,"yoffs":2,"xpad":1.25,"w":17,"h":28},{"c":168,"x0":178,"y0":381,"yoffs":4,"xpad":0.453125,"w":9,"h":4},{"c":169,"x0":481,"y0":190,"yoffs":4,"xpad":0.625,"w":25,"h":23},{"c":170,"x0":551,"y0":347,"yoffs":4,"xpad":0.296875,"w":10,"h":12},{"c":171,"x0":673,"y0":347,"yoffs":13,"xpad":0.140625,"w":11,"h":11},{"c":172,"x0":729,"y0":347,"yoffs":13,"xpad":0.382813,"w":15,"h":10},{"c":173,"x0":361,"y0":381,"xpad":2.94531,"w":1,"h":1},{"c":174,"x0":249,"y0":309,"yoffs":1,"xpad":0.3125,"w":22,"h":21},{"c":175,"x0":204,"y0":381,"yoffs":4,"w":9,"h":4},{"c":176,"x0":32,"y0":381,"yoffs":4,"w":8,"h":7},{"c":177,"x0":895,"y0":309,"yoffs":9,"w":14,"h":17},{"c":178,"x0":423,"y0":347,"yoffs":2,"xpad":0.890625,"w":11,"h":14},{"c":179,"x0":156,"y0":347,"yoffs":2,"xpad":1.52344,"w":11,"h":16},{"c":180,"x0":80,"y0":381,"yoffs":3,"w":6,"h":6},{"c":181,"x0":56,"y0":270,"yoffs":11,"xpad":1.85938,"w":15,"h":22},{"c":182,"x0":288,"y0":309,"yoffs":5,"xpad":0.5,"w":26,"h":21},{"c":183,"x0":230,"y0":381,"yoffs":16,"w":5,"h":4},{"c":184,"x0":8,"y0":381,"yoffs":25,"xpad":0.0703125,"w":7,"h":8},{"c":185,"x0":451,"y0":347,"yoffs":2,"xpad":0.6875,"w":10,"h":14},{"c":186,"x0":578,"y0":347,"yoffs":4,"xpad":0.625,"w":11,"h":12},{"c":187,"x0":701,"y0":347,"yoffs":13,"xpad":0.140625,"w":11,"h":11},{"c":188,"x0":247,"y0":8,"yoffs":2,"xpad":0.0546875,"w":25,"h":29},{"c":189,"x0":136,"y0":57,"yoffs":2,"xpad":1.22656,"w":25,"h":28},{"c":190,"x0":289,"y0":8,"yoffs":2,"xpad":0.109375,"w":26,"h":29},{"c":191,"x0":88,"y0":270,"yoffs":6,"xpad":0.09375,"w":13,"h":22},{"c":192,"x0":178,"y0":57,"yoffs":-2,"w":19,"h":28},{"c":193,"x0":214,"y0":57,"yoffs":-2,"w":19,"h":28},{"c":194,"x0":250,"y0":57,"yoffs":-2,"w":19,"h":28},{"c":195,"x0":648,"y0":103,"w":19,"h":26},{"c":196,"x0":252,"y0":103,"yoffs":-1,"w":19,"h":27},{"c":197,"x0":286,"y0":57,"yoffs":-2,"w":19,"h":28},{"c":198,"x0":331,"y0":309,"yoffs":5,"xpad":0.28125,"w":27,"h":21},{"c":199,"x0":322,"y0":57,"yoffs":5,"xpad":0.945313,"w":17,"h":28},{"c":200,"x0":356,"y0":57,"yoffs":-2,"xpad":0.617188,"w":16,"h":28},{"c":201,"x0":389,"y0":57,"yoffs":-2,"xpad":0.617188,"w":16,"h":28},{"c":202,"x0":422,"y0":57,"yoffs":-2,"xpad":0.617188,"w":16,"h":28},{"c":203,"x0":288,"y0":103,"yoffs":-1,"xpad":0.617188,"w":16,"h":27},{"c":204,"x0":455,"y0":57,"yoffs":-2,"xpad":1.54688,"w":7,"h":28},{"c":205,"x0":479,"y0":57,"yoffs":-2,"xpad":0.546875,"w":8,"h":28},{"c":206,"x0":504,"y0":57,"yoffs":-2,"w":11,"h":28},{"c":207,"x0":321,"y0":103,"yoffs":-1,"w":9,"h":27},{"c":208,"x0":375,"y0":309,"yoffs":5,"xpad":1.22656,"w":20,"h":21},{"c":209,"x0":684,"y0":103,"xpad":2.74219,"w":19,"h":26},{"c":210,"x0":332,"y0":8,"yoffs":-2,"xpad":1.22656,"w":21,"h":29},{"c":211,"x0":370,"y0":8,"yoffs":-2,"xpad":1.22656,"w":21,"h":29},{"c":212,"x0":408,"y0":8,"yoffs":-2,"xpad":1.22656,"w":21,"h":29},{"c":213,"x0":347,"y0":103,"xpad":1.22656,"w":21,"h":27},{"c":214,"x0":532,"y0":57,"yoffs":-1,"xpad":1.22656,"w":21,"h":28},{"c":215,"x0":346,"y0":347,"yoffs":11,"xpad":0.359375,"w":15,"h":15},{"c":216,"x0":523,"y0":190,"yoffs":4,"xpad":1.22656,"w":21,"h":23},{"c":217,"x0":446,"y0":8,"yoffs":-2,"xpad":2.04688,"w":19,"h":29},{"c":218,"x0":482,"y0":8,"yoffs":-2,"xpad":2.04688,"w":19,"h":29},{"c":219,"x0":518,"y0":8,"yoffs":-2,"xpad":2.04688,"w":19,"h":29},{"c":220,"x0":570,"y0":57,"yoffs":-1,"xpad":2.04688,"w":19,"h":28},{"c":221,"x0":606,"y0":57,"yoffs":-2,"w":18,"h":28},{"c":222,"x0":412,"y0":309,"yoffs":5,"xpad":1.00781,"w":17,"h":21},{"c":223,"x0":446,"y0":309,"yoffs":5,"xpad":1.30469,"w":17,"h":21},{"c":224,"x0":69,"y0":148,"yoffs":3,"xpad":1.29688,"w":14,"h":24},{"c":225,"x0":100,"y0":148,"yoffs":3,"xpad":1.29688,"w":14,"h":24},{"c":226,"x0":131,"y0":148,"yoffs":3,"xpad":1.29688,"w":14,"h":24},{"c":227,"x0":561,"y0":190,"yoffs":4,"xpad":1.29688,"w":14,"h":23},{"c":228,"x0":592,"y0":190,"yoffs":4,"xpad":1.29688,"w":14,"h":23},{"c":229,"x0":975,"y0":103,"yoffs":2,"xpad":1.29688,"w":14,"h":25},{"c":230,"x0":926,"y0":309,"yoffs":10,"xpad":0.960938,"w":24,"h":17},{"c":231,"x0":623,"y0":190,"yoffs":10,"xpad":0.273438,"w":14,"h":23},{"c":232,"x0":162,"y0":148,"yoffs":3,"xpad":1.04688,"w":15,"h":24},{"c":233,"x0":194,"y0":148,"yoffs":3,"xpad":1.04688,"w":15,"h":24},{"c":234,"x0":226,"y0":148,"yoffs":3,"xpad":1.04688,"w":15,"h":24},{"c":235,"x0":654,"y0":190,"yoffs":4,"xpad":1.04688,"w":15,"h":23},{"c":236,"x0":686,"y0":190,"yoffs":3,"xpad":1.34375,"w":6,"h":23},{"c":237,"x0":709,"y0":190,"yoffs":3,"w":8,"h":23},{"c":238,"x0":734,"y0":190,"yoffs":3,"w":11,"h":23},{"c":239,"x0":118,"y0":270,"yoffs":4,"w":9,"h":22},{"c":240,"x0":762,"y0":190,"yoffs":4,"xpad":1.53125,"w":15,"h":23},{"c":241,"x0":144,"y0":270,"yoffs":4,"xpad":2.03906,"w":15,"h":22},{"c":242,"x0":258,"y0":148,"yoffs":3,"xpad":0.828125,"w":16,"h":24},{"c":243,"x0":291,"y0":148,"yoffs":3,"xpad":0.828125,"w":16,"h":24},{"c":244,"x0":324,"y0":148,"yoffs":3,"xpad":0.828125,"w":16,"h":24},{"c":245,"x0":794,"y0":190,"yoffs":4,"xpad":0.828125,"w":16,"h":23},{"c":246,"x0":827,"y0":190,"yoffs":4,"xpad":0.828125,"w":16,"h":23},{"c":247,"x0":478,"y0":347,"yoffs":11,"xpad":0.453125,"w":14,"h":14},{"c":248,"x0":967,"y0":309,"yoffs":10,"xpad":0.828125,"w":16,"h":17},{"c":249,"x0":357,"y0":148,"yoffs":3,"xpad":1.64844,"w":15,"h":24},{"c":250,"x0":389,"y0":148,"yoffs":3,"xpad":1.64844,"w":15,"h":24},{"c":251,"x0":421,"y0":148,"yoffs":3,"xpad":1.64844,"w":15,"h":24},{"c":252,"x0":860,"y0":190,"yoffs":4,"xpad":1.64844,"w":15,"h":23},{"c":253,"x0":64,"y0":8,"yoffs":3,"w":15,"h":30},{"c":254,"x0":554,"y0":8,"yoffs":4,"xpad":0.890625,"w":16,"h":29},{"c":255,"x0":587,"y0":8,"yoffs":4,"w":15,"h":29},{"c":256,"x0":720,"y0":103,"w":19,"h":26},{"c":257,"x0":892,"y0":190,"yoffs":4,"xpad":1.29688,"w":14,"h":23},{"c":258,"x0":385,"y0":103,"yoffs":-1,"w":19,"h":27},{"c":259,"x0":453,"y0":148,"yoffs":3,"xpad":1.29688,"w":14,"h":24},{"c":260,"x0":641,"y0":57,"yoffs":5,"w":21,"h":28},{"c":261,"x0":923,"y0":190,"yoffs":10,"w":16,"h":23},{"c":262,"x0":619,"y0":8,"yoffs":-2,"xpad":0.945313,"w":17,"h":29},{"c":263,"x0":484,"y0":148,"yoffs":3,"xpad":0.273438,"w":14,"h":24},{"c":268,"x0":653,"y0":8,"yoffs":-2,"xpad":0.945313,"w":17,"h":29},{"c":269,"x0":515,"y0":148,"yoffs":3,"xpad":0.273438,"w":14,"h":24},{"c":270,"x0":679,"y0":57,"yoffs":-2,"xpad":1.01563,"w":20,"h":28},{"c":271,"x0":956,"y0":190,"yoffs":4,"w":22,"h":23},{"c":272,"x0":480,"y0":309,"yoffs":5,"xpad":1.22656,"w":20,"h":21},{"c":273,"x0":995,"y0":190,"yoffs":4,"xpad":0.0703125,"w":17,"h":23},{"c":274,"x0":756,"y0":103,"xpad":0.617188,"w":16,"h":26},{"c":275,"x0":8,"y0":230,"yoffs":4,"xpad":1.04688,"w":15,"h":23},{"c":278,"x0":421,"y0":103,"yoffs":-1,"xpad":0.617188,"w":16,"h":27},{"c":279,"x0":40,"y0":230,"yoffs":4,"xpad":1.04688,"w":15,"h":23},{"c":280,"x0":716,"y0":57,"yoffs":5,"xpad":0.617188,"w":16,"h":28},{"c":281,"x0":72,"y0":230,"yoffs":10,"xpad":1.04688,"w":15,"h":23},{"c":282,"x0":749,"y0":57,"yoffs":-2,"xpad":0.617188,"w":16,"h":28},{"c":283,"x0":546,"y0":148,"yoffs":3,"xpad":1.04688,"w":15,"h":24},{"c":286,"x0":782,"y0":57,"yoffs":-1,"xpad":1.75,"w":18,"h":28},{"c":287,"x0":96,"y0":8,"yoffs":3,"xpad":2.07031,"w":15,"h":30},{"c":290,"x0":817,"y0":57,"yoffs":5,"xpad":1.75,"w":18,"h":28},{"c":291,"x0":32,"y0":8,"yoffs":2,"xpad":2.07031,"w":15,"h":31},{"c":298,"x0":789,"y0":103,"w":9,"h":26},{"c":299,"x0":176,"y0":270,"yoffs":4,"w":9,"h":22},{"c":302,"x0":852,"y0":57,"yoffs":5,"xpad":0.546875,"w":8,"h":28},{"c":303,"x0":877,"y0":57,"yoffs":5,"w":8,"h":28},{"c":304,"x0":454,"y0":103,"yoffs":-1,"xpad":1.54688,"w":7,"h":27},{"c":305,"x0":378,"y0":347,"yoffs":11,"xpad":1.34375,"w":6,"h":15},{"c":310,"x0":687,"y0":8,"yoffs":5,"w":19,"h":29},{"c":311,"x0":128,"y0":8,"yoffs":4,"xpad":0.171875,"w":15,"h":30},{"c":313,"x0":902,"y0":57,"yoffs":-2,"w":16,"h":28},{"c":314,"x0":815,"y0":103,"w":8,"h":26},{"c":315,"x0":723,"y0":8,"yoffs":5,"w":16,"h":29},{"c":316,"x0":160,"y0":8,"yoffs":4,"xpad":1.46875,"w":6,"h":30},{"c":317,"x0":202,"y0":270,"yoffs":4,"w":16,"h":22},{"c":318,"x0":235,"y0":270,"yoffs":4,"w":12,"h":22},{"c":321,"x0":517,"y0":309,"yoffs":5,"xpad":0.046875,"w":16,"h":21},{"c":322,"x0":264,"y0":270,"yoffs":4,"w":11,"h":22},{"c":323,"x0":935,"y0":57,"yoffs":-2,"xpad":2.74219,"w":19,"h":28},{"c":324,"x0":104,"y0":230,"yoffs":3,"xpad":2.03906,"w":15,"h":23},{"c":325,"x0":756,"y0":8,"yoffs":5,"xpad":2.74219,"w":19,"h":29},{"c":326,"x0":578,"y0":148,"yoffs":10,"xpad":2.03906,"w":15,"h":24},{"c":327,"x0":971,"y0":57,"yoffs":-2,"xpad":2.74219,"w":19,"h":28},{"c":328,"x0":136,"y0":230,"yoffs":3,"xpad":2.03906,"w":15,"h":23},{"c":332,"x0":478,"y0":103,"xpad":1.22656,"w":21,"h":27},{"c":333,"x0":168,"y0":230,"yoffs":4,"xpad":0.828125,"w":16,"h":23},{"c":336,"x0":792,"y0":8,"yoffs":-2,"xpad":1.22656,"w":21,"h":29},{"c":337,"x0":610,"y0":148,"yoffs":3,"xpad":0.828125,"w":16,"h":24},{"c":338,"x0":292,"y0":270,"yoffs":5,"xpad":0.390625,"w":29,"h":22},{"c":339,"x0":8,"y0":347,"yoffs":10,"xpad":0.65625,"w":25,"h":17},{"c":340,"x0":8,"y0":103,"yoffs":-2,"w":19,"h":28},{"c":341,"x0":201,"y0":230,"yoffs":3,"xpad":0.203125,"w":10,"h":23},{"c":342,"x0":830,"y0":8,"yoffs":5,"w":19,"h":29},{"c":343,"x0":228,"y0":230,"yoffs":11,"xpad":0.203125,"w":10,"h":23},{"c":344,"x0":44,"y0":103,"yoffs":-2,"w":19,"h":28},{"c":345,"x0":255,"y0":230,"yoffs":3,"xpad":0.203125,"w":10,"h":23},{"c":346,"x0":866,"y0":8,"yoffs":-2,"xpad":1.32031,"w":15,"h":29},{"c":347,"x0":643,"y0":148,"yoffs":3,"xpad":0.28125,"w":13,"h":24},{"c":350,"x0":898,"y0":8,"yoffs":4,"xpad":1.32031,"w":15,"h":29},{"c":351,"x0":282,"y0":230,"yoffs":10,"xpad":0.28125,"w":13,"h":23},{"c":352,"x0":930,"y0":8,"yoffs":-2,"xpad":1.32031,"w":15,"h":29},{"c":353,"x0":673,"y0":148,"yoffs":3,"xpad":0.28125,"w":13,"h":24},{"c":354,"x0":80,"y0":103,"yoffs":5,"w":17,"h":28},{"c":355,"x0":840,"y0":103,"yoffs":7,"xpad":0.234375,"w":10,"h":26},{"c":356,"x0":114,"y0":103,"yoffs":-2,"w":17,"h":28},{"c":357,"x0":312,"y0":230,"yoffs":4,"w":15,"h":23},{"c":362,"x0":516,"y0":103,"xpad":2.04688,"w":19,"h":27},{"c":363,"x0":344,"y0":230,"yoffs":4,"xpad":1.64844,"w":15,"h":23},{"c":366,"x0":962,"y0":8,"yoffs":-2,"xpad":2.04688,"w":19,"h":29},{"c":367,"x0":8,"y0":148,"yoffs":2,"xpad":1.64844,"w":15,"h":25},{"c":368,"x0":8,"y0":57,"yoffs":-2,"xpad":2.04688,"w":19,"h":29},{"c":369,"x0":703,"y0":148,"yoffs":3,"xpad":1.64844,"w":15,"h":24},{"c":370,"x0":148,"y0":103,"yoffs":5,"xpad":2.04688,"w":19,"h":28},{"c":371,"x0":338,"y0":270,"yoffs":11,"w":17,"h":22},{"c":376,"x0":552,"y0":103,"yoffs":-1,"w":18,"h":27},{"c":377,"x0":184,"y0":103,"yoffs":-2,"xpad":0.226563,"w":17,"h":28},{"c":378,"x0":376,"y0":230,"yoffs":3,"xpad":0.851563,"w":13,"h":23},{"c":379,"x0":587,"y0":103,"yoffs":-1,"xpad":0.226563,"w":17,"h":27},{"c":380,"x0":372,"y0":270,"yoffs":4,"xpad":0.851563,"w":13,"h":22},{"c":381,"x0":218,"y0":103,"yoffs":-2,"xpad":0.226563,"w":17,"h":28},{"c":382,"x0":406,"y0":230,"yoffs":3,"xpad":0.851563,"w":13,"h":23},{"c":402,"x0":40,"y0":148,"yoffs":4,"w":12,"h":25},{"c":536,"x0":183,"y0":8,"yoffs":4,"xpad":1.32031,"w":15,"h":30},{"c":537,"x0":735,"y0":148,"yoffs":10,"xpad":0.28125,"w":13,"h":24},{"c":538,"x0":44,"y0":57,"yoffs":5,"w":17,"h":29},{"c":539,"x0":621,"y0":103,"yoffs":7,"xpad":0.234375,"w":10,"h":27},{"c":8226,"x0":103,"y0":381,"yoffs":13,"xpad":0.28125,"w":7,"h":6},{"c":8482,"x0":606,"y0":347,"yoffs":5,"xpad":0.882813,"w":22,"h":12},{"c":8592,"x0":761,"y0":347,"yoffs":11,"xpad":0.882813,"w":26,"h":10},{"c":8593,"x0":765,"y0":148,"yoffs":4,"xpad":7.88281,"w":19,"h":24},{"c":8594,"x0":804,"y0":347,"yoffs":11,"xpad":0.882813,"w":26,"h":10},{"c":8595,"x0":801,"y0":148,"yoffs":4,"xpad":7.88281,"w":19,"h":24},{"c":8734,"x0":509,"y0":347,"yoffs":11,"xpad":0.6875,"w":25,"h":14},{"c":9742,"x0":837,"y0":148,"yoffs":4,"w":31,"h":24},{"c":9743,"x0":885,"y0":148,"yoffs":4,"w":31,"h":24},{"c":65533,"x0":550,"y0":309,"yoffs":5,"w":20,"h":21}]}
},{}],57:[function(require,module,exports){
"use strict";exports.main=main;var local_storage=require("./glov/local_storage.js");local_storage.storage_prefix="galaxy-gen";var assert=require("assert");var camera2d=require("./glov/camera2d.js");var engine=require("./glov/engine.js");var _require=require("./glov/framebuffer.js"),copyCanvasToClipboard=_require.copyCanvasToClipboard,framebufferUpdateCanvasForCapture=_require.framebufferUpdateCanvasForCapture;var _require2=require("./galaxy.js"),createGalaxy=_require2.createGalaxy,distSq=_require2.distSq,LAYER_STEP=_require2.LAYER_STEP;var abs=Math.abs,ceil=Math.ceil,cos=Math.cos,floor=Math.floor,max=Math.max,min=Math.min,pow=Math.pow,round=Math.round,sin=Math.sin,sqrt=Math.sqrt,PI=Math.PI;var input=require("./glov/input.js");var KEYS=input.KEYS;var net=require("./glov/net.js");var perf=require("./glov/perf.js");var shaders=require("./glov/shaders.js");var _require3=require("./solar_system.js"),planetMapTexture=_require3.planetMapTexture,solarSystemCreate=_require3.solarSystemCreate;var sprites=require("./glov/sprites.js");var textures=require("./glov/textures.js");var ui=require("./glov/ui.js");var _require4=require("../common/util.js"),clamp=_require4.clamp,clone=_require4.clone,deepEqual=_require4.deepEqual,easeInOut=_require4.easeInOut,easeIn=_require4.easeIn,easeOut=_require4.easeOut,lerp=_require4.lerp;var _require5=require("./glov/vmath.js"),unit_vec=_require5.unit_vec,vec2=_require5.vec2,v2add=_require5.v2add,v2addScale=_require5.v2addScale,v2copy=_require5.v2copy,v2floor=_require5.v2floor,v2set=_require5.v2set,vec4=_require5.vec4;var createSprite=sprites.create;var BLEND_ADDITIVE=sprites.BLEND_ADDITIVE;window.Z=window.Z||{};Z.BACKGROUND=1;Z.SPRITES=10;Z.PARTICLES=20;Z.UI_TEST=200;var game_width=256+90;var game_height=256;function main(){if(engine.DEBUG){net.init({engine:engine})}var view=local_storage.getJSON("view",1);var show_panel=local_storage.getJSON("panel",0);var font_info_04b03x2=require("./img/font/04b03_8x2.json");var font_info_04b03x1=require("./img/font/04b03_8x1.json");var font_info_palanquin32=require("./img/font/palanquin32.json");var pixely=view===1?"strict":"on";var font;if(pixely==="strict"||true){font={info:font_info_04b03x1,texture:"font/04b03_8x1"}}else if(pixely&&pixely!=="off"){font={info:font_info_04b03x2,texture:"font/04b03_8x2"}}else{font={info:font_info_palanquin32,texture:"font/palanquin32"}}if(!engine.startup({game_width:game_width,game_height:game_height,pixely:pixely,font:font,viewport_postprocess:false,antialias:false,do_borders:false,show_fps:engine.defines.ATTRACT?false:undefined})){return}font=engine.font;ui.scaleSizes(13/32);ui.setFontHeight(8);var tex_palette=textures.load({url:"palette/pal2.png",filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE});var tex_palette_planets=textures.load({url:"palette/pal_planets.png",filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE});var shader_galaxy_pixel=shaders.create("shaders/galaxy_blend_pixel.fp");var shader_galaxy_blend=shaders.create("shaders/galaxy_blend.fp");var shader_planet_pixel=shaders.create("shaders/planet_pixel.fp");var white_tex=textures.textures.white;var MAX_ZOOM=16;var MAX_SOLAR_VIEW=1;var buf_dim=256;var params={buf_dim:buf_dim,dither:.5,arms:7,len_mods:4,twirl:4,center:.09,seed:1349,noise_freq:5,noise_weight:.22,poi_count:200,width_ly:128*1024,star_count:100*1e3*1e3*1e3,max_zoom:MAX_ZOOM,layer1:{noise_freq:20,noise_weight:.2},layer2:{noise_freq:80,noise_weight:.2},layer3:{noise_freq:250,noise_weight:.2},layer4:{noise_freq:750,noise_weight:.25},layer5:{noise_freq:2500,noise_weight:.3}};var solar_params={seed:80,star_id:55};var gen_params;var gen_solar_params;var debug_sprite;var galaxy;function allocSprite(){if(!debug_sprite){var tex=galaxy.getCellTextured(0,0).tex;debug_sprite=createSprite({texs:[tex,tex,tex]})}}function round4(v){return round(v*1e3)/1e3}function roundZoom(v){return view===1?round(v):v}function format(v){assert(v>=0);if(!v){return"0"}if(v>9e8){return(v/1e9).toFixed(1)+"B"}if(v>9e5){return(v/1e6).toFixed(1)+"M"}if(v>900){return(v/1e3).toFixed(1)+"K"}if(v>9){return""+round(v)}var precis=1;var check=.2;while(true){if(v>check){return v.toFixed(precis)}check*=.1;precis++}}var cells_drawn=0;perf.addMetric({name:"cells",show_stat:"false",labels:{"cells: ":function cells(){return cells_drawn.toString()}}});var zoom_level=local_storage.getJSON("zoom",0);var solar_view=local_storage.getJSON("solar_view",0);var solar_override=local_storage.getJSON("solar_override",false);var solar_override_system=null;var selected_star_id=local_storage.getJSON("selected_star",null);var target_zoom_level=zoom_level;var zoom_offs=vec2(local_storage.getJSON("offsx",0),local_storage.getJSON("offsy",0));var style=font.styleColored(null,255);var mouse_pos=vec2();var use_mouse_pos=false;var font_style_fade=font.styleColored(null,4294967104);var color_legend_fade=vec4(1,1,1,.25);var color_highlight=vec4(1,1,0,.75);var color_text_backdrop=vec4(0,0,0,.5);function doZoomActual(x,y,delta){var cur_zoom=pow(2,zoom_level);var new_zoom_level=max(0,min(zoom_level+delta,MAX_ZOOM));var new_zoom=pow(2,new_zoom_level);var point_x=zoom_offs[0]+x/cur_zoom;var point_y=zoom_offs[1]+y/cur_zoom;zoom_offs[0]=point_x-x/new_zoom;zoom_offs[1]=point_y-y/new_zoom;zoom_level=new_zoom_level;if(zoom_level===0){zoom_offs[0]=zoom_offs[1]=0}local_storage.setJSON("offsx",zoom_offs[0]);local_storage.setJSON("offsy",zoom_offs[1]);local_storage.setJSON("zoom",zoom_level)}var queued_zooms=[];var eff_solar_view=solar_view;var eff_solar_view_unsmooth=solar_view;function zoomTime(amount){return abs(amount)*500}function zoomTick(max_okay_zoom){var dt=engine.frame_dt;for(var ii=0;ii<queued_zooms.length;++ii){var zm=queued_zooms[ii];var new_progress=min(1,zm.progress+dt/zoomTime(zm.delta));var dp=void 0;if(engine.defines.ATTRACT){dp=new_progress-zm.progress}else{dp=easeOut(new_progress,2)-easeOut(zm.progress,2)}var new_zoom_level=min(zoom_level+zm.delta*dp,MAX_ZOOM);if(zm.delta>0&&new_zoom_level>max_okay_zoom&&false){continue}zm.progress=new_progress;doZoomActual(zm.x,zm.y,zm.delta*dp);if(new_progress===1){queued_zooms.splice(ii,1)}}if(!queued_zooms.length){zoom_level=target_zoom_level}var dsolar=dt*.003;if(eff_solar_view_unsmooth<solar_view){eff_solar_view_unsmooth=min(solar_view,eff_solar_view_unsmooth+dsolar)}else if(eff_solar_view_unsmooth>solar_view){eff_solar_view_unsmooth=max(solar_view,eff_solar_view_unsmooth-dsolar)}var iesvu=floor(eff_solar_view_unsmooth);eff_solar_view=round4(iesvu+easeInOut(eff_solar_view_unsmooth-iesvu,2))}function solarZoom(delta){solar_view=clamp(solar_view+delta,0,MAX_SOLAR_VIEW);local_storage.setJSON("solar_view",solar_view);local_storage.setJSON("selected_star",solar_view?selected_star_id:null)}function doZoom(x,y,delta){if(target_zoom_level===MAX_ZOOM&&delta>0){if(selected_star_id!==null){solarZoom(1)}return}if(solar_view&&delta<0){solarZoom(-1);return}target_zoom_level=max(0,min(target_zoom_level+delta,MAX_ZOOM));queued_zooms.push({x:x,y:y,delta:delta,progress:0})}var last_img;var img_id=0;function saveSnapshot(){var src=engine.canvas;var viewport=engine.viewport;var canvas_full=document.createElement("canvas");canvas_full.width=game_width*4;canvas_full.height=game_height*4;var ctx=canvas_full.getContext("2d");ctx.imageSmoothingEnabled=false;ctx.drawImage(src,viewport[0],src.height-viewport[3]+viewport[1],viewport[2],viewport[3],0,0,canvas_full.width,canvas_full.height);var data_full=canvas_full.toDataURL("image/png");if(data_full===last_img){return}last_img=data_full;if(net.client){var pak=net.client.pak("img");pak.writeInt(img_id++);pak.writeString(data_full);pak.send()}else{var win=window.open("","img_preview");var elems=win.document.getElementsByTagName("img");if(elems&&elems.length){elems[0].remove()}win.document.write('<html><body><img src="'+data_full+'"/></body></html>')}}var VSCALE=.5;function drawElipse(x,y,z,r0,r1,color){var segments=max(20,r0-10);var last_pos=[0,0];var cur_pos=[0,0];for(var ii=0;ii<=segments+1;++ii){v2copy(last_pos,cur_pos);var theta=ii/segments*PI*2+.1;v2set(cur_pos,x+cos(theta)*r0,y+sin(theta)*r1);if(view===1){v2floor(cur_pos,cur_pos);v2addScale(cur_pos,cur_pos,unit_vec,.5)}if(ii){ui.drawLine(last_pos[0],last_pos[1],cur_pos[0],cur_pos[1],z,1,.9,color)}}}var ORBIT_RATE=2e-4;function drawSolarSystem(solar_system,x0,y0,z,w,h,star_xp,star_yp,fade){var pmtex=planetMapTexture();x0=lerp(fade,star_xp,x0);y0=lerp(fade,star_yp,y0);w*=fade;h*=fade;var star_data=solar_system.star_data,planets=solar_system.planets;var xmid=x0+w/2;var ymid=y0+h/2;var sun_radius=star_data.game_radius;var sun_pad=w*.1;var c=star_data.color;ui.drawCircle(xmid,ymid,z,sun_radius+2,.25,[c[0],c[1],c[2],fade],BLEND_ADDITIVE);ui.drawCircle(xmid,ymid,z+.005,sun_radius,.95,[c[0],c[1],c[2],fade]);var rstep=(w/2-sun_pad)/(planets.length+2);var r0=sun_pad+rstep;for(var ii=0;ii<planets.length;++ii){var r=r0+rstep*ii;var planet=planets[ii];var theta=planet.orbit+planet.orbit_speed*engine.frame_timestamp*ORBIT_RATE;theta%=2*PI;var x=xmid+cos(theta)*r;var y=ymid+sin(theta)*r*VSCALE;var zz=z+(y-ymid)/h;drawElipse(xmid,ymid,z-2,r,r*VSCALE,[.5,.5,0,fade]);var sprite_size=planet.size;var planet_params={params:[engine.frame_timestamp*3e-4,pmtex.width/sprite_size*1.5/255,2-theta/PI,0]};sprites.queueraw([pmtex,planet.getTexture(sprite_size*2),tex_palette_planets],x-sprite_size,y-sprite_size,zz,sprite_size*2,sprite_size*2,0,0,1,1,[1,1,1,fade],shader_planet_pixel,planet_params)}var br0=w/2*1.5;var br1=h/2*VSCALE*1.5;ui.drawElipse(xmid-br0,ymid-br1,xmid+br0,ymid+br1,z-2.1,0,[0,0,0,fade])}var drag_temp=vec2();function test(dt){gl.clearColor(0,0,0,1);var z=Z.UI;var x=4;var button_spacing=ui.button_height+6;var y=4;var w=min(game_width,game_height);var map_x0=show_panel?game_width-w:(game_width-w)/2;var map_y0=0;function checkLevel(check_zoom_level){var zoom=pow(2,zoom_level);var layer_idx=floor(check_zoom_level/(LAYER_STEP/2));var gal_x0=(camera2d.x0Real()-map_x0)/w/zoom+zoom_offs[0];var gal_x1=(camera2d.x1Real()-map_x0)/w/zoom+zoom_offs[0];var gal_y0=(camera2d.y0Real()-map_y0)/w/zoom+zoom_offs[1];var gal_y1=(camera2d.y1Real()-map_y0)/w/zoom+zoom_offs[1];var layer_res=pow(LAYER_STEP,layer_idx);var layer_x0=max(0,floor(gal_x0*layer_res));var layer_x1=min(layer_res-1,floor(gal_x1*layer_res));var layer_y0=max(0,floor(gal_y0*layer_res));var layer_y1=min(layer_res-1,floor(gal_y1*layer_res));for(var cy=layer_y0;cy<=layer_y1;++cy){for(var cx=layer_x0;cx<=layer_x1;++cx){var cell=galaxy.getCellTextured(layer_idx,cy*layer_res+cx);if(!cell.tex){return false}}}return true}var max_okay_zoom=zoom_level;if(galaxy){var zlis=[LAYER_STEP/2*ceil(zoom_level/(LAYER_STEP/2)),LAYER_STEP/2*ceil((zoom_level+1)/(LAYER_STEP/2))];for(var ii=0;ii<zlis.length;++ii){var r=checkLevel(zlis[ii]);if(r){max_okay_zoom=zlis[ii]}}}if(galaxy&&!engine.defines.ATTRACT){galaxy.loading=false}if(!deepEqual(params,gen_params)){gen_params=clone(params);var first=true;if(galaxy){first=false;galaxy.dispose()}galaxy=createGalaxy(params);galaxy.loading=first||engine.defines.ATTRACT;allocSprite()}if(input.keyDown(KEYS.CTRL)&&input.keyDownEdge(KEYS.C)){copyCanvasToClipboard()}if(show_panel){if(ui.buttonText({x:x,y:y,text:"View: "+(view?"Pixely":"Raw"),w:ui.button_width*.75})||input.keyDownEdge(KEYS.V)){view=(view+1)%2;local_storage.setJSON("view",view);setTimeout(function(){return engine.setPixelyStrict(view===1)},0)}if(ui.buttonText({x:x+ui.button_width-ui.button_height,y:y,text:"<<",w:ui.button_height})||input.keyDownEdge(KEYS.ESC)){show_panel=!show_panel;local_storage.setJSON("panel",show_panel)}y+=button_spacing;if(solar_view){if(ui.buttonText({x:x,y:y,z:z,text:solar_override?"Override":"Generated"})){solar_override=!solar_override;local_storage.setJSON("solar_override",solar_override);solar_override_system=null}y+=button_spacing;if(solar_override){ui.print(style,x,y,z,"StarID: "+solar_params.star_id);y+=ui.font_height;solar_params.star_id=round(ui.slider(solar_params.star_id,{x:x,y:y,z:z,min:1,max:99}));y+=button_spacing;ui.print(style,x,y,z,"Seed: "+solar_params.seed);y+=ui.font_height;solar_params.seed=round(ui.slider(solar_params.seed,{x:x,y:y,z:z,min:1,max:99}));y+=button_spacing;if(!solar_override_system||!deepEqual(solar_params,gen_solar_params)){gen_solar_params=clone(solar_params);solar_override_system=solarSystemCreate(solar_params.seed,{id:solar_params.star_id})}}}else{ui.print(style,x,y,z,"Seed: "+params.seed);y+=ui.font_height;params.seed=round(ui.slider(params.seed,{x:x,y:y,z:z,min:1,max:9999}));y+=button_spacing;if(zoom_level<1.9){ui.print(style,x,y,z,"Arms: "+params.arms);y+=ui.font_height;params.arms=round(ui.slider(params.arms,{x:x,y:y,z:z,min:1,max:16}));y+=button_spacing;ui.print(style,x,y,z,"Arm Mods: "+params.len_mods);y+=ui.font_height;params.len_mods=round(ui.slider(params.len_mods,{x:x,y:y,z:z,min:1,max:32}));y+=button_spacing;ui.print(style,x,y,z,"Twirl: "+params.twirl);y+=ui.font_height;params.twirl=round4(ui.slider(params.twirl,{x:x,y:y,z:z,min:0,max:8}));y+=button_spacing;ui.print(style,x,y,z,"Center: "+params.center);y+=ui.font_height;params.center=round4(ui.slider(params.center,{x:x,y:y,z:z,min:0,max:.3}));y+=button_spacing;ui.print(style,x,y,z,"Noise Freq: "+params.noise_freq);y+=ui.font_height;params.noise_freq=round4(ui.slider(params.noise_freq,{x:x,y:y,z:z,min:.1,max:10}));y+=button_spacing;ui.print(style,x,y,z,"Noise Weight: "+params.noise_weight);y+=ui.font_height;params.noise_weight=round4(ui.slider(params.noise_weight,{x:x,y:y,z:z,min:0,max:4}));y+=button_spacing;ui.print(style,x,y,z,"Lone Clusters: "+params.poi_count);y+=ui.font_height;params.poi_count=round(ui.slider(params.poi_count,{x:x,y:y,z:z,min:0,max:1e3}));y+=button_spacing}else{var layer_idx=round(zoom_level/(LAYER_STEP/2));ui.print(style,x,y,z,"Layer #"+layer_idx+":");y+=ui.font_height+2;var key="layer"+layer_idx;if(params[key]){ui.print(style,x,y,z,"Noise Freq: "+params[key].noise_freq);y+=ui.font_height;params[key].noise_freq=round4(ui.slider(params[key].noise_freq,{x:x,y:y,z:z,min:.1,max:100*pow(2,layer_idx)}));y+=button_spacing;ui.print(style,x,y,z,"Noise Weight: "+params[key].noise_weight);y+=ui.font_height;params[key].noise_weight=round4(ui.slider(params[key].noise_weight,{x:x,y:y,z:z,min:0,max:4}));y+=button_spacing}}}ui.panel({x:x-4,y:0,w:ui.button_width+8,h:y,z:z-1})}else{if(!engine.defines.ATTRACT&&ui.buttonText({x:x,y:y,text:">>",w:ui.button_height})||input.keyDownEdge(KEYS.ESC)){show_panel=!show_panel;local_storage.setJSON("panel",show_panel)}y+=button_spacing}x=game_width-w+4;y=w-ui.button_height;if(ui.buttonText({x:x,y:y,z:z,w:ui.button_height,text:"-"})||input.keyDownEdge(KEYS.MINUS)||input.keyDownEdge(KEYS.Q)){use_mouse_pos=false;doZoom(.5,.5,-1)}x+=ui.button_height+2;var SLIDER_W=110;var new_zoom=roundZoom(ui.slider(target_zoom_level+solar_view,{x:x,y:y,z:z,w:SLIDER_W,min:0,max:MAX_ZOOM+1}));if(abs(new_zoom-target_zoom_level)>1e-6){doZoom(.5,.5,new_zoom-target_zoom_level)}x+=SLIDER_W+2;if(ui.buttonText({x:x,y:y,z:z,w:ui.button_height,text:"+"})||input.keyDownEdge(KEYS.EQUALS)||input.keyDownEdge(KEYS.E)){use_mouse_pos=false;doZoom(.5,.5,1)}x+=ui.button_height+2;var mouse_wheel=input.mouseWheel();if(input.click({button:2})){mouse_wheel-=1}if(mouse_wheel){use_mouse_pos=true;input.mousePos(mouse_pos);if(mouse_wheel<0&&eff_solar_view_unsmooth&&!solar_view){}else{doZoom((mouse_pos[0]-map_x0)/w,(mouse_pos[1]-map_y0)/w,mouse_wheel)}}zoomTick(max_okay_zoom);var zoom=pow(2,zoom_level);var zoom_text_y=floor(y+(ui.button_height-ui.font_height)/2);var zoom_text_w=ui.print(null,x,zoom_text_y,z,solar_view?"Solar":zoom.toFixed(0)+"X");ui.drawRect(x-2,zoom_text_y,x+zoom_text_w+2,zoom_text_y+ui.font_height,z-1,color_text_backdrop);x=game_width-w;var legend_scale=.25;var legend_x0=game_width-w*legend_scale-2;var legend_x1=game_width-4;var legend_color=solar_view?color_legend_fade:unit_vec;y=w;ui.drawLine(legend_x0,y-4.5,legend_x1,y-4.5,z,1,1,legend_color);ui.drawLine(legend_x0-.5,y-7,legend_x0-.5,y-2,z,1,1,legend_color);ui.drawLine(legend_x1+.5,y-7,legend_x1+.5,y-2,z,1,1,legend_color);var ly=legend_scale*params.width_ly/zoom;var legend_y=y-6-ui.font_height;font.drawSizedAligned(solar_view?font_style_fade:null,legend_x0,legend_y,z,ui.font_height,font.ALIGN.HCENTER,legend_x1-legend_x0,0,format(ly)+"ly");ui.drawRect(legend_x0-2,legend_y,legend_x1+2,y,z-1,color_text_backdrop);x=map_x0;y=map_y0;v2set(drag_temp,0,0);var kb_scale=input.keyDown(KEYS.SHIFT)?.5:.125;drag_temp[0]+=input.keyDown(KEYS.A)*kb_scale;drag_temp[0]-=input.keyDown(KEYS.D)*kb_scale;drag_temp[1]+=input.keyDown(KEYS.W)*kb_scale;drag_temp[1]-=input.keyDown(KEYS.S)*kb_scale;var drag=input.drag();if(drag&&drag.delta){v2add(drag_temp,drag_temp,drag.delta);use_mouse_pos=true}if(solar_view){v2set(drag_temp,0,0)}if(drag_temp[0]||drag_temp[1]){zoom_offs[0]-=drag_temp[0]/w/zoom;zoom_offs[1]-=drag_temp[1]/w/zoom;local_storage.setJSON("offsx",zoom_offs[0]);local_storage.setJSON("offsy",zoom_offs[1])}if(engine.defines.ATTRACT){zoom_offs[0]=clamp(zoom_offs[0],0,1-1/zoom);zoom_offs[1]=clamp(zoom_offs[1],0,1-1/zoom)}else{zoom_offs[0]=clamp(zoom_offs[0],-1/zoom,1);zoom_offs[1]=clamp(zoom_offs[1],-1/zoom,1)}if(input.mouseMoved()){use_mouse_pos=true}if(use_mouse_pos){input.mousePos(mouse_pos)}else{mouse_pos[0]=map_x0+w/2;mouse_pos[1]=map_y0+w/2}mouse_pos[0]=zoom_offs[0]+(mouse_pos[0]-map_x0)/w/zoom;mouse_pos[1]=zoom_offs[1]+(mouse_pos[1]-map_y0)/w/zoom;var overlay_y=0;var overlay_x=show_panel?map_x0+2:ui.button_height*2;var overlay_w=0;function overlayText(line){if(engine.defines.ATTRACT){return}var textw=ui.print(null,overlay_x,overlay_y,z,line);overlay_w=max(overlay_w,textw);overlay_y+=ui.font_height}if(0){overlayText((use_mouse_pos?"Mouse":"Target")+": "+mouse_pos[0].toFixed(9)+","+mouse_pos[1].toFixed(9))}function highlightCell(cell){var xp=x+(cell.x0-zoom_offs[0])*zoom*w;var yp=y+(cell.y0-zoom_offs[1])*zoom*w;var wp=w*zoom*cell.w;var hp=w*zoom*cell.h;if(view===1){xp=round(xp);yp=round(yp);hp=round(hp);wp=round(wp)}if(engine.defines.CELL){ui.drawHollowRect2({x:xp-.5,y:yp-.5,w:wp+1,h:hp+1,z:Z.UI-8,color:color_highlight});overlayText("Layer "+cell.layer_idx+", Cell "+cell.cell_idx+" ("+cell.cx+","+cell.cy+")");overlayText("Stars: "+format(cell.star_count));if(cell.pois.length){overlayText("POIs: "+cell.pois.length)}}if(engine.defines.CURSOR){var dx=floor((mouse_pos[0]-cell.x0)/cell.w*galaxy.buf_dim);var dy=floor((mouse_pos[1]-cell.y0)/cell.w*galaxy.buf_dim);var dd=cell.data[dy*galaxy.buf_dim+dx];overlayText("Value: "+dd.toFixed(5))}}var did_highlight=false;function checkCellHighlight(cell){if(cell.ready&&!did_highlight&&mouse_pos[0]>=cell.x0&&mouse_pos[0]<cell.x0+cell.w&&mouse_pos[1]>=cell.y0&&mouse_pos[1]<cell.y0+cell.h){did_highlight=true;highlightCell(cell)}}cells_drawn=0;function drawCell(alpha,parent,cell){++cells_drawn;var qx=cell.cx-parent.cx*LAYER_STEP;var qy=cell.cy-parent.cy*LAYER_STEP;var draw_param={x:x+(cell.x0-zoom_offs[0])*zoom*w,y:y+(cell.y0-zoom_offs[1])*zoom*w,w:w*zoom*cell.w,h:w*zoom*cell.h,z:Z.UI-10,nozoom:true};var partial=false;if(!parent.tex){if(!cell.tex){return}alpha=1;partial=true}else if(!cell.tex){alpha=0;partial=true}draw_param.shader=view===1?shader_galaxy_pixel:shader_galaxy_blend;var dither=lerp(clamp(zoom_level-12.5,0,1),params.dither,0);draw_param.shader_params={params:[alpha?buf_dim:buf_dim/LAYER_STEP,dither],scale:[qx/LAYER_STEP,qy/LAYER_STEP,1/LAYER_STEP,alpha]};var texs=cell.texs;if(!texs){texs=[cell.tex||white_tex,parent.tex||white_tex,tex_palette];if(!partial){cell.texs=texs}}debug_sprite.texs=texs;debug_sprite.draw(draw_param)}function drawLevel(layer_idx,alpha,do_highlight){var gal_x0=(camera2d.x0Real()-map_x0)/w/zoom+zoom_offs[0];var gal_x1=(camera2d.x1Real()-map_x0)/w/zoom+zoom_offs[0];var gal_y0=(camera2d.y0Real()-map_y0)/w/zoom+zoom_offs[1];var gal_y1=(camera2d.y1Real()-map_y0)/w/zoom+zoom_offs[1];var layer_res=pow(LAYER_STEP,layer_idx);var layer_x0=max(0,floor(gal_x0*layer_res));var layer_x1=min(layer_res-1,floor(gal_x1*layer_res));var layer_y0=max(0,floor(gal_y0*layer_res));var layer_y1=min(layer_res-1,floor(gal_y1*layer_res));var pres=pow(LAYER_STEP,layer_idx-1);for(var cy=layer_y0;cy<=layer_y1;++cy){for(var cx=layer_x0;cx<=layer_x1;++cx){var cell=galaxy.getCellTextured(layer_idx,cy*layer_res+cx);var px=floor(cx/LAYER_STEP);var py=floor(cy/LAYER_STEP);var parent=galaxy.getCellTextured(layer_idx-1,py*pres+px);drawCell(alpha,parent,cell);if(do_highlight){checkCellHighlight(cell)}else{checkCellHighlight(parent)}}}}var blend_range=1;var draw_level=max(0,(zoom_level-1)/(LAYER_STEP/2)+blend_range/2);var level0=floor(draw_level);var extra=min((draw_level-level0)/blend_range,1);if(!extra&&level0){level0--;extra=1}drawLevel(level0+1,extra,Boolean(extra));if(zoom_level>=12){var star;var SELECT_DIST=40;if(!solar_override_system){if((solar_view||eff_solar_view)&&selected_star_id!==null){star=galaxy.getStar(selected_star_id)}else{var closest=galaxy.starsNear(mouse_pos[0],mouse_pos[1],1);var star_id=closest.length?closest[0]:null;star=star_id!==null&&galaxy.getStar(star_id);if(star&&sqrt(distSq(star.x,star.y,mouse_pos[0],mouse_pos[1]))*zoom*w>SELECT_DIST){star=null}if(star){selected_star_id=star_id}else{selected_star_id=null}}}var xp=x+w/2;var yp=y+w/2;if(star){var max_zoom=pow(2,MAX_ZOOM);xp=floor(star.x*max_zoom*buf_dim);yp=floor(star.y*max_zoom*buf_dim);xp=x+(xp*zoom/max_zoom/buf_dim-zoom_offs[0]*zoom)*w;yp=y+(yp*zoom/max_zoom/buf_dim-zoom_offs[1]*zoom)*w;if(view===1){xp=round(xp);yp=round(yp)}var _r=4/(1+MAX_ZOOM-zoom_level);if(!solar_view){ui.drawHollowCircle(xp+.5,yp+.5,Z.UI-5,_r,.5,[1,1,0,1],BLEND_ADDITIVE);if(input.click({x:xp-SELECT_DIST,y:yp-SELECT_DIST,w:SELECT_DIST*2,h:SELECT_DIST*2})){if(zoom_level<MAX_ZOOM){doZoom((xp-map_x0)/w,(yp-map_y0)/w,MAX_ZOOM-zoom_level)}solarZoom(1)}}galaxy.getStarData(star)}var solar_system=solar_override_system||star&&star.solar_system;if(solar_system){var planets=solar_system.planets,star_data=solar_system.star_data,name=solar_system.name;overlayText(""+(name||(star&&star.id?"Star #"+star.id:"")||"Override Star")+(", Type: "+star_data.label));for(var _ii=0;_ii<planets.length;++_ii){var planet=planets[_ii];overlayText("  Planet #"+(_ii+1)+": Class "+planet.type.name)}var do_view=eff_solar_view?eff_solar_view:engine.defines.AUTOSOLAR&&zoom_level>15.5?1:0;if(do_view){drawSolarSystem(solar_system,map_x0,map_y0,Z.UI-1,w,w,xp,yp,do_view)}}else if(star){overlayText("Star #"+star.id)}}if(input.click()){use_mouse_pos=true;input.mousePos(mouse_pos);doZoom((mouse_pos[0]-map_x0)/w,(mouse_pos[1]-map_y0)/w,1)}ui.drawRect(overlay_x-2,0,overlay_x+overlay_w+2,overlay_y,z-1,color_text_backdrop);if(engine.defines.ATTRACT){engine.postRender(saveSnapshot)}}function testInit(dt){engine.setState(test);test(dt)}engine.setState(testInit)}


},{"../common/util.js":70,"./galaxy.js":3,"./glov/camera2d.js":6,"./glov/engine.js":11,"./glov/framebuffer.js":16,"./glov/input.js":25,"./glov/local_storage.js":27,"./glov/net.js":30,"./glov/perf.js":33,"./glov/shaders.js":40,"./glov/sprites.js":43,"./glov/textures.js":45,"./glov/ui.js":47,"./glov/vmath.js":49,"./img/font/04b03_8x1.json":54,"./img/font/04b03_8x2.json":55,"./img/font/palanquin32.json":56,"./solar_system.js":60,"assert":undefined}],58:[function(require,module,exports){
"use strict";exports.main=main;exports.sprites=exports.game_height=exports.game_width=void 0;var local_storage=require("./glov/local_storage.js");local_storage.storage_prefix="glovjs-multiplayer";var assert=require("assert");var _require=require("./glov/cmds.js"),cmd_parse=_require.cmd_parse;var engine=require("./glov/engine.js");var glov_font=require("./glov/font.js");var input=require("./glov/input.js");var atan2=Math.atan2,random=Math.random;var net=require("./glov/net.js");var net_position_manager=require("./glov/net_position_manager.js");var particles=require("./glov/particles.js");var shaders=require("./glov/shaders.js");var _require2=require("./glov/sound.js"),soundLoad=_require2.soundLoad,soundPlay=_require2.soundPlay;var glov_sprites=require("./glov/sprites.js");var sprite_animation=require("./glov/sprite_animation.js");var ui=require("./glov/ui.js");var _require3=require("../common/util.js"),toNumber=_require3.toNumber;var particle_data=require("./particle_data.js");var _require4=require("./glov/vmath.js"),vec2=_require4.vec2,vec3=_require4.vec3,v2sub=_require4.v2sub,vec4=_require4.vec4,v4copy=_require4.v4copy;window.Z=window.Z||{};Z.BACKGROUND=1;Z.SPRITES=10;Z.PARTICLES=20;var app=exports;window.app=app;var pos_manager=net_position_manager.create({n:3,dim_pos:2,dim_rot:1});var ROOM_REQUIRES_LOGIN=true;var game_width=1280;exports.game_width=game_width;var game_height=960;exports.game_height=game_height;var sprites={};exports.sprites=sprites;cmd_parse.register({cmd:"bin_get",func:function func(str,resp_func){app.chat_ui.channel.pak("bin_get").send(function(err,pak){if(err){return void resp_func(err)}resp_func(null,pak.readBuffer(false).join(","))})}});cmd_parse.register({cmd:"bin_set",func:function func(str,resp_func){var pak=app.chat_ui.channel.pak("bin_set");pak.writeBuffer(new Uint8Array(str.split(" ").map(toNumber)));pak.send(resp_func)}});function main(){net.init({engine:engine,cmd_parse:cmd_parse,auto_create_user:false});if(!engine.startup({game_width:game_width,game_height:game_height,pixely:false,font:{info:require("./img/font/palanquin32.json"),texture:"font/palanquin32"},safearea_ignore_bottom:true,ui_sounds:{msg_err:"msg_err",msg_in:"msg_in",msg_out:"msg_out",msg_out_err:"msg_out_err",user_join:"user_join",user_leave:"user_leave"}})){return}var test_shader=shaders.create("shaders/test.fp");var createSprite=glov_sprites.create;var createAnimation=sprite_animation.create;app.account_ui=require("./account_ui.js").create();app.chat_ui=require("./glov/chat_ui.js").create({max_len:1e3});var color_white=vec4(1,1,1,1);var color_gray=vec4(.5,.5,.5,1);var color_red=vec4(1,0,0,1);var color_yellow=vec4(1,1,0,1);var KEYS=input.KEYS;var PAD=input.PAD;var sprite_size=64;function initGraphics(){particles.preloadParticleData(particle_data);soundLoad("test");sprites.white=createSprite({url:"white"});sprites.test=createSprite({name:"test",size:vec2(sprite_size,sprite_size),origin:vec2(.5,.5)});sprites.test_tint=createSprite({name:"tinted",ws:[16,16,16,16],hs:[16,16,16],size:vec2(sprite_size,sprite_size),layers:2,origin:vec2(.5,.5)});sprites.animation=createAnimation({idle_left:{frames:[0,1],times:[200,500]},idle_right:{frames:[3,2],times:[200,500]}});sprites.animation.setState("idle_left");sprites.game_bg=createSprite({url:"white",size:vec2(game_width,game_height)})}var test_room;var _test;function playerMotion(dt){if(pos_manager.checkNet(function(pos){_test.character.x=pos[0];_test.character.y=pos[1];_test.character.rot=pos[2]})){return}_test.character.dx=0;_test.character.dx-=input.keyDown(KEYS.LEFT)+input.keyDown(KEYS.A)+input.padButtonDown(PAD.LEFT);_test.character.dx+=input.keyDown(KEYS.RIGHT)+input.keyDown(KEYS.D)+input.padButtonDown(PAD.RIGHT);_test.character.dy=0;_test.character.dy-=input.keyDown(KEYS.UP)+input.keyDown(KEYS.W)+input.padButtonDown(PAD.UP);_test.character.dy+=input.keyDown(KEYS.DOWN)+input.keyDown(KEYS.S)+input.padButtonDown(PAD.DOWN);if(_test.character.dx<0){sprites.animation.setState("idle_left")}else if(_test.character.dx>0){sprites.animation.setState("idle_right")}_test.character.x+=_test.character.dx*.2;_test.character.y+=_test.character.dy*.2;var bounds={x:_test.character.x-sprite_size/2,y:_test.character.y-sprite_size/2,w:sprite_size,h:sprite_size};if(input.mouseDown(bounds)){v4copy(_test.color_sprite,color_yellow)}else if(input.click(bounds)){v4copy(_test.color_sprite,_test.color_sprite[2]===0?color_white:color_red);soundPlay("test")}else if(input.mouseOver(bounds)){v4copy(_test.color_sprite,color_white);_test.color_sprite[3]=.5}else{v4copy(_test.color_sprite,color_white);_test.color_sprite[3]=1}var aim=v2sub(vec2(),input.mousePos(),[_test.character.x,_test.character.y]);_test.character.rot=atan2(aim[0],-aim[1]);pos_manager.updateMyPos(new Float64Array([_test.character.x,_test.character.y,_test.character.rot]),"idle")}function getRoom(){if(!test_room){test_room=net.subs.getChannel("test.test",true);pos_manager.reinit({channel:test_room,default_pos:vec3(random()*(game_width-sprite_size)+sprite_size*.5,random()*(game_height-sprite_size)+sprite_size*.5,0)});app.chat_ui.setChannel(test_room)}}function preLogout(){if(test_room){assert(test_room.subscriptions);net.subs.unsubscribe(test_room.channel_id);app.chat_ui.setChannel(null);test_room=null;if(!ROOM_REQUIRES_LOGIN){setTimeout(getRoom,1)}}}_test=function test(dt){ui.focusCheck("canvas");app.chat_ui.run(dt);app.account_ui.showLogin({x:0,y:0,prelogout:preLogout,center:false,style:glov_font.style(null,{outline_width:2,outline_color:4294967295,color:255})});if(!_test.color_sprite){_test.color_sprite=v4copy(vec4(),color_white);_test.character={x:0,y:0,rot:0}}if(test_room&&test_room.subscriptions){playerMotion(dt);sprites.game_bg.draw({x:0,y:0,z:Z.BACKGROUND,color:[.5,.6,.7,1],shader:test_shader,shader_params:{params:[1,1,1,engine.getFrameTimestamp()*5e-4%1e3]}});sprites.test_tint.drawDualTint({x:_test.character.x,y:_test.character.y,z:Z.SPRITES,rot:_test.character.rot,color:[1,1,0,1],color1:[1,0,1,1],size:[sprite_size,sprite_size],frame:sprites.animation.getFrame(dt)});var room_clients=test_room.getChannelData("public.clients",{});for(var client_id in room_clients){var other_client=room_clients[client_id];if(other_client.pos&&other_client.ids){var pcd=pos_manager.updateOtherClient(client_id,dt);if(pcd){var pos=pcd.pos;sprites.test.draw({x:pos[0],y:pos[1],z:Z.SPRITES-1,rot:pos[2],color:color_gray});ui.font.drawSizedAligned(glov_font.styleColored(null,128),pos[0],pos[1]-64,Z.SPRITES-1,ui.font_height,glov_font.ALIGN.HCENTER,0,0,other_client.ids.display_name||"client_"+client_id)}}}}app.chat_ui.runLate(dt)};function testInit(dt){engine.setState(_test);if(!ROOM_REQUIRES_LOGIN){getRoom()}net.subs.onLogin(getRoom);_test(dt)}initGraphics();engine.setState(testInit)}


},{"../common/util.js":70,"./account_ui.js":1,"./glov/chat_ui.js":7,"./glov/cmds.js":8,"./glov/engine.js":11,"./glov/font.js":15,"./glov/input.js":25,"./glov/local_storage.js":27,"./glov/net.js":30,"./glov/net_position_manager.js":31,"./glov/particles.js":32,"./glov/shaders.js":40,"./glov/sound.js":41,"./glov/sprite_animation.js":42,"./glov/sprites.js":43,"./glov/ui.js":47,"./glov/vmath.js":49,"./img/font/palanquin32.json":56,"./particle_data.js":59,"assert":undefined}],59:[function(require,module,exports){
"use strict";exports.defs=void 0;var defs={};exports.defs=defs;defs.explosion={particles:{part0:{blend:"alpha",texture:"particles/circle64",color:[1,1,1,1],color_track:[{t:0,v:[1,1,1,0]},{t:.2,v:[1,1,1,1]},{t:.4,v:[1,1,.5,.5]},{t:1,v:[1,0,0,0]}],size:[[48,8],[48,8]],size_track:[{t:0,v:[1,1]},{t:.2,v:[2,2]},{t:.4,v:[1,1]},{t:1,v:[1.5,1.5]}],accel:[0,0,0],rot:[0,360],rot_vel:[10,2],lifespan:[2500,0],kill_time_accel:5}},emitters:{part0:{particle:"part0",pos:[[-16,32],[-16,32],0],vel:[0,0,0],emit_rate:[15,0],emit_time:[0,1e3],emit_initial:10,max_parts:Infinity}},system_lifespan:2500};


},{}],60:[function(require,module,exports){
"use strict";exports.planetMapTexture=planetMapTexture;exports.solarSystemCreate=solarSystemCreate;var assert=require("assert");var atan2=Math.atan2,max=Math.max,round=Math.round,sqrt=Math.sqrt,PI=Math.PI;var _require=require("./glov/rand_alea.js"),randCreate=_require.randCreate,mashString=_require.mashString;var SimplexNoise=require("simplex-noise");var _require2=require("./star_types.js"),starTypeData=_require2.starTypeData,starTypeFromID=_require2.starTypeFromID;var textures=require("./glov/textures.js");var _require3=require("../common/util.js"),clamp=_require3.clamp,defaults=_require3.defaults,nextHighestPowerOfTwo=_require3.nextHighestPowerOfTwo;var _require4=require("./glov/vmath.js"),vec2=_require4.vec2,vec4=_require4.vec4;var rand=[randCreate(0),randCreate(0),randCreate(0),randCreate(0)];var color_table_earthlike=[.5,0,.6,1,1,2];var color_table_earthlike_islands=[.7,0,.8,1,1,2];var color_table_earthlike_pangea=[.3,0,.7,1,1,2];var color_table_water_world=[.5,22,.8,0,1,22];var color_table_low_life=[.3,0,.7,14,1,1];var color_table_molten=[.25,4,.46,3,.54,5,.75,3,1,4];var color_table_molten_small=[.4,3,.6,5,1,4];var color_table_gray=[.25,6,.5,7,.75,8,1,9];var color_table_frozen=[.23,11,.77,10,1,9];var color_table_gasgiant1=[.2,12,.35,13,.5,9,.65,12,.8,13,1,9];var color_table_dirt=[.5,14,1,15];var color_table_gasgiant2=[.2,16,.4,17,.6,16,.8,17,1,16];var color_table_gasgiant3=[.2,18,.4,5,.6,18,.8,5,1,18];var color_table_gasgiant4=[.2,19,.35,20,.5,21,.65,19,.8,20,1,21];var color_table_gasgiant5=[.2,23,.35,5,.5,12,.65,23,.8,5,1,12];var noise_base={frequency:2,amplitude:1,persistence:.5,lacunarity:{min:1.6,max:2.8,freq:.3},octaves:6,cutoff:.5,domain_warp:0,warp_freq:1,warp_amp:.1,skew_x:1,skew_y:1};function noiseMod(opts,base){base=base||noise_base;return defaults(opts,base||noise_base)}var noise_gasgiant=noiseMod({skew_x:.2,domain_warp:1,warp_amp:.1});var noise_molten=noiseMod({domain_warp:0,warp_amp:.1});var noise_dirt=noiseMod({domain_warp:1,warp_amp:.3});var noise_waterworld=noiseMod({skew_x:.5,domain_warp:1,warp_amp:.3});var planet_types=[{name:"D",size:[4,8],color:vec4(.7,.7,.7,1),color_table:color_table_gray,noise:noise_base},{name:"H",size:[6,10],color:vec4(.3,.4,.5,1),color_table:color_table_gray,noise:noise_base},{name:"J",size:[12,20],color:vec4(.9,.6,0,1),color_table:[color_table_gasgiant1,color_table_gasgiant4],noise:noise_gasgiant},{name:"K",size:[8,12],color:vec4(.5,.3,.2,1),color_table:color_table_dirt,noise:noise_dirt},{name:"L",size:[6,10],bias:1,color:vec4(.3,.7,.3,1),color_table:color_table_frozen,noise:noise_base},{name:"M",size:[9,12],color:vec4(0,1,0,1),color_table:[color_table_earthlike,color_table_earthlike_islands,color_table_earthlike_pangea],noise:noise_base},{name:"N",size:[4,8],bias:-1,color:vec4(.6,.6,0,1),color_table:color_table_molten_small,noise:noise_molten},{name:"P",size:[4,14],bias:1,color:vec4(.5,.7,1,1),color_table:color_table_frozen,noise:noise_base},{name:"R",size:[6,12],color:vec4(.2,.3,.2,1),color_table:color_table_low_life,noise:noise_base},{name:"T",size:[12,20],color:vec4(.6,.9,0,1),color_table:[color_table_gasgiant2,color_table_gasgiant3,color_table_gasgiant5],noise:noise_gasgiant},{name:"W",size:[8,18],color:vec4(.3,.3,1,1),color_table:color_table_water_world,noise:noise_waterworld},{name:"Y",size:[8,18],color:vec4(1,.3,0,1),color_table:color_table_molten,noise:noise_base}];function randExp(idx,min,mx){var v=rand[idx].random();v*=v;return min+(mx-min)*v}function typeFromName(name){for(var ii=0;ii<planet_types.length;++ii){if(planet_types[ii].name===name){return planet_types[ii]}}assert(false);return null}function Planet(solar_system,override_data){override_data=override_data||{};this.type=override_data.name?typeFromName(override_data.name):planet_types[rand[2].range(planet_types.length)];this.size=override_data.size||randExp(3,this.type.size[0],this.type.size[1]);this.orbit=rand[0].floatBetween(0,PI*2)*11;this.orbit_speed=randExp(1,.1,1);this.seed=override_data.seed||rand[2].uint32()}var noise;var noise_warp;var noise_skew=vec2();var total_amplitude;var noise_field;var subopts;function initNoise(seed,subopts_in){subopts=subopts_in;noise=new Array(subopts.octaves);for(var ii=0;ii<noise.length;++ii){noise[ii]=new SimplexNoise(seed+"n"+ii)}noise_warp=new Array(subopts.domain_warp);for(var _ii=0;_ii<noise_warp.length;++_ii){noise_warp[_ii]=new SimplexNoise(seed+"w"+_ii)}total_amplitude=0;var amp=subopts.amplitude;var p=subopts.persistence&&subopts.persistence.max||subopts.persistence;for(var _ii2=0;_ii2<subopts.octaves;_ii2++){total_amplitude+=amp;amp*=p}noise_field={};for(var f in subopts){var v=subopts[f];if(typeof v==="object"){noise_field[f]=new SimplexNoise(seed+"f"+subopts.key+f);v.mul=(v.max-v.min)*.5;v.add=v.min+v.mul}}noise_skew[0]=subopts.skew_x;noise_skew[1]=subopts.skew_y}{var get=function get(field){var v=subopts[field];if(typeof v!=="object"){return v}return v.add+v.mul*noise_field[field].noise2D(sample_pos[0]*v.freq,sample_pos[1]*v.freq)};var sample=function sample(x,y){sample_pos[0]=x*noise_skew[0];sample_pos[1]=y*noise_skew[1];var warp_freq=subopts.warp_freq;var warp_amp=subopts.warp_amp;for(var ii=0;ii<subopts.domain_warp;++ii){var dx=noise_warp[ii].noise2D(sample_pos[0]*warp_freq,sample_pos[1]*warp_freq);var dy=noise_warp[ii].noise2D((sample_pos[0]+7)*warp_freq,sample_pos[1]*warp_freq);sample_pos[0]+=dx*warp_amp;sample_pos[1]+=dy*warp_amp}var total=0;var amp=subopts.amplitude;var freq=get("frequency");var p=get("persistence");var lac=get("lacunarity");for(var i=0;i<subopts.octaves;i++){total+=(.5+.5*noise[i].noise2D(sample_pos[0]*freq,sample_pos[1]*freq))*amp;amp*=p;freq*=lac}return total/total_amplitude};var colorIndex=function colorIndex(table,value){for(var ii=0;ii<table.length;ii+=2){if(value<=table[ii]){return table[ii+1]}}return table[table.length-1]};var MAX_TEXTURES=20;var tex_pool=[];var tex_idx=0;var planet_tex_id=0;var PLANET_MIN_RES=8;var PLANET_MAX_RES=128;var tex_data=new Uint8Array(PLANET_MAX_RES*PLANET_MAX_RES);var sample_pos=vec2();Planet.prototype.getTexture=function(onscreen_size){if(this.tex&&this.tex.planet_tex_id===this.tex_id){return this.tex}for(var ii=0;ii<rand.length;++ii){rand[ii].reseed(mashString(this.seed+"_"+ii))}var color_table=this.type.color_table;if(Array.isArray(color_table[0])){color_table=color_table[rand[0].range(color_table.length)]}var planet_res=clamp(nextHighestPowerOfTwo(onscreen_size)/2,PLANET_MIN_RES,PLANET_MAX_RES);initNoise(this.seed,this.type.noise);for(var idx=0,jj=0;jj<planet_res;++jj){var last_wrap=false;for(var _ii3=0;_ii3<planet_res;++_ii3,++idx){var v=sample(_ii3/planet_res,jj/planet_res);if(last_wrap||_ii3===planet_res-1&&rand[1].range(2)){v=sample(-1/planet_res,jj/planet_res)}else if(_ii3===planet_res-2&&!rand[1].range(4)){v=sample(-2/planet_res,jj/planet_res);last_wrap=true}var b=colorIndex(color_table,v);tex_data[idx]=b}}if(tex_pool[tex_idx]){this.tex=tex_pool[tex_idx];this.tex.updateData(planet_res,planet_res,tex_data)}else{this.tex=tex_pool[tex_idx]=textures.load({name:"planet_"+ ++tex_idx,format:textures.format.R8,width:planet_res,height:planet_res,data:tex_data,filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.REPEAT,wrap_t:gl.CLAMP_TO_EDGE})}tex_idx=(tex_idx+1)%MAX_TEXTURES;this.tex_id=++planet_tex_id;this.tex.planet_tex_id=this.tex_id;return this.tex}}var PMRES=128;var PMBORDER=16;var pmtex;function planetMapTexture(){if(pmtex){return pmtex}var tex_data=new Uint8Array(PMRES*PMRES*3);var idx=0;var mid=PMRES/2;var PMR=PMRES/2-PMBORDER;function encodeRadian(rad){if(rad<0){rad+=PI*2}return clamp(round((rad-PI/2)/PI*255),0,255)}for(var yy=0;yy<PMRES;++yy){var unif_y=(yy-mid)/PMR;for(var xx=0;xx<PMRES;++xx){var unif_x=(xx-mid)/PMR;var dsq=unif_x*unif_x+unif_y*unif_y;var r=sqrt(dsq);var eff_r=max(1,r);var unif_z=r>=1?0:sqrt(eff_r*eff_r-dsq);var longitude=-atan2(unif_x,-unif_z);var xz_len=sqrt(unif_x*unif_x+unif_z*unif_z);var latitude=atan2(-unif_y,-xz_len);tex_data[idx++]=encodeRadian(longitude);tex_data[idx++]=encodeRadian(latitude);tex_data[idx++]=round(r/2*255)}}assert.equal(idx,tex_data.length);pmtex=textures.load({name:"pmtex",format:textures.format.RGB8,width:PMRES,height:PMRES,data:tex_data,filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE});return pmtex}function cmpSize(a,b){return a.size-b.size}function SolarSystem(global_seed,star){var id=star.id;var classif=starTypeFromID(id);var star_data=starTypeData(classif);this.star_data=star_data;for(var ii=0;ii<rand.length;++ii){rand[ii].reseed(mashString(id+"_"+global_seed+"_"+ii))}var planets=[];if(id===98897686813){this.name="Sol";planets.push(new Planet(this,{name:"D",size:4}));planets.push(new Planet(this,{name:"K",size:6}));planets.push(new Planet(this,{name:"M",size:8,seed:5}));planets.push(new Planet(this,{name:"Y",size:5}));planets.push(new Planet(this,{name:"T",size:16,seed:1}));planets.push(new Planet(this,{name:"J",size:12,seed:1}));planets.push(new Planet(this,{name:"P",size:9}));planets.push(new Planet(this,{name:"W",size:8}))}else{var num_planets=rand[0].range(4);var chance=.5;while(num_planets){planets.push(new Planet(this));--num_planets;if(!num_planets){if(rand[1].random()<chance){++num_planets;chance*=.9}}}var p1=[];var p2=[];for(var _ii4=0;_ii4<planets.length;++_ii4){var planet=planets[_ii4];if(!planet.type.bias&&rand[0].range(2)||planet.type.bias<0){p1.push(planet)}else{p2.push(planet)}}p1.sort(cmpSize);p2.sort(cmpSize).reverse();planets=p1.concat(p2)}this.planets=planets}function solarSystemCreate(global_seed,star){return new SolarSystem(global_seed,star)}


},{"../common/util.js":70,"./glov/rand_alea.js":36,"./glov/textures.js":45,"./glov/vmath.js":49,"./star_types.js":61,"assert":undefined,"simplex-noise":undefined}],61:[function(require,module,exports){
"use strict";exports.starTypeFromID=starTypeFromID;exports.hueFromID=hueFromID;exports.starTypeData=starTypeData;exports.hueFromType=hueFromType;var assert=require("assert");var engine=require("./glov/engine.js");var _require=require("./glov/rand_alea.js"),mashI53=_require.mashI53;var _require2=require("./glov/vmath.js"),vec4=_require2.vec4;var colors=[vec4(.816,1,1,1),vec4(.98,.204,0,1),vec4(1,.467,0,1),vec4(1,1,.408,1),vec4(1,1,.8,1),vec4(.922,1,1,1),vec4(.875,1,1,1),vec4(.816,1,1,1)];var sg_scale=.001/(.001+.1+.7+2+3.5+8+80);var star_types=function(){var raw={O:["O",.001,7,10,50,1e5,30],B:["B",.1,6,5,10,1e3,25],A:["A",.7,5,1.7,2,20,23],F:["F",2,4,1.3,1.5,4,22],G:["G",3.5,3,1,1,1,21],K:["K",8,2,.8,.7,.2,20],M:["M",80,1,.3,.2,.01,18],gG:["Giant G",.4*(4/92),3,50,5,1e3,36],gK:["Giant K",.4*(8/92),2,20,3.5,400,33],gM:["Giant M",.4*(80/92),1,10,1,50,30],D:["White Dwarf",5,6,.01,1.4,.01,6],sgO:["Supergiant O",sg_scale*.001,7,500,70,1e6,40],sgB:["Supergiant B",sg_scale*.1,6,300,60,82e3,37],sgA:["Supergiant A",sg_scale*.7,5,120,50,6e4,35],sgF:["Supergiant F",sg_scale*2,4,100,35,5e4,34],sgG:["Supergiant G",sg_scale*3.5,3,80,16,44e3,33],sgK:["Supergiant K",sg_scale*8,2,72,12,38e3,32],sgM:["Supergiant M",sg_scale*80,1,30,10,3e4,30]};var ret={};for(var key in raw){var rd=raw[key];ret[key]={label:rd[0],odds:rd[1],hue:rd[2],color:colors[rd[2]],astro_radius:rd[3],mass:rd[4],lumin:rd[5],game_radius:rd[6]}}return ret}();var star_types_total=function(){var ret=0;for(var key in star_types){ret+=star_types[key].odds}return ret}();function starType(choice){choice*=star_types_total;for(var key in star_types){choice-=star_types[key].odds;if(choice<=0){return key}}assert(!engine.DEBUG);return"M"}function starTypeFromID(id){return starType(mashI53(id))}function hueFromID(id){return star_types[starType(mashI53(id))].hue}function starTypeData(key){return star_types[key]}function hueFromType(key){return star_types[key].hue}


},{"./glov/engine.js":11,"./glov/rand_alea.js":36,"./glov/vmath.js":49,"assert":undefined}],62:[function(require,module,exports){
"use strict";exports.ackInitReceiver=ackInitReceiver;exports.ackWrapPakStart=ackWrapPakStart;exports.ackWrapPakPayload=ackWrapPakPayload;exports.ackWrapPakFinish=ackWrapPakFinish;exports.ackReadHeader=ackReadHeader;exports.failAll=failAll;exports.ackHandleMessage=ackHandleMessage;var assert=require("assert");var _require=require("./packet.js"),isPacket=_require.isPacket;function ackInitReceiver(receiver){receiver.last_pak_id=0;receiver.resp_cbs={};receiver.responses_waiting=0}var ERR_FAILALL_DISCONNECT="ERR_FAILALL_DISCONNECT";var ACKFLAG_IS_RESP=1<<3;var ACKFLAG_ERR=1<<4;var ACKFLAG_DATA_JSON=1<<5;function ackWrapPakStart(pak,receiver,msg){var flags=0;pak.ack_data={receiver:receiver};if(typeof msg==="number"){flags|=ACKFLAG_IS_RESP;pak.writeInt(msg)}else{pak.writeAnsiString(msg)}var resp_pak_id=receiver?++receiver.last_pak_id:0;pak.ack_data.resp_pak_id=resp_pak_id;pak.ack_data.resp_pak_id_offs=pak.getOffset();pak.writeInt(resp_pak_id);pak.ack_data.data_offs=pak.getOffset();pak.ack_data.flags=flags}function ackWrapPakPayload(pak,data){if(isPacket(data)){pak.appendRemaining(data)}else{pak.ack_data.flags|=ACKFLAG_DATA_JSON;pak.writeJSON(data)}}function ackWrapPakFinish(pak,err,resp_func){var flags=pak.ack_data.flags;var offs=pak.getOffset();if(err){assert.equal(pak.ack_data.data_offs,offs);flags|=ACKFLAG_ERR;pak.writeString(String(err));offs=pak.getOffset()}pak.makeReadable();var resp_pak_id=0;if(resp_func&&resp_func.expecting_response!==false){resp_pak_id=pak.ack_data.resp_pak_id;assert(resp_pak_id);assert(pak.ack_data.receiver);pak.ack_data.receiver.resp_cbs[resp_pak_id]=resp_func}else{pak.seek(pak.ack_data.resp_pak_id_offs);pak.zeroInt();pak.seek(offs)}pak.updateFlags(flags);delete pak.ack_data;return resp_pak_id}function ackReadHeader(pak){var flags=pak.getFlags();var msg=flags&ACKFLAG_IS_RESP?pak.readInt():pak.readAnsiString();var pak_id=pak.readInt();var err=flags&ACKFLAG_ERR?pak.readString():undefined;var data;if(flags&ACKFLAG_DATA_JSON){data=pak.readJSON()}else{data=pak}return{msg:msg,err:err,data:data,pak_id:pak_id}}function failAll(receiver,err){err=err||ERR_FAILALL_DISCONNECT;var cbs=receiver.resp_cbs;receiver.resp_cbs={};receiver.responses_waiting=0;for(var pak_id in cbs){cbs[pak_id](err)}}function ackHandleMessage(receiver,source,net_data_or_pak,send_func,pak_func,handle_func,filter_func){if(receiver.logPacketDispatch){receiver.logPacketDispatch(source,net_data_or_pak)}var net_data=isPacket(net_data_or_pak)?ackReadHeader(net_data_or_pak):net_data_or_pak;var err=net_data.err,data=net_data.data,msg=net_data.msg,pak_id=net_data.pak_id;var now=Date.now();var expecting_response=Boolean(pak_id);var timeout_id;if(expecting_response){timeout_id="pending"}var sent_response=false;var start_time=now;if(filter_func&&!filter_func(receiver,msg,data)){return}function preSendResp(err){assert(!sent_response,"Response function called twice");sent_response=true;if(expecting_response){if(timeout_id){if(timeout_id!=="pending"){clearTimeout(timeout_id)}}else{if(err===ERR_FAILALL_DISCONNECT){}else{(receiver.log?receiver:console).log("Response finally sent for "+msg+" after "+((Date.now()-start_time)/1e3).toFixed(1)+"s")}}receiver.responses_waiting--}}function respFunc(err,resp_data,resp_func){preSendResp(err);if(!expecting_response){if(resp_func){receiver.onError("Sending a response to a packet ("+msg+") that did not expect"+" one, but we are expecting a response");return}if(err){send_func("error",null,err,null)}return}send_func(pak_id,err,resp_data,resp_func)}respFunc.expecting_response=expecting_response;respFunc.pak=function(ref_pak){assert(expecting_response);var pak=pak_func(pak_id,ref_pak);var orig_send=pak.send;pak.send=function(err,resp_func){preSendResp(err);orig_send.call(pak,err,resp_func)};return pak};if(typeof msg==="number"){var cb=receiver.resp_cbs[msg];if(!cb){return void receiver.onError("Received response to unknown packet with id "+msg+" from "+source)}delete receiver.resp_cbs[msg];cb(err,data,respFunc)}else{if(!msg){return void receiver.onError("Received message with no .msg from "+source)}handle_func(msg,data,respFunc)}if(expecting_response){receiver.responses_waiting++;if(!sent_response&&!respFunc.suppress_timeout){timeout_id=setTimeout(function(){timeout_id=null;if(!respFunc.suppress_timeout){(receiver.log?receiver:console).log("Response not sent for "+msg+" from "+source+" after "+((Date.now()-start_time)/1e3).toFixed(1)+"s")}},15*1e3)}}}


},{"./packet.js":68,"assert":undefined}],63:[function(require,module,exports){
"use strict";var assert=require("assert");function series(arr,done){var length=arr.length;if(!length){return void done()}function handleItem(idx){arr[idx](function(err){if(err){return done(err)}if(idx<length-1){return handleItem(idx+1)}return done()})}handleItem(0)}exports.series=series;function eachLimit(arr,limit,proc,done){assert.equal(typeof limit,"number");assert(Array.isArray(arr));assert.equal(typeof proc,"function");assert.equal(typeof done,"function");var len=arr.length;var pending=len;var is_errored;var next;var results=[];function doNext(idx,err,result){results[idx]=result;if(err){is_errored=true}if(--pending===0||err){if(done){done(err,results)}done=null}else if(!is_errored&&next<len){var key=next++;proc(arr[key],doNext.bind(null,key))}}if(!pending){return void done(null,results)}next=limit;for(var ii=0;ii<arr.length&&ii<limit;++ii){proc(arr[ii],doNext.bind(null,ii))}}exports.eachLimit=eachLimit;function each(arr,proc,done){eachLimit(arr,Infinity,proc,done)}exports.each=each;function parallelLimit(tasks,limit,done){eachLimit(tasks,limit,function(task,next){task(next)},done)}exports.parallelLimit=parallelLimit;function parallel(tasks,done){parallelLimit(tasks,Infinity,done)}exports.parallel=parallel;function limiter(max_parallel){var avail=max_parallel;var head=null;var tail=null;function onFinish(){if(!head){++avail;return}var next=head;head=head.next;if(!head){tail=null}next(onFinish)}return function limiterRun(exec){if(!avail){if(!head){head=tail=exec}else{tail.next=exec;tail=exec}return}--avail;exec(onFinish)}}exports.limiter=limiter;Object.keys(exports).forEach(function(key){exports["async"+key[0].toUpperCase()+key.slice(1)]=exports[key]});


},{"assert":undefined}],64:[function(require,module,exports){
(function (Buffer){
"use strict";var floor=Math.floor;var chr_table="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var PAD="=";function encode(dv,offset,length){var data=dv.u8;var result="";var i;var effi;for(i=0;i<length-2;i+=3){effi=offset+i;result+=chr_table[data[effi]>>2];result+=chr_table[((data[effi]&3)<<4)+(data[effi+1]>>4)];result+=chr_table[((data[effi+1]&15)<<2)+(data[effi+2]>>6)];result+=chr_table[data[effi+2]&63]}if(length%3){i=length-length%3;effi=offset+i;result+=chr_table[data[effi]>>2];if(length%3===2){result+=chr_table[((data[effi]&3)<<4)+(data[effi+1]>>4)];result+=chr_table[(data[effi+1]&15)<<2];result+=PAD}else{result+=chr_table[(data[effi]&3)<<4];result+=PAD+PAD}}return result}function decodeNativeBrowser(data,allocator){var str=atob(data);var len=str.length;var dv=allocator(len);var u8=dv.u8;for(var ii=0;ii<len;++ii){u8[ii]=str.charCodeAt(ii)}dv.decode_size=len;return dv}function encodeNativeNode(dv,offset,length){return Buffer.from(dv.buffer).toString("base64",offset,offset+length)}function decodeNativeNode(data,allocator){var buffer_len=(data.length>>2)*3+floor(data.length%4/1.5);var dv=allocator(buffer_len);var buffer=Buffer.from(dv.buffer);dv.decode_size=buffer.write(data,"base64");return dv}var BROWSER=typeof window!=="undefined";exports.base64Decode=BROWSER?decodeNativeBrowser:decodeNativeNode;exports.base64Encode=BROWSER?encode:encodeNativeNode;


}).call(this,require("buffer").Buffer)

},{"buffer":undefined}],65:[function(require,module,exports){
"use strict";exports.canonical=canonical;exports.defaultHandler=defaultHandler;exports.create=create;exports.TYPE_STRING=exports.TYPE_FLOAT=exports.TYPE_INT=void 0;var assert=require("assert");var _require=require("./util.js"),isInteger=_require.isInteger;function canonical(cmd){return cmd.toLowerCase().replace(/[_.]/g,"")}var TYPE_INT=0;exports.TYPE_INT=TYPE_INT;var TYPE_FLOAT=1;exports.TYPE_FLOAT=TYPE_FLOAT;var TYPE_STRING=2;exports.TYPE_STRING=TYPE_STRING;var TYPE_NAME=["INTEGER","NUMBER","STRING"];function defaultHandler(err,resp){if(err){console.error(err,resp)}else{console.info(resp)}}function checkAccess(access,list){if(list){for(var ii=0;ii<list.length;++ii){if(!access||!access[list[ii]]){return false}}}return true}function CmdParse(params){this.cmds={};this.cmds_for_complete=this.cmds;this.was_not_found=false;this.storage=params&&params.storage;this.default_handler=defaultHandler;this.register({cmd:"cmd_list",func:this.cmdList.bind(this),access_show:["hidden"]})}CmdParse.prototype.cmdList=function(str,resp_func){if(!this.cmd_list){var list=this.cmd_list={};for(var cmd in this.cmds){var cmd_data=this.cmds[cmd];var access=[];if(cmd_data.access_show){access=access.concat(cmd_data.access_show)}if(cmd_data.access_run){access=access.concat(cmd_data.access_run)}if(access.indexOf("hidden")!==-1){continue}var data={name:cmd_data.name,help:cmd_data.help};if(cmd_data.usage){data.usage=cmd_data.usage}if(access.length){data.access_show=access}list[cmd]=data}}resp_func(null,this.cmd_list)};CmdParse.prototype.setDefaultHandler=function(fn){assert(this.default_handler===defaultHandler);this.default_handler=fn};CmdParse.prototype.handle=function(self,str,resp_func){resp_func=resp_func||this.default_handler;this.was_not_found=false;var m=str.match(/^([^\s]+)(?:\s+(.*))?$/);if(!m){resp_func("Missing command");return true}var cmd=canonical(m[1]);var cmd_data=this.cmds[cmd];if(cmd_data&&!checkAccess(self&&self.access,cmd_data.access_run)){resp_func('Access denied: "'+m[1]+'"');return false}if(!cmd_data){this.was_not_found=true;resp_func('Unknown command: "'+m[1]+'"');this.was_not_found=false;return false}cmd_data.fn.call(self,m[2]||"",resp_func);return true};CmdParse.prototype.register=function(param){assert.equal(typeof param,"object");var cmd=param.cmd,func=param.func,help=param.help,usage=param.usage,access_show=param.access_show,access_run=param.access_run;assert(cmd&&func);this.cmds[canonical(cmd)]={name:cmd,fn:func,help:help||"",usage:usage||undefined,access_show:access_show,access_run:access_run}};CmdParse.prototype.registerValue=function(cmd,param){var _this=this;assert(TYPE_NAME[param.type]||!param.set);assert(param.set||param.get);var label=param.label||cmd;var store=param.store&&this.storage||false;var store_key="cmd_parse_"+canonical(cmd);if(param.ver){store_key+="_"+param.ver}if(store){assert(param.set);var init_value=this.storage.getJSON(store_key);if(init_value!==undefined){if(param.range){init_value=Number(init_value);if(!isFinite(init_value)||init_value<param.range[0]||init_value>param.range[1]){init_value=undefined}}if(init_value!==undefined){param.set(init_value)}}}var fn=function fn(str,resp_func){function value(){resp_func(null,label+" = "+param.get())}function usage(){resp_func("Usage: /"+cmd+" "+TYPE_NAME[param.type])}if(!str){if(param.get){return value()}else{return usage()}}if(!param.set){return resp_func("Usage: /"+cmd)}var n=Number(str);if(param.range){if(n<param.range[0]){n=param.range[0]}else if(n>param.range[1]){n=param.range[1]}}var store_value=n;if(param.type===TYPE_INT){if(!isInteger(n)){return usage()}param.set(n)}else if(param.type===TYPE_FLOAT){if(!isFinite(n)){return usage()}param.set(n)}else{store_value=str;param.set(str)}if(store){_this.storage.setJSON(store_key,store_value)}if(param.on_change){param.on_change()}if(param.get){return value()}else{return resp_func(null,label+" udpated")}};this.register({cmd:cmd,func:fn,help:param.help||(param.get&&param.set?'Set or display "'+label+'" value':param.set?'Set "'+label+'" value':'Display "'+label+'" value'),usage:param.usage||(param.get?'Display "'+label+'" value\n  Usage: /'+cmd+"\n":"")+(param.set?'Set "'+label+'" value\n  Usage: /'+cmd+" NewValue":""),access_show:param.access_show,access_run:param.access_run})};function cmpCmd(a,b){if(a.cname<b.cname){return-1}return 1}CmdParse.prototype.addServerCommands=function(new_cmds){var cmds=this.cmds_for_complete;if(this.cmds_for_complete===this.cmds){cmds=this.cmds_for_complete={};for(var cname in this.cmds){cmds[cname]=this.cmds[cname]}}for(var _cname in new_cmds){if(!cmds[_cname]){cmds[_cname]=new_cmds[_cname]}}};CmdParse.prototype.autoComplete=function(str,access){var list=[];str=str.split(" ");var first_tok=canonical(str[0]);for(var cname in this.cmds_for_complete){if(str.length===1&&cname.slice(0,first_tok.length)===first_tok||str.length>1&&cname===first_tok){var cmd_data=this.cmds_for_complete[cname];if(checkAccess(access,cmd_data.access_show)&&checkAccess(access,cmd_data.access_run)){list.push({cname:cname,cmd:cmd_data.name,help:cmd_data.help,usage:cmd_data.usage})}}}list.sort(cmpCmd);return list};CmdParse.prototype.canonical=canonical;CmdParse.prototype.TYPE_INT=TYPE_INT;CmdParse.prototype.TYPE_FLOAT=TYPE_FLOAT;CmdParse.prototype.TYPE_STRING=TYPE_STRING;function create(params){return new CmdParse(params)}


},{"./util.js":70,"assert":undefined}],66:[function(require,module,exports){
"use strict";exports.PRESENCE_INACTIVE=exports.PRESENCE_ACTIVE=exports.PRESENCE_OFFLINE=exports.FRIEND_REMOVED=exports.FRIEND_ADDED_AUTO=exports.FRIEND_ADDED=void 0;var FRIEND_ADDED=1;exports.FRIEND_ADDED=FRIEND_ADDED;var FRIEND_ADDED_AUTO=2;exports.FRIEND_ADDED_AUTO=FRIEND_ADDED_AUTO;var FRIEND_REMOVED=3;exports.FRIEND_REMOVED=FRIEND_REMOVED;var PRESENCE_OFFLINE=0;exports.PRESENCE_OFFLINE=PRESENCE_OFFLINE;var PRESENCE_ACTIVE=1;exports.PRESENCE_ACTIVE=PRESENCE_ACTIVE;var PRESENCE_INACTIVE=2;exports.PRESENCE_INACTIVE=PRESENCE_INACTIVE;


},{}],67:[function(require,module,exports){
"use strict";var assert=require("assert");function stringUtf8Encode(str){var c;var n;var utftext=[];str=str.replace(/\r\n/g,"\n");for(n=0;n<str.length;++n){c=str.charCodeAt(n);if(c<128){utftext.push(String.fromCharCode(c))}else if(c>127&&c<2048){utftext.push(String.fromCharCode(c>>6|192));utftext.push(String.fromCharCode(c&63|128))}else{utftext.push(String.fromCharCode(c>>12|224));utftext.push(String.fromCharCode(c>>6&63|128));utftext.push(String.fromCharCode(c&63|128))}}return utftext.join("")}function rotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits}function addUnsigned(lX,lY){var lX8=lX&2147483648;var lY8=lY&2147483648;var lX4=lX&1073741824;var lY4=lY&1073741824;var lResult=(lX&1073741823)+(lY&1073741823);if(lX4&lY4){return lResult^2147483648^lX8^lY8}if(lX4|lY4){if(lResult&1073741824){return lResult^3221225472^lX8^lY8}else{return lResult^1073741824^lX8^lY8}}else{return lResult^lX8^lY8}}function F(x,y,z){return x&y|~x&z}function G(x,y,z){return x&z|y&~z}function H(x,y,z){return x^y^z}function I(x,y,z){return y^(x|~z)}function FF(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(F(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(G(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(H(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(I(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)}function convertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=new Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]|=string.charCodeAt(lByteCount)<<lBytePosition;lByteCount++}lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]|=128<<lBytePosition;lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray}function wordToHex(lValue){var wordToHexValue="";var wordToHexValue_temp="";var lByte;var lCount;for(lCount=0;lCount<=3;lCount++){lByte=lValue>>>lCount*8&255;wordToHexValue_temp="0"+lByte.toString(16);wordToHexValue+=wordToHexValue_temp.substr(wordToHexValue_temp.length-2,2)}return wordToHexValue}module.exports=function md5(string){var AA;var BB;var CC;var DD;var a;var b;var c;var d;var k;var S11=7;var S12=12;var S13=17;var S14=22;var S21=5;var S22=9;var S23=14;var S24=20;var S31=4;var S32=11;var S33=16;var S34=23;var S41=6;var S42=10;var S43=15;var S44=21;var x;if(typeof string==="string"){string=stringUtf8Encode(string);x=convertToWordArray(string)}else{assert(false)}a=1732584193;b=4023233417;c=2562383102;d=271733878;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k],S11,3614090360);d=FF(d,a,b,c,x[k+1],S12,3905402710);c=FF(c,d,a,b,x[k+2],S13,606105819);b=FF(b,c,d,a,x[k+3],S14,3250441966);a=FF(a,b,c,d,x[k+4],S11,4118548399);d=FF(d,a,b,c,x[k+5],S12,1200080426);c=FF(c,d,a,b,x[k+6],S13,2821735955);b=FF(b,c,d,a,x[k+7],S14,4249261313);a=FF(a,b,c,d,x[k+8],S11,1770035416);d=FF(d,a,b,c,x[k+9],S12,2336552879);c=FF(c,d,a,b,x[k+10],S13,4294925233);b=FF(b,c,d,a,x[k+11],S14,2304563134);a=FF(a,b,c,d,x[k+12],S11,1804603682);d=FF(d,a,b,c,x[k+13],S12,4254626195);c=FF(c,d,a,b,x[k+14],S13,2792965006);b=FF(b,c,d,a,x[k+15],S14,1236535329);a=GG(a,b,c,d,x[k+1],S21,4129170786);d=GG(d,a,b,c,x[k+6],S22,3225465664);c=GG(c,d,a,b,x[k+11],S23,643717713);b=GG(b,c,d,a,x[k],S24,3921069994);a=GG(a,b,c,d,x[k+5],S21,3593408605);d=GG(d,a,b,c,x[k+10],S22,38016083);c=GG(c,d,a,b,x[k+15],S23,3634488961);b=GG(b,c,d,a,x[k+4],S24,3889429448);a=GG(a,b,c,d,x[k+9],S21,568446438);d=GG(d,a,b,c,x[k+14],S22,3275163606);c=GG(c,d,a,b,x[k+3],S23,4107603335);b=GG(b,c,d,a,x[k+8],S24,1163531501);a=GG(a,b,c,d,x[k+13],S21,2850285829);d=GG(d,a,b,c,x[k+2],S22,4243563512);c=GG(c,d,a,b,x[k+7],S23,1735328473);b=GG(b,c,d,a,x[k+12],S24,2368359562);a=HH(a,b,c,d,x[k+5],S31,4294588738);d=HH(d,a,b,c,x[k+8],S32,2272392833);c=HH(c,d,a,b,x[k+11],S33,1839030562);b=HH(b,c,d,a,x[k+14],S34,4259657740);a=HH(a,b,c,d,x[k+1],S31,2763975236);d=HH(d,a,b,c,x[k+4],S32,1272893353);c=HH(c,d,a,b,x[k+7],S33,4139469664);b=HH(b,c,d,a,x[k+10],S34,3200236656);a=HH(a,b,c,d,x[k+13],S31,681279174);d=HH(d,a,b,c,x[k],S32,3936430074);c=HH(c,d,a,b,x[k+3],S33,3572445317);b=HH(b,c,d,a,x[k+6],S34,76029189);a=HH(a,b,c,d,x[k+9],S31,3654602809);d=HH(d,a,b,c,x[k+12],S32,3873151461);c=HH(c,d,a,b,x[k+15],S33,530742520);b=HH(b,c,d,a,x[k+2],S34,3299628645);a=II(a,b,c,d,x[k],S41,4096336452);d=II(d,a,b,c,x[k+7],S42,1126891415);c=II(c,d,a,b,x[k+14],S43,2878612391);b=II(b,c,d,a,x[k+5],S44,4237533241);a=II(a,b,c,d,x[k+12],S41,1700485571);d=II(d,a,b,c,x[k+3],S42,2399980690);c=II(c,d,a,b,x[k+10],S43,4293915773);b=II(b,c,d,a,x[k+1],S44,2240044497);a=II(a,b,c,d,x[k+8],S41,1873313359);d=II(d,a,b,c,x[k+15],S42,4264355552);c=II(c,d,a,b,x[k+6],S43,2734768916);b=II(b,c,d,a,x[k+13],S44,1309151649);a=II(a,b,c,d,x[k+4],S41,4149444226);d=II(d,a,b,c,x[k+11],S42,3174756917);c=II(c,d,a,b,x[k+2],S43,718787259);b=II(b,c,d,a,x[k+9],S44,3951481745);a=addUnsigned(a,AA);b=addUnsigned(b,BB);c=addUnsigned(c,CC);d=addUnsigned(d,DD)}var temp=wordToHex(a)+wordToHex(b)+wordToHex(c)+wordToHex(d);return temp.toLowerCase()};


},{"assert":undefined}],68:[function(require,module,exports){
(function (Buffer){
"use strict";exports.packetBufPoolAlloc=packetBufPoolAlloc;exports.packetBufPoolFree=packetBufPoolFree;var PACKET_DEBUG=exports.PACKET_DEBUG=1<<0;var PACKET_RESERVED1=exports.PACKET_RESERVED1=1<<1;var PACKET_RESERVED2=exports.PACKET_RESERVED2=1<<2;var FLAG_PACKET_INTERNAL=PACKET_DEBUG|PACKET_RESERVED1|PACKET_RESERVED2;var PACKET_UNOWNED_BUFFER=1<<8;exports.default_flags=0;var assert=require("assert");var max=Math.max;var _require=require("../common/util.js"),isInteger=_require.isInteger,log2=_require.log2;var _require2=require("../common/base64.js"),base64Encode=_require2.base64Encode,base64Decode=_require2.base64Decode;var FALSYS=[undefined,null,0,false,"",NaN];var PAK_BUF_DEFAULT_SIZE=1024;var UNDERRUN="PKTERR_UNDERRUN";var POOL_PACKETS=5e3;var POOL_TIMEOUT=5e3;var POOL_BUF_BY_SIZE=[0,10,10,20,20,20,20,20,20,20,5e3,20,20,20,20,20,20,10,10];var pak_pool=[];var pak_debug_pool=[];var buf_pool=POOL_BUF_BY_SIZE.map(function(){return[]});function allocDataView(size){var pool_idx=log2(size);assert(pool_idx);if(pool_idx>=buf_pool.length){pool_idx=0}if(pool_idx){size=1<<pool_idx;if(buf_pool[pool_idx].length){return buf_pool[pool_idx].pop()}}else{}var u8=new Uint8Array(size);var dv=new DataView(u8.buffer);dv.u8=u8;if(pool_idx){dv.packet_pool_idx=pool_idx}return dv}function wrapU8AsDataView(u8){var dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);dv.u8=u8;return dv}function utf8ByteLength(str){var len=str.length;var ret=len;for(var ii=0;ii<len;++ii){var c=str.charCodeAt(ii);if(c>127){++ret;if(c>2047){++ret;if(c>65535){++ret;if(c>2097151){++ret;if(c>67108863){++ret}}}}}}return ret}function utf8WriteChar(buf,buf_offs,c){if(c<=127){buf.u8[buf_offs++]=c}else if(c<=2047){buf.u8[buf_offs++]=c>>6|192;buf.u8[buf_offs++]=c&63|128}else if(c<=65535){buf.u8[buf_offs++]=c>>12|224;buf.u8[buf_offs++]=c>>6&63|128;buf.u8[buf_offs++]=c&63|128}else if(c<=2097151){buf.u8[buf_offs++]=c>>18|240;buf.u8[buf_offs++]=c>>12&63|128;buf.u8[buf_offs++]=c>>6&63|128;buf.u8[buf_offs++]=c&63|128}else if(c<=67108863){buf.u8[buf_offs++]=c>>24|248;buf.u8[buf_offs++]=c>>18&63|128;buf.u8[buf_offs++]=c>>12&63|128;buf.u8[buf_offs++]=c>>6&63|128;buf.u8[buf_offs++]=c&63|128}else if(c<=2147483647){buf.u8[buf_offs++]=c>>30|252;buf.u8[buf_offs++]=c>>24&63|128;buf.u8[buf_offs++]=c>>18&63|128;buf.u8[buf_offs++]=c>>12&63|128;buf.u8[buf_offs++]=c>>6&63|128;buf.u8[buf_offs++]=c&63|128}return buf_offs}function poolBuf(dv){assert(dv);assert(dv.u8);var pool_idx=dv.packet_pool_idx;if(pool_idx){var arr=buf_pool[pool_idx];if(arr.length<POOL_BUF_BY_SIZE[pool_idx]){arr.push(dv)}}else{}}function packetBufPoolAlloc(size){return allocDataView(size)}function packetBufPoolFree(dv){poolBuf(dv)}function Packet(flags,init_size,pak_debug){this.reinit(flags,init_size,pak_debug)}Packet.prototype.reinit=function(flags,init_size,pak_debug){this.flags=flags||0;this.has_flags=false;this.buf=null;this.buf_len=0;this.buf_offs=0;this.bufs=null;this.bsizes=null;this.readable=false;this.ref_count=1;this.pak_debug=pak_debug;if(init_size){this.fit(init_size,true);this.buf_len=init_size}};Packet.prototype.ref=function(){assert(this.ref_count);++this.ref_count};Packet.prototype.pool=function(){assert(this.ref_count);if(--this.ref_count){return}if(this.flags&PACKET_UNOWNED_BUFFER){}else{if(this.buf){poolBuf(this.buf)}if(this.bufs){for(var ii=0;ii<this.bufs.length;++ii){poolBuf(this.bufs[ii])}}}if(pak_pool.length<POOL_PACKETS){pak_pool.push(this)}if(this.pak_debug){this.pak_debug.poolDebug()}};Packet.prototype.totalSize=function(){var ret=0;if(this.readable){return this.buf_len}if(this.bsizes){for(var ii=0;ii<this.bsizes.length;++ii){ret+=this.bsizes[ii]}}ret+=this.buf_offs;return ret};Packet.prototype.setReadable=function(){assert(this.buf);assert(!this.bufs);assert(!this.readable);this.readable=true};Packet.prototype.makeReadable=function(){assert(this.buf);assert(!this.readable);var total=this.totalSize();this.readable=true;if(!this.bufs){this.buf_len=total;this.buf_offs=0;return}var buf=allocDataView(total);var u8=buf.u8;var offs=0;for(var ii=0;ii<this.bufs.length;++ii){var bsize=this.bsizes[ii];var dv=this.bufs[ii];if(offs+dv.u8.length>total){assert.equal(dv.byteOffset,0);u8.set(new Uint8Array(dv.buffer,0,bsize),offs)}else{u8.set(dv.u8,offs)}offs+=bsize;poolBuf(dv)}assert.equal(this.buf.byteOffset,0);u8.set(new Uint8Array(this.buf.buffer,this.buf.byteOffset,this.buf_offs),offs);poolBuf(this.buf);assert.equal(offs+this.buf_offs,total);this.bufs=this.bsizes=null;this.buf=buf;this.buf_offs=0;this.buf_len=total};Packet.prototype.flush=function(){var buf=this.buf,buf_offs=this.buf_offs;if(!this.bufs){this.bufs=[buf];this.bsizes=[buf_offs]}else{this.bufs.push(buf);this.bsizes.push(buf_offs)}this.buf=null;this.buf_len=0;this.buf_offs=0};Packet.prototype.fit=function(extra_bytes,no_advance){var buf=this.buf,buf_len=this.buf_len,buf_offs=this.buf_offs;var new_offs=buf_offs+extra_bytes;if(new_offs<=buf_len){if(!no_advance){this.buf_offs=new_offs}return buf_offs}assert(!this.readable);if(buf){this.flush()}this.buf_len=buf_len=max(PAK_BUF_DEFAULT_SIZE,extra_bytes);this.buf=allocDataView(buf_len);this.buf_offs=no_advance?0:extra_bytes;return 0};Packet.prototype.advance=function(bytes){var offs=this.buf_offs;var new_offs=offs+bytes;this.buf_offs=new_offs;if(new_offs>this.buf_len){throw new Error(UNDERRUN)}if(new_offs===this.buf_len){this.pool()}return offs};Packet.prototype.ended=function(){return this.buf_offs===this.buf_len};Packet.prototype.writeU8=function(v){assert(v>=0&&v<256);var offs=this.fit(1);this.buf.u8[offs]=v};Packet.prototype.readU8=function(){return this.buf.u8[this.advance(1)]};Packet.prototype.writeInt=function(v){assert(isInteger(v));var offs=this.fit(9,true);var buf=this.buf;var neg=v<0?1:0;if(neg){v=-v}if(v<248){if(neg){buf.u8[offs++]=255}buf.u8[offs++]=v}else{if(v<65536){buf.u8[offs++]=248+neg;buf.setUint16(offs,v,true);offs+=2}else if(v<4294967296){buf.u8[offs++]=250+neg;buf.setUint32(offs,v,true);offs+=4}else{buf.u8[offs++]=252+neg;var low_bits=v>>>0;buf.setUint32(offs,low_bits,true);offs+=4;buf.setUint32(offs,(v-low_bits)/4294967296,true);offs+=4}}this.buf_offs=offs};Packet.prototype.zeroInt=function(){var b1=this.buf.u8[this.buf_offs];if(b1<248){this.buf.u8[this.buf_offs++]=0;return}this.buf_offs++;var zeroes=1;switch(b1){case 253:case 252:zeroes+=4;case 251:case 250:zeroes+=2;case 249:case 248:zeroes++;case 255:break;default:throw new Error("PKTERR_PACKED_INT")}while(zeroes){--zeroes;this.buf.u8[this.buf_offs++]=0}};Packet.prototype.readInt=function(){var b1=this.buf.u8[this.advance(1)];if(b1<248){return b1}var sign=1;switch(b1){case 249:sign=-1;case 248:return sign*this.buf.getUint16(this.advance(2),true);case 251:sign=-1;case 250:return sign*this.buf.getUint32(this.advance(4),true);case 253:sign=-1;case 252:{var low_bits=this.buf.getUint32(this.advance(4),true);var high_bits=this.buf.getUint32(this.advance(4),true);return sign*(high_bits*4294967296+low_bits)}case 255:return-this.buf.u8[this.advance(1)];default:throw new Error("PKTERR_PACKED_INT")}};Packet.prototype.writeFloat=function(v){assert.equal(typeof v,"number");if(!v){this.buf.u8[this.fit(1)]=0;return}var offs=this.fit(5,true);this.buf.setFloat32(offs,v,true);if(this.buf.u8[offs]<=1){this.buf.u8[offs++]=1;this.buf.setFloat32(offs,v,true)}this.buf_offs=offs+4};Packet.prototype.readFloat=function(){var offs=this.advance(1);var b1=this.buf.u8[offs];if(!b1){return 0}if(b1===1){return this.buf.getFloat32(this.advance(4),true)}this.advance(3);return this.buf.getFloat32(offs,true)};Packet.prototype.writeU32=function(v){assert.equal(typeof v,"number");this.buf.setUint32(this.fit(4),v,true)};Packet.prototype.readU32=function(){return this.buf.getUint32(this.advance(4),true)};Packet.prototype.writeString=function(v){assert.equal(typeof v,"string");var byte_length=utf8ByteLength(v);this.writeInt(byte_length);if(!byte_length){return}var offs=this.fit(byte_length);var buf=this.buf;for(var ii=0;ii<v.length;++ii){var c=v.charCodeAt(ii);if(c<=127){buf.u8[offs++]=c}else{offs=utf8WriteChar(buf,offs,c)}}};Packet.prototype.utf8ReadChar=function(c){var buf=this.buf;if(c>=192&&c<224){return(c&31)<<6|buf.u8[this.buf_offs++]&63}else if(c>=224&&c<240){return(c&15)<<12|(buf.u8[this.buf_offs++]&63)<<6|buf.u8[this.buf_offs++]&63}else if(c>=240&&c<248){return(c&15)<<18|(buf.u8[this.buf_offs++]&63)<<12|(buf.u8[this.buf_offs++]&63)<<6|buf.u8[this.buf_offs++]&63}else if(c>=248&&c<252){return(c&15)<<24|(buf.u8[this.buf_offs++]&63)<<18|(buf.u8[this.buf_offs++]&63)<<12|(buf.u8[this.buf_offs++]&63)<<6|buf.u8[this.buf_offs++]&63}else{return(c&15)<<30|(buf.u8[this.buf_offs++]&63)<<24|(buf.u8[this.buf_offs++]&63)<<18|(buf.u8[this.buf_offs++]&63)<<12|(buf.u8[this.buf_offs++]&63)<<6|buf.u8[this.buf_offs++]&63}};var string_assembly=[];Packet.prototype.readString=function(){var byte_length=this.readInt();if(!byte_length){return""}if(this.buf_offs+byte_length>this.buf_len){throw new Error(UNDERRUN)}var buf=this.buf;var end_offset=this.buf_offs+byte_length;var ret;if(byte_length>8192){ret="";while(this.buf_offs<end_offset){var c=buf.u8[this.buf_offs++];if(c>127){c=this.utf8ReadChar(c)}ret+=String.fromCharCode(c)}}else{string_assembly.length=byte_length;var ii=0;while(this.buf_offs<end_offset){var _c=buf.u8[this.buf_offs++];if(_c>127){_c=this.utf8ReadChar(_c)}string_assembly[ii++]=_c}if(string_assembly.length!==ii){string_assembly.length=ii}ret=String.fromCharCode.apply(undefined,string_assembly)}if(this.buf_offs===this.buf_len){this.pool()}return ret};Packet.prototype.writeAnsiString=function(v){assert.equal(typeof v,"string");var byte_length=v.length;this.writeInt(byte_length);var offs=this.fit(byte_length);var buf=this.buf;for(var ii=0;ii<byte_length;++ii){buf.u8[offs++]=v.charCodeAt(ii)}};Packet.prototype.readAnsiString=function(){var len=this.readInt();if(!len){return""}var offs=this.advance(len);var buf=this.buf;string_assembly.length=len;for(var ii=0;ii<len;++ii){string_assembly[ii]=buf.u8[offs++]}return String.fromCharCode.apply(undefined,string_assembly)};Packet.prototype.writeJSON=function(v){if(!v){var idx=FALSYS.indexOf(v);assert(idx!==-1);this.writeU8(idx+1);return}this.writeU8(0);this.writeString(JSON.stringify(v))};Packet.prototype.readJSON=function(){var byte=this.readU8();if(byte){if(byte-1>=FALSYS.length){throw new Error("PKTERR_JSON_HEADER")}return FALSYS[byte-1]}var str=this.readString();return JSON.parse(str)};Packet.prototype.writeBuffer=function(v){this.writeInt(v.length);if(v.length){var offs=this.fit(v.length);this.buf.u8.set(v,offs)}};var null_buf=new Uint8Array(0);Packet.prototype.readBuffer=function(do_copy){var len=this.readInt();if(!len){return null_buf}var offs=this.advance(len);if(do_copy){return this.buf.u8.slice(offs,offs+len)}else{var buf=this.buf;return new Uint8Array(buf.buffer,buf.byteOffset+offs,len)}};Packet.prototype.writeBool=function(v){this.writeU8(v?1:0)};Packet.prototype.readBool=function(){return Boolean(this.readU8())};Packet.prototype.append=function(pak){assert.equal(this.flags&FLAG_PACKET_INTERNAL,pak.flags&FLAG_PACKET_INTERNAL);if(pak.bufs){for(var ii=0;ii<pak.bufs.length;++ii){var buf=pak.bufs[ii];var bsize=pak.bsizes[ii];var offs=this.fit(bsize);if(bsize!==buf.byteLength){this.buf.u8.set(new Uint8Array(buf.buffer,buf.byteOffset,bsize),offs)}else{this.buf.u8.set(buf.u8,offs)}}}if(pak.buf){var _buf=pak.buf;var _bsize=pak.readable?pak.buf_len:pak.buf_offs;var _offs=this.fit(_bsize);if(_bsize!==_buf.byteLength){this.buf.u8.set(new Uint8Array(_buf.buffer,_buf.byteOffset,_bsize),_offs)}else{this.buf.u8.set(_buf.u8,_offs)}}};Packet.prototype.appendRemaining=function(pak){assert.equal(this.flags&FLAG_PACKET_INTERNAL,pak.flags&FLAG_PACKET_INTERNAL);assert(pak.readable);assert(!pak.bufs);assert(pak.buf);assert(pak.buf_offs<=pak.buf_len);var bsize=pak.buf_len-pak.buf_offs;if(bsize){var offs=this.fit(bsize);this.buf.u8.set(new Uint8Array(pak.buf.buffer,pak.buf.byteOffset+pak.buf_offs,bsize),offs)}pak.pool()};Packet.prototype.toJSON=function(){var ret={f:this.flags};if(this.bufs){ret.b=[];for(var ii=0;ii<this.bufs.length;++ii){ret.b.push(base64Encode(this.bufs[ii],0,this.bsizes[ii]))}}if(this.buf){if(this.readable){ret.d=base64Encode(this.buf,0,this.buf_len)}else{ret.d=base64Encode(this.buf,0,this.buf_offs)}}return ret};Packet.prototype.setBuffer=function(buf,buf_len){assert(!this.buf);assert(!this.bufs);assert(this.flags&PACKET_UNOWNED_BUFFER);assert(buf instanceof Uint8Array);this.buf=wrapU8AsDataView(buf);this.buf_len=buf_len;this.readable=true};Packet.prototype.getBuffer=function(){assert(this.buf);assert(!this.bufs);return this.buf.u8};Packet.prototype.getBufferLen=function(){assert(this.buf);assert(!this.bufs);return this.readable?this.buf_len:this.buf_offs};Packet.prototype.getOffset=function(){if(this.readable){return this.buf_offs}return this.totalSize()};Packet.prototype.seek=function(pos){assert(this.readable);assert(pos>=0&&pos<=this.buf_len);this.buf_offs=pos};Packet.prototype.writeFlags=function(){assert(!this.has_flags);assert.equal(this.buf_offs,0);this.writeU8(this.flags);this.has_flags=true};Packet.prototype.updateFlags=function(flags){assert(this.has_flags);assert(!(flags&FLAG_PACKET_INTERNAL));this.flags=this.flags&FLAG_PACKET_INTERNAL|flags;var buf=this.bufs?this.bufs[0]:this.buf;buf.u8[0]=this.flags};Packet.prototype.readFlags=function(){var read=this.readU8();assert.equal(read,this.flags&255);this.has_flags=true;return this.flags};Packet.prototype.getFlags=function(){return this.flags};Packet.prototype.getInternalFlags=function(){return this.flags&FLAG_PACKET_INTERNAL};Packet.prototype.contents=function(){return"pak("+this.totalSize()+"b)"};function PacketDebug(flags,init_size){this.reinit(flags,init_size)}PacketDebug.prototype.reinit=function(flags,init_size){var _this=this;this.in_pool=false;if(pak_pool.length){this.pak=pak_pool.pop();this.pak.reinit(flags,init_size,this)}else{this.pak=new Packet(flags,init_size,this)}this.warned=false;this.pool_timer=setTimeout(function(){console.warn("Packet not pooled after 5s: "+_this.contents());_this.warned=true},POOL_TIMEOUT)};PacketDebug.prototype.poolDebug=function(){if(this.warned){console.warn("Packet pooled after timeout")}else{clearTimeout(this.pool_timer)}assert(!this.in_pool);this.in_pool=true;if(pak_debug_pool.length<POOL_PACKETS){pak_debug_pool.push(this)}};var types=[null,"U8","U32","Int","Float","String","AnsiString","JSON","Bool","Buffer"];types.forEach(function(type,idx){if(!type){return}var write="write"+type;var read="read"+type;var write_fn=Packet.prototype[write];var read_fn=Packet.prototype[read];PacketDebug.prototype[write]=function(v){this.pak.writeU8(idx);write_fn.call(this.pak,v)};PacketDebug.prototype[read]=function(param){var found_idx=this.pak.readU8();if(found_idx!==idx){assert(false,"PacketDebug error: Expected "+type+"("+idx+"), found "+types[found_idx]+"("+found_idx+")")}return read_fn.call(this.pak,param)}});PacketDebug.prototype.zeroInt=function(){this.pak.writeU8(3);this.pak.zeroInt()};["ended","getBuffer","getBufferLen","getFlags","getInternalFlags","getOffset","makeReadable","pool","readFlags","ref","seek","setBuffer","setReadable","toJSON","totalSize","updateFlags","writeFlags"].forEach(function(fname){var fn=Packet.prototype[fname];PacketDebug.prototype[fname]=function(){return fn.apply(this.pak,arguments)}});PacketDebug.prototype.append=function(pak){assert(pak instanceof PacketDebug);this.pak.append(pak.pak)};PacketDebug.prototype.appendRemaining=function(pak){assert(pak instanceof PacketDebug);this.pak.appendRemaining(pak.pak)};function format(v){switch(typeof v){case"object":if(v instanceof Uint8Array){return"u8<"+v.length+">"}return JSON.stringify(v);default:return v}}PacketDebug.prototype.contents=function(){var pak=this.pak;var cur_offs=pak.getOffset();var read_len=cur_offs;var ret=["buf:"+pak.buf_offs+"/"+pak.buf_len];if(pak.bufs){pak.makeReadable();ret.push("bufs")}else if(pak.buf){if(pak.readable){read_len=pak.buf_len}pak.buf_offs=0}else{ret.push("empty");read_len=-1}var saved_ref_count=pak.ref_count;pak.ref_count=2;try{if(!saved_ref_count){ret.push("!ref_count=0!")}if(pak.has_flags){ret.push("flags:"+pak.readU8())}while(pak.buf_offs<read_len){var type_idx=pak.readU8();var type=types[type_idx];if(!type){ret.push("UnknownType:"+type_idx);break}var val=pak["read"+type]();ret.push(type+":"+format(val))}}catch(e){ret.push("Error dumping packet contents: "+e)}pak.ref_count=saved_ref_count;pak.buf_offs=cur_offs;return ret.join(",")};function packetCreate(flags,init_size){if(flags===undefined){flags=exports.default_flags}var pool=flags&PACKET_DEBUG?pak_debug_pool:pak_pool;if(pool.length){var pak=pool.pop();pak.reinit(flags,init_size);return pak}if(flags&PACKET_DEBUG){return new PacketDebug(flags,init_size)}return new Packet(flags,init_size)}exports.packetCreate=packetCreate;function packetFromBuffer(buf,buf_len,need_copy){var flags=buf[0];assert.equal(typeof flags,"number");if(need_copy){assert(buf_len);assert(buf.buffer instanceof ArrayBuffer);var pak=packetCreate(flags,buf_len);if(buf.byteLength!==buf_len){buf=Buffer.from(buf.buffer,0,buf_len)}pak.getBuffer().set(buf);pak.setReadable();return pak}else{assert(buf instanceof Uint8Array);var _pak=packetCreate(flags|PACKET_UNOWNED_BUFFER);_pak.setBuffer(buf,buf_len||buf.byteLength);return _pak}}exports.packetFromBuffer=packetFromBuffer;function packetFromJSON(js_obj){var pak=packetCreate(js_obj.f);var payload=pak.pak||pak;function decode(str){return base64Decode(str,allocDataView)}if(js_obj.b){payload.bsizes=[];payload.bufs=[];for(var ii=0;ii<js_obj.b.length;++ii){var buf=decode(js_obj.b[ii]);payload.bufs.push(buf);payload.bsizes.push(buf.decode_size);delete buf.decode_size}}if(js_obj.d){payload.buf=decode(js_obj.d);payload.buf_len=payload.buf.decode_size;delete payload.buf.decode_size;payload.buf_offs=0}return pak}exports.packetFromJSON=packetFromJSON;function isPacket(thing){return thing instanceof Packet||thing instanceof PacketDebug}exports.isPacket=isPacket;


}).call(this,require("buffer").Buffer)

},{"../common/base64.js":64,"../common/util.js":70,"assert":undefined,"buffer":undefined}],69:[function(require,module,exports){
"use strict";var assert=require("assert");function EventEmitter(){this._listeners={}}module.exports=EventEmitter;module.exports.EventEmitter=EventEmitter;function addListener(ee,type,fn,once){assert(typeof fn==="function");var arr=ee._listeners[type];if(!arr){arr=ee._listeners[type]=[]}arr.push({once:once,fn:fn})}EventEmitter.prototype.hasListener=function(type,fn){var arr=this._listeners[type];if(!arr){return false}for(var ii=0;ii<arr.length;++ii){if(arr[ii].fn===fn){return true}}return false};EventEmitter.prototype.on=function(type,fn){addListener(this,type,fn,0);return this};EventEmitter.prototype.once=function(type,fn){addListener(this,type,fn,1);return this};EventEmitter.prototype.removeListener=function(type,fn){var arr=this._listeners[type];assert(arr);for(var ii=0;ii<arr.length;++ii){if(arr[ii].fn===fn){arr.splice(ii,1);return this}}assert(false);return this};function filterNotOnce(elem){return!elem.once}EventEmitter.prototype.emit=function(type){var arr=this._listeners[type];if(!arr){return false}var any=false;var any_once=false;for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}for(var ii=0;ii<arr.length;++ii){var elem=arr[ii];any=true;elem.fn.apply(elem,args);if(elem.once){any_once=true}}if(any_once){this._listeners[type]=arr.filter(filterNotOnce)}return any};


},{"assert":undefined}],70:[function(require,module,exports){
"use strict";exports.nop=nop;exports.once=once;exports.empty=empty;exports.easeInOut=easeInOut;exports.easeIn=easeIn;exports.easeOut=easeOut;exports.clone=clone;exports.merge=merge;exports.has=has;exports.defaults=defaults;exports.defaultsDeep=defaultsDeep;exports.cloneShallow=cloneShallow;exports.deepEqual=deepEqual;exports.clamp=clamp;exports.lerp=lerp;exports.mix=mix;exports.sign=sign;exports.log2=log2;exports.ridx=ridx;exports.round100=round100;exports.round1000=round1000;exports.fract=fract;exports.nearSame=nearSame;exports.titleCase=titleCase;exports.lineCircleIntersect=lineCircleIntersect;exports.inherits=inherits;exports.isPowerOfTwo=isPowerOfTwo;exports.nextHighestPowerOfTwo=nextHighestPowerOfTwo;exports.logdata=logdata;exports.isInteger=isInteger;exports.toNumber=toNumber;exports.randomNot=randomNot;exports.toArray=toArray;exports.matchAll=matchAll;exports.callEach=callEach;exports.sanitize=sanitize;exports.plural=plural;var assert=require("assert");var abs=Math.abs,floor=Math.floor,min=Math.min,max=Math.max,random=Math.random,round=Math.round,pow=Math.pow,sqrt=Math.sqrt;function nop(){}function once(fn){var called=false;return function(){if(called){return}called=true;fn.apply(void 0,arguments)}}function empty(obj){for(var key in obj){return false}return true}function easeInOut(v,a){var va=pow(v,a);return va/(va+pow(1-v,a))}function easeIn(v,a){return 2*easeInOut(.5*v,a)}function easeOut(v,a){return 2*easeInOut(.5+.5*v,a)-1}function clone(obj){return JSON.parse(JSON.stringify(obj))}function merge(dest,src){for(var f in src){dest[f]=src[f]}return dest}function has(obj,field){return Object.prototype.hasOwnProperty.call(obj,field)}function defaults(dest,src){for(var f in src){if(!has(dest,f)){dest[f]=src[f]}}return dest}function defaultsDeep(dest,src){for(var f in src){if(!has(dest,f)){dest[f]=src[f]}else if(typeof dest[f]==="object"){defaultsDeep(dest[f],src[f])}}return dest}function cloneShallow(src){return merge({},src)}function deepEqual(a,b){if(Array.isArray(a)){if(!Array.isArray(b)){return false}if(a.length!==b.length){return false}for(var ii=0;ii<a.length;++ii){if(!deepEqual(a[ii],b[ii])){return false}}return true}else if(typeof a==="object"){if(typeof b!=="object"){return false}if(!a||!b){return!a&&!b}for(var key in a){if(!deepEqual(a[key],b[key])){return false}}for(var _key in b){if(b[_key]!==undefined&&a[_key]===undefined){return false}}return true}return a===b}function clamp(v,mn,mx){return min(max(mn,v),mx)}function lerp(a,v0,v1){return(1-a)*v0+a*v1}function mix(v0,v1,a){return(1-a)*v0+a*v1}function sign(a){return a<0?-1:a>0?1:0}function log2(val){for(var ii=1,jj=0;;ii<<=1,++jj){if(ii>=val){return jj}}}function ridx(arr,idx){arr[idx]=arr[arr.length-1];arr.pop()}function round100(a){return round(a*100)/100}function round1000(a){return round(a*1e3)/1e3}function fract(a){return a-floor(a)}function nearSame(a,b,tol){return abs(b-a)<=tol}function titleCase(str){return str.split(" ").map(function(word){return""+word[0].toUpperCase()+word.slice(1)}).join(" ")}var EPSILON=1e-5;function lineCircleIntersect(p1,p2,pCircle,radius){var dp=[p2[0]-p1[0],p2[1]-p1[1]];var a=dp[0]*dp[0]+dp[1]*dp[1];var b=2*(dp[0]*(p1[0]-pCircle[0])+dp[1]*(p1[1]-pCircle[1]));var c=pCircle[0]*pCircle[0]+pCircle[1]*pCircle[1];c+=p1[0]*p1[0]+p1[1]*p1[1];c-=2*(pCircle[0]*p1[0]+pCircle[1]*p1[1]);c-=radius*radius;var bb4ac=b*b-4*a*c;if(abs(a)<EPSILON||bb4ac<0){return false}var mu1=(-b+sqrt(bb4ac))/(2*a);var mu2=(-b-sqrt(bb4ac))/(2*a);if(mu1>=0&&mu1<=1||mu2>=0&&mu2<=1){return true}return false}function inherits(ctor,superCtor){assert(typeof superCtor==="function");ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}function isPowerOfTwo(n){return(n&n-1)===0}function nextHighestPowerOfTwo(x){--x;for(var i=1;i<32;i<<=1){x|=x>>i}return x+1}function logdata(data){if(data===undefined){return""}var r=JSON.stringify(data);if(r.length<120){return r}return r.slice(0,120-3)+"..."}function isInteger(v){return typeof v==="number"&&isFinite(v)&&floor(v)===v}function toNumber(v){return Number(v)}function randomNot(not_value,max_value){var new_value;do{new_value=floor(random()*max_value)}while(new_value===not_value);return new_value}function toArray(array_like){return Array.prototype.slice.call(array_like)}function matchAll(str,re){var ret=[];var m;do{m=re.exec(str);if(m){ret.push(m[1])}}while(m);return ret}function callEach(arr,pre_clear){if(arr&&arr.length){for(var _len=arguments.length,args=new Array(_len>2?_len-2:0),_key2=2;_key2<_len;_key2++){args[_key2-2]=arguments[_key2]}for(var ii=0;ii<arr.length;++ii){arr[ii].apply(arr,args)}}}var utf16_surrogates=/[\uD800-\uDFFF]/g;function sanitize(str){return(str||"").replace(utf16_surrogates,"")}function plural(number,label){return""+label+(number===1?"":"s")}


},{"assert":undefined}],71:[function(require,module,exports){
"use strict";exports.profanityCommonStartup=profanityCommonStartup;exports.profanityFilterCommon=profanityFilterCommon;exports.isProfane=isProfane;var assert=require("assert");var max=Math.max;var trans_src="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+";var trans_dst="4bcd3fgh1jk1mn0pqr57uvwxy24bcd3fgh1jk1mn0pqr57uvwxy201234567897";var trans_src_regex=/[a-zA-Z0-9+]+/g;var trans_lookup={};function canonize(str){return str.split("").map(function(c){return trans_lookup[c]||c}).join("")}function rot13(str){return str.split("").map(function(c){c=c.charCodeAt(0);if(c>=97&&c<=122){c=97+(c-97+13)%26}else if(c>=65&&c<=90){c=65+(c-65+13)%26}return String.fromCharCode(c)}).join("")}var profanity={};var suffixes=["","s","s","in","ing","er","ers","ed","y"];var suffixes_canonized=["","5","35","1n","1ng","3r","3r5","3d","y"];var max_len=0;var inited=false;function profanityCommonStartup(filter_gkg){assert(!inited);inited=true;for(var ii=0;ii<trans_src.length;++ii){trans_lookup[trans_src[ii]]=trans_dst[ii]}var data=filter_gkg.split("\n").filter(function(a){return a});for(var _ii=0;_ii<data.length;++_ii){var s=rot13(data[_ii]);var start_len=s.length;s=canonize(s);assert.equal(start_len,s.length);for(var jj=0;jj<suffixes_canonized.length;++jj){var str=s+suffixes_canonized[jj];var existing=profanity[str];if(!existing||existing>jj){max_len=max(max_len,str.length);profanity[str]=jj+1}}}}var randWord;function filterWord(word_src){if(word_src.length>=max_len){return word_src}var is_uppercase=word_src[0].toUpperCase()===word_src[0];var word_canon=canonize(word_src);var suffix_idx=profanity[word_canon];if(!suffix_idx){return word_src}--suffix_idx;var word=randWord();if(is_uppercase){word=word[0].toUpperCase()+word.slice(1)}var suffix=suffixes[suffix_idx];if(word[word.length-1]===suffix[0]){suffix=suffix.slice(1)}if(word.endsWith("e")&&suffix[0]==="i"){word=word.slice(0,-1)}word+=suffix;return word}var is_profane;function checkWord(word_src){if(word_src.length>=max_len){return}if(profanity[canonize(word_src)]){is_profane=true}}function profanityFilterCommon(user_str,rand_word_fn){assert(inited);randWord=rand_word_fn;return user_str.replace(trans_src_regex,filterWord)}function isProfane(user_str){assert(inited);is_profane=false;user_str.replace(trans_src_regex,checkWord);return is_profane}


},{"assert":undefined}],72:[function(require,module,exports){
"use strict";exports.wsPakSendDest=wsPakSendDest;exports.wsPak=wsPak;exports.sendMessage=sendMessage;exports.wsHandleMessage=wsHandleMessage;exports.PING_TIME=exports.CONNECTION_TIMEOUT=exports.wsstats_out=exports.wsstats=void 0;var wsstats={msgs:0,bytes:0};exports.wsstats=wsstats;var wsstats_out={msgs:0,bytes:0};exports.wsstats_out=wsstats_out;var ack=require("./ack.js");var assert=require("assert");var ackHandleMessage=ack.ackHandleMessage,ackReadHeader=ack.ackReadHeader,ackWrapPakStart=ack.ackWrapPakStart,ackWrapPakPayload=ack.ackWrapPakPayload,ackWrapPakFinish=ack.ackWrapPakFinish;var packet=require("./packet.js");var isPacket=packet.isPacket,packetCreate=packet.packetCreate,packetFromBuffer=packet.packetFromBuffer;var CONNECTION_TIMEOUT=6e4;exports.CONNECTION_TIMEOUT=CONNECTION_TIMEOUT;var PING_TIME=CONNECTION_TIMEOUT/2;exports.PING_TIME=PING_TIME;exports.PROTOCOL_VERSION="1";var PAK_HEADER_SIZE=1+1+16+1+9;function wsPakSendDest(client,pak){if(!client.connected||client.socket.readyState!==1){console.warn("Attempting to send on a disconnected link (client_id:"+client.id+"), ignoring");pak.pool();return}var buf=pak.getBuffer();var buf_len=pak.getBufferLen();if(buf_len!==buf.length){buf=new Uint8Array(buf.buffer,buf.byteOffset,buf_len)}wsstats_out.msgs++;wsstats_out.bytes+=buf.length;if(client.ws_server){client.socket.send(buf,function(){pak.pool()})}else{client.socket.send(buf);pak.pool()}client.last_send_time=Date.now()}function wsPakSendFinish(pak,err,resp_func){var _pak$ws_data=pak.ws_data,client=_pak$ws_data.client,msg=_pak$ws_data.msg;delete pak.ws_data;var ack_resp_pkt_id=ackWrapPakFinish(pak,err,resp_func);if(!client.connected||client.socket.readyState!==1){if(msg==="channel_msg"){pak.seek(0);pak.readFlags();var header=ackReadHeader(pak);var is_packet=isPacket(header.data);var channel_id;var submsg;if(is_packet){pak.ref();channel_id=pak.readAnsiString();submsg=pak.readAnsiString();if(!pak.ended()){pak.pool()}}else{channel_id=header.data.channel_id;submsg=header.data.msg}msg="channel_msg:"+channel_id+":"+submsg}if(typeof msg!=="number"){(client.log?client:console).log("Attempting to send msg="+msg+" on a disconnected link, ignoring");if(!client.log&&client.onError&&msg){client.onError("Attempting to send msg="+msg+" on a disconnected link")}}if(ack_resp_pkt_id){delete client.resp_cbs[ack_resp_pkt_id]}pak.pool();return}assert.equal(Boolean(resp_func&&resp_func.expecting_response!==false),Boolean(ack_resp_pkt_id));wsPakSendDest(client,pak)}function wsPakSend(err,resp_func){var pak=this;if(typeof err==="function"&&!resp_func){resp_func=err;err=null}wsPakSendFinish(pak,err,resp_func)}function wsPak(msg,ref_pak,client){assert(typeof msg==="string"||typeof msg==="number");var pak=packetCreate(ref_pak?ref_pak.getInternalFlags():packet.default_flags,ref_pak?ref_pak.totalSize()+PAK_HEADER_SIZE:0);pak.writeFlags();ackWrapPakStart(pak,client,msg);pak.ws_data={msg:msg,client:client};pak.send=wsPakSend;return pak}function sendMessageInternal(client,msg,err,data,resp_func){var is_packet=isPacket(data);var pak=wsPak(msg,is_packet?data:null,client);if(!err){ackWrapPakPayload(pak,data)}pak.send(err,resp_func)}function sendMessage(msg,data,resp_func){sendMessageInternal(this,msg,null,data,resp_func)}function wsHandleMessage(client,buf,filter){++wsstats.msgs;var now=Date.now();var source=client.id?"client "+client.id:"server";if(!(buf instanceof Uint8Array)){(client.log?client:console).log("Received incorrect WebSocket data type from "+source+" ("+typeof buf+")");return client.onError("Invalid data received")}wsstats.bytes+=buf.length;var pak=packetFromBuffer(buf,buf.length,false);pak.readFlags();client.last_receive_time=now;client.idle_counter=0;return ackHandleMessage(client,source,pak,function sendFunc(msg,err,data,resp_func){if(resp_func&&!resp_func.expecting_response){resp_func=null}sendMessageInternal(client,msg,err,data,resp_func)},function pakFunc(msg,ref_pak){return wsPak(msg,ref_pak,client)},function handleFunc(msg,data,resp_func){var handler=client.handlers[msg];if(!handler){var error_msg="No handler for message "+JSON.stringify(msg)+" from "+source;console.error(error_msg,isPacket(data)?data.contents():data);if(client.onError){return client.onError(error_msg)}return resp_func(error_msg)}return handler(client,data,resp_func)},filter)}


},{"./ack.js":62,"./packet.js":68,"assert":undefined}]},{},[2])

//# sourceMappingURL=app.bundle.js.map
